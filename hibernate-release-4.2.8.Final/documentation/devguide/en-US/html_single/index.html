<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Hibernate Developer Guide</title><link rel="stylesheet" type="text/css" href="css/hibernate-single.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" title="Hibernate Developer Guide"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.hibernate.org" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d5e1"/>Hibernate Developer Guide</h1></div><div><div class="authorgroup">
            <div class="author"><h3 class="author">
                <span class="orgname"><a class="ulink" href="http://hibernate.org">The Hibernate Team</a></span>
            </h3></div>
            <div class="othercredit"><h3 class="othercredit">
                <span class="orgname"><a class="ulink" href="http://design.jboss.org/">The JBoss Visual Design Team</a></span>
            </h3></div>
        </div></div><div><p class="releaseinfo">4.2.8.Final</p></div><div><p class="copyright">Copyright © 2011 Red Hat, Inc.</p></div><div><p class="pubdate">2013-12-04</p></div></div><hr/></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="preface"><a href="#d5e23">Preface</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e38">1. Get Involved</a></span></dt><dt><span class="section"><a href="#d5e54">2. Getting Started Guide</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e58">1. Database access</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e60">1.1. Connecting</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e83">1.1.1. Configuration</a></span></dt><dt><span class="section"><a href="#d5e127">1.1.2. Obtaining a JDBC connection</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e150">1.2. Connection pooling</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e154">1.2.1. c3p0 connection pool</a></span></dt><dt><span class="section"><a href="#d5e170">1.2.2. Proxool connection pool</a></span></dt><dt><span class="section"><a href="#d5e199">1.2.3. Obtaining connections from an application server, using JNDI</a></span></dt><dt><span class="section"><a href="#d5e216">1.2.4. Other connection-specific configuration</a></span></dt><dt><span class="section"><a href="#d5e224">1.2.5. Optional configuration properties</a></span></dt></dl></dd><dt><span class="section"><a href="#configuring-dialects">1.3. Dialects</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e321">1.3.1. Specifying the Dialect to use</a></span></dt><dt><span class="section"><a href="#d5e326">1.3.2. Dialect resolution</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e339">1.4. Automatic schema generation with SchemaExport</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e347">1.4.1. Customizing the mapping files</a></span></dt><dt><span class="section"><a href="#d5e470">1.4.2. Running the SchemaExport tool</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d5e531">2. Transactions and concurrency control</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e533">2.1. Defining Transaction</a></span></dt><dt><span class="section"><a href="#d5e545">2.2. Physical Transactions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e565">2.2.1. Physical Transactions - JDBC</a></span></dt><dt><span class="section"><a href="#d5e571">2.2.2. Physical Transactions - JTA</a></span></dt><dt><span class="section"><a href="#d5e579">2.2.3. Physical Transactions - CMT</a></span></dt><dt><span class="section"><a href="#d5e590">2.2.4. Physical Transactions - Custom</a></span></dt><dt><span class="section"><a href="#d5e602">2.2.5. Physical Transactions - Legacy</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e618">2.3. Hibernate Transaction Usage</a></span></dt><dt><span class="section"><a href="#d5e626">2.4. Transactional patterns (and anti-patterns)</a></span></dt><dd><dl><dt><span class="section"><a href="#session-per-operation">2.4.1. Session-per-operation anti-pattern</a></span></dt><dt><span class="section"><a href="#session-per-request">2.4.2. Session-per-request pattern</a></span></dt><dt><span class="section"><a href="#long-conversations">2.4.3. Conversations</a></span></dt><dt><span class="section"><a href="#d5e719">2.4.4. Session-per-application</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e722">2.5. Object identity</a></span></dt><dt><span class="section"><a href="#transactions-basics-issues">2.6. Common issues</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e772">3. Persistence Contexts</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e801">3.1. Making entities persistent</a></span></dt><dt><span class="section"><a href="#d5e824">3.2. Deleting entities</a></span></dt><dt><span class="section"><a href="#d5e836">3.3. Obtain an entity reference without initializing its data</a></span></dt><dt><span class="section"><a href="#d5e845">3.4. Obtain an entity with its data initialized</a></span></dt><dt><span class="section"><a href="#d5e853">3.5. Obtain an entity by natural-id</a></span></dt><dt><span class="section"><a href="#d5e880">3.6. Refresh entity state</a></span></dt><dt><span class="section"><a href="#d5e891">3.7. Modifying managed/persistent state</a></span></dt><dt><span class="section"><a href="#d5e898">3.8. Working with detached data</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e902">3.8.1. Reattaching detached data</a></span></dt><dt><span class="section"><a href="#d5e922">3.8.2. Merging detached data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e933">3.9. Checking persistent state</a></span></dt><dt><span class="section"><a href="#d5e950">3.10. Accessing Hibernate APIs from JPA</a></span></dt></dl></dd><dt><span class="chapter"><a href="#batch">4. Batch Processing</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e971">4.1. Batch inserts</a></span></dt><dt><span class="section"><a href="#d5e980">4.2. Batch updates</a></span></dt><dt><span class="section"><a href="#d5e990">4.3. StatelessSession</a></span></dt><dt><span class="section"><a href="#d5e1033">4.4. Hibernate Query Language for DML</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1041">4.4.1. HQL for UPDATE and DELETE</a></span></dt><dt><span class="section"><a href="#d5e1076">4.4.2. HQL syntax for INSERT</a></span></dt><dt><span class="section"><a href="#d5e1104">4.4.3. More information on HQL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d5e1108">5. Locking</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1128">5.1. Optimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1144">5.1.1. Dedicated version number</a></span></dt><dt><span class="section"><a href="#d5e1207">5.1.2. Timestamp</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1256">5.2. Pessimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1261">5.2.1. The <code class="classname">LockMode</code> class</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d5e1322">6. Caching</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1326">6.1. The query cache</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1353">6.1.1. Query cache regions</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1364">6.2. Second-level cache providers</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1369">6.2.1. Configuring your cache providers</a></span></dt><dt><span class="section"><a href="#caching-strategies-list">6.2.2. Caching strategies</a></span></dt><dt><span class="section"><a href="#caching-provider-table">6.2.3. Second-level cache providers for Hibernate</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1560">6.3. Managing the cache</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1562">6.3.1. Moving items into and out of the cache</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d5e1648">7. Services</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1650">7.1. What are services?</a></span></dt><dt><span class="section"><a href="#d5e1653">7.2. Service contracts</a></span></dt><dt><span class="section"><a href="#d5e1661">7.3. Service dependencies</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1664">7.3.1. @<code class="interfacename">org.hibernate.service.spi.InjectService</code></a></span></dt><dt><span class="section"><a href="#d5e1677">7.3.2. <code class="interfacename">org.hibernate.service.spi.ServiceRegistryAwareService</code></a></span></dt></dl></dd><dt><span class="section"><a href="#services-registry">7.4. ServiceRegistry</a></span></dt><dt><span class="section"><a href="#d5e1693">7.5. Standard services</a></span></dt><dd><dl><dt><span class="section"><a href="#services-BatchBuilder">7.5.1. <code class="interfacename">org.hibernate.engine.jdbc.batch.spi.BatchBuilder</code></a></span></dt><dt><span class="section"><a href="#services-ConfigurationService">7.5.2. <code class="interfacename">org.hibernate.service.config.spi.ConfigurationService</code></a></span></dt><dt><span class="section"><a href="#services-ConnectionProvider">7.5.3. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#services-DialectFactory">7.5.4. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectFactory</code></a></span></dt><dt><span class="section"><a href="#services-DialectResolver">7.5.5. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code></a></span></dt><dt><span class="section"><a href="#services-JdbcServices">7.5.6. <code class="interfacename">org.hibernate.engine.jdbc.spi.JdbcServices</code></a></span></dt><dt><span class="section"><a href="#services-JmxService">7.5.7. <code class="interfacename">org.hibernate.service.jmx.spi.JmxService</code></a></span></dt><dt><span class="section"><a href="#services-JndiService">7.5.8. <code class="interfacename">org.hibernate.service.jndi.spi.JndiService</code></a></span></dt><dt><span class="section"><a href="#services-JtaPlatform">7.5.9. <code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code></a></span></dt><dt><span class="section"><a href="#services-MultiTenantConnectionProvider">7.5.10. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#services-PersisterClassResolver">7.5.11. <code class="interfacename">org.hibernate.persister.spi.PersisterClassResolver</code></a></span></dt><dt><span class="section"><a href="#services-PersisterFactory">7.5.12. <code class="interfacename">org.hibernate.persister.spi.PersisterFactory</code></a></span></dt><dt><span class="section"><a href="#services-RegionFactory">7.5.13. <code class="interfacename">org.hibernate.cache.spi.RegionFactory</code></a></span></dt><dt><span class="section"><a href="#services-SessionFactoryServiceRegistryFactory">7.5.14. <code class="interfacename">org.hibernate.service.spi.SessionFactoryServiceRegistryFactory</code></a></span></dt><dt><span class="section"><a href="#services-Statistics">7.5.15. <code class="interfacename">org.hibernate.stat.Statistics</code></a></span></dt><dt><span class="section"><a href="#services-TransactionFactory">7.5.16. <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code></a></span></dt><dt><span class="section"><a href="#services-ImportSqlCommandExtractor">7.5.17. <code class="interfacename">org.hibernate.tool.hbm2ddl.ImportSqlCommandExtractor</code></a></span></dt></dl></dd><dt><span class="section"><a href="#d5e2138">7.6. Custom services</a></span></dt><dt><span class="section"><a href="#d5e2157">7.7. Special service registries</a></span></dt><dd><dl><dt><span class="section"><a href="#services-registry-bootstrap">7.7.1. Boot-strap registry</a></span></dt><dt><span class="section"><a href="#services-registry-sessionfactory">7.7.2. SessionFactory registry</a></span></dt></dl></dd><dt><span class="section"><a href="#services-use">7.8. Using services and registries</a></span></dt><dt><span class="section"><a href="#integrators">7.9. Integrators</a></span></dt><dd><dl><dt><span class="section"><a href="#integrators-uses">7.9.1. Integrator use-cases</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#d5e2253">8. Data categorizations</a></span></dt><dd><dl><dt><span class="section"><a href="#value-types">8.1. Value types</a></span></dt><dd><dl><dt><span class="section"><a href="#value-basic-types">8.1.1. Basic types</a></span></dt><dt><span class="section"><a href="#value-national-character-types">8.1.2. National Character Types</a></span></dt><dt><span class="section"><a href="#value-composite-types">8.1.3. Composite types</a></span></dt><dt><span class="section"><a href="#value-collection-types">8.1.4. Collection types</a></span></dt></dl></dd><dt><span class="section"><a href="#entity-types">8.2. Entity Types</a></span></dt><dt><span class="section"><a href="#d5e2562">8.3. Implications of different data categorizations</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e2565">9. Mapping entities</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2567">9.1. Hierarchies</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e2570">10. Mapping associations</a></span></dt><dt><span class="chapter"><a href="#d5e2575">11. HQL and JPQL</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2580">11.1. Case Sensitivity</a></span></dt><dt><span class="section"><a href="#d5e2592">11.2. Statement types</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2608">11.2.1. Select statements</a></span></dt><dt><span class="section"><a href="#d5e2621">11.2.2. Update statements</a></span></dt><dt><span class="section"><a href="#d5e2656">11.2.3. Delete statements</a></span></dt><dt><span class="section"><a href="#d5e2666">11.2.4. Insert statements</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-from-clause">11.3. The <code class="literal">FROM</code> clause</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2703">11.3.1. Identification variables</a></span></dt><dt><span class="section"><a href="#d5e2710">11.3.2. Root entity references</a></span></dt><dt><span class="section"><a href="#d5e2734">11.3.3. Explicit joins</a></span></dt><dt><span class="section"><a href="#d5e2777">11.3.4. Implicit joins (path expressions)</a></span></dt><dt><span class="section"><a href="#ql-collection-valued-associations">11.3.5. Collection member references</a></span></dt><dt><span class="section"><a href="#d5e2847">11.3.6. Polymorphism</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-expressions">11.4. Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2866">11.4.1. Identification variable</a></span></dt><dt><span class="section"><a href="#d5e2870">11.4.2. Path expressions</a></span></dt><dt><span class="section"><a href="#d5e2874">11.4.3. Literals</a></span></dt><dt><span class="section"><a href="#d5e2900">11.4.4. Parameters</a></span></dt><dt><span class="section"><a href="#d5e2923">11.4.5. Arithmetic</a></span></dt><dt><span class="section"><a href="#d5e2945">11.4.6. Concatenation (operation)</a></span></dt><dt><span class="section"><a href="#d5e2956">11.4.7. Aggregate functions</a></span></dt><dt><span class="section"><a href="#ql-exp-functions">11.4.8. Scalar functions</a></span></dt><dt><span class="section"><a href="#ql-collection-expressions">11.4.9. Collection-related expressions</a></span></dt><dt><span class="section"><a href="#ql-entity-type-exp">11.4.10. Entity type</a></span></dt><dt><span class="section"><a href="#d5e3155">11.4.11. CASE expressions</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-select-clause">11.5. The <code class="literal">SELECT</code> clause</a></span></dt><dt><span class="section"><a href="#ql-conditional-expressions">11.6. Predicates</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3217">11.6.1. Relational comparisons</a></span></dt><dt><span class="section"><a href="#d5e3232">11.6.2. Nullness predicate</a></span></dt><dt><span class="section"><a href="#d5e3238">11.6.3. Like predicate</a></span></dt><dt><span class="section"><a href="#d5e3260">11.6.4. Between predicate</a></span></dt><dt><span class="section"><a href="#d5e3266">11.6.5. In predicate</a></span></dt><dt><span class="section"><a href="#d5e3291">11.6.6. Exists predicate</a></span></dt><dt><span class="section"><a href="#d5e3294">11.6.7. Empty collection predicate</a></span></dt><dt><span class="section"><a href="#d5e3301">11.6.8. Member-of collection predicate</a></span></dt><dt><span class="section"><a href="#d5e3308">11.6.9. NOT predicate operator</a></span></dt><dt><span class="section"><a href="#d5e3312">11.6.10. AND predicate operator</a></span></dt><dt><span class="section"><a href="#d5e3316">11.6.11. OR predicate operator</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-where-clause">11.7. The <code class="literal">WHERE</code> clause</a></span></dt><dt><span class="section"><a href="#ql-grouping">11.8. Grouping</a></span></dt><dt><span class="section"><a href="#ql-ordering">11.9. Ordering</a></span></dt><dt><span class="section"><a href="#ql-api">11.10. Query API</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3364">12. Criteria</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery">12.1. Typed criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">12.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">12.1.2. Selecting an expression</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">12.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">12.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">12.2. Tuple criteria queries</a></span></dt><dt><span class="section"><a href="#querycriteria-from">12.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">12.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">12.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">12.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">12.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">12.5. Using parameters</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3565">13. Native SQL Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querysql-creating">13.1. Using a <code class="literal">SQLQuery</code></a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3574">13.1.1. Scalar queries</a></span></dt><dt><span class="section"><a href="#d5e3598">13.1.2. Entity queries</a></span></dt><dt><span class="section"><a href="#d5e3616">13.1.3. Handling associations and collections</a></span></dt><dt><span class="section"><a href="#d5e3629">13.1.4. Returning multiple entities</a></span></dt><dt><span class="section"><a href="#d5e3721">13.1.5. Returning non-managed entities</a></span></dt><dt><span class="section"><a href="#d5e3733">13.1.6. Handling inheritance</a></span></dt><dt><span class="section"><a href="#d5e3736">13.1.7. Parameters</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-namedqueries">13.2. Named SQL queries</a></span></dt><dd><dl><dt><span class="section"><a href="#propertyresults">13.2.1. Using return-property to explicitly specify column/alias
      names</a></span></dt><dt><span class="section"><a href="#sp_query">13.2.2. Using stored procedures for querying</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-cud">13.3. Custom SQL for create, update and delete</a></span></dt><dt><span class="section"><a href="#querysql-load">13.4. Custom SQL for loading</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e3938">14. JMX</a></span></dt><dt><span class="chapter"><a href="#d5e3941">15. Envers</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3947">15.1. Basics</a></span></dt><dt><span class="section"><a href="#d5e3968">15.2. Configuration</a></span></dt><dt><span class="section"><a href="#d5e4099">15.3. Additional mapping annotations</a></span></dt><dt><span class="section"><a href="#d5e4121">15.4. Choosing an audit strategy</a></span></dt><dt><span class="section"><a href="#envers-revisionlog">15.5. Revision Log</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-tracking-modified-entities-revchanges">15.5.1. Tracking entity names modified during revisions</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-tracking-properties-changes">15.6. Tracking entity changes at property level</a></span></dt><dt><span class="section"><a href="#envers-queries">15.7. Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#entities-at-revision">15.7.1. Querying for entities of a class at a given revision</a></span></dt><dt><span class="section"><a href="#revisions-of-entity">15.7.2. Querying for revisions, at which entities of a given class changed</a></span></dt><dt><span class="section"><a href="#envers-envers-tracking-properties-changes-queries">15.7.3. Querying for revisions of entity that modified given property</a></span></dt><dt><span class="section"><a href="#envers-tracking-modified-entities-queries">15.7.4. Querying for entities modified in a given revision</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4338">15.8. Conditional auditing</a></span></dt><dt><span class="section"><a href="#d5e4358">15.9. Understanding the Envers Schema</a></span></dt><dt><span class="section"><a href="#envers-generateschema">15.10. Generating schema with Ant</a></span></dt><dt><span class="section"><a href="#envers-mappingexceptions">15.11. Mapping exceptions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4393">15.11.1. What isn't and will not be supported</a></span></dt><dt><span class="section"><a href="#d5e4404">15.11.2. What isn't and <span class="emphasis"><em>will</em></span> be supported</a></span></dt><dt><span class="section"><a href="#d5e4411">15.11.3. <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></a></span></dt></dl></dd><dt><span class="section"><a href="#envers-partitioning">15.12. Advanced: Audit table partitioning</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-partitioning-benefits">15.12.1. Benefits of audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-columns">15.12.2. Suitable columns for audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-example">15.12.3. Audit table partitioning example</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-links">15.13. Envers links</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e4623">16. Multi-tenancy</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4625">16.1. What is multi-tenancy?</a></span></dt><dt><span class="section"><a href="#d5e4628">16.2. Multi-tenant data approaches</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4634">16.2.1. Separate database</a></span></dt><dt><span class="section"><a href="#d5e4643">16.2.2. Separate schema</a></span></dt><dt><span class="section"><a href="#d5e4660">16.2.3. Partitioned (discriminator) data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4669">16.3. Multi-tenancy in Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4698">16.3.1. <code class="interfacename">MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#d5e4723">16.3.2. <code class="interfacename">CurrentTenantIdentifierResolver</code></a></span></dt><dt><span class="section"><a href="#d5e4748">16.3.3. Caching</a></span></dt><dt><span class="section"><a href="#d5e4751">16.3.4. Odds and ends</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4755">16.4. Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e4766">17. OSGi</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4773">17.1. OSGi Specification and Environment</a></span></dt><dt><span class="section"><a href="#d5e4788">17.2. hibernate-osgi</a></span></dt><dt><span class="section"><a href="#osgi-managed-jpa">17.3. Container-Managed JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4798">17.3.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4808">17.3.2. DataSource</a></span></dt><dt><span class="section"><a href="#d5e4815">17.3.3. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4819">17.3.4. Obtaining an EntityManger</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-jpa">17.4. Unmanaged JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4832">17.4.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4848">17.4.2. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4852">17.4.3. Obtaining an EntityMangerFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-native">17.5. Unmanaged Native</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4865">17.5.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4884">17.5.2. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4888">17.5.3. Obtaining an SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4896">17.6. Optional Modules</a></span></dt><dt><span class="section"><a href="#d5e4901">17.7. Extension Points</a></span></dt><dt><span class="section"><a href="#d5e4919">17.8. Caveats</a></span></dt></dl></dd><dt><span class="appendix"><a href="#d5e4945">A. Configuration properties</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4947">A.1. General Configuration</a></span></dt><dt><span class="section"><a href="#d5e5053">A.2. Database configuration</a></span></dt><dt><span class="section"><a href="#d5e5276">A.3. Connection pool properties</a></span></dt></dl></dd><dt><span class="appendix"><a href="#d5e5313">B. Legacy Hibernate Criteria Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-creating">B.1. Creating a <code class="literal">Criteria</code> instance</a></span></dt><dt><span class="section"><a href="#querycriteria-narrowing">B.2. Narrowing the result set</a></span></dt><dt><span class="section"><a href="#querycriteria-ordering">B.3. Ordering the results</a></span></dt><dt><span class="section"><a href="#querycriteria-associations">B.4. Associations</a></span></dt><dt><span class="section"><a href="#querycriteria-dynamicfetching">B.5. Dynamic association fetching</a></span></dt><dt><span class="section"><a href="#querycriteria-components">B.6. Components</a></span></dt><dt><span class="section"><a href="#querycriteria-collections">B.7. Collections</a></span></dt><dt><span class="section"><a href="#querycriteria-examples">B.8. Example queries</a></span></dt><dt><span class="section"><a href="#querycriteria-projection">B.9. Projections, aggregation and grouping</a></span></dt><dt><span class="section"><a href="#querycriteria-detachedqueries">B.10. Detached queries and subqueries</a></span></dt><dt><span class="section"><a href="#query-criteria-naturalid">B.11. Queries by natural identifier</a></span></dt></dl></dd></dl></div><div class="list-of-tables"><p><strong>List of Tables</strong></p><dl><dt>1.1. <a href="#d5e177">Important configuration properties for the Proxool connection pool</a></dt><dt>1.2. <a href="#d5e233">Supported database dialects</a></dt><dt>1.3. <a href="#tab-customizing-schema">Elements and attributes provided for customizing mapping files</a></dt><dt>1.4. <a href="#d5e478">SchemaExport Options</a></dt><dt>6.1. <a href="#shared-cache-mode-values">Possible values for Shared Cache Mode</a></dt><dt>8.1. <a href="#d5e2292">Basic Type Mappings</a></dt><dt>8.2. <a href="#d5e2500">National Character Type Mappings</a></dt><dt>13.1. <a href="#aliasinjection-summary">Alias injection names</a></dt><dt>15.1. <a href="#d5e3971">Envers Configuration Properties</a></dt><dt>15.2. <a href="#d5e4473">Salaries table</a></dt><dt>15.3. <a href="#d5e4497">Salaries - audit table</a></dt><dt>A.1. <a href="#d5e5055">JDBC properties</a></dt><dt>A.2. <a href="#d5e5119">Cache Properties</a></dt><dt>A.3. <a href="#d5e5181">Transactions properties</a></dt><dt>A.4. <a href="#d5e5230">Miscellaneous properties</a></dt><dt>A.5. <a href="#d5e5288">Proxool connection pool properties</a></dt></dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>1.1. <a href="#d5e86"><code class="filename">hibernate.properties</code> for a c3p0 connection pool</a></dt><dt>1.2. <a href="#d5e90"><code class="filename">hibernate.cfg.xml</code> for a connection to the bundled HSQL database</a></dt><dt>1.3. <a href="#d5e100">Specifying the mapping files directly</a></dt><dt>1.4. <a href="#d5e106">Letting Hibernate find the mapping files for you</a></dt><dt>1.5. <a href="#d5e113">Specifying configuration properties</a></dt><dt>1.6. <a href="#d5e133">Specifying configuration properties</a></dt><dt>1.7. <a href="#d5e473">SchemaExport syntax</a></dt><dt>1.8. <a href="#d5e528">Embedding SchemaExport into your application</a></dt><dt>2.1. <a href="#d5e726">Database identity</a></dt><dt>2.2. <a href="#d5e729">JVM identity</a></dt><dt>3.1. <a href="#d5e808">Example of making an entity persistent</a></dt><dt>3.2. <a href="#d5e827">Example of deleting an entity</a></dt><dt>3.3. <a href="#d5e839">Example of obtaining an entity reference without initializing its data</a></dt><dt>3.4. <a href="#d5e848">Example of obtaining an entity reference with its data initialized</a></dt><dt>3.5. <a href="#d5e856">Example of simple natural-id access</a></dt><dt>3.6. <a href="#d5e859">Example of natural-id access</a></dt><dt>3.7. <a href="#d5e883">Example of refreshing entity state</a></dt><dt>3.8. <a href="#d5e894">Example of modifying managed state</a></dt><dt>3.9. <a href="#d5e908">Example of reattaching a detached entity</a></dt><dt>3.10. <a href="#d5e925">Visualizing merge</a></dt><dt>3.11. <a href="#d5e929">Example of merging a detached entity</a></dt><dt>3.12. <a href="#d5e936">Examples of verifying managed state</a></dt><dt>3.13. <a href="#d5e940">Examples of verifying laziness</a></dt><dt>3.14. <a href="#d5e947">Alternative JPA means to verify laziness</a></dt><dt>3.15. <a href="#d5e953">Usage of EntityManager.unwrap</a></dt><dt>4.1. <a href="#d5e959">Naive way to insert 100000 lines with Hibernate</a></dt><dt>4.2. <a href="#d5e976">Flushing and clearing the <code class="classname">Session</code></a></dt><dt>4.3. <a href="#d5e986">Using <code class="methodname">scroll()</code></a></dt><dt>4.4. <a href="#d5e1018">Using a <code class="interfacename">StatelessSession</code></a></dt><dt>4.5. <a href="#d5e1043">Psuedo-syntax for UPDATE and DELETE statements using HQL</a></dt><dt>4.6. <a href="#d5e1054">Executing an HQL UPDATE, using the <code class="methodname">Query.executeUpdate()</code> method</a></dt><dt>4.7. <a href="#d5e1061">Updating the version of timestamp</a></dt><dt>4.8. <a href="#d5e1068">A HQL <code class="literal">DELETE</code> statement</a></dt><dt>4.9. <a href="#d5e1078">Pseudo-syntax for INSERT statements</a></dt><dt>4.10. <a href="#d5e1101">HQL INSERT statement</a></dt><dt>5.1. <a href="#d5e1148">The @Version annotation</a></dt><dt>5.2. <a href="#d5e1163">Declaring a version property in <code class="filename">hbm.xml</code></a></dt><dt>5.3. <a href="#d5e1213">Using timestamps for optimistic locking</a></dt><dt>5.4. <a href="#d5e1222">The timestamp element in <code class="filename">hbm.xml</code></a></dt><dt>6.1. <a href="#d5e1357">Method <code class="methodname">setCacheRegion</code></a></dt><dt>6.2. <a href="#configuring-cache-providers-annotations">Configuring cache providers using annotations</a></dt><dt>6.3. <a href="#d5e1454">Configuring cache providers using mapping files</a></dt><dt>6.4. <a href="#d5e1604">Evicting an item from the first-level cache</a></dt><dt>6.5. <a href="#d5e1611">Second-level cache eviction</a></dt><dt>6.6. <a href="#d5e1645">Browsing the second-level cache entries via the Statistics API</a></dt><dt>7.1. <a href="#BootstrapServiceRegistryBuilder-example">Using BootstrapServiceRegistryBuilder</a></dt><dt>7.2. <a href="#registering-listeners-example">Registering event listeners</a></dt><dt>11.1. <a href="#d5e2647">Example UPDATE query statements</a></dt><dt>11.2. <a href="#d5e2694">Example INSERT query statements</a></dt><dt>11.3. <a href="#ql-simple-query-ex">Simple query example</a></dt><dt>11.4. <a href="#d5e2726">Simple query using entity name for root entity reference</a></dt><dt>11.5. <a href="#d5e2730">Simple query using multiple root entity references</a></dt><dt>11.6. <a href="#d5e2741">Explicit inner join examples</a></dt><dt>11.7. <a href="#d5e2744">Explicit left (outer) join examples</a></dt><dt>11.8. <a href="#d5e2751">Fetch join example</a></dt><dt>11.9. <a href="#d5e2767">with-clause join example</a></dt><dt>11.10. <a href="#d5e2780">Simple implicit join example</a></dt><dt>11.11. <a href="#d5e2799">Reused implicit join</a></dt><dt>11.12. <a href="#d5e2808">Collection references example</a></dt><dt>11.13. <a href="#d5e2821">Qualified collection references example</a></dt><dt>11.14. <a href="#d5e2877">String literal examples</a></dt><dt>11.15. <a href="#d5e2881">Numeric literal examples</a></dt><dt>11.16. <a href="#d5e2907">Named parameter examples</a></dt><dt>11.17. <a href="#d5e2915">Positional (JPQL) parameter examples</a></dt><dt>11.18. <a href="#d5e2926">Numeric arithmetic examples</a></dt><dt>11.19. <a href="#d5e2950">Concatenation operation example</a></dt><dt>11.20. <a href="#d5e2976">Aggregate function examples</a></dt><dt>11.21. <a href="#d5e3135">Collection-related expressions examples</a></dt><dt>11.22. <a href="#d5e3139">Index operator examples</a></dt><dt>11.23. <a href="#d5e3148">Entity type expression examples</a></dt><dt>11.24. <a href="#d5e3164">Simple case expression example</a></dt><dt>11.25. <a href="#d5e3171">Searched case expression example</a></dt><dt>11.26. <a href="#d5e3177">NULLIF example</a></dt><dt>11.27. <a href="#d5e3194">Dynamic instantiation example - constructor</a></dt><dt>11.28. <a href="#d5e3202">Dynamic instantiation example - list</a></dt><dt>11.29. <a href="#d5e3207">Dynamic instantiation example - map</a></dt><dt>11.30. <a href="#d5e3220">Relational comparison examples</a></dt><dt>11.31. <a href="#d5e3228">ALL subquery comparison qualifier example</a></dt><dt>11.32. <a href="#d5e3235">Nullness checking examples</a></dt><dt>11.33. <a href="#d5e3257">Like predicate examples</a></dt><dt>11.34. <a href="#d5e3263">Between predicate examples</a></dt><dt>11.35. <a href="#d5e3288">In predicate examples</a></dt><dt>11.36. <a href="#d5e3298">Empty collection expression examples</a></dt><dt>11.37. <a href="#d5e3305">Member-of collection expression examples</a></dt><dt>11.38. <a href="#group_by_illustration">Group-by illustration</a></dt><dt>11.39. <a href="#having_illustration">Having illustration</a></dt><dt>11.40. <a href="#d5e3359">Order-by examples</a></dt><dt>12.1. <a href="#ex-criteria-typedquery-entity">Selecting the root entity</a></dt><dt>12.2. <a href="#ex-criteria-typedquery-attribute">Selecting an attribute</a></dt><dt>12.3. <a href="#ex-criteria-typedquery-array">Selecting an array</a></dt><dt>12.4. <a href="#ex-criteria-typedquery-array2">Selecting an array (2)</a></dt><dt>12.5. <a href="#ex-criteria-typedquery-construct">Selecting an wrapper</a></dt><dt>12.6. <a href="#ex-criteria-typedquery-tuple">Selecting a tuple</a></dt><dt>12.7. <a href="#d5e3518">Adding a root</a></dt><dt>12.8. <a href="#d5e3522">Adding multiple roots</a></dt><dt>12.9. <a href="#criteria-join-singular">Example with Embedded and ManyToOne</a></dt><dt>12.10. <a href="#criteria-join-plural">Example with Collections</a></dt><dt>12.11. <a href="#criteria-fetch-singular">Example with Embedded and ManyToOne</a></dt><dt>12.12. <a href="#criteria-fetch-plural">Example with Collections</a></dt><dt>12.13. <a href="#ex-querycriteria-param">Using parameters</a></dt><dt>13.1. <a href="#d5e3746">Named sql query using the &lt;sql-query&gt; maping
      element</a></dt><dt>13.2. <a href="#d5e3749">Execution of a named query</a></dt><dt>13.3. <a href="#d5e3755">Named sql query with association</a></dt><dt>13.4. <a href="#d5e3760">Named query returning a scalar</a></dt><dt>13.5. <a href="#d5e3766">&lt;resultset&gt; mapping used to externalize mapping
      information</a></dt><dt>13.6. <a href="#d5e3770">Programmatically specifying the result mapping information
      </a></dt><dt>13.7. <a href="#example-named-native-query-annotation-with-result-set-mapping">Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code></a></dt><dt>13.8. <a href="#example-implicit-result-set-mapping">Implicit result set mapping</a></dt><dt>13.9. <a href="#example-field-result-annotation-with-associations">Using dot notation in @FieldResult for specifying associations
      </a></dt><dt>13.10. <a href="#d5e3813">Scalar values via <code class="classname">@ColumnResult</code></a></dt><dt>13.11. <a href="#example-custom-crdu-via-annotations">Custom CRUD via annotations</a></dt><dt>13.12. <a href="#example-custom-crdu-via-xml">Custom CRUD XML</a></dt><dt>13.13. <a href="#example-overriding-sql-collections-annotations">Overriding SQL statements for collections using
      annotations</a></dt><dt>13.14. <a href="#d5e3912">Overriding SQL statements for secondary tables</a></dt><dt>13.15. <a href="#d5e3919">Stored procedures and their return value</a></dt><dt>15.1. <a href="#d5e4180">Example of storing username with revision</a></dt><dt>15.2. <a href="#d5e4213">Custom implementation of tracking entity classes modified during revisions</a></dt><dt>16.1. <a href="#specifying-tenant-ex">Specifying tenant identifier from <code class="interfacename">SessionFactory</code></a></dt><dt>16.2. <a href="#d5e4758">Implementing MultiTenantConnectionProvider using different connection pools</a></dt><dt>16.3. <a href="#d5e4762">Implementing MultiTenantConnectionProvider using single connection pool</a></dt><dt>17.1. <a href="#d5e4913">Example extension point registrations in blueprint.xml</a></dt></dl></div>
    


    <div class="preface" title="Preface"><div class="titlepage"><div><div><h2 class="title"><a id="d5e23"/>Preface</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e38">1. Get Involved</a></span></dt><dt><span class="section"><a href="#d5e54">2. Getting Started Guide</a></span></dt></dl></div>

    
    <p>
        Working with both Object-Oriented software and Relational Databases can be cumbersome and time consuming.
        Development costs are significantly higher due to a paradigm mismatch between how data is represented in
        objects versus relational databases.  Hibernate is an Object/Relational Mapping solution for Java environments.
        The term Object/Relational Mapping refers to the technique of mapping data from an object model representation
        to a relational data model representation (and visa versa).  See
        <a class="ulink" href="http://en.wikipedia.org/wiki/Object-relational_mapping">http://en.wikipedia.org/wiki/Object-relational_mapping</a> for a good high-level discussion.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            While having a strong background in SQL is not required to use Hibernate, having a basic understanding of
            the concepts can greatly help you understand Hibernate more fully and quickly.  Probably the single
            best background is an understanding of data modeling principles.  You might want to consider these resources
            as a good starting point:
            </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <a class="ulink" href="http://www.agiledata.org/essays/dataModeling101.html">http://www.agiledata.org/essays/dataModeling101.html</a>
                    </p>
                </li><li class="listitem">
                    <p>
                        <a class="ulink" href="http://en.wikipedia.org/wiki/Data_modeling">http://en.wikipedia.org/wiki/Data_modeling</a>
                    </p>
                </li></ul></div><p>
        </p>
    </div>

    <p>
        Hibernate not only takes care of the mapping from Java classes to database tables (and from Java data types to
        SQL data types), but also provides data query and retrieval facilities. It can significantly reduce
        development time otherwise spent with manual data handling in SQL and JDBC.  Hibernate’s design goal is to
        relieve the developer from 95% of common data persistence-related programming tasks by eliminating the need for
        manual, hand-crafted data processing using SQL and JDBC.  However, unlike many other persistence solutions,
        Hibernate does not hide the power of SQL from you and guarantees that your investment in relational technology
        and knowledge is as valid as always.
    </p>

    <p>
        Hibernate may not be the best solution for data-centric applications that only use stored-procedures to
        implement the business logic in the database, it is most useful with object-oriented domain models and business
        logic in the Java-based middle-tier. However, Hibernate can certainly help you to remove or encapsulate
        vendor-specific SQL code and will help with the common task of result set translation from a tabular
        representation to a graph of objects.
    </p>

    <div class="section" title="1. Get Involved"><div class="titlepage"><div><div><h2 class="title"><a id="d5e38"/>1. Get Involved</h2></div></div></div>
        
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    Use Hibernate and report any bugs or issues you find. See
                    <a class="ulink" href="http://hibernate.org/issuetracker.html">http://hibernate.org/issuetracker.html</a> for details.
                </p>
            </li><li class="listitem">
                <p>
                    Try your hand at fixing some bugs or implementing enhancements. Again, see
                    <a class="ulink" href="http://hibernate.org/issuetracker.html">http://hibernate.org/issuetracker.html</a>.
                </p>
            </li><li class="listitem">
                <p>
                    Engage with the community using mailing lists, forums, IRC, or other ways listed at
                    <a class="ulink" href="http://hibernate.org/community.html">http://hibernate.org/community.html</a>.
                </p>
            </li><li class="listitem">
                <p>
                    Help improve or translate this documentation. Contact us on
                    the developer mailing list if you have interest.
                </p>
            </li><li class="listitem">
                <p>
                    Spread the word. Let the rest of your organization know about the benefits of
                    Hibernate.
                </p>
            </li></ul></div>
    </div>

    <div class="section" title="2. Getting Started Guide"><div class="titlepage"><div><div><h2 class="title"><a id="d5e54"/>2. Getting Started Guide</h2></div></div></div>
        
        <p>
            New users may want to first look through the
            <em class="citetitle">Hibernate Getting Started Guide</em> for basic information as well as
            tutorials.  Even seasoned veterans may want to considering perusing the sections pertaining to
            build artifacts for any changes.
        </p>
    </div>

</div>
    <div class="chapter" title="Chapter 1. Database access"><div class="titlepage"><div><div><h2 class="title"><a id="d5e58"/>Chapter 1. Database access</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e60">1.1. Connecting</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e83">1.1.1. Configuration</a></span></dt><dt><span class="section"><a href="#d5e127">1.1.2. Obtaining a JDBC connection</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e150">1.2. Connection pooling</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e154">1.2.1. c3p0 connection pool</a></span></dt><dt><span class="section"><a href="#d5e170">1.2.2. Proxool connection pool</a></span></dt><dt><span class="section"><a href="#d5e199">1.2.3. Obtaining connections from an application server, using JNDI</a></span></dt><dt><span class="section"><a href="#d5e216">1.2.4. Other connection-specific configuration</a></span></dt><dt><span class="section"><a href="#d5e224">1.2.5. Optional configuration properties</a></span></dt></dl></dd><dt><span class="section"><a href="#configuring-dialects">1.3. Dialects</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e321">1.3.1. Specifying the Dialect to use</a></span></dt><dt><span class="section"><a href="#d5e326">1.3.2. Dialect resolution</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e339">1.4. Automatic schema generation with SchemaExport</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e347">1.4.1. Customizing the mapping files</a></span></dt><dt><span class="section"><a href="#d5e470">1.4.2. Running the SchemaExport tool</a></span></dt></dl></dd></dl></div>

    

    <div class="section" title="1.1. Connecting"><div class="titlepage"><div><div><h2 class="title"><a id="d5e60"/>1.1. Connecting</h2></div></div></div>
        
        <p>
            Hibernate connects to databases on behalf of your application. It can connect through a variety of mechanisms,
            including:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Stand-alone built-in connection pool</p></li><li class="listitem"><p><code class="classname">javax.sql.DataSource</code></p></li><li class="listitem"><p>Connection pools, including support for two different third-party opensource JDBC connection pools:</p>
                <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>c3p0</p></li><li class="listitem"><p>proxool</p></li></ul></div>
            </li><li class="listitem">
                <p>Application-supplied JDBC connections.  This is not a recommended approach and exists for legacy reasons</p>
            </li></ul></div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>The built-in connection pool is not intended for production environments.</p>
        </div>

        <p>
            Hibernate obtains JDBC connections as needed though the
            <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code> interface
            which is a service contract.  Applications may also supply their own
            <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code> implementation
            to define a custom approach for supplying connections to Hibernate (from a different connection pool
            implementation, for example).
        </p>

        

        <div class="section" title="1.1.1. Configuration"><div class="titlepage"><div><div><h3 class="title"><a id="d5e83"/>1.1.1. Configuration</h3></div></div></div>
            
            <p>
                You can configure database connections using a properties file, an XML deployment descriptor or
                programmatically.
              </p>
                <div class="example"><a id="d5e86"/><p class="title"><strong>Example 1.1. <code class="filename">hibernate.properties</code> for a c3p0 connection pool</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">hibernate.connection.driver_class = org.postgresql.Driver
hibernate.connection.url = jdbc:postgresql://localhost/mydatabase
hibernate.connection.username = myuser
hibernate.connection.password = secret
hibernate.c3p0.min_size=5
hibernate.c3p0.max_size=20
hibernate.c3p0.timeout=1800
hibernate.c3p0.max_statements=50
hibernate.dialect = org.hibernate.dialect.PostgreSQL82Dialect</pre>
                </div></div><br class="example-break"/>
                <div class="example"><a id="d5e90"/><p class="title"><strong>Example 1.2. <code class="filename">hibernate.cfg.xml</code> for a connection to the bundled HSQL database</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version='1.0'&nbsp;encoding='utf-8'?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">hibernate-configuration</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.hibernate.org/xsd/hibernate-configuration&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.hibernate.org/xsd/hibernate-configuration&nbsp;hibernate-configuration-4.0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">session-factory</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Database&nbsp;connection&nbsp;settings&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;connection.driver_class&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hsqldb.jdbcDriver</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;connection.url&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">jdbc:hsqldb:hsql://localhost</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;connection.username&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">sa</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;connection.password&quot;</span><span class="xml_tag_symbols">&gt;&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;JDBC&nbsp;connection&nbsp;pool&nbsp;(use&nbsp;the&nbsp;built-in)&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;connection.pool_size&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">1</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;SQL&nbsp;dialect&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;dialect&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.dialect.HSQLDialect</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Enable&nbsp;Hibernate's&nbsp;automatic&nbsp;session&nbsp;context&nbsp;management&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;current_session_context_class&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">thread</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Disable&nbsp;the&nbsp;second-level&nbsp;cache&nbsp;&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;cache.provider_class&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.cache.internal.NoCacheProvider</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Echo&nbsp;all&nbsp;executed&nbsp;SQL&nbsp;to&nbsp;stdout&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;show_sql&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">true</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;Drop&nbsp;and&nbsp;re-create&nbsp;the&nbsp;database&nbsp;schema&nbsp;on&nbsp;startup&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hbm2ddl.auto&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">update</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">mapping</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">resource</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org/hibernate/tutorial/domain/Event.hbm.xml&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">session-factory</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">hibernate-configuration</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
                </div></div><br class="example-break"/>

      <div class="section" title="1.1.1.1. Programatic configuration"><div class="titlepage"><div><div><h4 class="title"><a id="d5e94"/>1.1.1.1. Programatic configuration</h4></div></div></div>
        
        <p>
          An instance of object <code class="classname">org.hibernate.cfg.Configuration</code> represents an entire set of
          mappings of an application's Java types to an SQL database. The
          <code class="classname">org.hibernate.cfg.Configuration</code> builds an immutable
          <code class="classname">org.hibernate.SessionFactory</code>, and compiles the mappings from various XML mapping
          files. You can specify the mapping files directly, or Hibernate can find them for you.
        </p>
        <div class="example"><a id="d5e100"/><p class="title"><strong>Example 1.3. Specifying the mapping files directly</strong></p><div class="example-contents">
          
          <p>
            You can obtain a <code class="classname">org.hibernate.cfg.Configuration</code> instance by instantiating it
            directly and specifying XML mapping documents. If the mapping files are in the classpath, use method
            <code class="methodname">addResource()</code>.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_plain">&nbsp;cfg&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addResource</span><span class="java_separator">(</span><span class="java_literal">&quot;Item.hbm.xml&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addResource</span><span class="java_separator">(</span><span class="java_literal">&quot;Bid.hbm.xml&quot;</span><span class="java_separator">);</span></pre>
        </div></div><br class="example-break"/>
        <div class="example"><a id="d5e106"/><p class="title"><strong>Example 1.4. Letting Hibernate find the mapping files for you</strong></p><div class="example-contents">
          
          <p>
            The <code class="methodname">addClass()</code> method directs Hibernate to search the CLASSPATH for the mapping
            files, eliminating hard-coded file names. In the following example, it searches for
            <code class="filename">org/hibernate/auction/Item.hbm.xml</code> and
            <code class="filename">org/hibernate/auction/Bid.hbm.xml</code>.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_plain">&nbsp;cfg&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addClass</span><span class="java_separator">(</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">auction</span><span class="java_separator">.</span><span class="java_type">Item</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addClass</span><span class="java_separator">(</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">auction</span><span class="java_separator">.</span><span class="java_type">Bid</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span></pre>
        </div></div><br class="example-break"/>
        <div class="example"><a id="d5e113"/><p class="title"><strong>Example 1.5. Specifying configuration properties</strong></p><div class="example-contents">
          
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_plain">&nbsp;cfg&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addClass</span><span class="java_separator">(</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">auction</span><span class="java_separator">.</span><span class="java_type">Item</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addClass</span><span class="java_separator">(</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">auction</span><span class="java_separator">.</span><span class="java_type">Bid</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;hibernate.dialect&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;org.hibernate.dialect.MySQLInnoDBDialect&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;hibernate.connection.datasource&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;java:comp/env/jdbc/test&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;hibernate.order_updates&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;true&quot;</span><span class="java_separator">);</span></pre>
        </div></div><br class="example-break"/>
        <div class="itemizedlist" title="Other ways to configure Hibernate programmatically"><p class="title"><strong>Other ways to configure Hibernate programmatically</strong></p><ul class="itemizedlist"><li class="listitem">
            <p>
              Pass an instance of <code class="classname">java.util.Properties</code> to
              <code class="classname">Configuration.setProperties()</code>.
            </p>
          </li><li class="listitem">
            <p>
              Set System properties using <span class="command"><strong>java
              -D<em class="replaceable"><code>property</code></em>=<em class="replaceable"><code>value</code></em></strong></span>
            </p>
          </li></ul></div>
      </div>
    </div>
    
    <div class="section" title="1.1.2. Obtaining a JDBC connection"><div class="titlepage"><div><div><h3 class="title"><a id="d5e127"/>1.1.2. Obtaining a JDBC connection</h3></div></div></div>
        
        <p>
            After you configure the <a class="xref" href="#hibernate-jdbc-properties" title="Most important Hibernate JDBC properties">Most important Hibernate JDBC properties</a>, you can use method
            <code class="methodname">openSession</code> of class <code class="classname">org.hibernate.SessionFactory</code> to open
            sessions.  Sessions will obtain JDBC connections as needed based on the provided configuration.
        </p>
        <div class="example"><a id="d5e133"/><p class="title"><strong>Example 1.6. Specifying configuration properties</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessions</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span></pre>
        </div></div><br class="example-break"/>
        <div class="itemizedlist" title="Most important Hibernate JDBC properties"><a id="hibernate-jdbc-properties"/><p class="title"><strong>Most important Hibernate JDBC properties</strong></p><ul class="itemizedlist"><li class="listitem"><p>hibernate.connection.driver_class</p></li><li class="listitem"><p>hibernate.connection.url</p></li><li class="listitem"><p>hibernate.connection.username</p></li><li class="listitem"><p>hibernate.connection.password</p></li><li class="listitem"><p>hibernate.connection.pool_size</p></li></ul></div>
        <p>
            All available Hibernate settings are defined as constants and discussed on the
            <code class="interfacename">org.hibernate.cfg.AvailableSettings</code> interface.  See its source code or
            JavaDoc for details.
        </p>
    </div>
  </div>
  
  <div class="section" title="1.2. Connection pooling"><div class="titlepage"><div><div><h2 class="title"><a id="d5e150"/>1.2. Connection pooling</h2></div></div></div>
    
    <p>
      Hibernate's internal connection pooling algorithm is rudimentary, and is provided for development and testing
      purposes. Use a third-party pool for best performance and stability. To use a third-party pool, replace the
      <span class="property">hibernate.connection.pool_size property</span> with settings specific to your connection pool of
      choice. This disables Hibernate's internal connection pool.
    </p>
    
    <div class="section" title="1.2.1. c3p0 connection pool"><div class="titlepage"><div><div><h3 class="title"><a id="d5e154"/>1.2.1. c3p0 connection pool</h3></div></div></div>
      
      <p>
        C3P0 is an open source JDBC connection pool distributed along with Hibernate in the <code class="filename">lib/</code>
        directory. Hibernate uses its <code class="classname">org.hibernate.service.jdbc.connections.internal.C3P0ConnectionProvider</code> for
        connection pooling if you set the <span class="property">hibernate.c3p0.*</span> properties.  properties.
      </p>
      <div class="itemizedlist" title="Important configuration properties for the c3p0 connection pool"><p class="title"><strong>Important configuration properties for the c3p0 connection pool</strong></p><ul class="itemizedlist"><li class="listitem"><p>hibernate.c3p0.min_size</p></li><li class="listitem"><p>hibernate.c3p0.max_size</p></li><li class="listitem"><p>hibernate.c3p0.timeout</p></li><li class="listitem"><p>hibernate.c3p0.max_statements</p></li></ul></div>
    </div>
    
    <div class="section" title="1.2.2. Proxool connection pool"><div class="titlepage"><div><div><h3 class="title"><a id="d5e170"/>1.2.2. Proxool connection pool</h3></div></div></div>
      
      <p>
        Proxool is another open source JDBC connection pool distributed along with Hibernate in the
        <code class="filename">lib/</code> directory. Hibernate uses its
        <code class="classname">org.hibernate.service.jdbc.connections.internal.ProxoolConnectionProvider</code> for connection pooling if you set the
        <span class="property">hibernate.proxool.*</span> properties. Unlike c3p0, proxool requires some additional configuration
        parameters, as described by the Proxool documentation available at <a class="ulink" href="http://proxool.sourceforge.net/configure.html">http://proxool.sourceforge.net/configure.html</a>.
      </p>
      <div class="table"><a id="d5e177"/><p class="title"><strong>Table 1.1. Important configuration properties for the Proxool connection pool</strong></p><div class="table-contents">
        
        <table summary="Important configuration properties for the Proxool connection pool" border="1"><colgroup><col width="120px"/><col width="320px"/></colgroup><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td>hibernate.proxool.xml</td><td>Configure Proxool provider using an XML file (.xml is appended automatically)</td></tr><tr><td>hibernate.proxool.properties</td><td>Configure the Proxool provider using a properties file (.properties is appended
              automatically)</td></tr><tr><td>hibernate.proxool.existing_pool</td><td>Whether to configure the Proxool provider from an existing pool</td></tr><tr><td>hibernate.proxool.pool_alias</td><td>Proxool pool alias to use. Required.</td></tr></tbody></table>
      </div></div><br class="table-break"/>
    </div>

    
    <div class="section" title="1.2.3. Obtaining connections from an application server, using JNDI"><div class="titlepage"><div><div><h3 class="title"><a id="d5e199"/>1.2.3. Obtaining connections from an application server, using JNDI</h3></div></div></div>
      
      <p>
        To use Hibernate inside an application server, configure Hibernate to obtain connections from an application
        server <code class="classname">javax.sql.Datasource</code> registered in JNDI, by setting at least one of the following
        properties:
      </p>
      <div class="itemizedlist" title="Important Hibernate properties for JNDI datasources"><p class="title"><strong>Important Hibernate properties for JNDI datasources</strong></p><ul class="itemizedlist"><li class="listitem"><p>hibernate.connection.datasource (required)</p></li><li class="listitem"><p>hibernate.jndi.url</p></li><li class="listitem"><p>hibernate.jndi.class</p></li><li class="listitem"><p>hibernate.connection.username</p></li><li class="listitem"><p>hibernate.connection.password</p></li></ul></div>
      <p>
        JDBC connections obtained from a JNDI datasource automatically participate in the container-managed transactions
        of the application server.
      </p>
    </div>
    
    <div class="section" title="1.2.4. Other connection-specific configuration"><div class="titlepage"><div><div><h3 class="title"><a id="d5e216"/>1.2.4. Other connection-specific configuration</h3></div></div></div>
      
      <p>
        You can pass arbitrary connection properties by prepending <code class="literal">hibernate.connection</code> to the
        connection property name. For example, specify a charSet connection property as
        <span class="property">hibernate.connection.charSet</span>.
      </p>
      <p>
        You can define your own plugin strategy for obtaining JDBC connections by implementing the interface
        <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code> and specifying your custom
        implementation with the <span class="property">hibernate.connection.provider_class</span> property.
      </p>
    </div>
    
    <div class="section" title="1.2.5. Optional configuration properties"><div class="titlepage"><div><div><h3 class="title"><a id="d5e224"/>1.2.5. Optional configuration properties</h3></div></div></div>
      
      <p>
        In addition to the properties mentioned in the previous sections, Hibernate includes many other optional
        properties. See <a class="xref" href="#">???</a> for a more complete list.
      </p>
    </div>
  </div>
  
  <div class="section" title="1.3. Dialects"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-dialects"/>1.3. Dialects</h2></div></div></div>
    
    <p>
        Although SQL is relatively standardized, each database vendor uses a subset of supported syntax. This is referred
        to as a <em class="firstterm">dialect</em>.  Hibernate handles variations across these dialects through its
        <code class="classname">org.hibernate.dialect.Dialect</code> class and the various subclasses for each vendor dialect.
    </p>

    <div class="table"><a id="d5e233"/><p class="title"><strong>Table 1.2. Supported database dialects</strong></p><div class="table-contents">
      
      <table summary="Supported database dialects" border="1"><colgroup><col width="120px"/><col width="320px"/></colgroup><thead><tr><th>Database</th><th>Dialect</th></tr></thead><tbody><tr><td>DB2</td><td>org.hibernate.dialect.DB2Dialect</td></tr><tr><td>DB2 AS/400</td><td>org.hibernate.dialect.DB2400Dialect</td></tr><tr><td>DB2 OS390</td><td>org.hibernate.dialect.DB2390Dialect</td></tr><tr><td>Firebird</td><td>org.hibernate.dialect.FirebirdDialect</td></tr><tr><td>FrontBase</td><td>org.hibernate.dialect.FrontbaseDialect</td></tr><tr><td>HypersonicSQL</td><td>org.hibernate.dialect.HSQLDialect</td></tr><tr><td>Informix</td><td>org.hibernate.dialect.InformixDialect</td></tr><tr><td>Interbase</td><td>org.hibernate.dialect.InterbaseDialect</td></tr><tr><td>Ingres</td><td>org.hibernate.dialect.IngresDialect</td></tr><tr><td>Microsoft SQL Server 2005</td><td>org.hibernate.dialect.SQLServer2005Dialect</td></tr><tr><td>Microsoft SQL Server 2008</td><td>org.hibernate.dialect.SQLServer2008Dialect</td></tr><tr><td>Mckoi SQL</td><td>org.hibernate.dialect.MckoiDialect</td></tr><tr><td>MySQL</td><td>org.hibernate.dialect.MySQLDialect</td></tr><tr><td>MySQL with InnoDB</td><td>org.hibernate.dialect.MySQL5InnoDBDialect</td></tr><tr><td>MySQL with MyISAM</td><td>org.hibernate.dialect.MySQLMyISAMDialect</td></tr><tr><td>Oracle 8i</td><td>org.hibernate.dialect.Oracle8iDialect</td></tr><tr><td>Oracle 9i</td><td>org.hibernate.dialect.Oracle9iDialect</td></tr><tr><td>Oracle 10g</td><td>org.hibernate.dialect.Oracle10gDialect</td></tr><tr><td>Pointbase</td><td>org.hibernate.dialect.PointbaseDialect</td></tr><tr><td>PostgreSQL 8.1</td><td>org.hibernate.dialect.PostgreSQL81Dialect</td></tr><tr><td>PostgreSQL 8.2 and later</td><td>org.hibernate.dialect.PostgreSQL82Dialect</td></tr><tr><td>Progress</td><td>org.hibernate.dialect.ProgressDialect</td></tr><tr><td>SAP DB</td><td>org.hibernate.dialect.SAPDBDialect</td></tr><tr><td>Sybase ASE 15.5</td><td>org.hibernate.dialect.SybaseASE15Dialect</td></tr><tr><td>Sybase ASE 15.7</td><td>org.hibernate.dialect.SybaseASE157Dialect</td></tr><tr><td>Sybase Anywhere</td><td>org.hibernate.dialect.SybaseAnywhereDialect</td></tr></tbody></table>
    </div></div><br class="table-break"/>

      <div class="section" title="1.3.1. Specifying the Dialect to use"><div class="titlepage"><div><div><h3 class="title"><a id="d5e321"/>1.3.1. Specifying the Dialect to use</h3></div></div></div>
          
          <p>
              The developer may manually specify the Dialect to use by setting the
              <span class="property">hibernate.dialect</span> configuration property to the name of a specific
              <code class="classname">org.hibernate.dialect.Dialect</code> class to use.
          </p>
      </div>

      <div class="section" title="1.3.2. Dialect resolution"><div class="titlepage"><div><div><h3 class="title"><a id="d5e326"/>1.3.2. Dialect resolution</h3></div></div></div>
          
          <p>
              Assuming a <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code> has been
              set up, Hibernate will attempt to automatically determine the Dialect to use based on the
              <code class="interfacename">java.sql.DatabaseMetaData</code> reported by a
              <code class="interfacename">java.sql.Connection</code> obtained from that
              <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code>.
          </p>
          <p>
                This functionality is provided by a series of
                <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code> instances registered
                with Hibernate internally.  Hibernate comes with a standard set of recognitions.  If your application
                requires extra Dialect resolution capabilities, it would simply register a custom implementation
                of <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code> as follows:
          </p>
          
            <p>
                Registered <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code> are
                <span class="emphasis"><em>prepended</em></span> to an internal list of resolvers, so they take precedence
                before any already registered resolvers including the standard one.
            </p>
      </div>
  </div>

  <div class="section" title="1.4. Automatic schema generation with SchemaExport"><div class="titlepage"><div><div><h2 class="title"><a id="d5e339"/>1.4. Automatic schema generation with SchemaExport</h2></div></div></div>
    
    <p>
      SchemaExport is a Hibernate utility which generates DDL from your mapping files. The generated schema includes
      referential integrity constraints, primary and foreign keys, for entity and collection tables. It also creates
      tables and sequences for mapped identifier generators.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        You must specify a SQL Dialect via the <span class="property">hibernate.dialect</span> property when using this tool,
        because DDL is highly vendor-specific. See <a class="xref" href="#configuring-dialects" title="1.3. Dialects">Section 1.3, “Dialects”</a> for information.
      </p>
    </div>
    <p>
      Before Hibernate can generate your schema, you must customize your mapping files.
    </p>
    
    <div class="section" title="1.4.1. Customizing the mapping files"><div class="titlepage"><div><div><h3 class="title"><a id="d5e347"/>1.4.1. Customizing the mapping files</h3></div></div></div>
      
      <p>
        Hibernate provides several elements and attributes to customize your mapping files. They are listed in <a class="xref" href="#tab-customizing-schema" title="Table 1.3. Elements and attributes provided for customizing mapping files">Table 1.3, “Elements and attributes provided for customizing mapping files”</a>, and a logical order of customization is presented in <a class="xref" href="#proc-customizing-schema" title="Procedure 1.1. Customizing the schema">Procedure 1.1, “Customizing the schema”</a>.
      </p>
      <div class="table"><a id="tab-customizing-schema"/><p class="title"><strong>Table 1.3. Elements and attributes provided for customizing mapping files</strong></p><div class="table-contents">
        
        <table summary="Elements and attributes provided for customizing mapping files" border="1"><colgroup><col width="80px"/><col width="80px"/><col width="280px"/></colgroup><thead><tr><th>Name</th><th>Type of value</th><th>Description</th></tr></thead><tbody><tr><td>length</td><td>number</td><td>Column length</td></tr><tr><td>precision</td><td>number</td><td>Decimal precision of column</td></tr><tr><td>scale</td><td>number</td><td>Decimal scale of column</td></tr><tr><td>not-null</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Whether a column is allowed to hold null values</td></tr><tr><td>unique</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Whether values in the column must be unique</td></tr><tr><td>index</td><td>string</td><td>The name of a multi-column index</td></tr><tr><td>unique-key</td><td>string</td><td>The name of a multi-column unique constraint</td></tr><tr><td>foreign-key</td><td>string</td><td>The name of the foreign key constraint generated for an association. This applies to
              &lt;one-to-one&gt;, &lt;many-to-one&gt;, &lt;key&gt;, and &lt;many-to-many&gt; mapping
              elements. <code class="literal">inverse="true"</code> sides are skipped by SchemaExport.</td></tr><tr><td>sql-type</td><td>string</td><td>Overrides the default column type. This applies to the &lt;column&gt; element only.</td></tr><tr><td>default</td><td>string</td><td>Default value for the column</td></tr><tr><td>check</td><td>string</td><td>An SQL check constraint on either a column or atable</td></tr></tbody></table>
      </div></div><br class="table-break"/>
      <div class="procedure" title="Procedure 1.1. Customizing the schema"><a id="proc-customizing-schema"/><p class="title"><strong>Procedure 1.1. Customizing the schema</strong></p><ol class="procedure" type="1"><li class="step" title="Set the length, precision, and scale of mapping elements.">
          <p class="title"><strong>Set the length, precision, and scale of mapping elements.</strong></p>
          <p>
            Many Hibernate mapping elements define optional attributes named <code class="option">length</code>,
            <code class="option">precision</code>, and <code class="option">scale</code>.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;zip&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">length</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;5&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;balance&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">precision</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;12&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">scale</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set the not-null, UNIQUE, unique-key attributes.">
          <p class="title"><strong>Set the <code class="option">not-null</code>, <code class="option">UNIQUE</code>, <code class="option">unique-key</code> attributes.</strong></p>
          <p>
            The <code class="option">not-null</code> and <code class="option">UNIQUE</code> attributes generate constraints on table columns.
          </p>
          <p>
            The unique-key attribute groups columns in a single, unique key constraint. The attribute overrides
            the name of any generated unique key constraint.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">many-to-one</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;barId&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">not-null</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">element</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;serialNumber&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;long&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">not-null</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">unique</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">many-to-one</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;orgId&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">unique-key</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;OrgEmployeeId&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;employeeId&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">unique-key</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;OrgEmployee&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set the index and foreign-key attributes.">
          <p class="title"><strong>Set the <code class="option">index</code> and <code class="option">foreign-key</code> attributes.</strong></p>
          <p>
            The <code class="option">index</code> attribute specifies the name of an index for Hibernate to create using the mapped
            column or columns. You can group multiple columns into the same index by assigning them the same index name.
          </p>
          <p>
            A foreign-key attribute overrides the name of any generated foreign key constraint.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">many-to-one</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;barId&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">foreign-key</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;FKFooBar&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set child &lt;column&gt; elements.">
          <p class="title"><strong>Set child <code class="option">&lt;column&gt;</code> elements.</strong></p>
          <p>
            Many mapping elements accept one or more child &lt;column&gt; elements. This is particularly useful for
            mapping types involving multiple columns.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;name&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;my.customtypes.Name&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;last&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">not-null</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">index</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar_idx&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">length</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;30&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;first&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">not-null</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">index</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar_idx&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">length</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;20&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;initial&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set the default attribute.">
          <p class="title"><strong>Set the <code class="option">default</code> attribute.</strong></p>
          <p>
            The <code class="option">default</code> attribute represents a default value for a column. Assign the same value to the
            mapped property before saving a new instance of the mapped class.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;credits&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;integer&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">insert</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;credits&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">default</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;10&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;version&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;integer&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">insert</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;version&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">default</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;0&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set the sql-type attribure.">
          <p class="title"><strong>Set the <code class="option">sql-type</code> attribure.</strong></p>
          <p>
            Use the <code class="option">sql-type</code> attribute to override the default mapping of a Hibernate type to SQL
            datatype.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;balance&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;float&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;balance&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">sql-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;decimal(13,3)&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Set the check attribute.">
          <p class="title"><strong>Set the <code class="option">check</code> attribute.</strong></p>
          <p>
            use the <code class="option">check</code> attribute to specify a <em class="wordasword">check</em> constraint.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;integer&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">column</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">check</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foo&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">&nbsp;10</span><span class="xml_attribute_value">&quot;/</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&lt;/</span><span class="xml_attribute_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Foo&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">table</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;foos&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">check</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_plain">&nbsp;100.0</span><span class="xml_attribute_value">&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;&lt;</span><span class="xml_attribute_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;bar&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;float&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li><li class="step" title="Add &lt;comment&gt; elements to your schema.">
          <p class="title"><strong>Add &lt;comment&gt; elements to your schema.</strong></p>
          <p>
            Use the &lt;comment&gt; element to specify comments for the generated schema.
          </p>
          <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;Customer&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">table</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;CurCust&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">comment</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">Current&nbsp;customers&nbsp;only</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">comment</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre>
        </li></ol></div>
    </div>

    <div class="section" title="1.4.2. Running the SchemaExport tool"><div class="titlepage"><div><div><h3 class="title"><a id="d5e470"/>1.4.2. Running the SchemaExport tool</h3></div></div></div>
      
      <p>
        The SchemaExport tool writes a DDL script to standard output, executes the DDL statements, or both.
      </p>
      <div class="example"><a id="d5e473"/><p class="title"><strong>Example 1.7. SchemaExport syntax</strong></p><div class="example-contents">
        
        <pre class="screen">
          java -cp hibernate_classpaths org.hibernate.tool.hbm2ddl.SchemaExport <em class="replaceable"><code>options</code></em> <em class="replaceable"><code>mapping_files</code></em> 
        </pre>
      </div></div><br class="example-break"/>
      <div class="table"><a id="d5e478"/><p class="title"><strong>Table 1.4. SchemaExport Options</strong></p><div class="table-contents">
        
        <table summary="SchemaExport Options" border="1"><colgroup><col width="120px"/><col width="320px"/></colgroup><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td>--quiet</td><td>do not output the script to standard output</td></tr><tr><td>--drop</td><td>only drop the tables</td></tr><tr><td>--create</td><td>only create the tables</td></tr><tr><td>--text</td><td>do not export to the database</td></tr><tr><td><p>--output=<em class="replaceable"><code>my_schema.ddl</code></em></p></td><td>output the ddl script to a file</td></tr><tr><td><p>--naming=<em class="replaceable"><code>eg.MyNamingStrategy</code></em></p></td><td>select a NamingStrategy</td></tr><tr><td><p>--config=<em class="replaceable"><code>hibernate.cfg.xml</code></em></p></td><td>read Hibernate configuration from an XML file</td></tr><tr><td><p>--properties=<em class="replaceable"><code>hibernate.properties</code></em></p></td><td>read database properties from a file</td></tr><tr><td>--format</td><td>format the generated SQL nicely in the script</td></tr><tr><td><p>--delimiter=<em class="replaceable"><code>;</code></em></p></td><td>set an end-of-line delimiter for the script</td></tr></tbody></table>
      </div></div><br class="table-break"/>
      <div class="example"><a id="d5e528"/><p class="title"><strong>Example 1.8. Embedding SchemaExport into your application</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Configuration</span><!-- <br/> --><span class="java_plain">&nbsp;cfg&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">....;</span>
<!--  --><br/><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SchemaExport</span><span class="java_separator">(</span><span class="java_plain">cfg</span><span class="java_separator">).</span><span class="java_plain">create</span><span class="java_separator">(</span><span class="java_literal">false</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">true</span><span class="java_separator">);</span></pre>
      </div></div><br class="example-break"/>
    </div>
  </div>
</div>
    <div class="chapter" title="Chapter 2. Transactions and concurrency control"><div class="titlepage"><div><div><h2 class="title"><a id="d5e531"/>Chapter 2. Transactions and concurrency control</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e533">2.1. Defining Transaction</a></span></dt><dt><span class="section"><a href="#d5e545">2.2. Physical Transactions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e565">2.2.1. Physical Transactions - JDBC</a></span></dt><dt><span class="section"><a href="#d5e571">2.2.2. Physical Transactions - JTA</a></span></dt><dt><span class="section"><a href="#d5e579">2.2.3. Physical Transactions - CMT</a></span></dt><dt><span class="section"><a href="#d5e590">2.2.4. Physical Transactions - Custom</a></span></dt><dt><span class="section"><a href="#d5e602">2.2.5. Physical Transactions - Legacy</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e618">2.3. Hibernate Transaction Usage</a></span></dt><dt><span class="section"><a href="#d5e626">2.4. Transactional patterns (and anti-patterns)</a></span></dt><dd><dl><dt><span class="section"><a href="#session-per-operation">2.4.1. Session-per-operation anti-pattern</a></span></dt><dt><span class="section"><a href="#session-per-request">2.4.2. Session-per-request pattern</a></span></dt><dt><span class="section"><a href="#long-conversations">2.4.3. Conversations</a></span></dt><dt><span class="section"><a href="#d5e719">2.4.4. Session-per-application</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e722">2.5. Object identity</a></span></dt><dt><span class="section"><a href="#transactions-basics-issues">2.6. Common issues</a></span></dt></dl></div>

    

    <div class="section" title="2.1. Defining Transaction"><div class="titlepage"><div><div><h2 class="title"><a id="d5e533"/>2.1. Defining Transaction</h2></div></div></div>
        
        <p>
            It is important to understand that the term transaction has many different yet related meanings in regards
            to persistence and Object/Relational Mapping.  In most use-cases these definitions align, but that is not
            always the case.
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    Might refer to the physical transaction with the database.
                </p>
            </li><li class="listitem">
                <p>
                    Might refer to the logical notion of a transaction as related to a persistence context.
                </p>
            </li><li class="listitem">
                <p>
                    Might refer to the application notion of a Unit-of-Work, as defined by the archetypal pattern.
                </p>
            </li></ul></div>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                This documentation largely treats the physical and logic notions of transaction as one-in-the-same.
            </p>
        </div>
    </div>

    <div class="section" title="2.2. Physical Transactions"><div class="titlepage"><div><div><h2 class="title"><a id="d5e545"/>2.2. Physical Transactions</h2></div></div></div>
        
        <p>
            Hibernate uses the JDBC API for persistence.  In the world of Java there are 2 well defined mechanism
            for dealing with transactions in JDBC: JDBC itself and JTA.  Hibernate supports both mechanisms for
            integrating with transactions and allowing applications to manage physical transactions.
        </p>
        <p>
            The first concept in understanding Hibernate transaction support is the
            <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code> interface which
            serves 2 main functions:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    It allows Hibernate to understand the transaction semantics of the environment.  Are we operating
                    in a JTA environment?  Is a physical transaction already currently active?  etc.
                </p>
            </li><li class="listitem">
                <p>
                    It acts as a factory for <code class="interfacename">org.hibernate.Transaction</code> instances which
                    are used to allow applications to manage and check the state of transactions.
                    <code class="interfacename">org.hibernate.Transaction</code> is Hibernate's notion of a logical
                    transaction.  JPA has a similar notion in the
                    <code class="interfacename">javax.persistence.EntityTransaction</code> interface.
                </p>
            </li></ul></div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                <code class="interfacename">javax.persistence.EntityTransaction</code> is only available when using
                resource-local transactions.  Hibernate allows access to
                <code class="interfacename">org.hibernate.Transaction</code> regardless of environment.
            </p>
        </div>

        <p>
            <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code> is a standard
            Hibernate service.  See <a class="xref" href="#services-TransactionFactory" title="7.5.16. org.hibernate.engine.transaction.spi.TransactionFactory">Section 7.5.16, “<code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code>”</a> for details.
        </p>

        <div class="section" title="2.2.1. Physical Transactions - JDBC"><div class="titlepage"><div><div><h3 class="title"><a id="d5e565"/>2.2.1. Physical Transactions - JDBC</h3></div></div></div>
            
            <p>
                JDBC-based transaction management leverages the JDBC defined methods
                <code class="methodname">java.sql.Connection.commit()</code> and
                <code class="methodname">java.sql.Connection.rollback()</code> (JDBC does not define an explicit
                method of beginning a transaction).  In Hibernate, this approach is represented by the
                <code class="classname">org.hibernate.engine.transaction.internal.jdbc.JdbcTransactionFactory</code> class.
            </p>
        </div>

        <div class="section" title="2.2.2. Physical Transactions - JTA"><div class="titlepage"><div><div><h3 class="title"><a id="d5e571"/>2.2.2. Physical Transactions - JTA</h3></div></div></div>
            
            <p>
                JTA-based transaction approach which leverages the
                <code class="interfacename">javax.transaction.UserTransaction</code> interface as obtained from
                <code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code> API.  This approach
                is represented by the
                <code class="classname">org.hibernate.engine.transaction.internal.jta.JtaTransactionFactory</code> class.
            </p>
            <p>
                See <a class="xref" href="#services-JtaPlatform" title="7.5.9. org.hibernate.service.jta.platform.spi.JtaPlatform">Section 7.5.9, “<code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code>”</a> for information on integration with the underlying JTA
                system.
            </p>
        </div>


        <div class="section" title="2.2.3. Physical Transactions - CMT"><div class="titlepage"><div><div><h3 class="title"><a id="d5e579"/>2.2.3. Physical Transactions - CMT</h3></div></div></div>
            
            <p>
                Another JTA-based transaction approach which leverages the JTA
                <code class="interfacename">javax.transaction.TransactionManager</code> interface as obtained from
                <code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code> API.  This approach
                is represented by the
                <code class="classname">org.hibernate.engine.transaction.internal.jta.CMTTransactionFactory</code> class.  In
                an actual JEE CMT environment, access to the
                <code class="interfacename">javax.transaction.UserTransaction</code> is restricted.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    The term CMT is potentially misleading here.  The important point simply being that the physical JTA
                    transactions are being managed by something other than the Hibernate transaction API.
                </p>
            </div>
            <p>
                See <a class="xref" href="#services-JtaPlatform" title="7.5.9. org.hibernate.service.jta.platform.spi.JtaPlatform">Section 7.5.9, “<code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code>”</a> for information on integration with the underlying JTA
                system.
            </p>
        </div>

        <div class="section" title="2.2.4. Physical Transactions - Custom"><div class="titlepage"><div><div><h3 class="title"><a id="d5e590"/>2.2.4. Physical Transactions - Custom</h3></div></div></div>
            
            <p>
                Its is also possible to plug in a custom transaction approach by implementing the
                <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code> contract.
                The default service initiator has built-in support for understanding custom transaction approaches
                via the <code class="literal">hibernate.transaction.factory_class</code> which can name either:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        The instance of <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code>
                        to use.
                    </p>
                </li><li class="listitem">
                    <p>
                        The name of a class implementing
                        <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code>
                        to use.  The expectation is that the implementation class have a no-argument constructor.
                    </p>
                </li></ul></div>
        </div>

        <div class="section" title="2.2.5. Physical Transactions - Legacy"><div class="titlepage"><div><div><h3 class="title"><a id="d5e602"/>2.2.5. Physical Transactions - Legacy</h3></div></div></div>
            
            <p>
                During development of 4.0, most of these classes named here were moved to new packages.  To help
                facilitate upgrading, Hibernate will also recognize the legacy names here for a short period of time.
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.transaction.JDBCTransactionFactory</code> is mapped to
                        <code class="classname">org.hibernate.engine.transaction.internal.jdbc.JdbcTransactionFactory</code>
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.transaction.JTATransactionFactory</code> is mapped to
                        <code class="classname">org.hibernate.engine.transaction.internal.jta.JtaTransactionFactory</code>
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">org.hibernate.transaction.CMTTransactionFactory</code> is mapped to
                        <code class="classname">org.hibernate.engine.transaction.internal.jta.CMTTransactionFactory</code>
                    </p>
                </li></ul></div>
        </div>

    </div>


    <div class="section" title="2.3. Hibernate Transaction Usage"><div class="titlepage"><div><div><h2 class="title"><a id="d5e618"/>2.3. Hibernate Transaction Usage</h2></div></div></div>
        
        <p>
            Hibernate uses JDBC connections and JTA resources directly, without adding any additional locking behavior.
            It is important for you to become familiar with the JDBC, ANSI SQL, and transaction isolation specifics
            of your database management system.
        </p>
        <p>
            Hibernate does not lock objects in memory.  The behavior defined by the isolation level of your database
            transactions does not change when you use Hibernate.  The Hibernate
            <code class="interfacename">org.hibernate.Session</code> acts as a transaction-scoped cache providing
            repeatable reads for lookup by identifier and queries that result in loading entities.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                To reduce lock contention in the database, the physical database transaction needs to be as short as
                possible.  Long database transactions prevent your application from scaling to a highly-concurrent load.
                Do not hold a database transaction open during end-user-level work, but open it after the end-user-level
                work is finished.  This is concept is referred to as <code class="literal">transactional write-behind</code>.
            </p>
        </div>
    </div>

    <div class="section" title="2.4. Transactional patterns (and anti-patterns)"><div class="titlepage"><div><div><h2 class="title"><a id="d5e626"/>2.4. Transactional patterns (and anti-patterns)</h2></div></div></div>
        

        <div class="section" title="2.4.1. Session-per-operation anti-pattern"><div class="titlepage"><div><div><h3 class="title"><a id="session-per-operation"/>2.4.1. Session-per-operation anti-pattern</h3></div></div></div>
            
            <p>
                This is an anti-pattern of opening and closing a <code class="classname">Session</code> for each database call
                in a single thread.  It is also an anti-pattern in terms of database transactions. Group your database
                calls into a planned sequence.  In the same way, do not auto-commit after every SQL statement in your
                application.  Hibernate disables, or expects the application server to disable, auto-commit mode
                immediately.  Database transactions are never optional.  All communication with a database must
                be encapsulated by a transaction.  Avoid auto-commit behavior for reading data, because many small
                transactions are unlikely to perform better than one clearly-defined unit of work, and are more
                difficult to maintain and extend.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Using auto-commit does not circumvent database transactions.  Instead, when in auto-commit mode,
                    JDBC drivers simply perform each call in an implicit transaction call.  It is as if your application
                    called commit after each and every JDBC call.
                </p>
            </div>
        </div>

        <div class="section" title="2.4.2. Session-per-request pattern"><div class="titlepage"><div><div><h3 class="title"><a id="session-per-request"/>2.4.2. Session-per-request pattern</h3></div></div></div>
            
            <p>
                This is the most common transaction pattern.  The term request here relates to the concept of a system
                that reacts to a series of requests from a client/user.  Web applications are a prime example of this
                type of system, though certainly not the only one.  At the beginning of handling such a request, the
                application opens a Hibernate <code class="interfacename">Session</code>, starts a transaction, performs
                all data related work, ends the transaction and closes the <code class="interfacename">Session</code>.
                The crux of the pattern is the one-to-one relationship between the transaction and the
                <code class="interfacename">Session</code>.
            </p>

            <p>
                Within this pattern there is a common technique of defining a <em class="firstterm">current session</em> to
                simplify the need of passing this <code class="interfacename">Session</code> around to all the application
                components that may need access to it.  Hibernate provides support for this technique through the
                <code class="methodname">getCurrentSession</code> method of the <code class="interfacename">SessionFactory</code>.
                The concept of a "current" session has to have a scope that defines the bounds in which the notion
                of "current" is valid.   This is purpose of the
                <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.  There are 2
                reliable defining scopes:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        First is a JTA transaction because it allows a callback hook to know when it is ending which
                        gives Hibernate a chance to close the <code class="interfacename">Session</code> and clean up.
                        This is represented by the
                        <code class="classname">org.hibernate.context.internal.JTASessionContext</code> implementation of
                        the <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.
                        Using this implementation, a <code class="interfacename">Session</code> will be opened the first
                        time <code class="methodname">getCurrentSession</code> is called within that transaction.
                    </p>
                </li><li class="listitem">
                    <p>
                        Secondly is this application request cycle itself.  This is best represented with the
                        <code class="classname">org.hibernate.context.internal.ManagedSessionContext</code> implementation of
                        the <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> contract.
                        Here an external component is responsible for managing the lifecycle and scoping of a "current"
                        session.  At the start of such a scope, <code class="classname">ManagedSessionContext</code>'s
                        <code class="methodname">bind</code> method is called passing in the
                        <code class="interfacename">Session</code>.  At the end, its <code class="methodname">unbind</code>
                        method is called.
                    </p>
                    <p>
                        Some common examples of such "external components" include:
                    </p>
                    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                            <p>
                                <code class="interfacename">javax.servlet.Filter</code> implementation
                            </p>
                        </li><li class="listitem">
                            <p>
                                AOP interceptor with a pointcut on the service methods
                            </p>
                        </li><li class="listitem">
                            <p>
                                A proxy/interception container
                            </p>
                        </li></ul></div>
                </li></ul></div>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    The <code class="methodname">getCurrentSession()</code> method has one downside in a JTA environment.  If
                    you use it, after_statement connection release mode is also used by default.  Due to a limitation of
                    the JTA specification, Hibernate cannot automatically clean up any unclosed
                    <code class="interfacename">ScrollableResults</code> or <code class="interfacename">Iterator</code>
                    instances returned by <code class="methodname">scroll()</code> or <code class="methodname">iterate()</code>.
                    Release the underlying database cursor by calling <code class="methodname">ScrollableResults.close()</code>
                    or <code class="methodname">Hibernate.close(Iterator)</code> explicitly from a
                    <code class="systemitem">finally</code> block.
                </p>
            </div>
        </div>

        <div class="section" title="2.4.3. Conversations"><div class="titlepage"><div><div><h3 class="title"><a id="long-conversations"/>2.4.3. Conversations</h3></div></div></div>
            
            <p>
                The <span>session-per-request</span> pattern is not the only valid way of designing units of work.
                Many business processes require a whole series of interactions with the user that are interleaved with
                database accesses. In web and enterprise applications, it is not acceptable for a database transaction
                to span a user interaction. Consider the following example:
            </p>
            <div class="procedure" title="Procedure 2.1. An example of a long-running conversation"><a id="d5e685"/><p class="title"><strong>Procedure 2.1. An example of a long-running conversation</strong></p><ol class="procedure" type="1"><li class="step" title="Step 1">
                    <p>
                        The first screen of a dialog opens. The data seen by the user is loaded in a particular
                        <code class="classname">Session</code> and database transaction.  The user is free to modify the objects.
                    </p>
                </li><li class="step" title="Step 2">
                    <p>
                        The user uses a UI element to save their work after five minutes of editing. The modifications
                        are made persistent.  The user also expects to have exclusive access to the data during the edit
                        session.
                    </p>
                </li></ol></div>

            <p>
                Even though we have multiple databases access here, from the point of view of the user, this series of
                steps represents a single unit of work.  There are many ways to implement this in your application.
            </p>

            <p>
                A first naive implementation might keep the <code class="classname">Session</code> and database transaction open
                while the user is editing, using database-level locks to prevent other users from modifying the same
                data and to guarantee isolation and atomicity.  This is an anti-pattern, because lock contention is a
                bottleneck which will prevent scalability in the future.
            </p>
            <p>
                Several database transactions are used to implement the conversation.  In this case, maintaining
                isolation of business processes becomes the partial responsibility of the application tier.  A single
                conversation usually spans several database transactions.  These multiple database accesses can only
                be atomic as a whole if only one of these database transactions (typically the last one) stores the
                updated data.  All others only read data.  A common way to receive this data is through a wizard-style
                dialog spanning several request/response cycles.  Hibernate includes some features which make this easy
                to implement.
            </p>

            <div class="informaltable">
                <table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>
                                <p>
                                    Automatic Versioning
                                </p>
                            </td><td>
                                <p>
                                    Hibernate can perform automatic optimistic concurrency control for you.  It can
                                    automatically detect if a concurrent modification occurred during user think time.
                                    Check for this at the end of the conversation.
                                </p>
                            </td></tr><tr><td>
                                <p>
                                    Detached Objects
                                </p>
                            </td><td>
                                <p>
                                    If you decide to use the session-per-request pattern, all loaded instances will be
                                    in the detached state during user think time.  Hibernate allows you to reattach the
                                    objects and persist the modifications.  The pattern is called
                                    session-per-request-with-detached-objects.  Automatic versioning is used to isolate
                                    concurrent modifications.
                                </p>
                            </td></tr><tr><td>
                                <p>
                                    Extended Session
                                </p>
                            </td><td>
                                <p>
                                    The Hibernate <code class="interfacename">Session</code> can be disconnected from the
                                    underlying JDBC connection after the database transaction has been committed and
                                    reconnected when a new client request occurs. This pattern is known as
                                    session-per-conversation and makes even reattachment unnecessary. Automatic
                                    versioning is used to isolate concurrent modifications and the
                                    <code class="interfacename">Session</code> will not be allowed to flush automatically,
                                    only explicitly.
                                </p>
                            </td></tr></tbody></table>
            </div>

            <p>
                <span>Session-per-request-with-detached-objects</span> and <span>session-per-conversation</span>
                each have advantages and disadvantages.
            </p>
        </div>

        <div class="section" title="2.4.4. Session-per-application"><div class="titlepage"><div><div><h3 class="title"><a id="d5e719"/>2.4.4. Session-per-application</h3></div></div></div>
            
            <p>
                Discussion coming soon..
            </p>
        </div>
    </div>

    <div class="section" title="2.5. Object identity"><div class="titlepage"><div><div><h2 class="title"><a id="d5e722"/>2.5. Object identity</h2></div></div></div>
        
        <p>
            An application can concurrently access the same persistent state (database row) in two different Sessions.
            However, an instance of a persistent class is never shared between two
            <code class="interfacename">Session</code> instances.  Two different notions of identity exist and come into
            play here: Database identity and JVM identity.
        </p>
        <div class="example"><a id="d5e726"/><p class="title"><strong>Example 2.1. Database identity</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">foo</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getId</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">equals</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;bar</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getId</span><!-- <br/> --><span class="java_separator">()</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span></pre>
        </div></div><br class="example-break"/>
        <div class="example"><a id="d5e729"/><p class="title"><strong>Example 2.2. JVM identity</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">foo</span><!-- <br/> --><span class="java_operator">==</span><!-- <br/> --><span class="java_plain">bar</span></pre>
        </div></div><br class="example-break"/>
        <p>
            For objects attached to a particular <code class="interfacename">Session</code>, the two notions are
            equivalent, and JVM identity for database identity is guaranteed by Hibernate.  The application might
            concurrently access a business object with the same identity in two different sessions, the two
            instances are actually different, in terms of JVM identity.  Conflicts are resolved using an optimistic
            approach and automatic versioning at flush/commit time.
        </p>
        <p>
            This approach places responsibility for concurrency on Hibernate and the database. It also provides the
            best scalability, since expensive locking is not needed to guarantee identity in single-threaded units
            of work.  The application does not need to synchronize on any business object, as long as it maintains
            a single thread per anti-patterns.  While not recommended, within a
            <code class="interfacename">Session</code> the application could safely use the <code class="literal">==</code>
            operator to compare objects.
        </p>
        <p>

            However, an application that uses the <code class="literal">==</code> operator outside of a
            <code class="interfacename">Session</code>
    may introduce problems.. If you put two detached instances into the same <code class="classname">Set</code>, they might
    use the same database identity, which means they represent the same row in the database. They would not be
    guaranteed to have the same JVM identity if they are in a detached state. Override the
    <code class="methodname">equals</code> and <code class="methodname">hashCode</code> methods in persistent classes, so that
    they have their own notion of object equality. Never use the database identifier to implement equality. Instead,
    use a business key that is a combination of unique, typically immutable, attributes. The database identifier
    changes if a transient object is made persistent. If the transient instance, together with detached instances,
    is held in a <code class="classname">Set</code>, changing the hash-code breaks the contract of the
    <code class="classname">Set</code>. Attributes for business keys can be less stable than database primary keys. You only
    need to guarantee stability as long as the objects are in the same <code class="classname">Set</code>.This is not a
    Hibernate issue, but relates to Java's implementation of object identity and equality.
  </p>

</div>


    <div class="section" title="2.6. Common issues"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-basics-issues"/>2.6. Common issues</h2></div></div></div>
        

         <p>
             Both the <span class="emphasis"><em>session-per-user-session</em></span> and <span class="emphasis"><em>session-per-application</em></span>
             anti-patterns are susceptible to the following issues.  Some of the issues might also arise within the
             recommended patterns, so ensure that you understand the implications before making a design decision:
         </p>

        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    A <code class="interfacename">Session</code> is not thread-safe. Things that work concurrently, like
                    HTTP requests, session beans, or Swing workers, will cause race conditions if a
                    <code class="interfacename">Session</code> instance is shared. If you keep your Hibernate
                    <code class="interfacename">Session</code> in your
                    <code class="interfacename">javax.servlet.http.HttpSession</code> (this is discussed later in the
                    chapter), you should consider synchronizing access to your
                    <code class="interfacename">HttpSession</code>; otherwise, a user that clicks reload fast enough can use
                    the same <code class="interfacename">Session</code> in two concurrently running threads.
                </p>
            </li><li class="listitem">
                <p>
                    An exception thrown by Hibernate means you have to rollback your database transaction
                    and close the <code class="interfacename">Session</code> immediately (this is discussed in more detail
                    later in the chapter).  If your <code class="interfacename">Session</code> is bound to the application,
                    you have to stop the application.  Rolling back the database transaction does not put your business
                    objects back into the state they were at the start of the transaction.  This means that the
                    database state and the business objects will be out of sync. Usually this is not a
                    problem, because exceptions are not recoverable and you will have to start over after
                    rollback anyway.
                </p>
            </li><li class="listitem">
                <p>
                    The <code class="interfacename">Session</code> caches every object that is in a persistent state
                    (watched and checked for changes by Hibernate).  If you keep it open for a long time or simply load
                    too much data, it will grow endlessly until you get an OutOfMemoryException.  One solution is to
                    call <code class="methodname">clear()</code> and <code class="methodname">evict()</code> to manage the
                    <code class="interfacename">Session</code> cache, but you should consider an alternate means of dealing
                    with large amounts of data such as a Stored Procedure.  Java is simply not the right tool for these
                    kind of operations.  Some solutions are shown in <a class="xref" href="#batch" title="Chapter 4. Batch Processing">Chapter 4, <em>Batch Processing</em></a>.  Keeping a
                    <code class="interfacename">Session</code> open for the duration of a user session also means a higher
                    probability of stale data.
                </p>
            </li></ul></div>

    </div>

</div>
    <div class="chapter" title="Chapter 3. Persistence Contexts"><div class="titlepage"><div><div><h2 class="title"><a id="d5e772"/>Chapter 3. Persistence Contexts</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e801">3.1. Making entities persistent</a></span></dt><dt><span class="section"><a href="#d5e824">3.2. Deleting entities</a></span></dt><dt><span class="section"><a href="#d5e836">3.3. Obtain an entity reference without initializing its data</a></span></dt><dt><span class="section"><a href="#d5e845">3.4. Obtain an entity with its data initialized</a></span></dt><dt><span class="section"><a href="#d5e853">3.5. Obtain an entity by natural-id</a></span></dt><dt><span class="section"><a href="#d5e880">3.6. Refresh entity state</a></span></dt><dt><span class="section"><a href="#d5e891">3.7. Modifying managed/persistent state</a></span></dt><dt><span class="section"><a href="#d5e898">3.8. Working with detached data</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e902">3.8.1. Reattaching detached data</a></span></dt><dt><span class="section"><a href="#d5e922">3.8.2. Merging detached data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e933">3.9. Checking persistent state</a></span></dt><dt><span class="section"><a href="#d5e950">3.10. Accessing Hibernate APIs from JPA</a></span></dt></dl></div>

    

    <p>
        Both the <code class="interfacename">org.hibernate.Session</code> API and
        <code class="interfacename">javax.persistence.EntityManager</code> API represent a context for dealing with
        persistent data.  This concept is called a <code class="literal">persistence context</code>.  Persistent data has a
        state in relation to both a persistence context and the underlying database.
    </p>

    <div class="itemizedlist" title="Entity states"><p class="title"><strong>Entity states</strong></p><ul class="itemizedlist"><li class="listitem">
            <p>
                <code class="literal">new</code>, or <code class="literal">transient</code> - the entity has just been instantiated and is
                not associated with a persistence context.  It has no persistent representation in the database and no
                identifier value has been assigned.
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">managed</code>, or <code class="literal">persistent</code> - the entity has an associated identifier
                and is associated with a persistence context.
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">detached</code> - the entity has an associated identifier, but is no longer associated with
                a persistence context (usually because the persistence context was closed or the instance was evicted
                from the context)
            </p>
        </li><li class="listitem">
            <p>
                <code class="literal">removed</code> - the entity has an associated identifier and is associated with a persistence
                context, however it is scheduled for removal from the database.
            </p>
        </li></ul></div>

    

    <p>
        In Hibernate native APIs, the persistence context is defined as the
        <code class="interfacename">org.hibernate.Session</code>.  In JPA, the persistence context is defined by
        <code class="interfacename">javax.persistence.EntityManager</code>.  Much of the
        <code class="interfacename">org.hibernate.Session</code> and
        <code class="interfacename">javax.persistence.EntityManager</code> methods deal with moving entities between these
        states.
    </p>

    <div class="section" title="3.1. Making entities persistent"><div class="titlepage"><div><div><h2 class="title"><a id="d5e801"/>3.1. Making entities persistent</h2></div></div></div>
        

        <p>
            Once you've created a new entity instance (using the standard <code class="literal">new</code> operator) it is in
            <code class="literal">new</code> state.   You can make it persistent by associating it to either a
            <code class="interfacename">org.hibernate.Session</code> or
            <code class="interfacename">javax.persistence.EntityManager</code>
        </p>

        <div class="example"><a id="d5e808"/><p class="title"><strong>Example 3.1. Example of making an entity persistent</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DomesticCat fritz = new DomesticCat();
fritz.setColor( Color.GINGER );
fritz.setSex( 'M' );
fritz.setName( "Fritz" );
session.save( fritz );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DomesticCat fritz = new DomesticCat();
fritz.setColor( Color.GINGER );
fritz.setSex( 'M' );
fritz.setName( "Fritz" );
entityManager.persist( fritz );</pre>
        </div></div><br class="example-break"/>

        <p>
            <code class="interfacename">org.hibernate.Session</code> also has a method named <code class="methodname">persist</code>
            which follows the exact semantic defined in the JPA specification for the <code class="methodname">persist</code>
            method.  It is this method on <code class="interfacename">org.hibernate.Session</code> to which the
            Hibernate <code class="interfacename">javax.persistence.EntityManager</code> implementation delegates.
        </p>

        <p>
            If the <code class="classname">DomesticCat</code> entity type has a generated identifier, the value is associated
            to the instance when the <code class="methodname">save</code> or <code class="methodname">persist</code> is called.  If the
            identifier is not automatically generated, the application-assigned (usually natural) key value has to be
            set on the instance before <code class="methodname">save</code> or <code class="methodname">persist</code> is called.
        </p>
    </div>

    <div class="section" title="3.2. Deleting entities"><div class="titlepage"><div><div><h2 class="title"><a id="d5e824"/>3.2. Deleting entities</h2></div></div></div>
        
        <p>
            Entities can also be deleted.
        </p>
        <div class="example"><a id="d5e827"/><p class="title"><strong>Example 3.2. Example of deleting an entity</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.delete( fritz );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">entityManager.remove( fritz );</pre>
        </div></div><br class="example-break"/>
        <p>
            It is important to note that Hibernate itself can handle deleting detached state.  JPA, however, disallows
            it.  The implication here is that the entity instance passed to the
            <code class="interfacename">org.hibernate.Session</code> <code class="methodname">delete</code> method can be either
            in managed or detached state, while the entity instance passed to <code class="methodname">remove</code> on
            <code class="interfacename">javax.persistence.EntityManager</code> must be in managed state.
        </p>
    </div>

    <div class="section" title="3.3. Obtain an entity reference without initializing its data"><div class="titlepage"><div><div><h2 class="title"><a id="d5e836"/>3.3. Obtain an entity reference without initializing its data</h2></div></div></div>
        
        <p>
            Sometimes referred to as lazy loading, the ability to obtain a reference to an entity without having to
            load its data is hugely important.  The most common case being the need to create an association between
            an entity and another, existing entity.
        </p>
        <div class="example"><a id="d5e839"/><p class="title"><strong>Example 3.3. Example of obtaining an entity reference without initializing its data</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Book book = new Book();
book.setAuthor( session.byId( Author.class ).getReference( authorId ) );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Book book = new Book();
book.setAuthor( entityManager.getReference( Author.class, authorId ) );</pre>
        </div></div><br class="example-break"/>
        <p>
            The above works on the assumption that the entity is defined to allow lazy loading, generally through
            use of runtime proxies.  For more information see <a class="xref" href="#">???</a>.  In both
            cases an exception will be thrown later if the given entity does not refer to actual database state if and
            when the application attempts to use the returned proxy in any way that requires access to its data.
        </p>
    </div>

    <div class="section" title="3.4. Obtain an entity with its data initialized"><div class="titlepage"><div><div><h2 class="title"><a id="d5e845"/>3.4. Obtain an entity with its data initialized</h2></div></div></div>
        

        <p>
            It is also quite common to want to obtain an entity along with with its data, for display for example.
        </p>
        <div class="example"><a id="d5e848"/><p class="title"><strong>Example 3.4. Example of obtaining an entity reference with its data initialized</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.byId( Author.class ).load( authorId );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">entityManager.find( Author.class, authorId );</pre>
        </div></div><br class="example-break"/>
        <p>
            In both cases null is returned if no matching database row was found.
        </p>
    </div>

    <div class="section" title="3.5. Obtain an entity by natural-id"><div class="titlepage"><div><div><h2 class="title"><a id="d5e853"/>3.5. Obtain an entity by natural-id</h2></div></div></div>
        

        <p>
            In addition to allowing to load by identifier, Hibernate allows applications to load by declared
            natural identifier.
        </p>
        <div class="example"><a id="d5e856"/><p class="title"><strong>Example 3.5. Example of simple natural-id access</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
public class User {
	@Id
	@GeneratedValue
	Long id;

	@NaturalId
	String userName;

	...
}

// use getReference() to create associations...
Resource aResource = (Resource) session.byId( Resource.class ).getReference( 123 );
User aUser = (User) session.bySimpleNaturalId( User.class ).getReference( "steve" );
aResource.assignTo( user );


// use load() to pull initialzed data
return session.bySimpleNaturalId( User.class ).load( "steve" );</pre>
        </div></div><br class="example-break"/>
        <div class="example"><a id="d5e859"/><p class="title"><strong>Example 3.6. Example of natural-id access</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">import java.lang.String;

@Entity
public class User {
	@Id
	@GeneratedValue
	Long id;

	@NaturalId
	String system;

	@NaturalId
	String userName;

	...
}

// use getReference() to create associations...
Resource aResource = (Resource) session.byId( Resource.class ).getReference( 123 );
User aUser = (User) session.byNaturalId( User.class )
		.using( "system", "prod" )
		.using( "userName", "steve" )
		.getReference();
aResource.assignTo( user );


// use load() to pull initialzed data
return session.byNaturalId( User.class )
		.using( "system", "prod" )
		.using( "userName", "steve" )
		.load();</pre>
        </div></div><br class="example-break"/>
        <p>
            Just like we saw above, access entity data by natural id allows both the <code class="methodname">load</code>
            and <code class="methodname">getReference</code> forms, with the same semantics.
        </p>

        <p>
            Accessing persistent data by identifier and by natural-id is consistent in the Hibernate API.  Each defines
            the same 2 data access methods:
        </p>
        <div class="variablelist"><dl><dt><span class="term"><code class="methodname">getReference</code></span></dt><dd>
                    <p>
                        Should be used in cases where the identifier is assumed to exist, where non-existence would be
                        an actual error.  Should never be used to test existence.  That is because this method will
                        prefer to create and return a proxy if the data is not already associated with the Session
                        rather than hit the database.  The quintessential use-case for using this method is to create
                        foreign-key based associations.
                    </p>
                </dd><dt><span class="term"><code class="methodname">load</code></span></dt><dd>
                    <p>
                        Will return the persistent data associated with the given identifier value or null if that
                        identifier does not exist.
                    </p>
                </dd></dl></div>
        <p>
            In addition to those 2 methods, each also defines the method <code class="methodname">with</code> accepting
            a <code class="interfacename">org.hibernate.LockOptions</code> argument.  Locking is discussed in a separate
            chapter.
        </p>
    </div>

    <div class="section" title="3.6. Refresh entity state"><div class="titlepage"><div><div><h2 class="title"><a id="d5e880"/>3.6. Refresh entity state</h2></div></div></div>
        

        <p>
            You can reload an entity instance and it's collections at any time.
        </p>

        <div class="example"><a id="d5e883"/><p class="title"><strong>Example 3.7. Example of refreshing entity state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = session.get( Cat.class, catId );
...
session.refresh( cat );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = entityManager.find( Cat.class, catId );
...
entityManager.refresh( cat );</pre>
        </div></div><br class="example-break"/>

        <p>
            One case where this is useful is when it is known that the database state has changed since the data was
            read.  Refreshing allows the current database state to be pulled into the entity instance and the
            persistence context.
        </p>

        <p>
            Another case where this might be useful is when database triggers are used to initialize some of the
            properties of the entity.  Note that only the entity instance and its collections are refreshed unless you
            specify <code class="literal">REFRESH</code> as a cascade style of any associations.  However, please note that
            Hibernate has the capability to handle this automatically through its notion of generated properties.
            See <a class="xref" href="#">???</a> for information.
        </p>
    </div>

    <div class="section" title="3.7. Modifying managed/persistent state"><div class="titlepage"><div><div><h2 class="title"><a id="d5e891"/>3.7. Modifying managed/persistent state</h2></div></div></div>
        

        <p>
            Entities in managed/persistent state may be manipulated by the application and any changes will be
            automatically detected and persisted when the persistence context is flushed. There is no need to call a
            particular method to make your modifications persistent.
        </p>

        <div class="example"><a id="d5e894"/><p class="title"><strong>Example 3.8. Example of modifying managed state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = session.get( Cat.class, catId );
cat.setName( "Garfield" );
session.flush(); // generally this is not explicitly needed</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = entityManager.find( Cat.class, catId );
cat.setName( "Garfield" );
entityManager.flush(); // generally this is not explicitly needed</pre>
        </div></div><br class="example-break"/>
    </div>

    <div class="section" title="3.8. Working with detached data"><div class="titlepage"><div><div><h2 class="title"><a id="d5e898"/>3.8. Working with detached data</h2></div></div></div>
        

        <p>
            Detachment is the process of working with data outside the scope of any persistence context.  Data becomes
            detached in a number of ways.  Once the persistence context is closed, all data that was associated with it
            becomes detached.  Clearing the persistence context has the same effect.  Evicting a particular entity
            from the persistence context makes it detached.  And finally, serialization will make the deserialized form
            be detached (the original instance is still managed).
        </p>

        <p>
            Detached data can still be manipulated, however the persistence context will no longer automatically know
            about these modification and the application will need to intervene to make the changes persistent.
        </p>

        <div class="section" title="3.8.1. Reattaching detached data"><div class="titlepage"><div><div><h3 class="title"><a id="d5e902"/>3.8.1. Reattaching detached data</h3></div></div></div>
            
            <p>
                Reattachment is the process of taking an incoming entity instance that is in detached state
                and re-associating it with the current persistence context.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    JPA does not provide for this model.  This is only available through Hibernate
                    <code class="interfacename">org.hibernate.Session</code>.
                </p>
            </div>
            <div class="example"><a id="d5e908"/><p class="title"><strong>Example 3.9. Example of reattaching a detached entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class=""/>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.saveOrUpdate( someDetachedCat );</pre>
            </div></div><br class="example-break"/>
            <p>
                The method name <code class="methodname">update</code> is a bit misleading here.  It does not mean that an
                <code class="literal">SQL</code> <code class="literal">UPDATE</code> is immediately performed.  It does, however, mean that
                an <code class="literal">SQL</code> <code class="literal">UPDATE</code> will be performed when the persistence context is
                flushed since Hibernate does not know its previous state against which to compare for changes.  Unless
                the entity is mapped with <code class="literal">select-before-update</code>, in which case Hibernate will
                pull the current state from the database and see if an update is needed.
            </p>
            <p>
                Provided the entity is detached, <code class="methodname">update</code> and <code class="methodname">saveOrUpdate</code>
                operate exactly the same.
            </p>
        </div>

        <div class="section" title="3.8.2. Merging detached data"><div class="titlepage"><div><div><h3 class="title"><a id="d5e922"/>3.8.2. Merging detached data</h3></div></div></div>
            
            <p>
                Merging is the process of taking an incoming entity instance that is in detached state and copying its
                data over onto a new instance that is in managed state.
            </p>
            <div class="example"><a id="d5e925"/><p class="title"><strong>Example 3.10. Visualizing merge</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Object detached = ...;
Object managed = entityManager.find( detached.getClass(), detached.getId() );
managed.setXyz( detached.getXyz() );
...
return managed;</pre>
            </div></div><br class="example-break"/>
            <p>
                That is not exactly what happens, but its a good visualization.
            </p>
            <div class="example"><a id="d5e929"/><p class="title"><strong>Example 3.11. Example of merging a detached entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat theManagedInstance = session.merge( someDetachedCat );</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat theManagedInstance = entityManager.merge( someDetachedCat );</pre>
            </div></div><br class="example-break"/>
        </div>

    </div>


    <div class="section" title="3.9. Checking persistent state"><div class="titlepage"><div><div><h2 class="title"><a id="d5e933"/>3.9. Checking persistent state</h2></div></div></div>
        

        <p>
            An application can verify the state of entities and collections in relation to the persistence context.
        </p>
        <div class="example"><a id="d5e936"/><p class="title"><strong>Example 3.12. Examples of verifying managed state</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">assert session.contains( cat );</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">assert entityManager.contains( cat );</pre>
        </div></div><br class="example-break"/>
        <div class="example"><a id="d5e940"/><p class="title"><strong>Example 3.13. Examples of verifying laziness</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">if ( Hibernate.isInitialized( customer.getAddress() ) {
    //display address if loaded
}
if ( Hibernate.isInitialized( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (Hibernate.isPropertyInitialized( customer, "detailedBio" ) ) {
    //display property detailedBio if loaded
}</pre>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">javax.persistence.PersistenceUnitUtil jpaUtil = entityManager.getEntityManagerFactory().getPersistenceUnitUtil();
if ( jpaUtil.isLoaded( customer.getAddress() ) {
    //display address if loaded
}
if ( jpaUtil.isLoaded( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (jpaUtil.isLoaded( customer, "detailedBio" ) ) {
    //display property detailedBio if loaded
}</pre>
        </div></div><br class="example-break"/>
        <p>
            In JPA there is an alternative means to check laziness using the following
            <code class="interfacename">javax.persistence.PersistenceUtil</code> pattern.  However, the
            <code class="interfacename">javax.persistence.PersistenceUnitUtil</code> is recommended where ever possible
        </p>
        <div class="example"><a id="d5e947"/><p class="title"><strong>Example 3.14. Alternative JPA means to verify laziness</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">javax.persistence.PersistenceUtil jpaUtil = javax.persistence.Persistence.getPersistenceUtil();
if ( jpaUtil.isLoaded( customer.getAddress() ) {
    //display address if loaded
}
if ( jpaUtil.isLoaded( customer.getOrders()) ) ) {
    //display orders if loaded
}
if (jpaUtil.isLoaded(customer, "detailedBio") ) {
    //display property detailedBio if loaded
}</pre>
        </div></div><br class="example-break"/>

    </div>

    <div class="section" title="3.10. Accessing Hibernate APIs from JPA"><div class="titlepage"><div><div><h2 class="title"><a id="d5e950"/>3.10. Accessing Hibernate APIs from JPA</h2></div></div></div>
        
        <p>
            JPA defines an incredibly useful method to allow applications access to the APIs of the underlying provider.
        </p>
        <div class="example"><a id="d5e953"/><p class="title"><strong>Example 3.15. Usage of EntityManager.unwrap</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = entityManager.unwrap( Session.class );
SessionImplementor sessionImplementor = entityManager.unwrap( SessionImplementor.class );</pre>
        </div></div><br class="example-break"/>
    </div>
</div>
    <div class="chapter" title="Chapter 4. Batch Processing"><div class="titlepage"><div><div><h2 class="title"><a id="batch"/>Chapter 4. Batch Processing</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e971">4.1. Batch inserts</a></span></dt><dt><span class="section"><a href="#d5e980">4.2. Batch updates</a></span></dt><dt><span class="section"><a href="#d5e990">4.3. StatelessSession</a></span></dt><dt><span class="section"><a href="#d5e1033">4.4. Hibernate Query Language for DML</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1041">4.4.1. HQL for UPDATE and DELETE</a></span></dt><dt><span class="section"><a href="#d5e1076">4.4.2. HQL syntax for INSERT</a></span></dt><dt><span class="section"><a href="#d5e1104">4.4.3. More information on HQL</a></span></dt></dl></dd></dl></div>

  
  <p>
    The following example shows an antipattern for batch inserts.
  </p>
  <div class="example"><a id="d5e959"/><p class="title"><strong>Example 4.1. Naive way to insert 100000 lines with Hibernate</strong></p><div class="example-contents">
    
    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;i</span><span class="java_operator">=</span><span class="java_literal">0</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">&lt;</span><span class="java_literal">100000</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">++</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Customer</span><span class="java_plain">&nbsp;customer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">(.....);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">save</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre>
    <p>
      This fails with exception <code class="systemitem">OutOfMemoryException</code> after around 50000 rows on most
      systems. The reason is that Hibernate caches all the newly inserted Customer instances in the session-level
      cache. There are several ways to avoid this problem.
    </p>
  </div></div><br class="example-break"/>
  <p>
    Before batch processing, enable JDBC batching. To enable JDBC batching, set the property
    <span class="property">hibernate.jdbc.batch_size</span> to an integer between 10 and 50.
  </p>
  <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
    <p>
      Hibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.
    </p>
  </div>
  <p>
    If the above approach is not appropriate, you can disable the second-level cache, by setting
    <span class="property">hibernate.cache.use_second_level_cache</span> to <code class="literal">false</code>.
  </p>
  
  <div class="section" title="4.1. Batch inserts"><div class="titlepage"><div><div><h2 class="title"><a id="d5e971"/>4.1. Batch inserts</h2></div></div></div>
    
    <p>
      When you make new objects persistent, employ methods <code class="methodname">flush()</code> and
      <code class="methodname">clear()</code> to the session regularly, to control the size of the first-level cache.
    </p>
    <div class="example"><a id="d5e976"/><p class="title"><strong>Example 4.2. Flushing and clearing the <code class="classname">Session</code></strong></p><div class="example-contents">
      
      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;i</span><span class="java_operator">=</span><span class="java_literal">0</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">&lt;</span><span class="java_literal">100000</span><span class="java_separator">;</span><span class="java_plain">&nbsp;i</span><span class="java_operator">++</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Customer</span><span class="java_plain">&nbsp;customer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">(.....);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">save</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;i&nbsp;</span><span class="java_operator">%</span><span class="java_plain">&nbsp;</span><span class="java_literal">20</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_literal">20</span><span class="java_separator">,</span><span class="java_plain">&nbsp;same&nbsp;as&nbsp;the&nbsp;JDBC&nbsp;batch&nbsp;size</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">flush&nbsp;a&nbsp;batch&nbsp;of&nbsp;inserts&nbsp;and&nbsp;release&nbsp;memory</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">flush</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">clear</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre>
    </div></div><br class="example-break"/>
  </div>
  
  <div class="section" title="4.2. Batch updates"><div class="titlepage"><div><div><h2 class="title"><a id="d5e980"/>4.2. Batch updates</h2></div></div></div>
    
    <p>
      When you retriev and update data, <code class="methodname">flush()</code> and <code class="methodname">clear()</code> the
      session regularly.  In addition, use method <code class="methodname">scroll()</code> to take advantage of server-side
      cursors for queries that return many rows of data.
    </p>
    <div class="example"><a id="d5e986"/><p class="title"><strong>Example 4.3. Using <code class="methodname">scroll()</code></strong></p><div class="example-contents">
      
      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_type">ScrollableResults</span><span class="java_plain">&nbsp;customers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">getNamedQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;GetCustomers&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setCacheMode</span><span class="java_separator">(</span><span class="java_type">CacheMode</span><span class="java_separator">.</span><span class="java_plain">IGNORE</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">scroll</span><span class="java_separator">(</span><span class="java_type">ScrollMode</span><span class="java_separator">.</span><span class="java_plain">FORWARD_ONLY</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;count</span><span class="java_operator">=</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customers</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Customer</span><span class="java_plain">&nbsp;customer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Customer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;customers</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">updateStuff</span><span class="java_separator">(...);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_operator">++</span><span class="java_plain">count&nbsp;</span><span class="java_operator">%</span><span class="java_plain">&nbsp;</span><span class="java_literal">20</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">flush&nbsp;a&nbsp;batch&nbsp;of&nbsp;updates&nbsp;and&nbsp;release&nbsp;memory</span><span class="java_operator">:</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">flush</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">clear</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre>
    </div></div><br class="example-break"/>
  </div>
  
  <div class="section" title="4.3. StatelessSession"><div class="titlepage"><div><div><h2 class="title"><a id="d5e990"/>4.3. StatelessSession</h2></div></div></div>
    
    <p>
      <code class="interfacename">StatelessSession</code> is a command-oriented API provided by Hibernate. Use it to stream
      data to and from the database in the form of detached objects. A <code class="interfacename">StatelessSession</code>
      has no persistence context associated with it and does not provide many of the higher-level life cycle
      semantics. Some of the things not provided by a <code class="interfacename">StatelessSession</code> include:
    </p>
    <div class="itemizedlist" title="Features and behaviors not provided by StatelessSession"><p class="title"><strong>Features and behaviors not provided by <code class="interfacename">StatelessSession</code></strong></p><ul class="itemizedlist"><li class="listitem">
        <p>
          a first-level cache
        </p>
      </li><li class="listitem">
        <p>
          interaction with any second-level or query cache
        </p>
      </li><li class="listitem">
        <p>
          transactional write-behind or automatic dirty checking
        </p>
      </li></ul></div>
    <div class="itemizedlist" title="Limitations of StatelessSession"><p class="title"><strong>Limitations of <code class="interfacename">StatelessSession</code></strong></p><ul class="itemizedlist"><li class="listitem">
        <p>
          Operations performed using a stateless session never cascade to associated instances.
        </p>
      </li><li class="listitem">
        <p>
          Collections are ignored by a stateless session.
        </p>
      </li><li class="listitem">
        <p>
          Operations performed via a stateless session bypass Hibernate's event model and interceptors.
        </p>
      </li><li class="listitem">
        <p>
          Due to the lack of a first-level cache, Stateless sessions are vulnerable to data aliasing effects.
        </p>
      </li><li class="listitem">
        <p>
          A stateless session is a lower-level abstraction that is much closer to the underlying JDBC.
        </p>
      </li></ul></div>
    <div class="example"><a id="d5e1018"/><p class="title"><strong>Example 4.4. Using a <code class="interfacename">StatelessSession</code></strong></p><div class="example-contents">
      
      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">StatelessSession</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openStatelessSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_type">ScrollableResults</span><span class="java_plain">&nbsp;customers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">getNamedQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;GetCustomers&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">scroll</span><span class="java_separator">(</span><span class="java_type">ScrollMode</span><span class="java_separator">.</span><span class="java_plain">FORWARD_ONLY</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customers</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Customer</span><span class="java_plain">&nbsp;customer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Customer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;customers</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">updateStuff</span><span class="java_separator">(...);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">update</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre>
      <p>
        The <code class="classname">Customer</code> instances returned by the query are immediately detached. They are never
        associated with any persistence context.
      </p>
    </div></div><br class="example-break"/>
    <p>
      The <code class="methodname">insert()</code>, <code class="methodname">update()</code>, and <code class="methodname">delete()</code>
      operations defined by the <code class="interfacename">StatelessSession</code> interface operate directly on database
      rows. They cause the corresponding SQL operations to be executed immediately.  They have different semantics from
      the <code class="methodname">save()</code>, <code class="methodname">saveOrUpdate()</code>, and
      <code class="methodname">delete()</code> operations defined by the <code class="interfacename">Session</code> interface.
    </p>
  </div>
  
  <div class="section" title="4.4. Hibernate Query Language for DML"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1033"/>4.4. Hibernate Query Language for DML</h2></div></div></div>
    
    <p>
      DML, or <em class="firstterm">Data Markup Language</em>, refers to SQL statements such as <code class="literal">INSERT</code>,
      <code class="literal">UPDATE</code>, and <code class="literal">DELETE</code>. Hibernate provides methods for bulk SQL-style DML
      statement execution, in the form of <em class="firstterm">Hibernate Query Language (HQL)</em>.
    </p>
    <div class="section" title="4.4.1. HQL for UPDATE and DELETE"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1041"/>4.4.1. HQL for UPDATE and DELETE</h3></div></div></div>
      
      <div class="example"><a id="d5e1043"/><p class="title"><strong>Example 4.5. Psuedo-syntax for UPDATE and DELETE statements using HQL</strong></p><div class="example-contents">
        
        <pre class="screen">
          ( UPDATE | DELETE ) FROM? EntityName (WHERE where_conditions)?
        </pre>
        <p>
          The <code class="literal">?</code> suffix indications an optional parameter. The <code class="literal">FROM</code> and
          <code class="literal">WHERE</code> clauses are each optional.
        </p>
      </div></div><br class="example-break"/>
      <p>
        The <code class="literal">FROM</code> clause can only refer to a single entity, which can be aliased. If the entity name
        is aliased, any property references must be qualified using that alias. If the entity name is not aliased, then
        it is illegal for any property references to be qualified.
      </p>
      <p>
        Joins, either implicit or explicit, are prohibited in a bulk HQL query. You can use sub-queries in the
        <code class="literal">WHERE</code> clause, and the sub-queries themselves can contain joins.
      </p>
      <div class="example"><a id="d5e1054"/><p class="title"><strong>Example 4.6. Executing an HQL UPDATE, using the <code class="methodname">Query.executeUpdate()</code> method</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;hqlUpdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;update&nbsp;Customer&nbsp;c&nbsp;set&nbsp;c.name&nbsp;=&nbsp;:newName&nbsp;where&nbsp;c.name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;or&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;hqlUpdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;update&nbsp;Customer&nbsp;set&nbsp;name&nbsp;=&nbsp;:newName&nbsp;where&nbsp;name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;updatedEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;hqlUpdate&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;newName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;newName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;oldName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;oldName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre>
      </div></div><br class="example-break"/>
      <p>
        In keeping with the EJB3 specification, HQL UPDATE statements, by default, do not effect the version or the
        timestamp property values for the affected entities. You can use a versioned update to force Hibernate to reset
        the version or timestamp property values, by adding the <code class="literal">VERSIONED</code> keyword after the
        <code class="literal">UPDATE</code> keyword.
      </p>
      <div class="example"><a id="d5e1061"/><p class="title"><strong>Example 4.7. Updating the version of timestamp</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;hqlVersionedUpdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;update&nbsp;versioned&nbsp;Customer&nbsp;set&nbsp;name&nbsp;=&nbsp;:newName&nbsp;where&nbsp;name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;updatedEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;hqlUpdate&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;newName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;newName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;oldName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;oldName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre>
      </div></div><br class="example-break"/>
      <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
          If you use the <code class="literal">VERSIONED</code> statement, you cannot use custom version types, which use class
          <code class="classname">org.hibernate.usertype.UserVersionType</code>.
        </p>
      </div>
      <div class="example"><a id="d5e1068"/><p class="title"><strong>Example 4.8. A HQL <code class="literal">DELETE</code> statement</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;hqlDelete&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;delete&nbsp;Customer&nbsp;c&nbsp;where&nbsp;c.name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;or&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;hqlDelete&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;delete&nbsp;Customer&nbsp;where&nbsp;name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;deletedEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;hqlDelete&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;oldName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;oldName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre>
      </div></div><br class="example-break"/>
      <p>
        Method <code class="methodname">Query.executeUpdate()</code> returns an <span class="type">int</span> value, which indicates the
        number of entities effected by the operation. This may or may not correlate to the number of rows effected in
        the database. An HQL bulk operation might result in multiple SQL statements being executed, such as for
        joined-subclass. In the example of joined-subclass, a <code class="literal">DELETE</code> against one of the subclasses
        may actually result in deletes in the tables underlying the join, or further down the inheritance hierarchy.
      </p>
    </div>
    
    <div class="section" title="4.4.2. HQL syntax for INSERT"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1076"/>4.4.2. HQL syntax for INSERT</h3></div></div></div>
      
      <div class="example"><a id="d5e1078"/><p class="title"><strong>Example 4.9. Pseudo-syntax for INSERT statements</strong></p><div class="example-contents">
        
        <pre class="screen">
          INSERT INTO EntityName <em class="replaceable"><code>properties_list</code></em> <em class="replaceable"><code>select_statement</code></em>
        </pre>
      </div></div><br class="example-break"/>
      <p>
        Only the <code class="literal">INSERT INTO ... SELECT ...</code> form is supported. You cannot specify explicit values to
        insert.
      </p>
      <p>
        The <em class="replaceable"><code>properties_list</code></em> is analogous to the column specification in the <code class="literal">SQL
        INSERT</code> statement. For entities involved in mapped inheritance, you can only use properties directly
        defined on that given class-level in the <em class="replaceable"><code>properties_list</code></em>. Superclass properties are
        not allowed and subclass properties are irrelevant. In other words, <code class="literal">INSERT</code> statements are
        inherently non-polymorphic.
      </p>
      <p>
        The <em class="replaceable"><code>select_statement</code></em> can be any valid HQL select query, but the return types must
        match the types expected by the INSERT. Hibernate verifies the return types during query compilation, instead of
        expecting the database to check it. Problems might result from Hibernate types which are equivalent, rather than
        equal. One such example is a mismatch between a property defined as an <span class="type">org.hibernate.type.DateType</span>
        and a property defined as an <span class="type">org.hibernate.type.TimestampType</span>, even though the database may not
        make a distinction, or may be capable of handling the conversion.
      </p>
      <p>
        If <em class="replaceable"><code>id</code></em> property is not specified in the <em class="replaceable"><code>properties_list</code></em>,
        Hibernate generates a value automatically. Automatic generation is only available if you use ID generators which
        operate on the database. Otherwise, Hibernate throws an exception during parsing. Available in-database
        generators are <code class="classname">org.hibernate.id.SequenceGenerator</code> and its subclasses, and objects which
        implement <code class="interfacename">org.hibernate.id.PostInsertIdentifierGenerator</code>. The most notable
        exception is <code class="classname">org.hibernate.id.TableHiLoGenerator</code>, which does not expose a selectable way
        to get its values.
      </p>
      <p>
        For properties mapped as either version or timestamp, the insert statement gives you two options. You can either
        specify the property in the properties_list, in which case its value is taken from the corresponding select
        expressions, or omit it from the properties_list, in which case the seed value defined by the
        org.hibernate.type.VersionType is used.
      </p>
      <div class="example"><a id="d5e1101"/><p class="title"><strong>Example 4.10. HQL INSERT statement</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">beginTransaction</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;hqlInsert&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;insert&nbsp;into&nbsp;DelinquentAccount&nbsp;(id,&nbsp;name)&nbsp;select&nbsp;c.id,&nbsp;c.name&nbsp;from&nbsp;Customer&nbsp;c&nbsp;where&nbsp;...&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;createdEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;hqlInsert&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">session</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
</pre>
      </div></div><br class="example-break"/>
    </div>
    <div class="section" title="4.4.3. More information on HQL"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1104"/>4.4.3. More information on HQL</h3></div></div></div>
      
      <p>
        This section is only a brief overview of HQL. For more information, see <a class="xref" href="#">???</a>.
      </p>
    </div>
  </div>
</div>
    <div class="chapter" title="Chapter 5. Locking"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1108"/>Chapter 5. Locking</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e1128">5.1. Optimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1144">5.1.1. Dedicated version number</a></span></dt><dt><span class="section"><a href="#d5e1207">5.1.2. Timestamp</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1256">5.2. Pessimistic</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1261">5.2.1. The <code class="classname">LockMode</code> class</a></span></dt></dl></dd></dl></div>
  
  <p>
    Locking refers to actions taken to prevent data in a relational database from changing between the time it is read
    and the time that it is used.
  </p>
  <p>
    Your locking strategy can be either <em class="firstterm">optimistic</em> or <em class="firstterm">pessimistic</em>.
  </p>
  <div class="variablelist" title="Locking strategies"><p class="title"><strong>Locking strategies</strong></p><dl><dt><span class="term">Optimistic</span></dt><dd>
        <p>
          Optimistic locking assumes that multiple transactions can complete without affecting each other, and that
          therefore transactions can proceed without locking the data resources that they affect. Before committing,
          each transaction verifies that no other transaction has modified its data. If the check reveals conflicting
          modifications, the committing transaction rolls back<sup>[<a id="d5e1120" href="#ftn.d5e1120" class="footnote">1</a>]</sup>.
        </p>
      </dd><dt><span class="term">Pessimistic</span></dt><dd>
        <p>
          Pessimistic locking assumes that concurrent transactions will conflict with each other, and requires resources
          to be locked after they are read and only unlocked after the application has finished using the data.
        </p>
      </dd></dl></div>
  <p>
    Hibernate provides mechanisms for implementing both types of locking in your applications.
  </p>
  <div class="section" title="5.1. Optimistic"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1128"/>5.1. Optimistic</h2></div></div></div>
    
    <p>
      When your application uses long transactions or conversations that span several database transactions, you can
      store versioning data, so that if the same entity is updated by two conversations, the last to commit changes is
      informed of the conflict, and does not override the other conversation's work. This approach guarantees some
      isolation, but scales well and works particularly well in <em class="firstterm">Read-Often Write-Sometimes</em>
      situations.
    </p>
    <p>
      Hibernate provides two different mechanisms for storing versioning information, a dedicated version number or a
      timestamp.
    </p>
    <div class="variablelist"><dl><dt><span class="term">Version number</span></dt><dd>
          <p>

          </p>
        </dd><dt><span class="term">Timestamp</span></dt><dd>
          <p>

          </p>
        </dd></dl></div>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        A version or timestamp property can never be null for a detached instance. Hibernate detects any instance with a
        null version or timestamp as transient, regardless of other unsaved-value strategies that you specify. Declaring
        a nullable version or timestamp property is an easy way to avoid problems with transitive reattachment in
        Hibernate, especially useful if you use assigned identifiers or composite keys.
      </p>
    </div>
    
    <div class="section" title="5.1.1. Dedicated version number"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1144"/>5.1.1. Dedicated version number</h3></div></div></div>
      
      <p>
        The version number mechanism for optimistic locking is provided through a <code class="literal">@Version</code>
        annotation.
      </p>
      <div class="example"><a id="d5e1148"/><p class="title"><strong>Example 5.1. The @Version annotation</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Flight</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;OPTLOCK&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;getVersion</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span></pre>
        <p>
          Here, the version property is mapped to the <code class="literal">OPTLOCK</code> column, and the entity manager uses it
          to detect conflicting updates, and prevent the loss of updates that would be overwritten by a
          <em class="firstterm">last-commit-wins</em> strategy.
        </p>
      </div></div><br class="example-break"/>
      <p>
        The version column can be any kind of type, as long as you define and implement the appropriate
        <code class="classname">UserVersionType</code>.
      </p>
      <p>
        Your application is forbidden from altering the version number set by Hibernate. To artificially increase the
        version number, see the documentation for properties
        <span class="property">LockModeType.OPTIMISTIC_FORCE_INCREMENT</span> or
        <span class="property">LockModeType.PESSIMISTIC_FORCE_INCREMENTcheck</span> in the Hibernate Entity Manager reference
        documentation.
      </p>
      <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Database-generated version numbers</h2>
        
        <p>
          If the version number is generated by the database, such as a trigger, use the annotation
          <code class="literal">@org.hibernate.annotations.Generated(GenerationTime.ALWAYS)</code>.
        </p>
      </div>
      <div class="example"><a id="d5e1163"/><p class="title"><strong>Example 5.2. Declaring a version property in <code class="filename">hbm.xml</code></strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;version_column&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;propertyName&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;typename&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">access</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;field|property|ClassName&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">unsaved-value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;null|negative|undefined&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">generated</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;never|always&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">insert</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true|false&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">node</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;element-name|@attribute-name|element/@attribute|.&quot;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        <div class="informaltable">
          <table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>column</td><td><p>The name of the column holding the version number. Optional, defaults to the property
                name. </p></td></tr><tr><td>name</td><td><p>The name of a property of the persistent class.</p></td></tr><tr><td>type</td><td><p>The type of the version number. Optional, defaults to
                <code class="literal">integer</code>.</p></td></tr><tr><td>access</td><td><p>Hibernate's strategy for accessing the property value. Optional, defaults to
                <code class="literal">property</code>.</p></td></tr><tr><td>unsaved-value</td><td><p>Indicates that an instance is newly instantiated and thus unsaved. This distinguishes it
                from detached instances that were saved or loaded in a previous session. The default value,
                <code class="literal">undefined</code>, indicates that the identifier property value should be
                used. Optional.</p></td></tr><tr><td>generated</td><td><p>Indicates that the version property value is generated by the database. Optional, defaults
                to <code class="literal">never</code>.</p></td></tr><tr><td>insert</td><td><p>Whether or not to include the <code class="code">version</code> column in SQL <code class="code">insert</code>
                statements. Defaults to <code class="literal">true</code>, but you can set it to <code class="literal">false</code> if the
                database column is defined with a default value of <code class="literal">0</code>.</p></td></tr></tbody></table>
        </div>
      </div></div><br class="example-break"/>
    </div>
    
    <div class="section" title="5.1.2. Timestamp"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1207"/>5.1.2. Timestamp</h3></div></div></div>
      
      <p>
        Timestamps are a less reliable way of optimistic locking than version numbers, but can be used by applications
        for other purposes as well. Timestamping is automatically used if you the <code class="code">@Version</code> annotation on a
        <span class="type">Date</span> or <span class="type">Calendar</span>.
      </p>
      <div class="example"><a id="d5e1213"/><p class="title"><strong>Example 5.3. Using timestamps for optimistic locking</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Flight</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Version</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;getLastUpdate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span></pre>
      </div></div><br class="example-break"/>
      <p>
        Hibernate can retrieve the timestamp value from the database or the JVM, by reading the value you specify for
        the <code class="code">@org.hibernate.annotations.Source</code> annotation. The value can be either
        <code class="literal">org.hibernate.annotations.SourceType.DB</code> or
        <code class="literal">org.hibernate.annotations.SourceType.VM</code>. The default behavior is to use the database, and is
        also used if you don't specify the annotation at all.
      </p>
      <p>
        The timestamp can also be generated by the database instead of Hibernate, if you use the
        <code class="code">@org.hibernate.annotations.Generated(GenerationTime.ALWAYS)</code> annotation.
      </p>
      <div class="example"><a id="d5e1222"/><p class="title"><strong>Example 5.4. The timestamp element in <code class="filename">hbm.xml</code></strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">timestamp</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">column</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;timestamp_column&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;propertyName&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">access</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;field|property|ClassName&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">unsaved-value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;null|undefined&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">source</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;vm|db&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">generated</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;never|always&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">node</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;element-name|@attribute-name|element/@attribute|.&quot;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        <div class="informaltable">
          <table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>column</td><td><p>The name of the column which holds the timestamp. Optional, defaults to the property
                namel</p></td></tr><tr><td>name</td><td><p>The name of a JavaBeans style property of Java type Date or Timestamp of the persistent
                class.</p></td></tr><tr><td>access</td><td><p>The strategy Hibernate uses to access the property value. Optional, defaults to
                <code class="literal">property</code>.</p></td></tr><tr><td>unsaved-value</td><td><p>A version property which indicates than instance is newly
                instantiated, and unsaved. This distinguishes it from detached instances that were saved or loaded in a
                previous session. The default value of <code class="literal">undefined</code> indicates that Hibernate uses the
                identifier property value.</p></td></tr><tr><td>source</td><td><p>Whether Hibernate retrieves the timestamp from the database or the current
                JVM. Database-based timestamps incur an overhead because Hibernate needs to query the database each time
                to determine the incremental next value. However, database-derived timestamps are safer to use in a
                clustered environment. Not all database dialects are known to support the retrieval of the database's
                current timestamp. Others may also be unsafe for locking, because of lack of precision.</p></td></tr><tr><td>generated</td><td><p>Whether the timestamp property value is generated by the database. Optional, defaults to
                <code class="literal">never</code>.</p></td></tr></tbody></table>
        </div>
      </div></div><br class="example-break"/>
    </div>

  </div>
  
  <div class="section" title="5.2. Pessimistic"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1256"/>5.2. Pessimistic</h2></div></div></div>
    
    <p>
      Typically, you only need to specify an isolation level for the JDBC connections and let the database handle
      locking issues. If you do need to obtain exclusive pessimistic locks or re-obtain locks at the start of a new
      transaction, Hibernate gives you the tools you need.
    </p>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        Hibernate always uses the locking mechanism of the database, and never lock objects in memory.
      </p>
    </div>
    <div class="section" title="5.2.1. The LockMode class"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1261"/>5.2.1. The <code class="classname">LockMode</code> class</h3></div></div></div>
      
      <p>
        The <code class="classname">LockMode</code> class defines the different lock levels that Hibernate can acquire.
      </p>
      <div class="informaltable">
        <table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>LockMode.WRITE</td><td><p>acquired automatically when Hibernate updates or inserts a row.</p></td></tr><tr><td>LockMode.UPGRADE</td><td><p>acquired upon explicit user request using <code class="code">SELECT ... FOR UPDATE</code> on databases
              which support that syntax.</p></td></tr><tr><td>LockMode.UPGRADE_NOWAIT</td><td><p>acquired upon explicit user request using a <code class="code">SELECT ... FOR UPDATE NOWAIT</code> in
              Oracle.</p></td></tr><tr><td>LockMode.READ</td><td><p>acquired automatically when Hibernate reads data under <span>Repeatable Read</span> or
              <span>Serializable</span> isolation level. It can be re-acquired by explicit user
              request.</p></td></tr><tr><td>LockMode.NONE</td><td><p>The absence of a lock. All objects switch to this lock mode at the end of a
              Transaction. Objects associated with the session via a call to <code class="methodname">update()</code> or
              <code class="methodname">saveOrUpdate()</code> also start out in this lock mode. </p></td></tr></tbody></table>
      </div>
      <p>
        The explicit user request mentioned above occurs as a consequence of any of the following actions:
      </p>
      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>
            A call to <code class="methodname">Session.load()</code>, specifying a LockMode.
          </p>
        </li><li class="listitem">
          <p>
            A call to <code class="methodname">Session.lock()</code>.
          </p>
        </li><li class="listitem">
          <p>
            A call to <code class="methodname">Query.setLockMode()</code>.
          </p>
        </li></ul></div>
      <p>
        If you call <code class="methodname">Session.load()</code> with option <code class="option">UPGRADE</code> or
        <code class="option">UPGRADE_NOWAIT</code>, and the requested object is not already loaded by the session, the object is
        loaded using <code class="code">SELECT ... FOR UPDATE</code>. If you call <code class="methodname">load()</code> for an object that
        is already loaded with a less restrictive lock than the one you request, Hibernate calls
        <code class="methodname">lock()</code> for that object.
      </p>
      <p>
        <code class="methodname">Session.lock()</code> performs a version number check if the specified lock mode is
        <code class="literal">READ</code>, <code class="literal">UPGRADE</code>, or <code class="literal">UPGRADE_NOWAIT</code>. In the case of
        <code class="literal">UPGRADE</code> or <code class="literal">UPGRADE_NOWAIT</code>, <code class="code">SELECT ... FOR UPDATE</code> syntax is
        used.
      </p>
      <p>
        If the requested lock mode is not supported by the database, Hibernate uses an appropriate alternate mode
        instead of throwing an exception. This ensures that applications are portable.
      </p>
    </div>
  </div>
<div class="footnotes"><br/><hr width="100" align="left"/><div class="footnote"><p><sup>[<a id="ftn.d5e1120" href="#d5e1120" class="para">1</a>] </sup><a class="ulink" href="http://en.wikipedia.org/wiki/Optimistic_locking">http://en.wikipedia.org/wiki/Optimistic_locking</a></p></div></div></div>
    <div class="chapter" title="Chapter 6. Caching"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1322"/>Chapter 6. Caching</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e1326">6.1. The query cache</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1353">6.1.1. Query cache regions</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1364">6.2. Second-level cache providers</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1369">6.2.1. Configuring your cache providers</a></span></dt><dt><span class="section"><a href="#caching-strategies-list">6.2.2. Caching strategies</a></span></dt><dt><span class="section"><a href="#caching-provider-table">6.2.3. Second-level cache providers for Hibernate</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1560">6.3. Managing the cache</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1562">6.3.1. Moving items into and out of the cache</a></span></dt></dl></dd></dl></div>

    

  <div class="section" title="6.1. The query cache"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1326"/>6.1. The query cache</h2></div></div></div>
    
    <p>
      If you have queries that run over and over, with the same parameters, query caching provides performance gains.
    </p>
    <p>
      Caching introduces overhead in the area of transactional processing. For example, if you cache results of a query
      against an object, Hibernate needs to keep track of whether any changes have been committed against the object,
      and invalidate the cache accordingly. In addition, the benefit from caching query results is limited, and highly
      dependent on the usage patterns of your application. For these reasons, Hibernate disables the query cache by
      default.
    </p>
    <div class="procedure" title="Procedure 6.1. Enabling the query cache"><a id="d5e1330"/><p class="title"><strong>Procedure 6.1. Enabling the query cache</strong></p><ol class="procedure" type="1"><li class="step" title="Set the hibernate.cache.use_query_cache property to true.">
        <p class="title"><strong>Set the <span class="property">hibernate.cache.use_query_cache</span> property to <code class="literal">true</code>.</strong></p>
        <p>
          This setting creates two new cache regions:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
            <p>
              <code class="code">org.hibernate.cache.internal.StandardQueryCache</code> holds the cached query results.
            </p>
          </li><li class="listitem">
            <p>
              <code class="code">org.hibernate.cache.spi.UpdateTimestampsCache</code> holds timestamps of the most recent updates to
              queryable tables. These timestamps validate results served from the query cache.
            </p>
          </li></ul></div>
      </li><li class="step" title="Adjust the cache timeout of the underlying cache region">
        <p class="title"><strong>Adjust the cache timeout of the underlying cache region</strong></p>
        <p>
          If you configure your underlying cache implementation to use expiry or timeouts, set the cache timeout of the
          underlying cache region for the <code class="code">UpdateTimestampsCache</code> to a higher value than the timeouts of any
          of the query caches. It is possible, and recommended, to set the UpdateTimestampsCache region never to
          expire. To be specific, a LRU (Least Recently Used) cache expiry policy is never appropriate.
        </p>
      </li><li class="step" title="Enable results caching for specific queries">
        <p class="title"><strong>Enable results caching for specific queries</strong></p>
        <p>
          Since most queries do not benefit from caching of their results, you need to enable caching for individual
          queries, e ven after enabling query caching overall. To enable results caching for a particular query, call
          <code class="methodname">org.hibernate.Query.setCacheable(true)</code>. This call allows the query to look for
          existing cache results or add its results to the cache when it is executed.
        </p>
      </li></ol></div>
    <p>
      The query cache does not cache the state of the actual entities in the cache. It caches identifier values and
      results of value type. Therefore, always use the query cache in conjunction with the second-level
      cache for those entities which should be cached as part of a query result cache.
    </p>
    
    <div class="section" title="6.1.1. Query cache regions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1353"/>6.1.1. Query cache regions</h3></div></div></div>
      
      <p>
        For fine-grained control over query cache expiration policies, specify a named cache region for a particular
        query by calling <code class="methodname">Query.setCacheRegion()</code>.
      </p>

      <div class="example"><a id="d5e1357"/><p class="title"><strong>Example 6.1. Method <code class="methodname">setCacheRegion</code></strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_plain">&nbsp;blogs&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sess</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;from&nbsp;Blog&nbsp;blog&nbsp;where&nbsp;blog.blogger&nbsp;=&nbsp;:blogger&quot;</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setEntity</span><span class="java_separator">(</span><span class="java_literal">&quot;blogger&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;blogger</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setMaxResults</span><span class="java_separator">(</span><span class="java_literal">15</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setCacheable</span><span class="java_separator">(</span><span class="java_literal">true</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setCacheRegion</span><span class="java_separator">(</span><span class="java_literal">&quot;frontpages&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
</pre>
      </div></div><br class="example-break"/>

      <p>
        To force the query cache to refresh one of its regions and disregard any cached results in the region, call
        <code class="code">org.hibernate.Query.setCacheMode(CacheMode.REFRESH)</code>. In conjunction with the region defined for the
        given query, Hibernate selectively refreshes the results cached in that particular region. This is much more
        efficient than bulk eviction of the region via <code class="code">org.hibernate.SessionFactory.evictQueries()</code>.
      </p>
      
    </div>

  </div>
  
  <div class="section" title="6.2. Second-level cache providers"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1364"/>6.2. Second-level cache providers</h2></div></div></div>
    
    <p>
      Hibernate is compatible with several second-level cache providers. None of the providers support all of
      Hibernate's possible caching strategies. <a class="xref" href="#caching-provider-table" title="6.2.3. Second-level cache providers for Hibernate">Section 6.2.3, “Second-level cache providers for Hibernate”</a> lists the providers, along with
      their interfaces and supported caching strategies. For definitions of caching strategies, see <a class="xref" href="#caching-strategies-list" title="6.2.2. Caching strategies">Section 6.2.2, “Caching strategies”</a>.
    </p>
    
    <div class="section" title="6.2.1. Configuring your cache providers"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1369"/>6.2.1. Configuring your cache providers</h3></div></div></div>
      
      <p>
        You can configure your cache providers using either annotations or mapping files.
      </p>
      <p title="Entities">
        <strong>Entities. </strong>
        
          By default, entities are not part of the second-level cache, and their use is not recommended. If you
          absolutely must use entities, set the <code class="code">shared-cache-mode</code> element in
          <code class="filename">persistence.xml</code>, or use property <span class="property">javax.persistence.sharedCache.mode</span>
          in your configuration. Use one of the values in <a class="xref" href="#shared-cache-mode-values" title="Table 6.1. Possible values for Shared Cache Mode">Table 6.1, “Possible values for Shared Cache Mode”</a>.
        
      </p>
      <div class="table"><a id="shared-cache-mode-values"/><p class="title"><strong>Table 6.1. Possible values for Shared Cache Mode</strong></p><div class="table-contents">
        
        <table summary="Possible values for Shared Cache Mode" border="1"><colgroup><col/><col/></colgroup><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>ENABLE_SELECTIVE</td><td>
                <p>
                  Entities are not cached unless you explicitly mark them as cachable. This is the default and
                  recommended value.
                </p>
              </td></tr><tr><td>DISABLE_SELECTIVE</td><td>
                <p>
                  Entities are cached unless you explicitly mark them as not cacheable.
                </p>
              </td></tr><tr><td>ALL</td><td>
                <p>
                  All entities are always cached even if you mark them as not cacheable.
                </p>
              </td></tr><tr><td>NONE</td><td>
                <p>
                  No entities are cached even if you mark them as cacheable. This option basically disables second-level
                  caching.
                </p>
              </td></tr></tbody></table>
      </div></div><br class="table-break"/>
      <p>
        Set the global default cache concurrency strategy The cache concurrency strategy with the
        <span class="property">hibernate.cache.default_cache_concurrency_strategy</span> configuration property. See <a class="xref" href="#caching-strategies-list" title="6.2.2. Caching strategies">Section 6.2.2, “Caching strategies”</a> for possible values.
      </p>
      <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
          When possible, define the cache concurrency strategy per entity rather than globally. Use the
          <code class="code">@org.hibernate.annotations.Cache</code> annotation.
        </p>
      </div>
      <div class="example"><a id="configuring-cache-providers-annotations"/><p class="title"><strong>Example 6.2. Configuring cache providers using annotations</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Cacheable</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Cache</span><span class="java_separator">(</span><span class="java_plain">usage&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">CacheConcurrencyStrategy</span><span class="java_separator">.</span><span class="java_plain">NONSTRICT_READ_WRITE</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Forest</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span></pre>
        <p>
          You can cache the content of a collection or the identifiers, if the collection contains other entities. Use
          the <code class="code">@Cache</code> annotation on the Collection property.
        </p>
        <p>
          <code class="code">@Cache</code> can take several attributes.
        </p>
        <div class="variablelist" title="Attributes of @Cache annotation"><p class="title"><strong>Attributes of <code class="code">@Cache</code> annotation</strong></p><dl><dt><span class="term">usage</span></dt><dd>
              <p>
                The given cache concurrency strategy, which may be:
              </p>
              <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                  <p>
                    <code class="literal">NONE</code>
                  </p>
                </li><li class="listitem">
                  <p>
                    <code class="literal">READ_ONLY</code>
                  </p>
                </li><li class="listitem">
                  <p>
                    <code class="literal">NONSTRICT_READ_WRITE</code>
                  </p>
                </li><li class="listitem">
                  <p>
                    <code class="literal">READ_WRITE</code>
                  </p>
                </li><li class="listitem">
                  <p>
                    <code class="literal">TRANSACTIONAL</code>
                  </p>
                </li></ul></div>
            </dd><dt><span class="term">region</span></dt><dd>
              <p>
                The cache region. This attribute is optional, and defaults to the fully-qualified class name of the
                class, or the qually-qualified role name of the collection.
              </p>
            </dd><dt><span class="term">include</span></dt><dd>
              <p>
                Whether or not to include all properties.. Optional, and can take one of two possible values.
              </p>
              <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                  <p>
                    A value of <code class="literal">all</code> includes all properties. This is the default.
                  </p>
                </li><li class="listitem">
                  <p>
                    A value of <code class="literal">non-lazy</code> only includes non-lazy properties.
                  </p>
                </li></ul></div>
            </dd></dl></div>
      </div></div><br class="example-break"/>

      <div class="example"><a id="d5e1454"/><p class="title"><strong>Example 6.3. Configuring cache providers using mapping files</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">cache</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">usage</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;transactional&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">region</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;RegionName&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">include</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;all&quot;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
</pre>
        <p>
          Just as in the <a class="xref" href="#configuring-cache-providers-annotations" title="Example 6.2. Configuring cache providers using annotations">Example 6.2, “Configuring cache providers using annotations”</a>, you can provide attributes in the
          mapping file. There are some specific differences in the syntax for the attributes in a mapping file.
        </p>
        <div class="variablelist"><dl><dt><span class="term">usage</span></dt><dd>
              <p>
                The caching strategy. This attribute is required, and can be any of the following values.
              </p>
              <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>transactional</p></li><li class="listitem"><p>read-write</p></li><li class="listitem"><p>nonstrict-read-write</p></li><li class="listitem"><p>read-only</p></li></ul></div>
            </dd><dt><span class="term">region</span></dt><dd>
              <p>
                The name of the second-level cache region. This optional attribute defaults to the class or collection
                role name.
              </p>
            </dd><dt><span class="term">include</span></dt><dd>
              <p>
                Whether properties of the entity mapped with <code class="literal">lazy=true</code> can be cached when
                attribute-level lazy fetching is enabled. Defaults to <code class="literal">all</code> and can also be
                <code class="literal">non-lazy</code>.
              </p>
            </dd></dl></div>
        <p>
          Instead of <code class="code">&lt;cache&gt;</code>, you can use <code class="code">&lt;class-cache&gt;</code> and
          <code class="code">&lt;collection-cache&gt;</code> elements in <code class="filename">hibernate.cfg.xml</code>.
        </p>
      </div></div><br class="example-break"/>
    </div>
    <div class="section" title="6.2.2. Caching strategies"><div class="titlepage"><div><div><h3 class="title"><a id="caching-strategies-list"/>6.2.2. Caching strategies</h3></div></div></div>
      
      <div class="variablelist"><dl><dt><span class="term">read-only</span></dt><dd>
            <p>
              A read-only cache is good for data that needs to be read often but not modified. It is simple, performs
              well, and is safe to use in a clustered environment.
            </p>
          </dd><dt><span class="term">nonstrict read-write</span></dt><dd>
            <p>
              Some applications only rarely need to modify data. This is the case if two transactions are unlikely to
              try to update the same item simultaneously. In this case, you do not need strict transaction isolation,
              and a nonstrict-read-write cache might be appropriate. If the cache is used in a JTA environment, you must
              specify <code class="classname">hibernate.transaction.manager_lookup_class</code>. In other environments, ensore
              that the transaction is complete before you call <code class="methodname">Session.close()</code> or
              <code class="methodname">Session.disconnect()</code>.
            </p>
          </dd><dt><span class="term">read-write</span></dt><dd>
            <p>
              A read-write cache is appropriate for an application which needs to update data regularly. Do not use a
              read-write strategy if you need serializable transaction isolation. In a JTA environment, specify a
              strategy for obtaining the JTA TransactionManager by setting the property
              <span class="property">hibernate.transaction.manager_lookup_class</span>. In non-JTA environments, be sure the
              transaction is complete before you call <code class="methodname">Session.close()</code> or
              <code class="methodname">Session.disconnect()</code>.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
              <p>
                To use the read-write strategy in a clustered environment, the underlying cache implementation must
                support locking. The build-in cache providers do not support locking.
              </p>
            </div>
          </dd><dt><span class="term">transactional</span></dt><dd>
            <p>
              The transactional cache strategy provides support for transactional cache providers such as JBoss
              TreeCache. You can only use such a cache in a JTA environment, and you must first specify
              <code class="classname">hibernate.transaction.manager_lookup_class</code>.
            </p>
          </dd></dl></div>
    </div>
    <div class="section" title="6.2.3. Second-level cache providers for Hibernate"><div class="titlepage"><div><div><h3 class="title"><a id="caching-provider-table"/>6.2.3. Second-level cache providers for Hibernate</h3></div></div></div>
      
      <div class="informaltable">
        <table border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Cache</th><th>Interface</th><th>Supported strategies</th><td class="auto-generated"> </td><td class="auto-generated"> </td></tr></thead><tbody><tr><td>HashTable (testing only)</td><td> </td><td>
                <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>read-only</p></li><li class="listitem"><p>nonstrict read-write</p></li><li class="listitem"><p>read-write</p></li></ul></div>
              </td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td>EHCache</td><td> </td><td>
                <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>read-only</p></li><li class="listitem"><p>nonstrict read-write</p></li><li class="listitem"><p>read-write</p></li><li class="listitem"><p>transactional</p></li></ul></div>
              </td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td>Infinispan</td><td> </td><td>
                <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>read-only</p></li><li class="listitem"><p>transactional</p></li></ul></div>
              </td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr></tbody></table>
      </div>
    </div>
  </div>

  <div class="section" title="6.3. Managing the cache"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1560"/>6.3. Managing the cache</h2></div></div></div>
    
    
    <div class="section" title="6.3.1. Moving items into and out of the cache"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1562"/>6.3.1. Moving items into and out of the cache</h3></div></div></div>
      
      <div class="variablelist" title="Actions that add an item to internal cache of the Session"><p class="title"><strong>Actions that add an item to internal cache of the Session</strong></p><dl><dt><span class="term">Saving or updating an item</span></dt><dd>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                  <code class="methodname">save()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">update()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">saveOrUpdate()</code>
                </p>
              </li></ul></div>
          </dd><dt><span class="term">Retrieving an item</span></dt><dd>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                  <code class="methodname">load()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">get()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">list()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">iterate()</code>
                </p>
              </li><li class="listitem">
                <p>
                  <code class="methodname">scroll()</code>
                </p>
              </li></ul></div>
          </dd></dl></div>
      <p title="Syncing or removing a cached item">
        <strong>Syncing or removing a cached item. </strong>
        
          The state of an object is synchronized with the database when you call method
          <code class="methodname">flush()</code>. To avoid this synchronization, you can remove the object and all collections
          from the first-level cache with the <code class="methodname">evict()</code> method. To remove all items from the
          Session cache, use method <code class="methodname">Session.clear()</code>.
        
      </p>
      <div class="example"><a id="d5e1604"/><p class="title"><strong>Example 6.4. Evicting an item from the first-level cache</strong></p><div class="example-contents">
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">ScrollableResult</span><!-- <br/> --><span class="java_plain">&nbsp;cats&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sess</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;from&nbsp;Cat&nbsp;as&nbsp;cat&quot;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">scroll</span><!-- <br/> --><span class="java_separator">();</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">a&nbsp;huge&nbsp;result&nbsp;set</span>
<!--  --><br/><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cats</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;cat&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">)</span><span class="java_plain">&nbsp;cats</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;doSomethingWithACat</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;sess</span><span class="java_separator">.</span><span class="java_plain">evict</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre>
      </div></div><br class="example-break"/>
      <p title="Determining whether an item belongs to the Session cache">
        <strong>Determining whether an item belongs to the Session cache. </strong>
        
          The Session provides a <code class="methodname">contains()</code> method to determine if an instance belongs to the
          session cache.
        
      </p>
      
      <div class="example"><a id="d5e1611"/><p class="title"><strong>Example 6.5. Second-level cache eviction</strong></p><div class="example-contents">
        
        <p>
          You can evict the cached state of an instance, entire class, collection instance or entire collection role,
          using methods of <code class="classname">SessionFactory</code>.
        </p>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getCache</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">containsEntity</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;catId</span><!-- <br/> --><span class="java_separator">);</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;is&nbsp;</span><!-- <br/> --><span class="java_keyword">this</span><!-- <br/> --><span class="java_plain">&nbsp;particular&nbsp;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_plain">&nbsp;currently&nbsp;in&nbsp;the&nbsp;cache</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictEntity</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;catId</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;a&nbsp;particular&nbsp;</span><span class="java_type">Cat</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictEntityRegion</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;all&nbsp;</span><span class="java_type">Cats</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictEntityRegions</span><span class="java_separator">();</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;all&nbsp;entity&nbsp;data</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">containsCollection</span><span class="java_separator">(</span><span class="java_literal">&quot;Cat.kittens&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;catId</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;is&nbsp;</span><span class="java_keyword">this</span><span class="java_plain">&nbsp;particular&nbsp;collection&nbsp;currently&nbsp;in&nbsp;the&nbsp;cache</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictCollection</span><span class="java_separator">(</span><span class="java_literal">&quot;Cat.kittens&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;catId</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;a&nbsp;particular&nbsp;collection&nbsp;of&nbsp;kittens</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictCollectionRegion</span><span class="java_separator">(</span><span class="java_literal">&quot;Cat.kittens&quot;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;all&nbsp;kitten&nbsp;collections</span>
</span>
<!--  --><br/><span class="java_plain">sessionFactory</span><span class="java_separator">.</span><span class="java_plain">getCache</span><span class="java_separator">().</span><span class="java_plain">evictCollectionRegions</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;evict&nbsp;all&nbsp;collection&nbsp;data</span></pre>
      </div></div><br class="example-break"/>       
      <div class="section" title="6.3.1.1. Interactions between a Session and the second-level cache"><div class="titlepage"><div><div><h4 class="title"><a id="d5e1616"/>6.3.1.1. Interactions between a Session and the second-level cache</h4></div></div></div>
        
        <p>
          The CacheMode controls how a particular session interacts with the second-level cache.
        </p>
        <div class="informaltable">
          <table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>CacheMode.NORMAL</td><td>reads items from and writes them to the second-level cache.</td></tr><tr><td>CacheMode.GET</td><td>reads items from the second-level cache, but does not write to the second-level cache except to
                update data.</td></tr><tr><td>CacheMode.PUT</td><td>writes items to the second-level cache. It does not read from the second-level cache. It bypasses
                the effect of <span class="property">hibernate.cache.use_minimal_puts</span> and forces a refresh of the
                second-level cache for all items read from the database.</td></tr></tbody></table>
        </div>
      </div>
      
      <div class="section" title="6.3.1.2. Browsing the contents of a second-level or query cache region"><div class="titlepage"><div><div><h4 class="title"><a id="d5e1632"/>6.3.1.2. Browsing the contents of a second-level or query cache region</h4></div></div></div>
        
        <p>
          After enabling statistics, you can browse the contents of a second-level cache or query cache region.
        </p>
        <div class="procedure" title="Procedure 6.2. Enabling Statistics"><a id="d5e1635"/><p class="title"><strong>Procedure 6.2. Enabling Statistics</strong></p><ol class="procedure" type="1"><li class="step" title="Step 1">
            <p>
              Set <code class="code">hibernate.generate_statistics</code> to <code class="literal">true</code>.
            </p>
          </li><li class="step" title="Step 2">
            <p>
              Optionally, set <code class="code">hibernate.cache.use_structured_entries</code> to <code class="literal">true</code>, to cause
              Hibernate to store the cache entries in a human-readable format.
            </p>
          </li></ol></div>
        <div class="example"><a id="d5e1645"/><p class="title"><strong>Example 6.6. Browsing the second-level cache entries via the Statistics API</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Map</span><!-- <br/> --><span class="java_plain">&nbsp;cacheEntries&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getStatistics</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getSecondLevelCacheStatistics</span><span class="java_separator">(</span><span class="java_plain">regionName</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getEntries</span><span class="java_separator">();</span></pre>
        </div></div><br class="example-break"/>
      </div>
    </div>
  </div>
</div>
    <div class="chapter" title="Chapter 7. Services"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1648"/>Chapter 7. Services</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e1650">7.1. What are services?</a></span></dt><dt><span class="section"><a href="#d5e1653">7.2. Service contracts</a></span></dt><dt><span class="section"><a href="#d5e1661">7.3. Service dependencies</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1664">7.3.1. @<code class="interfacename">org.hibernate.service.spi.InjectService</code></a></span></dt><dt><span class="section"><a href="#d5e1677">7.3.2. <code class="interfacename">org.hibernate.service.spi.ServiceRegistryAwareService</code></a></span></dt></dl></dd><dt><span class="section"><a href="#services-registry">7.4. ServiceRegistry</a></span></dt><dt><span class="section"><a href="#d5e1693">7.5. Standard services</a></span></dt><dd><dl><dt><span class="section"><a href="#services-BatchBuilder">7.5.1. <code class="interfacename">org.hibernate.engine.jdbc.batch.spi.BatchBuilder</code></a></span></dt><dt><span class="section"><a href="#services-ConfigurationService">7.5.2. <code class="interfacename">org.hibernate.service.config.spi.ConfigurationService</code></a></span></dt><dt><span class="section"><a href="#services-ConnectionProvider">7.5.3. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#services-DialectFactory">7.5.4. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectFactory</code></a></span></dt><dt><span class="section"><a href="#services-DialectResolver">7.5.5. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code></a></span></dt><dt><span class="section"><a href="#services-JdbcServices">7.5.6. <code class="interfacename">org.hibernate.engine.jdbc.spi.JdbcServices</code></a></span></dt><dt><span class="section"><a href="#services-JmxService">7.5.7. <code class="interfacename">org.hibernate.service.jmx.spi.JmxService</code></a></span></dt><dt><span class="section"><a href="#services-JndiService">7.5.8. <code class="interfacename">org.hibernate.service.jndi.spi.JndiService</code></a></span></dt><dt><span class="section"><a href="#services-JtaPlatform">7.5.9. <code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code></a></span></dt><dt><span class="section"><a href="#services-MultiTenantConnectionProvider">7.5.10. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#services-PersisterClassResolver">7.5.11. <code class="interfacename">org.hibernate.persister.spi.PersisterClassResolver</code></a></span></dt><dt><span class="section"><a href="#services-PersisterFactory">7.5.12. <code class="interfacename">org.hibernate.persister.spi.PersisterFactory</code></a></span></dt><dt><span class="section"><a href="#services-RegionFactory">7.5.13. <code class="interfacename">org.hibernate.cache.spi.RegionFactory</code></a></span></dt><dt><span class="section"><a href="#services-SessionFactoryServiceRegistryFactory">7.5.14. <code class="interfacename">org.hibernate.service.spi.SessionFactoryServiceRegistryFactory</code></a></span></dt><dt><span class="section"><a href="#services-Statistics">7.5.15. <code class="interfacename">org.hibernate.stat.Statistics</code></a></span></dt><dt><span class="section"><a href="#services-TransactionFactory">7.5.16. <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code></a></span></dt><dt><span class="section"><a href="#services-ImportSqlCommandExtractor">7.5.17. <code class="interfacename">org.hibernate.tool.hbm2ddl.ImportSqlCommandExtractor</code></a></span></dt></dl></dd><dt><span class="section"><a href="#d5e2138">7.6. Custom services</a></span></dt><dt><span class="section"><a href="#d5e2157">7.7. Special service registries</a></span></dt><dd><dl><dt><span class="section"><a href="#services-registry-bootstrap">7.7.1. Boot-strap registry</a></span></dt><dt><span class="section"><a href="#services-registry-sessionfactory">7.7.2. SessionFactory registry</a></span></dt></dl></dd><dt><span class="section"><a href="#services-use">7.8. Using services and registries</a></span></dt><dt><span class="section"><a href="#integrators">7.9. Integrators</a></span></dt><dd><dl><dt><span class="section"><a href="#integrators-uses">7.9.1. Integrator use-cases</a></span></dt></dl></dd></dl></div>

    

    <div class="section" title="7.1. What are services?"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1650"/>7.1. What are services?</h2></div></div></div>
        
        <p>
            Services are classes that provide Hibernate with pluggable implementations of various types of
            functionality.  Specifically they are implementations of certain service contract interfaces.  The interface
            is known as the service role; the implementation class is know as the service implementation.  Generally
            speaking, users can plug in alternate implementations of all standard service roles (overriding); they can
            also define additional services beyond the base set of service roles (extending).
        </p>
    </div>

    <div class="section" title="7.2. Service contracts"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1653"/>7.2. Service contracts</h2></div></div></div>
        
        <p>
            The basic requirement for a service is to implement the marker interface
            <code class="interfacename">org.hibernate.service.Service</code>.  Hibernate uses this internally for some
            basic type safety.
        </p>
        <p>
            Optionally, the service can also implement the
            <code class="interfacename">org.hibernate.service.spi.Startable</code> and
            <code class="interfacename">org.hibernate.service.spi.Stoppable</code> interfaces to receive notifications
            of being started and stopped.  Another optional service contract is
            <code class="interfacename">org.hibernate.service.spi.Manageable</code> which marks the service as manageable
            in JMX provided the JMX integration is enabled.
        </p>
    </div>

    <div class="section" title="7.3. Service dependencies"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1661"/>7.3. Service dependencies</h2></div></div></div>
        
        <p>
            Services are allowed to declare dependencies on other services using either of 2 approaches.
        </p>
        <div class="section" title="7.3.1. @org.hibernate.service.spi.InjectService"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1664"/>7.3.1. @<code class="interfacename">org.hibernate.service.spi.InjectService</code></h3></div></div></div>
            
            <p>
                Any method on the service implementation class accepting a single parameter and annotated with
                @<code class="interfacename">InjectService</code> is considered requesting injection of another service.
            </p>
            <p>
                By default the type of the method parameter is expected to be the service role to be injected.  If the
                parameter type is different than the service role, the <code class="methodname">serviceRole</code> attribute
                of the <code class="interfacename">InjectService</code> should be used to explicitly name the role.
            </p>
            <p>
                By default injected services are considered required, that is the start up will fail if a named
                dependent service is missing.  If the service to be injected is optional, the
                <code class="methodname">required</code> attribute of the <code class="interfacename">InjectService</code>
                should be declared as <code class="literal">false</code> (default is <code class="literal">true</code>).
            </p>
        </div>
        <div class="section" title="7.3.2. org.hibernate.service.spi.ServiceRegistryAwareService"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1677"/>7.3.2. <code class="interfacename">org.hibernate.service.spi.ServiceRegistryAwareService</code></h3></div></div></div>
            
            <p>
                The second approach is a pull approach where the service implements the optional service interface
                <code class="interfacename">org.hibernate.service.spi.ServiceRegistryAwareService</code> which declares
                a single <code class="methodname">injectServices</code> method.  During startup, Hibernate will inject the
                <code class="interfacename">org.hibernate.service.ServiceRegistry</code> itself into services which
                implement this interface.  The service can then use the <code class="interfacename">ServiceRegistry</code>
                reference to locate any additional services it needs.
            </p>
        </div>
    </div>

    <div class="section" title="7.4. ServiceRegistry"><div class="titlepage"><div><div><h2 class="title"><a id="services-registry"/>7.4. ServiceRegistry</h2></div></div></div>
        
        <p>
            The central service API, aside from the services themselves, is the
            <code class="interfacename">org.hibernate.service.ServiceRegistry</code> interface. The main purpose of
            a service registry is to hold, manage and provide access to services.
        </p>
        <p>
            Service registries are hierarchical.  Services in one registry can depend on and utilize services in that
            same registry as well as any parent registries.
        </p>
        <p>
            Use <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code> to build a
            <code class="interfacename">org.hibernate.service.ServiceRegistry</code> instance.
        </p>
    </div>


    <div class="section" title="7.5. Standard services"><div class="titlepage"><div><div><h2 class="title"><a id="d5e1693"/>7.5. Standard services</h2></div></div></div>
        

        <div class="section" title="7.5.1. org.hibernate.engine.jdbc.batch.spi.BatchBuilder"><div class="titlepage"><div><div><h3 class="title"><a id="services-BatchBuilder"/>7.5.1. <code class="interfacename">org.hibernate.engine.jdbc.batch.spi.BatchBuilder</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Defines strategy for how Hibernate manages JDBC statement batching
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.engine.jdbc.batch.internal.BatchBuilderInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.engine.jdbc.batch.internal.BatchBuilderImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.2. org.hibernate.service.config.spi.ConfigurationService"><div class="titlepage"><div><div><h3 class="title"><a id="services-ConfigurationService"/>7.5.2. <code class="interfacename">org.hibernate.service.config.spi.ConfigurationService</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Provides access to the configuration settings, combining those explicitly provided as well
                            as those contributed by any registered
                            <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> implementations
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.config.internal.ConfigurationServiceInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.config.internal.ConfigurationServiceImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.3. org.hibernate.service.jdbc.connections.spi.ConnectionProvider"><div class="titlepage"><div><div><h3 class="title"><a id="services-ConnectionProvider"/>7.5.3. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Defines the means in which Hibernate can obtain and release
                            <code class="interfacename">java.sql.Connection</code> instances for its use.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jdbc.connections.internal.ConnectionProviderInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jdbc.connections.internal.C3P0ConnectionProvider</code> -
                                    provides connection pooling based on integration with the C3P0 connection pooling library
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jdbc.connections.internal.DatasourceConnectionProviderImpl</code> -
                                    provides connection managed delegated to a
                                    <code class="interfacename">javax.sql.DataSource</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jdbc.connections.internal.DriverManagerConnectionProviderImpl</code> -
                                    provides rudimentary connection pooling based on simple custom pool.  Note intended
                                    production use!
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jdbc.connections.internal.ProxoolConnectionProvider</code> -
                                    provides connection pooling based on integration with the proxool connection pooling library
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jdbc.connections.internal.UserSuppliedConnectionProviderImpl</code> -
                                    Provides no connection support.  Indicates the user will supply connections to Hibernate directly.
                                    Not recommended for use.
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.4. org.hibernate.service.jdbc.dialect.spi.DialectFactory"><div class="titlepage"><div><div><h3 class="title"><a id="services-DialectFactory"/>7.5.4. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectFactory</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Contract for Hibernate to obtain <code class="classname">org.hibernate.dialect.Dialect</code>
                            instance to use.  This is either explicitly defined by the
                            <span class="property">hibernate.dialect</span> property or determined by the
                            <a class="xref" href="#services-DialectResolver" title="7.5.5. org.hibernate.service.jdbc.dialect.spi.DialectResolver">Section 7.5.5, “<code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code>”</a> service which is a delegate to this service.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.DialectFactoryInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.DialectFactoryImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.5. org.hibernate.service.jdbc.dialect.spi.DialectResolver"><div class="titlepage"><div><div><h3 class="title"><a id="services-DialectResolver"/>7.5.5. <code class="interfacename">org.hibernate.service.jdbc.dialect.spi.DialectResolver</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Provides resolution of <code class="classname">org.hibernate.dialect.Dialect</code> to use based on
                            information extracted from JDBC metadata.
                        </p>
                        <p>
                            The standard resolver implementation acts as a chain, delegating to a series of individual
                            resolvers.  The standard Hibernate resolution behavior is contained in
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.StandardDialectResolver</code>.
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.DialectResolverInitiator</code>
                            also consults with the <span class="property">hibernate.dialect_resolvers</span> setting for any
                            custom resolvers.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.DialectResolverInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jdbc.dialect.internal.DialectResolverSet</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.6. org.hibernate.engine.jdbc.spi.JdbcServices"><div class="titlepage"><div><div><h3 class="title"><a id="services-JdbcServices"/>7.5.6. <code class="interfacename">org.hibernate.engine.jdbc.spi.JdbcServices</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Special type of service that aggregates together a number of other services and provides
                            a higher-level set of functionality.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.engine.jdbc.internal.JdbcServicesInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.engine.jdbc.internal.JdbcServicesImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.7. org.hibernate.service.jmx.spi.JmxService"><div class="titlepage"><div><div><h3 class="title"><a id="services-JmxService"/>7.5.7. <code class="interfacename">org.hibernate.service.jmx.spi.JmxService</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Provides simplified access to JMX related features needed by Hibernate.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jmx.internal.JmxServiceInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jmx.internal.DisabledJmxServiceImpl</code> -
                                    A no-op implementation when JMX functionality is disabled.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jmx.internal.JmxServiceImpl</code> -
                                    Standard implementation of JMX handling
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.8. org.hibernate.service.jndi.spi.JndiService"><div class="titlepage"><div><div><h3 class="title"><a id="services-JndiService"/>7.5.8. <code class="interfacename">org.hibernate.service.jndi.spi.JndiService</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Provides simplified access to JNDI related features needed by Hibernate.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jndi.internal.JndiServiceInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jndi.internal.JndiServiceImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.9. org.hibernate.service.jta.platform.spi.JtaPlatform"><div class="titlepage"><div><div><h3 class="title"><a id="services-JtaPlatform"/>7.5.9. <code class="interfacename">org.hibernate.service.jta.platform.spi.JtaPlatform</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Provides an abstraction from the underlying JTA platform when JTA features are used.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.jta.platform.internal.JtaPlatformInitiator</code>
                        </p>
                        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                            <p>
                                <code class="classname">JtaPlatformInitiator</code> provides mapping against the legacy,
                                now-deprecated <code class="interfacename">org.hibernate.transaction.TransactionManagerLookup</code>
                                names internally for the Hibernate-provided
                                <code class="interfacename">org.hibernate.transaction.TransactionManagerLookup</code>
                                implementations.
                            </p>
                        </div>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.BitronixJtaPlatform</code> -
                                    Integration with the Bitronix stand-alone transaction manager.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.BorlandEnterpriseServerJtaPlatform</code> -
                                    Integration with the transaction manager as deployed within a Borland Enterprise Server
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.JBossAppServerJtaPlatform</code> -
                                    Integration with the transaction manager as deployed within a JBoss Application Server
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.JBossStandAloneJtaPlatform</code> -
                                    Integration with the JBoss Transactions stand-alone transaction manager
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.JOTMJtaPlatform</code> -
                                    Integration with the JOTM stand-alone transaction manager
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.JOnASJtaPlatform</code> -
                                    Integration with the JOnAS transaction manager.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.JRun4JtaPlatform</code> -
                                    Integration with the transaction manager as deployed in a JRun 4 application server.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.NoJtaPlatform</code> -
                                    No-op version when no JTA set up is configured
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.OC4JJtaPlatform</code> -
                                    Integration with transaction manager as deployed in an OC4J (Oracle) application
                                    server.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.OrionJtaPlatform</code> -
                                    Integration with transaction manager as deployed in an Orion application server.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.ResinJtaPlatform</code> -
                                    Integration with transaction manager as deployed in a Resin application server.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.SunOneJtaPlatform</code> -
                                    Integration with transaction manager as deployed in a Sun ONE (7 and above)
                                    application server.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.TransactionManagerLookupBridge</code> -
                                    Provides a bridge to legacy (and deprecated)
                                    <code class="interfacename">org.hibernate.transaction.TransactionManagerLookup</code>
                                    implementations
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.WebSphereExtendedJtaPlatform</code> -
                                    Integration with transaction manager as deployed in a WebSphere Application Server
                                    (6 and above).
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.WebSphereJtaPlatform</code> -
                                    Integration with transaction manager as deployed in a WebSphere Application Server
                                    (4, 5.0 and 5.1).
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.service.jta.platform.internal.WeblogicJtaPlatform</code> -
                                    Integration with transaction manager as deployed in a Weblogic application server.
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.10. org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider"><div class="titlepage"><div><div><h3 class="title"><a id="services-MultiTenantConnectionProvider"/>7.5.10. <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            A variation of <a class="xref" href="#services-ConnectionProvider" title="7.5.3. org.hibernate.service.jdbc.connections.spi.ConnectionProvider">Section 7.5.3, “<code class="interfacename">org.hibernate.service.jdbc.connections.spi.ConnectionProvider</code>”</a> providing access to JDBC
                            connections in multi-tenant environments.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            N/A
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            Intended that users provide appropriate implementation if needed.
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.11. org.hibernate.persister.spi.PersisterClassResolver"><div class="titlepage"><div><div><h3 class="title"><a id="services-PersisterClassResolver"/>7.5.11. <code class="interfacename">org.hibernate.persister.spi.PersisterClassResolver</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Contract for determining the appropriate
                            <code class="interfacename">org.hibernate.persister.entity.EntityPersister</code>
                            or <code class="interfacename">org.hibernate.persister.collection.CollectionPersister</code>
                            implementation class to use given an entity or collection mapping.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.persister.internal.PersisterClassResolverInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.persister.internal.StandardPersisterClassResolver</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.12. org.hibernate.persister.spi.PersisterFactory"><div class="titlepage"><div><div><h3 class="title"><a id="services-PersisterFactory"/>7.5.12. <code class="interfacename">org.hibernate.persister.spi.PersisterFactory</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Factory for creating
                            <code class="interfacename">org.hibernate.persister.entity.EntityPersister</code>
                            and <code class="interfacename">org.hibernate.persister.collection.CollectionPersister</code>
                            instances.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.persister.internal.PersisterFactoryInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.persister.internal.PersisterFactoryImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.13. org.hibernate.cache.spi.RegionFactory"><div class="titlepage"><div><div><h3 class="title"><a id="services-RegionFactory"/>7.5.13. <code class="interfacename">org.hibernate.cache.spi.RegionFactory</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Integration point for Hibernate's second level cache support.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.cache.internal.RegionFactoryInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.cache.ehcache.EhCacheRegionFactory</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.cache.infinispan.InfinispanRegionFactory</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.cache.infinispan.JndiInfinispanRegionFactory</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.cache.internal.NoCachingRegionFactory</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.cache.ehcache.SingletonEhCacheRegionFactory</code>
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.14. org.hibernate.service.spi.SessionFactoryServiceRegistryFactory"><div class="titlepage"><div><div><h3 class="title"><a id="services-SessionFactoryServiceRegistryFactory"/>7.5.14. <code class="interfacename">org.hibernate.service.spi.SessionFactoryServiceRegistryFactory</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Factory for creating
                            <code class="interfacename">org.hibernate.service.spi.SessionFactoryServiceRegistry</code>
                            instances which acts as a specialized
                            <code class="interfacename">org.hibernate.service.ServiceRegistry</code> for
                            <code class="interfacename">org.hibernate.SessionFactory</code> scoped services.  See
                            <a class="xref" href="#services-registry-sessionfactory" title="7.7.2. SessionFactory registry">Section 7.7.2, “SessionFactory registry”</a> for more details.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.internal.SessionFactoryServiceRegistryFactoryInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.service.internal.SessionFactoryServiceRegistryFactoryImpl</code>
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.15. org.hibernate.stat.Statistics"><div class="titlepage"><div><div><h3 class="title"><a id="services-Statistics"/>7.5.15. <code class="interfacename">org.hibernate.stat.Statistics</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Contract for exposing collected statistics.  The statistics are collected through the
                            <code class="interfacename">org.hibernate.stat.spi.StatisticsImplementor</code> contract.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.stat.internal.StatisticsInitiator</code>
                        </p>
                        <p>
                            Defines a <span class="property">hibernate.stats.factory</span> setting to allow
                            configuring the
                            <code class="interfacename">org.hibernate.stat.spi.StatisticsFactory</code> to use internally
                            when building the actual
                            <code class="interfacename">org.hibernate.stat.Statistics</code> instance.
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.stat.internal.ConcurrentStatisticsImpl</code>
                        </p>
                        <p>
                            The default <code class="interfacename">org.hibernate.stat.spi.StatisticsFactory</code>
                            implementation builds a
                            <code class="classname">org.hibernate.stat.internal.ConcurrentStatisticsImpl</code> instance.
                        </p>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.16. org.hibernate.engine.transaction.spi.TransactionFactory"><div class="titlepage"><div><div><h3 class="title"><a id="services-TransactionFactory"/>7.5.16. <code class="interfacename">org.hibernate.engine.transaction.spi.TransactionFactory</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Strategy defining how Hibernate's <code class="interfacename">org.hibernate.Transaction</code>
                            API maps to the underlying transaction approach.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.stat.internal.StatisticsInitiator</code>
                        </p>
                        <p>
                            Defines a <span class="property">hibernate.stats.factory</span> setting to allow
                            configuring the
                            <code class="interfacename">org.hibernate.stat.spi.StatisticsFactory</code> to use internally
                            when building the actual
                            <code class="interfacename">org.hibernate.stat.Statistics</code> instance.
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.engine.transaction.internal.jta.CMTTransactionFactory</code> -
                                    A JTA-based strategy in which Hibernate is not controlling the transactions.  An
                                    important distinction here is that interaction with the underlying JTA implementation
                                    is done through the
                                    <code class="interfacename">javax.transaction.TransactionManager</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.engine.transaction.internal.jdbc.JdbcTransactionFactory</code> -
                                    A non-JTA strategy in which the transactions are managed using the JDBC
                                    <code class="interfacename">java.sql.Connection</code>
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.engine.transaction.internal.jta.JtaTransactionFactory</code> -
                                    A JTA-based strategy in which Hibernate *may* be controlling the transactions.  An
                                    important distinction here is that interaction with the underlying JTA
                                    implementation is done through the
                                    <code class="interfacename">javax.transaction.UserTransaction</code>
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

        <div class="section" title="7.5.17. org.hibernate.tool.hbm2ddl.ImportSqlCommandExtractor"><div class="titlepage"><div><div><h3 class="title"><a id="services-ImportSqlCommandExtractor"/>7.5.17. <code class="interfacename">org.hibernate.tool.hbm2ddl.ImportSqlCommandExtractor</code></h3></div></div></div>
            
            <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                        <p>
                            Contract for extracting statements from <code class="literal">import.sql</code> scripts.
                        </p>
                    </dd><dt><span class="term">Initiator</span></dt><dd>
                        <p>
                            <code class="classname">org.hibernate.tool.hbm2ddl.ImportSqlCommandExtractorInitiator</code>
                        </p>
                    </dd><dt><span class="term">Implementations</span></dt><dd>
                        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.tool.hbm2ddl.SingleLineSqlCommandExtractor</code>
                                    treats each line as a complete SQL statement. Comment lines shall start with
                                    <code class="literal">--</code>, <code class="literal">//</code> or <code class="literal">/*</code> character
                                    sequence.
                                </p>
                            </li><li class="listitem">
                                <p>
                                    <code class="classname">org.hibernate.tool.hbm2ddl.MultipleLinesSqlCommandExtractor</code>
                                    supports instructions/comments and quoted strings spread over multiple lines. Each
                                    statement must end with semicolon.
                                </p>
                            </li></ul></div>
                    </dd></dl></div>
        </div>

    </div>


    <div class="section" title="7.6. Custom services"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2138"/>7.6. Custom services</h2></div></div></div>
        
        <p>
            Once a <code class="interfacename">org.hibernate.service.ServiceRegistry</code> is built it is considered
            immutable; the services themselves might accept re-configuration, but immutability here means
            adding/replacing services.  So another role provided by the
            <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code> is to allow tweaking of the services
            that will be contained in the <code class="interfacename">org.hibernate.service.ServiceRegistry</code>
            generated from it.
        </p>
        <p>
            There are 2 means to tell a <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code> about
            custom services.
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    Implement a <code class="interfacename">org.hibernate.service.spi.BasicServiceInitiator</code> class
                    to control on-demand construction of the service class and add it to the
                    <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code> via its
                    <code class="methodname">addInitiator</code> method.
                </p>
            </li><li class="listitem">
                <p>
                    Just instantiate the service class and add it to the
                    <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code> via its
                    <code class="methodname">addService</code> method.
                </p>
            </li></ul></div>
        <p>
            Either approach the adding a service approach or the adding an initiator approach are valid for extending a
            registry (adding new service roles) and overriding services (replacing service implementations).
        </p>
    </div>


    <div class="section" title="7.7. Special service registries"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2157"/>7.7. Special service registries</h2></div></div></div>
        

        <div class="section" title="7.7.1. Boot-strap registry"><div class="titlepage"><div><div><h3 class="title"><a id="services-registry-bootstrap"/>7.7.1. Boot-strap registry</h3></div></div></div>
            
            <p>
                The boot-strap registry holds services that absolutely have to be available for most things to work.
                The main service here is the <a class="xref" href="#services-ClassLoaderService" title="7.7.1.1.1. org.hibernate.service.classloading.spi.ClassLoaderService">Section 7.7.1.1.1, “<code class="interfacename">org.hibernate.service.classloading.spi.ClassLoaderService</code>”</a> which is a perfect example.
                Even resolving configuration files needs access to class loading services (resource look ups).  This
                is the root registry (no parent) in normal use.
            </p>

            <p>
                Instances of boot-strap registries are built using the
                <code class="classname">org.hibernate.service.BootstrapServiceRegistryBuilder</code> class.
            </p>

            <div class="example"><a id="BootstrapServiceRegistryBuilder-example"/><p class="title"><strong>Example 7.1. Using BootstrapServiceRegistryBuilder</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">BootstrapServiceRegistry bootstrapServiceRegistry = new BootstrapServiceRegistryBuilder()
        // pass in org.hibernate.integrator.spi.Integrator instances which are not
        // auto-discovered (for whatever reason) but which should be included
        .with( anExplicitIntegrator )
        // pass in a class-loader Hibernate should use to load application classes
        .withApplicationClassLoader( anExplicitClassLoaderForApplicationClasses )
        // pass in a class-loader Hibernate should use to load resources
        .withResourceClassLoader( anExplicitClassLoaderForResources )
        // see BootstrapServiceRegistryBuilder for rest of available methods
        ...
        // finally, build the bootstrap registry with all the above options
        .build();
</pre>
            </div></div><br class="example-break"/>

            <div class="section" title="7.7.1.1. Bootstrap registry services"><div class="titlepage"><div><div><h4 class="title"><a id="services-registry-bootstrap-services"/>7.7.1.1. Bootstrap registry services</h4></div></div></div>
                
                <div class="section" title="7.7.1.1.1. org.hibernate.service.classloading.spi.ClassLoaderService"><div class="titlepage"><div><div><h5 class="title"><a id="services-ClassLoaderService"/>7.7.1.1.1. <code class="interfacename">org.hibernate.service.classloading.spi.ClassLoaderService</code></h5></div></div></div>
                    
                    <p>
                        Hibernate needs to interact with ClassLoaders.  However, the manner in which Hibernate
                        (or any library) should interact with ClassLoaders varies based on the runtime environment
                        which is hosting the application.  Application servers, OSGi containers, and other modular
                        class loading systems impose very specific class-loading requirements.  This service is provides
                        Hibernate an abstraction from this environmental complexity.  And just as importantly, it does
                        so in a single-swappable-component manner.
                    </p>
                    <p>
                        In terms of interacting with a ClassLoader, Hibernate needs the following capabilities:
                        </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                                <p>
                                    the ability to locate application classes
                                </p>
                            </li><li class="listitem">
                                <p>
                                    the ability to locate integration classes
                                </p>
                            </li><li class="listitem">
                                <p>
                                    the ability to locate resources (properties files, xml files, etc)
                                </p>
                            </li><li class="listitem">
                                <p>
                                    the ability to load <code class="classname">java.util.ServiceLoader</code>
                                </p>
                            </li></ul></div><p>
                    </p>
                    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                        <p>
                            Currently, the ability to load application classes and the ability to load integration
                            classes are combined into a single "load class" capability on the service.  That may
                            change in a later release.
                        </p>
                    </div>
                </div>

                <div class="section" title="7.7.1.1.2. org.hibernate.integrator.spi.IntegratorService"><div class="titlepage"><div><div><h5 class="title"><a id="services-IntegratorService"/>7.7.1.1.2. <code class="interfacename">org.hibernate.integrator.spi.IntegratorService</code></h5></div></div></div>
                    
                    <p>
                        Applications, add-ons and others all need to integrate with Hibernate which used to require
                        something, usually the application, to coordinate registering the pieces of each integration
                        needed on behalf of each integrator.  The intent of this service is to allow those integrators
                        to be discovered and to have them integrate themselves with Hibernate.
                    </p>
                    <p>
                        This service focuses on the discovery aspect.  It leverages the standard Java
                        <code class="classname">java.util.ServiceLoader</code> capability provided by the
                        <code class="interfacename">org.hibernate.service.classloading.spi.ClassLoaderService</code>
                        in order to discover implementations of the
                        <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> contract.
                        Integrators would simply define a file named
                        <code class="filename">/META-INF/services/org.hibernate.integrator.spi.Integrator</code> and make it
                        available on the classpath.  <code class="classname">java.util.ServiceLoader</code> covers the
                        format of this file in detail, but essentially it list classes by FQN that implement the
                        <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> one per line.
                    </p>
                    <p>
                        See <a class="xref" href="#integrators" title="7.9. Integrators">Section 7.9, “Integrators”</a>
                    </p>
                </div>
            </div>
        </div>

        <div class="section" title="7.7.2. SessionFactory registry"><div class="titlepage"><div><div><h3 class="title"><a id="services-registry-sessionfactory"/>7.7.2. SessionFactory registry</h3></div></div></div>
            
            <p>
                While it is best practice to treat instances of all the registry types as targeting a given
                <code class="interfacename">org.hibernate.SessionFactory</code>, the instances of services in this group
                explicitly belong to a single <code class="interfacename">org.hibernate.SessionFactory</code>.  The
                difference is a matter of timing in when they need to be initiated.  Generally they need access to the
                <code class="interfacename">org.hibernate.SessionFactory</code> to be initiated.  This special registry is
                <code class="interfacename">org.hibernate.service.spi.SessionFactoryServiceRegistry</code>
            </p>

            <div class="section" title="7.7.2.1. org.hibernate.event.service.spi.EventListenerRegistry"><div class="titlepage"><div><div><h4 class="title"><a id="services-EventListenerRegistry"/>7.7.2.1. <code class="interfacename">org.hibernate.event.service.spi.EventListenerRegistry</code></h4></div></div></div>
                
                <div class="variablelist"><dl><dt><span class="term">Notes</span></dt><dd>
                            <p>
                                Service for managing event listeners.
                            </p>
                        </dd><dt><span class="term">Initiator</span></dt><dd>
                            <p>
                                <code class="classname">org.hibernate.event.service.internal.EventListenerServiceInitiator</code>
                            </p>
                        </dd><dt><span class="term">Implementations</span></dt><dd>
                            <p>
                                <code class="classname">org.hibernate.event.service.internal.EventListenerRegistryImpl</code>
                            </p>
                        </dd></dl></div>
            </div>
        </div>

    </div>


    <div class="section" title="7.8. Using services and registries"><div class="titlepage"><div><div><h2 class="title"><a id="services-use"/>7.8. Using services and registries</h2></div></div></div>
        
        <p>
            Coming soon...
        </p>
    </div>

    <div class="section" title="7.9. Integrators"><div class="titlepage"><div><div><h2 class="title"><a id="integrators"/>7.9. Integrators</h2></div></div></div>
        
        <p>
            The <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> is intended to provide a simple
            means for allowing developers to hook into the process of building a functioning SessionFactory.  The
            The <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> interface defines 2 methods of
            interest: <code class="methodname">integrate</code> allows us to hook into the building process;
            <code class="methodname">disintegrate</code> allows us to hook into a SessionFactory shutting down.
        </p>
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                There is a 3rd method defined on <code class="interfacename">org.hibernate.integrator.spi.Integrator</code>,
                an overloaded form of <code class="methodname">integrate</code> accepting a
                <code class="interfacename">org.hibernate.metamodel.source.MetadataImplementor</code> instead of
                <code class="classname">org.hibernate.cfg.Configuration</code>.  This form is intended for use with the new
                metamodel code scheduled for completion in 5.0
            </p>
        </div>
        <p>
            See <a class="xref" href="#services-IntegratorService" title="7.7.1.1.2. org.hibernate.integrator.spi.IntegratorService">Section 7.7.1.1.2, “<code class="interfacename">org.hibernate.integrator.spi.IntegratorService</code>”</a>
        </p>
        <p>
            In addition to the discovery approach provided by the IntegratorService, applications can manually
            register Integrator implementations when building the BootstrapServiceRegistry.
            See <a class="xref" href="#BootstrapServiceRegistryBuilder-example" title="Example 7.1. Using BootstrapServiceRegistryBuilder">Example 7.1, “Using BootstrapServiceRegistryBuilder”</a>
        </p>

        <div class="section" title="7.9.1. Integrator use-cases"><div class="titlepage"><div><div><h3 class="title"><a id="integrators-uses"/>7.9.1. Integrator use-cases</h3></div></div></div>
            
            <p>
                The main use cases for an <code class="interfacename">org.hibernate.integrator.spi.Integrator</code> right
                now are registering event listeners and providing services (see
                <code class="interfacename">org.hibernate.integrator.spi.ServiceContributingIntegrator</code>).  With 5.0
                we plan on expanding that to allow altering the metamodel describing the mapping between object and
                relational models.
            </p>

            <div class="example"><a id="registering-listeners-example"/><p class="title"><strong>Example 7.2. Registering event listeners</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class MyIntegrator implements org.hibernate.integrator.spi.Integrator {

    public void integrate(
            Configuration configuration,
            SessionFactoryImplementor sessionFactory,
            SessionFactoryServiceRegistry serviceRegistry) {
        // As you might expect, an EventListenerRegistry is the thing with which event listeners are registered  It is a
        // service so we look it up using the service registry
        final EventListenerRegistry eventListenerRegistry = serviceRegistry.getService( EventListenerRegistry.class );

        // If you wish to have custom determination and handling of "duplicate" listeners, you would have to add an
        // implementation of the org.hibernate.event.service.spi.DuplicationStrategy contract like this
        eventListenerRegistry.addDuplicationStrategy( myDuplicationStrategy );

        // EventListenerRegistry defines 3 ways to register listeners:
        //     1) This form overrides any existing registrations with
        eventListenerRegistry.setListeners( EventType.AUTO_FLUSH, myCompleteSetOfListeners );
        //     2) This form adds the specified listener(s) to the beginning of the listener chain
        eventListenerRegistry.prependListeners( EventType.AUTO_FLUSH, myListenersToBeCalledFirst );
        //     3) This form adds the specified listener(s) to the end of the listener chain
        eventListenerRegistry.appendListeners( EventType.AUTO_FLUSH, myListenersToBeCalledLast );
    }
}
</pre>
            </div></div><br class="example-break"/>
        </div>
    </div>
</div>
    <div class="chapter" title="Chapter 8. Data categorizations"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2253"/>Chapter 8. Data categorizations</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#value-types">8.1. Value types</a></span></dt><dd><dl><dt><span class="section"><a href="#value-basic-types">8.1.1. Basic types</a></span></dt><dt><span class="section"><a href="#value-national-character-types">8.1.2. National Character Types</a></span></dt><dt><span class="section"><a href="#value-composite-types">8.1.3. Composite types</a></span></dt><dt><span class="section"><a href="#value-collection-types">8.1.4. Collection types</a></span></dt></dl></dd><dt><span class="section"><a href="#entity-types">8.2. Entity Types</a></span></dt><dt><span class="section"><a href="#d5e2562">8.3. Implications of different data categorizations</a></span></dt></dl></div>

  
  <p>
    Hibernate understands both the Java and JDBC representations of application data. The ability to read and write
    object data to a database is called <em class="firstterm">marshalling</em>, and is the function of a Hibernate
    <code class="classname">type</code>. A <code class="classname">type</code> is an implementation of the
    <code class="interfacename">org.hibernate.type.Type</code> interface. A Hibernate <code class="classname">type</code> describes
    various aspects of behavior of the Java type such as how to check for equality and how to clone values.
  </p>
  <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Usage of the word <em class="wordasword">type</em></h2>
    
    <p>
      A Hibernate <code class="classname">type</code> is neither a Java type nor a SQL datatype. It provides information about
      both of these.
    </p>
    <p>
      When you encounter the term <em class="firstterm">type</em> in regards to Hibernate, it may refer to the Java type,
      the JDBC type, or the Hibernate type, depending on context.
    </p>
  </div>
  <p>
    Hibernate categorizes types into two high-level groups: <a class="xref" href="#value-types" title="8.1. Value types">Section 8.1, “Value types”</a>
      and <a class="xref" href="#entity-types" title="8.2. Entity Types">Section 8.2, “Entity Types”</a>.
  </p>
  
  <div class="section" title="8.1. Value types"><div class="titlepage"><div><div><h2 class="title"><a id="value-types"/>8.1. Value types</h2></div></div></div>
    
    <p>
      A <em class="firstterm">value type</em> does not define its own lifecycle. It is, in effect, owned by an <a class="xref" href="#entity-types" title="8.2. Entity Types">Section 8.2, “Entity Types”</a>, which defines its
      lifecycle. Value types are further classified into three sub-categories.
    </p>
    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><a class="xref" href="#value-basic-types" title="8.1.1. Basic types">Section 8.1.1, “Basic types”</a></p></li><li class="listitem"><p><a class="xref" href="#value-national-character-types" title="8.1.2. National Character Types">Section 8.1.2, “National Character Types”</a></p></li><li class="listitem"><p><a class="xref" href="#value-composite-types" title="8.1.3. Composite types">Section 8.1.3, “Composite types”</a></p></li><li class="listitem"><p><a class="xref" href="#value-collection-types" title="8.1.4. Collection types">Section 8.1.4, “Collection types”</a></p></li></ul></div>

    <div class="section" title="8.1.1. Basic types"><div class="titlepage"><div><div><h3 class="title"><a id="value-basic-types"/>8.1.1. Basic types</h3></div></div></div>
      
      <p>
        Basic value types usually map a single database value, or column, to a single, non-aggregated Java
        type. Hibernate provides a number of built-in basic types, which follow the natural mappings recommended in the
        JDBC specifications. You can override these mappings and provide and use alternative mappings. These topics are
        discussed further on.
      </p>
      <div class="table"><a id="d5e2292"/><p class="title"><strong>Table 8.1. Basic Type Mappings</strong></p><div class="table-contents">
        
        <table summary="Basic Type Mappings" border="1"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th>Hibernate type</th><th>Database type</th><th>JDBC type</th><th>Type registry</th></tr></thead><tbody><tr><td>org.hibernate.type.StringType</td><td>string</td><td>VARCHAR</td><td>string, java.lang.String</td></tr><tr><td>org.hibernate.type.MaterializedClob</td><td>string</td><td>CLOB</td><td>materialized_clob</td></tr><tr><td>org.hibernate.type.TextType</td><td>string</td><td>LONGVARCHAR</td><td>text</td></tr><tr><td>org.hibernate.type.CharacterType</td><td>char, java.lang.Character</td><td>CHAR</td><td>char, java.lang.Character</td></tr><tr><td>org.hibernate.type.BooleanType</td><td>boolean</td><td>BIT</td><td>boolean, java.lang.Boolean</td></tr><tr><td>org.hibernate.type.NumericBooleanType</td><td>boolean</td><td>INTEGER, 0 is false, 1 is true</td><td>numeric_boolean</td></tr><tr><td>org.hibernate.type.YesNoType</td><td>boolean</td><td>CHAR, 'N'/'n' is false, 'Y'/'y' is true. The uppercase value is written to the database.</td><td>yes_no</td></tr><tr><td>org.hibernate.type.TrueFalseType</td><td>boolean</td><td>CHAR, 'F'/'f' is false, 'T'/'t' is true. The uppercase value is written to the database.</td><td>true_false</td></tr><tr><td>org.hibernate.type.ByteType</td><td>byte, java.lang.Byte</td><td>TINYINT</td><td>byte, java.lang.Byte</td></tr><tr><td>org.hibernate.type.ShortType</td><td>short, java.lang.Short</td><td>SMALLINT</td><td>short, java.lang.Short</td></tr><tr><td>org.hibernate.type.IntegerTypes</td><td>int, java.lang.Integer</td><td>INTEGER</td><td>int, java.lang.Integer</td></tr><tr><td>org.hibernate.type.LongType</td><td>long, java.lang.Long</td><td>BIGINT</td><td>long, java.lang.Long</td></tr><tr><td>org.hibernate.type.FloatType</td><td>float, java.lang.Float</td><td>FLOAT</td><td>float, java.lang.Float</td></tr><tr><td>org.hibernate.type.DoubleType</td><td>double, java.lang.Double</td><td>DOUBLE</td><td>double, java.lang.Double</td></tr><tr><td>org.hibernate.type.BigIntegerType</td><td>java.math.BigInteger</td><td>NUMERIC</td><td>big_integer</td></tr><tr><td>org.hibernate.type.BigDecimalType</td><td>java.math.BigDecimal</td><td>NUMERIC</td><td>big_decimal, java.math.bigDecimal</td></tr><tr><td>org.hibernate.type.TimestampType</td><td>java.sql.Timestamp</td><td>TIMESTAMP</td><td>timestamp, java.sql.Timestamp</td></tr><tr><td>org.hibernate.type.TimeType</td><td>java.sql.Time</td><td>TIME</td><td>time, java.sql.Time</td></tr><tr><td>org.hibernate.type.DateType</td><td>java.sql.Date</td><td>DATE</td><td>date, java.sql.Date</td></tr><tr><td>org.hibernate.type.CalendarType</td><td>java.util.Calendar</td><td>TIMESTAMP</td><td>calendar, java.util.Calendar</td></tr><tr><td>org.hibernate.type.CalendarDateType</td><td>java.util.Calendar</td><td>DATE</td><td>calendar_date</td></tr><tr><td>org.hibernate.type.CurrencyType</td><td>java.util.Currency</td><td>VARCHAR</td><td>currency, java.util.Currency</td></tr><tr><td>org.hibernate.type.LocaleType</td><td>java.util.Locale</td><td>VARCHAR</td><td>locale, java.utility.locale</td></tr><tr><td>org.hibernate.type.TimeZoneType</td><td>java.util.TimeZone</td><td>VARCHAR, using the TimeZone ID</td><td>timezone, java.util.TimeZone</td></tr><tr><td>org.hibernate.type.UrlType</td><td>java.net.URL</td><td>VARCHAR</td><td>url, java.net.URL</td></tr><tr><td>org.hibernate.type.ClassType</td><td>java.lang.Class</td><td>VARCHAR, using the class name</td><td>class, java.lang.Class</td></tr><tr><td>org.hibernate.type.BlobType</td><td>java.sql.Blob</td><td>BLOB</td><td>blog, java.sql.Blob</td></tr><tr><td>org.hibernate.type.ClobType</td><td>java.sql.Clob</td><td>CLOB</td><td>clob, java.sql.Clob</td></tr><tr><td>org.hibernate.type.BinaryType</td><td>primitive byte[]</td><td>VARBINARY</td><td>binary, byte[]</td></tr><tr><td>org.hibernate.type.MaterializedBlobType</td><td>primitive byte[]</td><td>BLOB</td><td>materized_blob</td></tr><tr><td>org.hibernate.type.ImageType</td><td>primitive byte[]</td><td>LONGVARBINARY</td><td>image</td></tr><tr><td>org.hibernate.type.BinaryType</td><td>java.lang.Byte[]</td><td>VARBINARY</td><td>wrapper-binary</td></tr><tr><td>org.hibernate.type.CharArrayType</td><td>char[]</td><td>VARCHAR</td><td>characters, char[]</td></tr><tr><td>org.hibernate.type.CharacterArrayType</td><td>java.lang.Character[]</td><td>VARCHAR</td><td>wrapper-characters, Character[], java.lang.Character[]</td></tr><tr><td>org.hibernate.type.UUIDBinaryType</td><td>java.util.UUID</td><td>BINARY</td><td>uuid-binary, java.util.UUID</td></tr><tr><td>org.hibernate.type.UUIDCharType</td><td>java.util.UUID</td><td>CHAR, can also read VARCHAR</td><td>uuid-char</td></tr><tr><td>org.hibernate.type.PostgresUUIDType</td><td>java.util.UUID</td><td>PostgreSQL UUID, through Types#OTHER, which complies to the PostgreSQL JDBC driver
              definition</td><td>pg-uuid</td></tr><tr><td>org.hibernate.type.SerializableType</td><td>implementors of java.lang.Serializable</td><td>VARBINARY</td><td> Unlike the other value types, multiple instances of this type are registered. It is registered
              once under java.io.Serializable, and registered under the specific java.io.Serializable implementation
              class names.</td></tr></tbody></table>
      </div></div><br class="table-break"/>
    </div>
    <div class="section" title="8.1.2. National Character Types"><div class="titlepage"><div><div><h3 class="title"><a id="value-national-character-types"/>8.1.2. National Character Types</h3></div></div></div>
        
        <p>
            National Character types, which is a new feature since JDBC 4.0 API, now available in hibernate type system.
            National Language Support enables you retrieve data or insert data into a database in any character
            set that the underlying database supports.
        </p>

        <p>
            Depending on your environment, you might want to set the configuration option <span class="property">hibernate.use_nationalized_character_data</span>
            to true and having all string or clob based attributes having this national character support automatically.
            There is nothing else to be changed, and you don't have to use any hibernate specific mapping, so it is portable
            ( though the national character support feature is not required and may not work on other JPA provider impl ).
        </p>

        <p>
            The other way of using this feature is having the <code class="classname">@Nationalized</code> annotation on the attribute
            that should be nationalized. This only works on string based attributes, including string, char, char array and clob.

            </p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                @Entity( name="NationalizedEntity")
                public static class NationalizedEntity {
                    @Id
                    private Integer id;

                    @Nationalized
                    private String nvarcharAtt;

                    @Lob
                    @Nationalized
                    private String materializedNclobAtt;

                    @Lob
                    @Nationalized
                    private NClob nclobAtt;

                    @Nationalized
                    private Character ncharacterAtt;

                    @Nationalized
                    private Character[] ncharArrAtt;

                    @Type(type = "ntext")
                    private String nlongvarcharcharAtt;
                }</pre><p>
        </p>

        <div class="table"><a id="d5e2500"/><p class="title"><strong>Table 8.2. National Character Type Mappings</strong></p><div class="table-contents">
            
            <table summary="National Character Type Mappings" border="1"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th>Hibernate type</th><th>Database type</th><th>JDBC type</th><th>Type registry</th></tr></thead><tbody><tr><td>org.hibernate.type.StringNVarcharType</td><td>string</td><td>NVARCHAR</td><td>nstring</td></tr><tr><td>org.hibernate.type.NTextType</td><td>string</td><td>LONGNVARCHAR</td><td>materialized_clob</td></tr><tr><td>org.hibernate.type.NClobType</td><td>java.sql.NClob</td><td>NCLOB</td><td>nclob</td></tr><tr><td>org.hibernate.type.MaterializedNClobType</td><td>string</td><td>NCLOB</td><td>materialized_nclob</td></tr><tr><td>org.hibernate.type.PrimitiveCharacterArrayNClobType</td><td>char[]</td><td>NCHAR</td><td>char[]</td></tr><tr><td>org.hibernate.type.CharacterNCharType</td><td>java.lang.Character</td><td>NCHAR</td><td>ncharacter</td></tr><tr><td>org.hibernate.type.CharacterArrayNClobType</td><td>java.lang.Character[]</td><td>NCLOB</td><td>Character[], java.lang.Character[]</td></tr></tbody></table>
        </div></div><br class="table-break"/>
    </div>
    <div class="section" title="8.1.3. Composite types"><div class="titlepage"><div><div><h3 class="title"><a id="value-composite-types"/>8.1.3. Composite types</h3></div></div></div>
      
      <p>
        <em class="firstterm">Composite types</em>, or <em class="firstterm">embedded types</em>, as they are called by the Java
        Persistence API, have traditionally been called <em class="firstterm">components</em> in Hibernate. All of these
        terms mean the same thing.
      </p>
      <p>
        Components represent aggregations of values into a single Java type. An example is an
        <code class="classname">Address</code> class, which aggregates street, city, state, and postal code.  A composite type
        behaves in a similar way to an entity. They are each classes written specifically for an application. They may
        both include references to other application-specific classes, as well as to collections and simple JDK
        types. The only distinguishing factors are that a component does not have its own lifecycle or define an
        identifier.
      </p>
      
    </div>
    
    <div class="section" title="8.1.4. Collection types"><div class="titlepage"><div><div><h3 class="title"><a id="value-collection-types"/>8.1.4. Collection types</h3></div></div></div>
      
      <p>
        A <em class="firstterm">collection</em> type refers to the data type itself, not its contents.
      </p>
      <p>
        A Collection denotes a one-to-one or one-to-many relationship between tables of a database.
      </p>
      <p>
        Refer to the chapter on Collections for more information on collections.
      </p>
    </div>
  </div>
  <div class="section" title="8.2. Entity Types"><div class="titlepage"><div><div><h2 class="title"><a id="entity-types"/>8.2. Entity Types</h2></div></div></div>
    
    <p>
      Entities are application-specific classes which correlate to rows in a table, using a unique identifier. Because
      of the requirement for a unique identifier, ntities exist independently and define their own lifecycle. As an
      example, deleting a Membership should not delete the User or the Group. For more information, see the chapter on
      Persistent Classes.
    </p>
  </div>
  
  <div class="section" title="8.3. Implications of different data categorizations"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2562"/>8.3. Implications of different data categorizations</h2></div></div></div>
    
    <p>
      NEEDS TO BE WRITTEN
    </p>
    
  </div>

</div>
    <div class="chapter" title="Chapter 9. Mapping entities"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2565"/>Chapter 9. Mapping entities</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e2567">9.1. Hierarchies</a></span></dt></dl></div>
    
    <div class="section" title="9.1. Hierarchies"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2567"/>9.1. Hierarchies</h2></div></div></div>
        
        <p/>
    </div>
</div>
    <div class="chapter" title="Chapter 10. Mapping associations"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2570"/>Chapter 10. Mapping associations</h2></div></div></div>
    
    <p>
        The most basic form of mapping in Hibernate is mapping a persistent entity class to a database table.
        You can expand on this concept by mapping associated classes together.  <a class="xref" href="#">???</a>
        shows a <code class="classname">Person</code> class with a
    </p>
</div>
    <div class="chapter" title="Chapter 11. HQL and JPQL"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2575"/>Chapter 11. HQL and JPQL</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e2580">11.1. Case Sensitivity</a></span></dt><dt><span class="section"><a href="#d5e2592">11.2. Statement types</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2608">11.2.1. Select statements</a></span></dt><dt><span class="section"><a href="#d5e2621">11.2.2. Update statements</a></span></dt><dt><span class="section"><a href="#d5e2656">11.2.3. Delete statements</a></span></dt><dt><span class="section"><a href="#d5e2666">11.2.4. Insert statements</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-from-clause">11.3. The <code class="literal">FROM</code> clause</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2703">11.3.1. Identification variables</a></span></dt><dt><span class="section"><a href="#d5e2710">11.3.2. Root entity references</a></span></dt><dt><span class="section"><a href="#d5e2734">11.3.3. Explicit joins</a></span></dt><dt><span class="section"><a href="#d5e2777">11.3.4. Implicit joins (path expressions)</a></span></dt><dt><span class="section"><a href="#ql-collection-valued-associations">11.3.5. Collection member references</a></span></dt><dt><span class="section"><a href="#d5e2847">11.3.6. Polymorphism</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-expressions">11.4. Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e2866">11.4.1. Identification variable</a></span></dt><dt><span class="section"><a href="#d5e2870">11.4.2. Path expressions</a></span></dt><dt><span class="section"><a href="#d5e2874">11.4.3. Literals</a></span></dt><dt><span class="section"><a href="#d5e2900">11.4.4. Parameters</a></span></dt><dt><span class="section"><a href="#d5e2923">11.4.5. Arithmetic</a></span></dt><dt><span class="section"><a href="#d5e2945">11.4.6. Concatenation (operation)</a></span></dt><dt><span class="section"><a href="#d5e2956">11.4.7. Aggregate functions</a></span></dt><dt><span class="section"><a href="#ql-exp-functions">11.4.8. Scalar functions</a></span></dt><dt><span class="section"><a href="#ql-collection-expressions">11.4.9. Collection-related expressions</a></span></dt><dt><span class="section"><a href="#ql-entity-type-exp">11.4.10. Entity type</a></span></dt><dt><span class="section"><a href="#d5e3155">11.4.11. CASE expressions</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-select-clause">11.5. The <code class="literal">SELECT</code> clause</a></span></dt><dt><span class="section"><a href="#ql-conditional-expressions">11.6. Predicates</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3217">11.6.1. Relational comparisons</a></span></dt><dt><span class="section"><a href="#d5e3232">11.6.2. Nullness predicate</a></span></dt><dt><span class="section"><a href="#d5e3238">11.6.3. Like predicate</a></span></dt><dt><span class="section"><a href="#d5e3260">11.6.4. Between predicate</a></span></dt><dt><span class="section"><a href="#d5e3266">11.6.5. In predicate</a></span></dt><dt><span class="section"><a href="#d5e3291">11.6.6. Exists predicate</a></span></dt><dt><span class="section"><a href="#d5e3294">11.6.7. Empty collection predicate</a></span></dt><dt><span class="section"><a href="#d5e3301">11.6.8. Member-of collection predicate</a></span></dt><dt><span class="section"><a href="#d5e3308">11.6.9. NOT predicate operator</a></span></dt><dt><span class="section"><a href="#d5e3312">11.6.10. AND predicate operator</a></span></dt><dt><span class="section"><a href="#d5e3316">11.6.11. OR predicate operator</a></span></dt></dl></dd><dt><span class="section"><a href="#ql-where-clause">11.7. The <code class="literal">WHERE</code> clause</a></span></dt><dt><span class="section"><a href="#ql-grouping">11.8. Grouping</a></span></dt><dt><span class="section"><a href="#ql-ordering">11.9. Ordering</a></span></dt><dt><span class="section"><a href="#ql-api">11.10. Query API</a></span></dt></dl></div>

    

    <p>
        The Hibernate Query Language (HQL) and Java Persistence Query Language (JPQL) are both object model
        focused query languages similar in nature to SQL.  JPQL is a heavily-inspired-by subset of HQL.  A JPQL
        query is always a valid HQL query, the reverse is not true however.
    </p>

    <p>
        Both HQL and JPQL are non-type-safe ways to perform query operations.  Criteria queries offer a
        type-safe approach to querying.  See <a class="xref" href="#">???</a> for more information.
    </p>

    <div class="section" title="11.1. Case Sensitivity"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2580"/>11.1. Case Sensitivity</h2></div></div></div>
        

        <p>
            With the exception of names of Java classes and properties, queries are case-insensitive.
            So <code class="literal">SeLeCT</code> is the same as <code class="literal">sELEct</code> is the same as
            <code class="literal">SELECT</code>, but
            <code class="literal">org.hibernate.eg.FOO</code> and <code class="literal">org.hibernate.eg.Foo</code> are different, as are
            <code class="literal">foo.barSet</code> and <code class="literal">foo.BARSET</code>.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                This documentation uses lowercase keywords as convention in examples.
            </p>
        </div>
    </div>

    <div class="section" title="11.2. Statement types"><div class="titlepage"><div><div><h2 class="title"><a id="d5e2592"/>11.2. Statement types</h2></div></div></div>
        
        <p>
            Both HQL and JPQL allow <code class="literal">SELECT</code>, <code class="literal">UPDATE</code> and <code class="literal">DELETE</code>
            statements to be performed.  HQL additionally allows <code class="literal">INSERT</code> statements, in a form
            similar to a SQL <code class="literal">INSERT-SELECT</code>.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Care should be taken as to when a <code class="literal">UPDATE</code> or <code class="literal">DELETE</code> statement is
                executed.
            </p>
            <div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
                    Caution should be used when executing bulk update or delete operations because they may result in
                    inconsistencies between the database and the entities in the active persistence context. In general, bulk
                    update and delete operations should only be performed within a transaction in a new persistence con-
                    text or before fetching or accessing entities whose state might be affected by such operations.
                </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution"><em class="citetitle">Section 4.10 of the JPA 2.0 Specification</em></span></td></tr></table></div>
        </div>

        <div class="section" title="11.2.1. Select statements"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2608"/>11.2.1. Select statements</h3></div></div></div>
            
            <p>
                The BNF for <code class="literal">SELECT</code> statements in HQL is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select_statement :: =
        [select_clause]
        from_clause
        [where_clause]
        [groupby_clause]
        [having_clause]
        [orderby_clause]</pre>
            <p>
                The simplest possible HQL <code class="literal">SELECT</code> statement is of the form:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">from com.acme.Cat</pre>
            <p>
                The select statement in JPQL is exactly the same as for HQL except that JPQL requires a
                <code class="literal">select_clause</code>, whereas HQL does not.  Even though HQL does not require the presence
                of a <code class="literal">select_clause</code>, it is generally good practice to include one.  For simple queries
                the intent is clear and so the intended result of the <code class="literal">select_clause</code> is east to
                infer.  But on more complex queries that is not always the case.  It is usually better to explicitly
                specify intent.  Hibernate does not actually enforce that a <code class="literal">select_clause</code> be present
                even when parsing JPQL queries, however applications interested in JPA portability should take heed of
                this.
            </p>
        </div>

        <div class="section" title="11.2.2. Update statements"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2621"/>11.2.2. Update statements</h3></div></div></div>
            
            <p>
                The BNF for <code class="literal">UPDATE</code> statements is the same in HQL and JPQL:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">update_statement ::= update_clause [where_clause]

update_clause ::= UPDATE entity_name [[AS] identification_variable]
        SET update_item {, update_item}*

update_item ::= [identification_variable.]{state_field | single_valued_object_field}
        = new_value

new_value ::= scalar_expression |
                simple_entity_expression |
                NULL
</pre>
            <p>
                <code class="literal">UPDATE</code> statements, by default, do not effect the <code class="literal">version</code>
                or the <code class="literal">timestamp</code> attribute values for the affected entities. However,
                you can force Hibernate to set the <code class="literal">version</code> or <code class="literal">timestamp</code> attribute
                values through the use of a <code class="literal">versioned update</code>.  This is achieved by adding the
                <code class="literal">VERSIONED</code> keyword after the <code class="literal">UPDATE</code> keyword.  Note, however, that
                this is a Hibernate specific feature and will not work in a portable manner.  Custom version types,
                <code class="interfacename">org.hibernate.usertype.UserVersionType</code>, are not allowed in conjunction
                with a <code class="literal">update versioned</code> statement.
            </p>
            <p>
                An <code class="literal">UPDATE</code> statement is executed using the <code class="methodname">executeUpdate</code>
                of either <code class="interfacename">org.hibernate.Query</code> or
                <code class="interfacename">javax.persistence.Query</code>.  The method is named for those familiar with
                the JDBC <code class="methodname">executeUpdate</code> on <code class="interfacename">java.sql.PreparedStatement</code>.
                The <code class="literal">int</code> value returned by the <code class="methodname">executeUpdate()</code> method
                indicates the number of entities effected by the operation.  This may or may not correlate to the number
                of rows effected in the database.  An HQL bulk operation might result in multiple actual SQL statements
                being executed (for joined-subclass, for example).  The returned number indicates the number of actual
                entities affected by the statement.  Using a JOINED inheritance hierarchy, a delete against one of the
                subclasses may actually result in deletes against not just the table to which that subclass is mapped,
                but also the "root" table and tables <span class="quote">“<span class="quote">in between</span>”</span>
            </p>
            <div class="example"><a id="d5e2647"/><p class="title"><strong>Example 11.1. Example UPDATE query statements</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlUpdate =
		"update Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = session.createQuery( hqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String jpqlUpdate =
		"update Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = entityManager.createQuery( jpqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlVersionedUpdate =
		"update versioned Customer c " +
		"set c.name = :newName " +
		"where c.name = :oldName";
int updatedEntities = s.createQuery( hqlUpdate )
        .setString( "newName", newName )
        .setString( "oldName", oldName )
        .executeUpdate();</pre>
            </div></div><br class="example-break"/>
        </div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Neither <code class="literal">UPDATE</code> nor <code class="literal">DELETE</code> statements are allowed to
                result in what is called an implicit join.  Their form already disallows explicit joins.
            </p>
        </div>

        <div class="section" title="11.2.3. Delete statements"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2656"/>11.2.3. Delete statements</h3></div></div></div>
            
            <p>
                The BNF for <code class="literal">DELETE</code> statements is the same in HQL and JPQL:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">delete_statement ::= delete_clause [where_clause]

delete_clause ::= DELETE FROM entity_name [[AS] identification_variable]
</pre>
            <p>
                A <code class="literal">DELETE</code> statement is also executed using the <code class="methodname">executeUpdate</code>
                method of either <code class="interfacename">org.hibernate.Query</code> or
                <code class="interfacename">javax.persistence.Query</code>.
            </p>
        </div>

        <div class="section" title="11.2.4. Insert statements"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2666"/>11.2.4. Insert statements</h3></div></div></div>
            
            <p>
                HQL adds the ability to define <code class="literal">INSERT</code> statements as well.  There is no JPQL
                equivalent to this.  The BNF for an HQL <code class="literal">INSERT</code> statement is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">insert_statement ::= insert_clause select_statement

insert_clause ::= INSERT INTO entity_name (attribute_list)

attribute_list ::= state_field[, state_field ]*</pre>
            <p>
                The <code class="literal">attribute_list</code> is analogous to the <code class="literal">column specification</code> in the
                SQL <code class="literal">INSERT</code> statement.  For entities involved in mapped inheritance, only attributes
                directly defined on the named entity can be used in the <code class="literal">attribute_list</code>.  Superclass
                properties are not allowed and subclass properties do not make sense.  In other words,
                <code class="literal">INSERT</code> statements are inherently non-polymorphic.
            </p>
            <p>
                <code class="literal">select_statement</code> can be any valid HQL select query, with the caveat that the return
                types must match the types expected by the insert.  Currently, this is checked during query
                compilation rather than allowing the check to relegate to the database.  This may cause problems
                between Hibernate Types which are <span class="emphasis"><em>equivalent</em></span> as opposed to
                <span class="emphasis"><em>equal</em></span>.  For example, this might cause lead to issues with mismatches between an
                attribute mapped as a <code class="classname">org.hibernate.type.DateType</code> and an attribute defined as
                a <code class="classname">org.hibernate.type.TimestampType</code>, even though the database might not make a
                distinction or might be able to handle the conversion.
            </p>
            <p>
                For the id attribute, the insert statement gives you two options.  You can either explicitly specify
                the id property in the <code class="literal">attribute_list</code>, in which case its value is taken from the
                corresponding select expression, or omit it from the <code class="literal">attribute_list</code> in which case a
                generated value is used.  This latter option is only available when using id generators that operate
                <span class="quote">“<span class="quote">in the database</span>”</span>; attempting to use this option with any <span class="quote">“<span class="quote">in memory</span>”</span> type
                generators will cause an exception during parsing.
            </p>
            <p>
                For optimistic locking attributes, the insert statement again gives you two options.  You can either
                specify the attribute in the <code class="literal">attribute_list</code> in which case its value is taken from
                the corresponding select expressions, or omit it from the <code class="literal">attribute_list</code> in which
                case the <code class="literal">seed value</code> defined by the corresponding
                <code class="interfacename">org.hibernate.type.VersionType</code> is used.
            </p>
            <div class="example"><a id="d5e2694"/><p class="title"><strong>Example 11.2. Example INSERT query statements</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String hqlInsert = "insert into DelinquentAccount (id, name) select c.id, c.name from Customer c where ...";
int createdEntities = s.createQuery( hqlInsert ).executeUpdate();</pre>
            </div></div><br class="example-break"/>
        </div>
    </div>

    <div class="section" title="11.3. The FROM clause"><div class="titlepage"><div><div><h2 class="title"><a id="ql-from-clause"/>11.3. The <code class="literal">FROM</code> clause</h2></div></div></div>
        
        <p>
            The <code class="literal">FROM</code> clause is responsible defining the scope of object model types available to
            the rest of the query.  It also is responsible for defining all the <span class="quote">“<span class="quote">identification variables</span>”</span>
            available to the rest of the query.
        </p>
        <div class="section" title="11.3.1. Identification variables"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2703"/>11.3.1. Identification variables</h3></div></div></div>
            
            <p>
                Identification variables are often referred to as aliases.  References to object model classes
                in the FROM clause can be associated with an identification variable that can then be used to
                refer to that type thoughout the rest of the query.
            </p>
            <p>
                In most cases declaring an identification variable is optional, though it is usually good practice to
                declare them.
            </p>
            <p>
                An identification variable must follow the rules for Java identifier validity.
            </p>
            <p>
                According to JPQL, identification variables must be treated as case insensitive.  Good practice
                says you should use the same case throughout a query to refer to a given identification variable.  In
                other words, JPQL says they <span class="emphasis"><em>can be</em></span> case insensitive and so Hibernate must
                be able to treat them as such, but this does not make it good practice.
            </p>
        </div>
        <div class="section" title="11.3.2. Root entity references"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2710"/>11.3.2. Root entity references</h3></div></div></div>
            
            <p>
                A root entity reference, or what JPA calls a <code class="literal">range variable declaration</code>, is
                specifically a reference to a mapped entity type from the application.  It cannot name component/
                embeddable types.  And associations, including collections, are handled in a different manner
                discussed later.
            </p>
            <p>
                The BNF for a root entity reference is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">root_entity_reference ::= entity_name [AS] identification_variable</pre>
            <div class="example"><a id="ql-simple-query-ex"/><p class="title"><strong>Example 11.3. Simple query example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c from com.acme.Cat c</pre>
            </div></div><br class="example-break"/>
            <p>
                We see that the query is defining a root entity reference to the <code class="classname">com.acme.Cat</code>
                object model type.  Additionally, it declares an alias of <code class="literal">c</code> to that
                <code class="classname">com.acme.Cat</code> reference; this is the identification variable.
            </p>
            <p>
                Usually the root entity reference just names the <code class="literal">entity name</code> rather than the
                entity class FQN.  By default the entity name is the unqualified entity class name,
                here <code class="literal">Cat</code>
            </p>
            <div class="example"><a id="d5e2726"/><p class="title"><strong>Example 11.4. Simple query using entity name for root entity reference</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c from Cat c</pre>
            </div></div><br class="example-break"/>
            <p>
                Multiple root entity references can also be specified.  Even naming the same entity!
            </p>
            <div class="example"><a id="d5e2730"/><p class="title"><strong>Example 11.5. Simple query using multiple root entity references</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// build a product between customers and active mailing campaigns so we can spam!
select distinct cust, camp
from Customer cust, Campaign camp
where camp.type = 'mail'
  and current_timestamp() between camp.activeRange.start and camp.activeRange.end</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// retrieve all customers with headquarters in the same state as Acme's headquarters
select distinct c1
from Customer c1, Customer c2
where c1.address.state = c2.address.state
  and c2.name = 'Acme'</pre>
            </div></div><br class="example-break"/>
        </div>
        <div class="section" title="11.3.3. Explicit joins"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2734"/>11.3.3. Explicit joins</h3></div></div></div>
            
            <p>
                The <code class="literal">FROM</code> clause can also contain explicit relationship joins using the
                <code class="literal">join</code> keyword.  These joins can be either <code class="literal">inner</code>
                or <code class="literal">left outer</code> style joins.
            </p>
            <div class="example"><a id="d5e2741"/><p class="title"><strong>Example 11.6. Explicit inner join examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    join c.chiefExecutive ceo
where ceo.age &lt; 25

// same query but specifying join type as 'inner' explicitly
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
</pre>
            </div></div><br class="example-break"/>
            <div class="example"><a id="d5e2744"/><p class="title"><strong>Example 11.7. Explicit left (outer) join examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// get customers who have orders worth more than $5000
// or who are in "preferred" status
select distinct c
from Customer c
    left join c.orders o
where o.value &gt; 5000.00
  or c.status = 'preferred'

// functionally the same query but using the
// 'left outer' phrase
select distinct c
from Customer c
    left outer join c.orders o
where o.value &gt; 5000.00
  or c.status = 'preferred'
</pre>
            </div></div><br class="example-break"/>
            <p>
                An important use case for explicit joins is to define <code class="literal">FETCH JOINS</code> which override
                the laziness of the joined association.  As an example, given an entity named <code class="classname">Customer</code>
                with a collection-valued association named <code class="literal">orders</code>
            </p>
            <div class="example"><a id="d5e2751"/><p class="title"><strong>Example 11.8. Fetch join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    left join fetch c.orders o</pre>
            </div></div><br class="example-break"/>
            <p>
                As you can see from the example, a fetch join is specified by injecting the keyword <code class="literal">fetch</code>
                after the keyword <code class="literal">join</code>.  In the example, we used a left outer join because we want
                to return customers who have no orders also.  Inner joins can also be fetched.  But inner joins still
                filter.  In the example, using an inner join instead would have resulted in customers without any orders
                being filtered out of the result.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    Fetch joins are not valid in sub-queries.
                </p>
                <p>
                    Care should be taken when fetch joining a collection-valued association which is in any way further
                    restricted; the fetched collection will be restricted too!  For this reason it is usually considered
                    best practice to not assign an identification variable to fetched joins except for the purpose
                    of specifying nested fetch joins.
                </p>
                <p>
                    Fetch joins should not be used in paged queries (aka, <code class="methodname">setFirstResult</code>/
                    <code class="methodname">setMaxResults</code>).  Nor should they be used with the HQL
                    <code class="methodname">scroll</code> or <code class="methodname">iterate</code> features.
                </p>
            </div>
            <p>
                HQL also defines a <code class="literal">WITH</code> clause to qualify the join conditions.  Again, this is
                specific to HQL; JPQL does not define this feature.
            </p>
            <div class="example"><a id="d5e2767"/><p class="title"><strong>Example 11.9. with-clause join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select distinct c
from Customer c
    left join c.orders o
        with o.value &gt; 5000.00</pre>
            </div></div><br class="example-break"/>
            <p>
                The important distinction is that in the generated SQL the conditions of the
                <code class="literal">with clause</code> are made part of the <code class="literal">on clause</code> in the generated SQL
                as opposed to the other queries in this section where the HQL/JPQL conditions are made part of the
                <code class="literal">where clause</code> in the generated SQL.  The distinction in this specific example is
                probably not that significant.  The <code class="literal">with clause</code> is sometimes necessary in more
                complicated queries.
            </p>
            <p>
                Explicit joins may reference association or component/embedded attributes.  For further information
                about collection-valued association references, see <a class="xref" href="#ql-collection-valued-associations" title="11.3.5. Collection member references">Section 11.3.5, “Collection member references”</a>.
                In the case of component/embedded attributes, the join is simply logical and does not correlate to a
                physical (SQL) join.
            </p>
        </div>
        <div class="section" title="11.3.4. Implicit joins (path expressions)"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2777"/>11.3.4. Implicit joins (path expressions)</h3></div></div></div>
            
            <p>
                Another means of adding to the scope of object model types available to the query is through the
                use of implicit joins, or path expressions.
            </p>
            <div class="example"><a id="d5e2780"/><p class="title"><strong>Example 11.10. Simple implicit join example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.chiefExecutive.age &lt; 25

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
</pre>
            </div></div><br class="example-break"/>
            <p>
                An implicit join always starts from an <code class="literal">identification variable</code>, followed by
                the navigation operator (.), followed by an attribute for the object model type referenced by the
                initial <code class="literal">identification variable</code>.  In the example, the initial
                <code class="literal">identification variable</code> is <code class="literal">c</code> which refers to the
                <code class="classname">Customer</code> entity.  The <code class="literal">c.chiefExecutive</code> reference then refers
                to the <code class="methodname">chiefExecutive</code> attribute of the <code class="classname">Customer</code> entity.
                <code class="methodname">chiefExecutive</code> is an association type so we further navigate to its
                <code class="methodname">age</code> attribute.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
                <p>
                    If the attribute represents an entity association (non-collection) or a component/embedded, that
                    reference can be further navigated.  Basic values and collection-valued associations cannot be
                    further navigated.
                </p>
            </div>
            <p>
                As shown in the example, implicit joins can appear outside the <code class="literal">FROM clause</code>.  However,
                they affect the <code class="literal">FROM clause</code>.  Implicit joins are always treated as inner joins.
                Multiple references to the same implicit join always refer to the same logical and physical (SQL) join.
            </p>
            <div class="example"><a id="d5e2799"/><p class="title"><strong>Example 11.11. Reused implicit join</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.chiefExecutive.age &lt; 25
   and c.chiefExecutive.address.state = 'TX'

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
where ceo.age &lt; 25
  and ceo.address.state = 'TX'

// same as
select c
from Customer c
    inner join c.chiefExecutive ceo
    inner join ceo.address a
where ceo.age &lt; 25
  and a.state = 'TX'
</pre>
            </div></div><br class="example-break"/>
            <p>
                Just as with explicit joins, implicit joins may reference association or component/embedded attributes.
                For further information about collection-valued association references, see
                <a class="xref" href="#ql-collection-valued-associations" title="11.3.5. Collection member references">Section 11.3.5, “Collection member references”</a>.  In the case of component/embedded attributes,
                the join is simply logical and does not correlate to a physical (SQL) join.  Unlike explicit joins,
                however, implicit joins may also reference basic state fields as long as the path expression ends
                there.
            </p>
        </div>
        <div class="section" title="11.3.5. Collection member references"><div class="titlepage"><div><div><h3 class="title"><a id="ql-collection-valued-associations"/>11.3.5. Collection member references</h3></div></div></div>
            
            <p>
                References to collection-valued associations actually refer to the <span class="emphasis"><em>values</em></span> of
                that collection.
            </p>
            <div class="example"><a id="d5e2808"/><p class="title"><strong>Example 11.12. Collection references example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
    join c.orders o
    join o.lineItems l
    join l.product p
where o.status = 'pending'
  and p.status = 'backorder'

// alternate syntax
select c
from Customer c,
    in(c.orders) o,
    in(o.lineItems) l
    join l.product p
where o.status = 'pending'
  and p.status = 'backorder'</pre>
            </div></div><br class="example-break"/>
            <p>
                In the example, the identification variable <code class="literal">o</code> actually refers to the object model
                type <code class="classname">Order</code> which is the type of the elements of the
                <code class="methodname">Customer#orders</code> association.
            </p>
            <p>
                The example also shows the alternate syntax for specifying collection association joins using the
                <code class="literal">IN</code> syntax.  Both forms are equivalent.  Which form an application chooses to use is
                simply a matter of taste.
            </p>
            <div class="section" title="11.3.5.1. Special case - qualified path expressions"><div class="titlepage"><div><div><h4 class="title"><a id="ql-collection-qualification"/>11.3.5.1. Special case - qualified path expressions</h4></div></div></div>
                
                <p>
                    We said earlier that collection-valued associations actually refer to the <span class="emphasis"><em>values</em></span>
                    of that collection.  Based on the type of collection, there are also available a set of
                    explicit qualification expressions.
                </p>
                <div class="example"><a id="d5e2821"/><p class="title"><strong>Example 11.13. Qualified collection references example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// Product.images is a Map&lt;String,String&gt; : key = a name, value = file path

// select all the image file paths (the map value) for Product#123
select i
from Product p
    join p.images i
where p.id = 123

// same as above
select value(i)
from Product p
    join p.images i
where p.id = 123

// select all the image names (the map key) for Product#123
select key(i)
from Product p
    join p.images i
where p.id = 123

// select all the image names and file paths (the 'Map.Entry') for Product#123
select entry(i)
from Product p
    join p.images i
where p.id = 123

// total the value of the initial line items for all orders for a customer
select sum( li.amount )
from Customer c
        join c.orders o
        join o.lineItems li
where c.id = 123
  and index(li) = 1</pre>
                </div></div><br class="example-break"/>
                <div class="variablelist"><dl><dt><span class="term">VALUE</span></dt><dd>
                            <p>
                                Refers to the collection value.  Same as not specifying a qualifier.  Useful to
                                explicitly show intent.  Valid for any type of collection-valued reference.
                            </p>
                        </dd><dt><span class="term">INDEX</span></dt><dd>
                            <p>
                                According to HQL rules, this is valid for both Maps and Lists which specify a
                                <code class="interfacename">javax.persistence.OrderColumn</code> annotation to refer to
                                the Map key or the List position (aka the OrderColumn value).  JPQL however, reserves
                                this for use in the List case and adds <code class="literal">KEY</code> for the MAP case.
                                Applications interested in JPA provider portability should be aware of this
                                distinction.
                            </p>
                        </dd><dt><span class="term">KEY</span></dt><dd>
                            <p>
                                Valid only for Maps.  Refers to the map's key.  If the key is itself an entity,
                                can be further navigated.
                            </p>
                        </dd><dt><span class="term">ENTRY</span></dt><dd>
                            <p>
                                Only valid only for Maps.  Refers to the Map's logical
                                <code class="interfacename">java.util.Map.Entry</code> tuple (the combination  of its key
                                and value).  <code class="literal">ENTRY</code> is only valid as a terminal path and only valid
                                in the select clause.
                            </p>
                        </dd></dl></div>
                <p>
                    See <a class="xref" href="#ql-collection-expressions" title="11.4.9. Collection-related expressions">Section 11.4.9, “Collection-related expressions”</a> for additional details on collection related
                    expressions.
                </p>
            </div>
        </div>
        <div class="section" title="11.3.6. Polymorphism"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2847"/>11.3.6. Polymorphism</h3></div></div></div>
            
            <p>
                HQL and JPQL queries are inherently polymorphic.
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p from Payment p</pre>
            <p>
                This query names the <code class="classname">Payment</code> entity explicitly.  However, all subclasses of
                <code class="classname">Payment</code> are also available to the query.  So if the
                <code class="classname">CreditCardPayment</code> entity and <code class="classname">WireTransferPayment</code> entity
                each extend from <code class="classname">Payment</code> all three types would be available to the query.  And
                the query would return instances of all three.
            </p>
            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>The logical extreme</h2>
                
                <p>
                    The HQL query <code class="literal">from java.lang.Object</code> is totally valid!  It returns every
                    object of every type defined in your application. 
                </p>
            </div>
            <p>
                This can be altered by using either the
                <code class="interfacename">org.hibernate.annotations.Polymorphism</code> annotation (global, and
                Hibernate-specific) or limiting them using in the query itself using an entity type expression.
            </p>
        </div>
    </div>

    <div class="section" title="11.4. Expressions"><div class="titlepage"><div><div><h2 class="title"><a id="ql-expressions"/>11.4. Expressions</h2></div></div></div>
        

        <p>
            Essentially expressions are references that resolve to basic or tuple values.
        </p>

        <div class="section" title="11.4.1. Identification variable"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2866"/>11.4.1. Identification variable</h3></div></div></div>
            
            <p>
                See <a class="xref" href="#ql-from-clause" title="11.3. The FROM clause">Section 11.3, “The <code class="literal">FROM</code> clause”</a>.
            </p>
        </div>

        <div class="section" title="11.4.2. Path expressions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2870"/>11.4.2. Path expressions</h3></div></div></div>
            
            <p>
                Again, see <a class="xref" href="#ql-from-clause" title="11.3. The FROM clause">Section 11.3, “The <code class="literal">FROM</code> clause”</a>.
            </p>
        </div>

        <div class="section" title="11.4.3. Literals"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2874"/>11.4.3. Literals</h3></div></div></div>
            
            <p>
                String literals are enclosed in single-quotes.  To escape a single-quote within a string literal, use
                double single-quotes.
            </p>
            <div class="example"><a id="d5e2877"/><p class="title"><strong>Example 11.14. String literal examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c
from Customer c
where c.name = 'Acme'

select c
from Customer c
where c.name = 'Acme''s Pretzel Logic'

</pre>
            </div></div><br class="example-break"/>

            <p>
                Numeric literals are allowed in a few different forms.
            </p>
            <div class="example"><a id="d5e2881"/><p class="title"><strong>Example 11.15. Numeric literal examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// simple integer literal
select o
from Order o
where o.referenceNumber = 123

// simple integer literal, typed as a long
select o
from Order o
where o.referenceNumber = 123L

// decimal notation
select o
from Order o
where o.total &gt; 5000.00

// decimal notation, typed as a float
select o
from Order o
where o.total &gt; 5000.00F

// scientific notation
select o
from Order o
where o.total &gt; 5e+3

// scientific notation, typed as a float
select o
from Order o
where o.total &gt; 5e+3F</pre>
            </div></div><br class="example-break"/>
            <p>
                In the scientific notation form, the <code class="literal">E</code> is case insensitive.
            </p>
            <p>
                Specific typing can be achieved through the use of the same suffix approach specified by Java.  So,
                <code class="literal">L</code> denotes a long; <code class="literal">D</code> denotes a double; <code class="literal">F</code>
                denotes a float.  The actual suffix is case insensitive.
            </p>

            <p>
                The boolean literals are <code class="literal">TRUE</code> and <code class="literal">FALSE</code>, again case-insensitive.
            </p>

            <p>
                Enums can even be referenced as literals.  The fully-qualified enum class name must be used.  HQL
                can also handle constants in the same manner, though JPQL does not define that as supported.
            </p>

            <p>
                Entity names can also be used as literal.  See <a class="xref" href="#ql-entity-type-exp" title="11.4.10. Entity type">Section 11.4.10, “Entity type”</a>.
            </p>

            <p>
                Date/time literals can be specified using the JDBC escape syntax: <code class="literal">{d 'yyyy-mm-dd'}</code>
                for dates, <code class="literal">{t 'hh:mm:ss'}</code> for times and
                <code class="literal">{ts 'yyyy-mm-dd hh:mm:ss[.millis]'}</code> (millis optional) for timestamps.  These
                literals only work if you JDBC drivers supports them.
            </p>
        </div>

        <div class="section" title="11.4.4. Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2900"/>11.4.4. Parameters</h3></div></div></div>
            
            <p>
                HQL supports all 3 of the following forms.  JPQL does not support the HQL-specific positional
                parameters notion.  It is good practice to not mix forms in a given query.
            </p>
            <div class="section" title="11.4.4.1. Named parameters"><div class="titlepage"><div><div><h4 class="title"><a id="d5e2903"/>11.4.4.1. Named parameters</h4></div></div></div>
                
                <p>
                    Named parameters are declared using a colon followed by an identifier -
                    <code class="literal">:aNamedParameter</code>.  The same named parameter can appear multiple times in a query.
                </p>
                <div class="example"><a id="d5e2907"/><p class="title"><strong>Example 11.16. Named parameter examples</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String queryString =
        "select c " +
        "from Customer c " +
        "where c.name = :name " +
        "   or c.nickName = :name";

// HQL
List customers = session.createQuery( queryString )
        .setParameter( "name", theNameOfInterest )
        .list();

// JPQL
List&lt;Customer&gt; customers = entityManager.createQuery( queryString, Customer.class )
        .setParameter( "name", theNameOfInterest )
        .getResultList();</pre>
                </div></div><br class="example-break"/>
            </div>
            <div class="section" title="11.4.4.2. Positional (JPQL) parameters"><div class="titlepage"><div><div><h4 class="title"><a id="d5e2910"/>11.4.4.2. Positional (JPQL) parameters</h4></div></div></div>
                
                <p>
                    JPQL-style positional parameters are declared using a question mark followed by an ordinal -
                    <code class="literal">?1</code>, <code class="literal">?2</code>.  The ordinals start with 1.  Just like with
                    named parameters, positional parameters can also appear multiple times in a query.
                </p>
                <div class="example"><a id="d5e2915"/><p class="title"><strong>Example 11.17. Positional (JPQL) parameter examples</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String queryString =
        "select c " +
        "from Customer c " +
        "where c.name = ?1 " +
        "   or c.nickName = ?1";

// HQL - as you can see, handled just like named parameters
//      in terms of API
List customers = session.createQuery( queryString )
        .setParameter( "1", theNameOfInterest )
        .list();

// JPQL
List&lt;Customer&gt; customers = entityManager.createQuery( queryString, Customer.class )
        .setParameter( 1, theNameOfInterest )
        .getResultList();</pre>
                </div></div><br class="example-break"/>
            </div>
            <div class="section" title="11.4.4.3. Positional (HQL) parameters"><div class="titlepage"><div><div><h4 class="title"><a id="d5e2918"/>11.4.4.3. Positional (HQL) parameters</h4></div></div></div>
                
                <p>
                    HQL-style positional parameters follow JDBC positional parameter syntax.  They are declared using
                    <code class="literal">?</code> without a following ordinal.  There is no way to relate two such
                    positional parameters as being "the same" aside from binding the same value to each.
                </p>
                <p>
                    This form should be considered deprecated and may be removed in the near future.
                </p>
            </div>
        </div>

        <div class="section" title="11.4.5. Arithmetic"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2923"/>11.4.5. Arithmetic</h3></div></div></div>
            
            <p>
                Arithmetic operations also represent valid expressions.
            </p>
            <div class="example"><a id="d5e2926"/><p class="title"><strong>Example 11.18. Numeric arithmetic examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select year( current_date() ) - year( c.dateOfBirth )
from Customer c

select c
from Customer c
where year( current_date() ) - year( c.dateOfBirth ) &lt; 30

select o.customer, o.total + ( o.total * :salesTax )
from Order o</pre>
            </div></div><br class="example-break"/>
            <p>
                The following rules apply to the result of arithmetic operations:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        If either of the operands is Double/double, the result is a Double;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either of the operands is Float/float, the result is a Float;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is BigDecimal, the result is BigDecimal;
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is BigInteger, the result is BigInteger (except for division, in
                        which case the result type is not further defined);
                    </p>
                </li><li class="listitem">
                    <p>
                        else, if either operand is Long/long, the result is Long (except for division, in
                        which case the result type is not further defined);
                    </p>
                </li><li class="listitem">
                    <p>
                        else, (the assumption being that both operands are of integral type) the result is Integer
                        (except for division, in which case the result type is not further defined);
                    </p>
                </li></ul></div>

            <p>
                Date arithmetic is also supported, albeit in a more limited fashion.  This is due partially to
                differences in database support and partially to the lack of support for <code class="literal">INTERVAL</code>
                definition in the query language itself.
            </p>
        </div>

        <div class="section" title="11.4.6. Concatenation (operation)"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2945"/>11.4.6. Concatenation (operation)</h3></div></div></div>
            
            <p>
                HQL defines a concatenation operator in addition to supporting the concatenation
                (<code class="literal">CONCAT</code>) function.  This is not defined by JPQL, so portable applications
                should avoid it use.  The concatenation operator is taken from the SQL concatenation operator -
                <code class="literal">||</code>.
            </p>
            <div class="example"><a id="d5e2950"/><p class="title"><strong>Example 11.19. Concatenation operation example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select 'Mr. ' || c.name.first || ' ' || c.name.last
from Customer c
where c.gender = Gender.MALE</pre>
            </div></div><br class="example-break"/>
            <p>
                See <a class="xref" href="#ql-exp-functions" title="11.4.8. Scalar functions">Section 11.4.8, “Scalar functions”</a> for details on the <code class="literal">concat()</code> function
            </p>
        </div>

        <div class="section" title="11.4.7. Aggregate functions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e2956"/>11.4.7. Aggregate functions</h3></div></div></div>
            
            <p>
                Aggregate functions are also valid expressions in HQL and JPQL.  The semantic is the same as their
                SQL counterpart.  The supported aggregate functions are:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <code class="literal">COUNT</code> (including distinct/all qualifiers) - The result type is always Long.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">AVG</code> -  The result type is always Double.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">MIN</code> - The result type is the same as the argument type.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">MAX</code> - The result type is the same as the argument type.
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">SUM</code> -  The result type of the <code class="literal">avg()</code> function depends on
                        the type of the values being averaged.  For integral values (other than BigInteger), the result
                        type is Long.  For floating point values (other than BigDecimal) the result type is Double.  For
                        BigInteger values, the result type is BigInteger.  For BigDecimal values, the result type is
                        BigDecimal.
                    </p>
                </li></ul></div>
            <div class="example"><a id="d5e2976"/><p class="title"><strong>Example 11.20. Aggregate function examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select count(*), sum( o.total ), avg( o.total ), min( o.total ), max( o.total )
from Order o

select count( distinct c.name )
from Customer c

select c.id, c.name, sum( o.total )
from Customer c
    left join c.orders o
group by c.id, c.name</pre>
            </div></div><br class="example-break"/>
            <p>
                Aggregations often appear with grouping.  For information on grouping see <a class="xref" href="#ql-grouping" title="11.8. Grouping">Section 11.8, “Grouping”</a>
            </p>
        </div>

        <div class="section" title="11.4.8. Scalar functions"><div class="titlepage"><div><div><h3 class="title"><a id="ql-exp-functions"/>11.4.8. Scalar functions</h3></div></div></div>
            
            <p>
                Both HQL and JPQL define some standard functions that are available regardless of the underlying 
                database in use.  HQL can also understand additional functions defined by the Dialect as well as the 
                application.
            </p>

            <div class="section" title="11.4.8.1. Standardized functions - JPQL"><div class="titlepage"><div><div><h4 class="title"><a id="d5e2984"/>11.4.8.1. Standardized functions - JPQL</h4></div></div></div>
                
                <p>
                    Here are the list of functions defined as supported by JPQL.  Applications interested in remaining
                    portable between JPA providers should stick to these functions.
                </p>
                <div class="variablelist"><dl><dt><span class="term">CONCAT</span></dt><dd>
                            <p>
                                String concatenation function.  Variable argument length of 2 or more string values
                                to be concatenated together.
                            </p>
                        </dd><dt><span class="term">SUBSTRING</span></dt><dd>
                            <p>
                                Extracts a portion of a string value.
                            </p>
                            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">substring( string_expression, numeric_expression [, numeric_expression] )</pre>
                            <p>
                                The second argument denotes the starting position.  The third (optional) argument
                                denotes the length.
                            </p>
                        </dd><dt><span class="term">UPPER</span></dt><dd>
                            <p>
                                Upper cases the specified string
                            </p>
                        </dd><dt><span class="term">LOWER</span></dt><dd>
                            <p>
                                Lower cases the specified string
                            </p>
                        </dd><dt><span class="term">TRIM</span></dt><dd>
                            <p>
                                Follows the semantics of the SQL trim function.
                            </p>
                        </dd><dt><span class="term">LENGTH</span></dt><dd>
                            <p>
                                Returns the length of a string.
                            </p>
                        </dd><dt><span class="term">LOCATE</span></dt><dd>
                            <p>
                                Locates a string within another string.
                            </p>
                            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">locate( string_expression, string_expression[, numeric_expression] )</pre>
                            <p>
                                The third argument (optional) is used to denote a position from which to start looking.
                            </p>
                        </dd><dt><span class="term">ABS</span></dt><dd>
                            <p>
                                Calculates the mathematical absolute value of a numeric value.
                            </p>
                        </dd><dt><span class="term">MOD</span></dt><dd>
                            <p>
                                Calculates the remainder of dividing the first argument by the second.
                            </p>
                        </dd><dt><span class="term">SQRT</span></dt><dd>
                            <p>
                                Calculates the mathematical square root of a numeric value.
                            </p>
                        </dd><dt><span class="term">CURRENT_DATE</span></dt><dd>
                            <p>
                                Returns the database current date.
                            </p>
                        </dd><dt><span class="term">CURRENT_TIME</span></dt><dd>
                            <p>
                                Returns the database current time.
                            </p>
                        </dd><dt><span class="term">CURRENT_TIMESTAMP</span></dt><dd>
                            <p>
                                Returns the database current timestamp.
                            </p>
                        </dd></dl></div>
            </div>
            <div class="section" title="11.4.8.2. Standardized functions - HQL"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3044"/>11.4.8.2. Standardized functions - HQL</h4></div></div></div>
                
                <p>
                    Beyond the JPQL standardized functions, HQL makes some additional functions available regardless
                    of the underlying database in use.
                </p>
                <div class="variablelist"><dl><dt><span class="term">BIT_LENGTH</span></dt><dd>
                            <p>
                                Returns the length of binary data.
                            </p>
                        </dd><dt><span class="term">CAST</span></dt><dd>
                            <p>
                                Performs a SQL cast.  The cast target should name the Hibernate mapping type to use.
                                See the chapter on data types for more information.
                            </p>
                        </dd><dt><span class="term">EXTRACT</span></dt><dd>
                            <p>
                                Performs a SQL extraction on datetime values.  An extraction extracts parts of
                                the datetime (the year, for example).  See the abbreviated forms below.
                            </p>
                        </dd><dt><span class="term">SECOND</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the second.
                            </p>
                        </dd><dt><span class="term">MINUTE</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the minute.
                            </p>
                        </dd><dt><span class="term">HOUR</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the hour.
                            </p>
                        </dd><dt><span class="term">DAY</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the day.
                            </p>
                        </dd><dt><span class="term">MONTH</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the month.
                            </p>
                        </dd><dt><span class="term">YEAR</span></dt><dd>
                            <p>
                                Abbreviated extract form for extracting the year.
                            </p>
                        </dd><dt><span class="term">STR</span></dt><dd>
                            <p>
                                Abbreviated form for casting a value as character data.
                            </p>
                        </dd></dl></div>
            </div>

            <div class="section" title="11.4.8.3. Non-standardized functions"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3088"/>11.4.8.3. Non-standardized functions</h4></div></div></div>
                
                <p>
                    Hibernate Dialects can register additional functions known to be available for that particular
                    database product.  These functions are also available in HQL (and JPQL, though only when using
                    Hibernate as the JPA provider obviously).  However, they would only be available when using that
                    database/Dialect.  Applications that aim for database portability should avoid using functions
                    in this category.
                </p>
                <p>
                    Application developers can also supply their own set of functions.  This would usually represent
                    either custom SQL functions or aliases for snippets of SQL.  Such function declarations are
                    made by using the <code class="methodname">addSqlFunction</code> method of
                    <code class="classname">org.hibernate.cfg.Configuration</code>
                </p>
            </div>
        </div>

        <div class="section" title="11.4.9. Collection-related expressions"><div class="titlepage"><div><div><h3 class="title"><a id="ql-collection-expressions"/>11.4.9. Collection-related expressions</h3></div></div></div>
            
            <p>
                There are a few specialized expressions for working with collection-valued associations.  Generally
                these are just abbreviated forms or other expressions for the sake of conciseness.
            </p>
            <div class="variablelist"><dl><dt><span class="term">SIZE</span></dt><dd>
                        <p>
                            Calculate the size of a collection.  Equates to a subquery!
                        </p>
                    </dd><dt><span class="term">MAXELEMENT</span></dt><dd>
                        <p>
                            Available for use on collections of basic type.  Refers to the maximum value as determined
                            by applying the <code class="literal">max</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MAXINDEX</span></dt><dd>
                        <p>
                            Available for use on indexed collections.  Refers to the maximum index (key/position) as
                            determined by applying the <code class="literal">max</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MINELEMENT</span></dt><dd>
                        <p>
                            Available for use on collections of basic type.  Refers to the minimum value as determined
                            by applying the <code class="literal">min</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">MININDEX</span></dt><dd>
                        <p>
                            Available for use on indexed collections.  Refers to the minimum index (key/position) as
                            determined by applying the <code class="literal">min</code> SQL aggregation.
                        </p>
                    </dd><dt><span class="term">ELEMENTS</span></dt><dd>
                        <p>
                            Used to refer to the elements of a collection as a whole.  Only allowed in the where clause.
                            Often used in conjunction with <code class="literal">ALL</code>, <code class="literal">ANY</code> or
                            <code class="literal">SOME</code> restrictions.
                        </p>
                    </dd><dt><span class="term">INDICES</span></dt><dd>
                        <p>
                            Similar to <code class="literal">elements</code> except that <code class="literal">indices</code> refers to
                            the collections indices (keys/positions) as a whole.
                        </p>
                    </dd></dl></div>
            <div class="example"><a id="d5e3135"/><p class="title"><strong>Example 11.21. Collection-related expressions examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select cal
from Calendar cal
where maxelement(cal.holidays) &gt; current_date()

select o
from Order o
where maxindex(o.items) &gt; 100

select o
from Order o
where minelement(o.items) &gt; 10000

select m
from Cat as m, Cat as kit
where kit in elements(m.kittens)

// the above query can be re-written in jpql standard way:
select m
from Cat as m, Cat as kit
where kit member of m.kittens

select p
from NameList l, Person p
where p.name = some elements(l.names)

select cat
from Cat cat
where exists elements(cat.kittens)

select p
from Player p
where 3 &gt; all elements(p.scores)

select show
from Show show
where 'fizard' in indices(show.acts)</pre>
            </div></div><br class="example-break"/>
            <p>
                Elements of indexed collections (arrays, lists, and maps) can be referred to by index operator.
            </p>
            <div class="example"><a id="d5e3139"/><p class="title"><strong>Example 11.22. Index operator examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select o
from Order o
where o.items[0].id = 1234

select p
from Person p, Calendar c
where c.holidays['national day'] = p.birthDay
  and p.nationality.calendar = c

select i
from Item i, Order o
where o.items[ o.deliveredItemIndices[0] ] = i
  and o.id = 11

select i
from Item i, Order o
where o.items[ maxindex(o.items) ] = i
  and o.id = 11

select i
from Item i, Order o
where o.items[ size(o.items) - 1 ] = i</pre>
            </div></div><br class="example-break"/>
            <p>
                See also <a class="xref" href="#ql-collection-qualification" title="11.3.5.1. Special case - qualified path expressions">Section 11.3.5.1, “Special case - qualified path expressions”</a> as there is a good deal of overlap.
            </p>
        </div>

        <div class="section" title="11.4.10. Entity type"><div class="titlepage"><div><div><h3 class="title"><a id="ql-entity-type-exp"/>11.4.10. Entity type</h3></div></div></div>
            
            <p>
                We can also refer to the type of an entity as an expression.  This is mainly useful when dealing
                with entity inheritance hierarchies.  The type can expressed using a <code class="literal">TYPE</code> function
                used to refer to the type of an identification variable representing an entity.  The name of the
                entity also serves as a way to refer to an entity type.  Additionally the entity type can be
                parametrized, in which case the entity's Java Class reference would be bound as the parameter
                value.
            </p>
            <div class="example"><a id="d5e3148"/><p class="title"><strong>Example 11.23. Entity type expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Payment p
where type(p) = CreditCardPayment

select p
from Payment p
where type(p) = :aType

</pre>
            </div></div><br class="example-break"/>
            <p>
                HQL also has a legacy form of referring to an entity type, though that legacy form is considered
                deprecated in favor of <code class="literal">TYPE</code>.  The legacy form would have used <code class="literal">p.class</code>
                in the examples rather than <code class="literal">type(p)</code>.  It is mentioned only for completeness.
            </p>
        </div>

        <div class="section" title="11.4.11. CASE expressions"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3155"/>11.4.11. CASE expressions</h3></div></div></div>
            
            <p>
                Both the simple and searched forms are supported, as well as the 2 SQL defined abbreviated forms
                (<code class="literal">NULLIF</code> and <code class="literal">COALESCE</code>)
            </p>
            <div class="section" title="11.4.11.1. Simple CASE expressions"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3160"/>11.4.11.1. Simple CASE expressions</h4></div></div></div>
                
                <p>
                    The simple form has the following syntax:
                </p>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CASE {operand} WHEN {test_value} THEN {match_result} ELSE {miss_result} END</pre>
                <div class="example"><a id="d5e3164"/><p class="title"><strong>Example 11.24. Simple case expression example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select case c.nickName when null then '&lt;no nick name&gt;' else c.nickName end
from Customer c

// This NULL checking is such a common case that most dbs
// define an abbreviated CASE form.  For example:
select nvl( c.nickName, '&lt;no nick name&gt;' )
from Customer c

// or:
select isnull( c.nickName, '&lt;no nick name&gt;' )
from Customer c

// the standard coalesce abbreviated form can be used
// to achieve the same result:
select coalesce( c.nickName, '&lt;no nick name&gt;' )
from Customer c
</pre>
                </div></div><br class="example-break"/>
            </div>
            <div class="section" title="11.4.11.2. Searched CASE expressions"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3167"/>11.4.11.2. Searched CASE expressions</h4></div></div></div>
                
                <p>
                    The searched form has the following syntax:
                </p>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CASE [ WHEN {test_conditional} THEN {match_result} ]* ELSE {miss_result} END</pre>
                <div class="example"><a id="d5e3171"/><p class="title"><strong>Example 11.25. Searched case expression example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select case when c.name.first is not null then c.name.first
            when c.nickName is not null then c.nickName
            else '&lt;no first name&gt;' end
from Customer c

// Again, the abbreviated form coalesce can handle this a
// little more succinctly
select coalesce( c.name.first, c.nickName, '&lt;no first name&gt;' )
from Customer c
</pre>
                </div></div><br class="example-break"/>
            </div>
            <div class="section" title="11.4.11.3. NULLIF expressions"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3174"/>11.4.11.3. NULLIF expressions</h4></div></div></div>
                
                <p>
                    NULLIF is an abbreviated CASE expression that returns NULL if its operands are considered equal.
                </p>
                <div class="example"><a id="d5e3177"/><p class="title"><strong>Example 11.26. NULLIF example</strong></p><div class="example-contents">
                    
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// return customers who have changed their last name
select nullif( c.previousName.last, c.name.last )
from Customer c

// equivalent CASE expression
select case when c.previousName.last = c.name.last then null
            else c.previousName.last end
from Customer c
</pre>
                </div></div><br class="example-break"/>
            </div>
            <div class="section" title="11.4.11.4. COALESCE expressions"><div class="titlepage"><div><div><h4 class="title"><a id="d5e3180"/>11.4.11.4. COALESCE expressions</h4></div></div></div>
                
                <p>
                    COALESCE is an  abbreviated CASE expression that returns the first non-null operand.  We have seen a 
                    number of COALESCE examples above.
                </p>
            </div>
        </div>
    </div>

    <div class="section" title="11.5. The SELECT clause"><div class="titlepage"><div><div><h2 class="title"><a id="ql-select-clause"/>11.5. The <code class="literal">SELECT</code> clause</h2></div></div></div>
        
        <p>
            The <code class="literal">SELECT</code> clause identifies which objects and values to return as the query results.
            The expressions discussed in <a class="xref" href="#ql-expressions" title="11.4. Expressions">Section 11.4, “Expressions”</a> are all valid select expressions, except
            where otherwise noted.  See the section <a class="xref" href="#ql-api" title="11.10. Query API">Section 11.10, “Query API”</a> for information on handling the results
            depending on the types of values specified in the <code class="literal">SELECT</code> clause.
        </p>

        <p>
            There is a particular expression type that is only valid in the select clause.  Hibernate calls this
            <span class="quote">“<span class="quote">dynamic instantiation</span>”</span>.  JPQL supports some of that feature and calls it
            a <span class="quote">“<span class="quote">constructor expression</span>”</span>
        </p>

        <div class="example"><a id="d5e3194"/><p class="title"><strong>Example 11.27. Dynamic instantiation example - constructor</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new Family( mother, mate, offspr )
from DomesticCat as mother
    join mother.mate as mate
    left join mother.kittens as offspr</pre>
        </div></div><br class="example-break"/>

        <p>
            So rather than dealing with the Object[] (again, see <a class="xref" href="#ql-api" title="11.10. Query API">Section 11.10, “Query API”</a>) here we are wrapping
            the values in a type-safe java object that will be returned as the results of the query.  The class
            reference must be fully qualified and it must have a matching constructor.
        </p>
        <p>
            The class here need not be mapped.  If it does represent an entity, the resulting instances are
            returned in the NEW state (not managed!).
        </p>

        <p>
            That is the part JPQL supports as well.  HQL supports additional <span class="quote">“<span class="quote">dynamic instantiation</span>”</span>
            features.  First, the query can specify to return a List rather than an Object[] for scalar results:
        </p>
        <div class="example"><a id="d5e3202"/><p class="title"><strong>Example 11.28. Dynamic instantiation example - list</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new list(mother, offspr, mate.name)
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr</pre>
        </div></div><br class="example-break"/>
        <p>
            The results from this query will be a List&lt;List&gt; as opposed to a List&lt;Object[]&gt;
        </p>

        <p>
            HQL also supports wrapping the scalar results in a Map.
        </p>
        <div class="example"><a id="d5e3207"/><p class="title"><strong>Example 11.29. Dynamic instantiation example - map</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select new map( mother as mother, offspr as offspr, mate as mate )
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr

select new map( max(c.bodyWeight) as max, min(c.bodyWeight) as min, count(*) as n )
from Cat c</pre>
        </div></div><br class="example-break"/>
        <p>
            The results from this query will be a List&lt;Map&lt;String,Object&gt;&gt; as opposed to a
            List&lt;Object[]&gt;.  The keys of the map are defined by the aliases given to the select
            expressions.
        </p>
    </div>

    <div class="section" title="11.6. Predicates"><div class="titlepage"><div><div><h2 class="title"><a id="ql-conditional-expressions"/>11.6. Predicates</h2></div></div></div>
        
        <p>
            Predicates form the basis of the where clause, the having clause and searched case expressions.
            They are expressions which resolve to a truth value, generally <code class="literal">TRUE</code> or
            <code class="literal">FALSE</code>, although boolean comparisons involving NULLs generally resolve to
            <code class="literal">UNKNOWN</code>.
        </p>

        <div class="section" title="11.6.1. Relational comparisons"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3217"/>11.6.1. Relational comparisons</h3></div></div></div>
            
            <p>
                Comparisons involve one of the comparison operators - =, &gt;, &gt;=, &lt;, &lt;=, &lt;&gt;]&gt;.  HQL also defines
                &lt;![CDATA[!= as a comparison operator synonymous with &lt;&gt;.  The operands should be
                of the same type.
            </p>
            <div class="example"><a id="d5e3220"/><p class="title"><strong>Example 11.30. Relational comparison examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// numeric comparison
select c
from Customer c
where c.chiefExecutive.age &lt; 30

// string comparison
select c
from Customer c
where c.name = 'Acme'

// datetime comparison
select c
from Customer c
where c.inceptionDate &lt; {d '2000-01-01'}

// enum comparison
select c
from Customer c
where c.chiefExecutive.gender = com.acme.Gender.MALE

// boolean comparison
select c
from Customer c
where c.sendEmail = true

// entity type comparison
select p
from Payment p
where type(p) = WireTransferPayment

// entity value comparison
select c
from Customer c
where c.chiefExecutive = c.chiefTechnologist</pre>
            </div></div><br class="example-break"/>
            <p>
                Comparisons can also involve subquery qualifiers - <code class="literal">ALL</code>, <code class="literal">ANY</code>,
                <code class="literal">SOME</code>.  SOME and ANY are synonymous.
            </p>
            <p>
                The ALL qualifier resolves to true if the comparison is true for all of the values in the result of
                the subquery.  It resolves to false if the subquery result is empty.
            </p>
            <div class="example"><a id="d5e3228"/><p class="title"><strong>Example 11.31. ALL subquery comparison qualifier example</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// select all players that scored at least 3 points
// in every game.
select p
from Player p
where 3 &gt; all (
    select spg.points
    from StatsPerGame spg
    where spg.player = p
)</pre>
            </div></div><br class="example-break"/>
            <p>
                The ANY/SOME qualifier resolves to true if the comparison is true for some of (at least one of) the
                values in the result of the subquery.  It resolves to false if the subquery result is empty.
            </p>
        </div>

        <div class="section" title="11.6.2. Nullness predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3232"/>11.6.2. Nullness predicate</h3></div></div></div>
            
            <p>
                Check a value for nullness.  Can be applied to basic attribute references, entity references and
                parameters.  HQL additionally allows it to be applied to component/embeddable types.
            </p>
            <div class="example"><a id="d5e3235"/><p class="title"><strong>Example 11.32. Nullness checking examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// select everyone with an associated address
select p
from Person p
where p.address is not null

// select everyone without an associated address
select p
from Person p
where p.address is null</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.3. Like predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3238"/>11.6.3. Like predicate</h3></div></div></div>
            
            <p>
                Performs a like comparison on string values.  The syntax is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">like_expression ::=
        string_expression
        [NOT] LIKE pattern_value
        [ESCAPE escape_character]
</pre>
            <p>
                The semantics follow that of the SQL like expression.  The <code class="literal">pattern_value</code> is the
                pattern to attempt to match in the <code class="literal">string_expression</code>.  Just like SQL,
                <code class="literal">pattern_value</code> can use <span class="quote">“<span class="quote">_</span>”</span> and <span class="quote">“<span class="quote">%</span>”</span> as wildcards.  The
                meanings are the same.  <span class="quote">“<span class="quote">_</span>”</span> matches any single character.  <span class="quote">“<span class="quote">%</span>”</span> matches
                any number of characters.
            </p>
            <p>
                The optional <code class="literal">escape_character</code> is used to specify an escape character used to
                escape the special meaning of <span class="quote">“<span class="quote">_</span>”</span> and <span class="quote">“<span class="quote">%</span>”</span> in the
                <code class="literal">pattern_value</code>.  THis is useful when needing to search on patterns including either
                <span class="quote">“<span class="quote">_</span>”</span> or <span class="quote">“<span class="quote">%</span>”</span>
            </p>
            <div class="example"><a id="d5e3257"/><p class="title"><strong>Example 11.33. Like predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Person p
where p.name like '%Schmidt'

select p
from Person p
where p.name not like 'Jingleheimmer%'

// find any with name starting with "sp_"
select sp
from StoredProcedureMetadata sp
where sp.name like 'sp|_%' escape '|'

</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.4. Between predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3260"/>11.6.4. Between predicate</h3></div></div></div>
            
            <p>
                Analogous to the SQL between expression.  Perform a evaluation that a value is within the range
                of 2 other values.  All the operands should have comparable types.
            </p>
            <div class="example"><a id="d5e3263"/><p class="title"><strong>Example 11.34. Between predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Customer c
    join c.paymentHistory p
where c.id = 123
  and index(p) between 0 and 9

select c
from Customer c
where c.president.dateOfBirth
        between {d '1945-01-01'}
            and {d '1965-01-01'}

select o
from Order o
where o.total between 500 and 5000

select p
from Person p
where p.name between 'A' and 'E' </pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.5. In predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3266"/>11.6.5. In predicate</h3></div></div></div>
            
            <p>
                <code class="literal">IN</code> predicates performs a check that a particular value is in a list of values.
                Its syntax is:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">in_expression ::= single_valued_expression
            [NOT] IN single_valued_list

single_valued_list ::= constructor_expression |
            (subquery) |
            collection_valued_input_parameter

constructor_expression ::= (expression[, expression]*)</pre>
            <p>
                The types of the <code class="literal">single_valued_expression</code> and the individual values in the
                <code class="literal">single_valued_list</code> must be consistent.    JPQL limits the valid types here
                to string, numeric, date, time, timestamp, and enum types.  In JPQL,
                <code class="literal">single_valued_expression</code> can only refer to:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        <span class="quote">“<span class="quote">state fields</span>”</span>, which is its term for simple attributes.  Specifically this
                        excludes association and component/embedded attributes.
                    </p>
                </li><li class="listitem">
                    <p>
                        entity type expressions.  See <a class="xref" href="#ql-entity-type-exp" title="11.4.10. Entity type">Section 11.4.10, “Entity type”</a>
                    </p>
                </li></ul></div>
            <p>
                In HQL, <code class="literal">single_valued_expression</code> can refer to a far more broad set of expression
                types.  Single-valued association are allowed.  So are component/embedded attributes, although that
                feature depends on the level of support for tuple or <span class="quote">“<span class="quote">row value constructor syntax</span>”</span> in
                the underlying database.  Additionally, HQL does not limit the value type in any way, though
                application developers should be aware that different types may incur limited support based on
                the underlying database vendor.  This is largely the reason for the JPQL limitations.
            </p>
            <p>
                The list of values can come from a number of different sources.  In the
                <code class="literal">constructor_expression</code> and <code class="literal">collection_valued_input_parameter</code>, the
                list of values must not be empty; it must contain at least one value.
            </p>
            <div class="example"><a id="d5e3288"/><p class="title"><strong>Example 11.35. In predicate examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Payment p
where type(p) in (CreditCardPayment, WireTransferPayment)

select c
from Customer c
where c.hqAddress.state in ('TX', 'OK', 'LA', 'NM')

select c
from Customer c
where c.hqAddress.state in ?

select c
from Customer c
where c.hqAddress.state in (
    select dm.state
    from DeliveryMetadata dm
    where dm.salesTax is not null
)

// Not JPQL compliant!
select c
from Customer c
where c.name in (
    ('John','Doe'),
    ('Jane','Doe')
)

// Not JPQL compliant!
select c
from Customer c
where c.chiefExecutive in (
    select p
    from Person p
    where ...
)</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.6. Exists predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3291"/>11.6.6. Exists predicate</h3></div></div></div>
            
            <p>
                Exists expressions test the existence of results from a subquery.  The affirmative form returns true
                if the subquery result contains values.  The negated form returns true if the subquery
                result is empty.
            </p>
        </div>

        <div class="section" title="11.6.7. Empty collection predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3294"/>11.6.7. Empty collection predicate</h3></div></div></div>
            
            <p>
                The <code class="literal">IS [NOT] EMPTY</code> expression applies to collection-valued path expressions.  It
                checks whether the particular collection has any associated values.
            </p>
            <div class="example"><a id="d5e3298"/><p class="title"><strong>Example 11.36. Empty collection expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select o
from Order o
where o.lineItems is empty

select c
from Customer c
where c.pastDueBills is not empty</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.8. Member-of collection predicate"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3301"/>11.6.8. Member-of collection predicate</h3></div></div></div>
            
            <p>
                The <code class="literal">[NOT] MEMBER [OF]</code> expression applies to collection-valued path expressions.  It
                checks whether a value is a member of the specified collection.
            </p>
            <div class="example"><a id="d5e3305"/><p class="title"><strong>Example 11.37. Member-of collection expression examples</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select p
from Person p
where 'John' member of p.nickNames

select p
from Person p
where p.name.first = 'Joseph'
  and 'Joey' not member of p.nickNames
</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="11.6.9. NOT predicate operator"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3308"/>11.6.9. NOT predicate operator</h3></div></div></div>
            
            <p>
                The <code class="literal">NOT</code> operator is used to negate the predicate that follows it.  If that
                following predicate is true, the NOT resolves to false.  If the predicate is true, NOT resolves to
                false.  If the predicate is unknown, the NOT resolves to unknown as well.
            </p>
        </div>

        <div class="section" title="11.6.10. AND predicate operator"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3312"/>11.6.10. AND predicate operator</h3></div></div></div>
            
            <p>
                The <code class="literal">AND</code> operator is used to combine 2 predicate expressions.  The result of the
                AND expression is true if and only if both predicates resolve to true.  If either predicate resolves
                to unknown, the AND expression resolves to unknown as well.  Otherwise, the result is false.
            </p>
        </div>

        <div class="section" title="11.6.11. OR predicate operator"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3316"/>11.6.11. OR predicate operator</h3></div></div></div>
            
            <p>
                The <code class="literal">OR</code> operator is used to combine 2 predicate expressions.  The result of the
                OR expression is true if either predicate resolves to true.  If both predicates resolve to unknown, the
                OR expression resolves to unknown.  Otherwise, the result is false.
            </p>
        </div>
    </div>

    <div class="section" title="11.7. The WHERE clause"><div class="titlepage"><div><div><h2 class="title"><a id="ql-where-clause"/>11.7. The <code class="literal">WHERE</code> clause</h2></div></div></div>
        
        <p>
            The <code class="literal">WHERE</code> clause of a query is made up of predicates which assert whether values in
            each potential row match the predicated checks.  Thus, the where clause restricts the results returned
            from a select query and limits the scope of update and delete queries.
        </p>
    </div>

    <div class="section" title="11.8. Grouping"><div class="titlepage"><div><div><h2 class="title"><a id="ql-grouping"/>11.8. Grouping</h2></div></div></div>
        
        <p>
            The <code class="literal">GROUP BY</code> clause allows building aggregated results for various value groups.  As an
            example, consider the following queries:
        </p>
        <div class="example"><a id="group_by_illustration"/><p class="title"><strong>Example 11.38. Group-by illustration</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// retrieve the total for all orders
select sum( o.total )
from Order o

// retrieve the total of all orders
// *grouped by* customer
select c.id, sum( o.total )
from Order o
    inner join o.customer c
group by c.id</pre>
        </div></div><br class="example-break"/>
        <p>
            The first query retrieves the complete total of all orders.  The second retrieves the total for each
            customer; grouped by each customer.
        </p>
        <p>
            In a grouped query, the where clause applies to the non aggregated values (essentially it determines whether
            rows will make it into the aggregation).  The <code class="literal">HAVING</code> clause also restricts results,
            but it operates on the aggregated values.  In the <a class="xref" href="#group_by_illustration" title="Example 11.38. Group-by illustration">Example 11.38, “Group-by illustration”</a> example,
            we retrieved order totals for all customers.  If that ended up being too much data to deal with,
            we might want to restrict the results to focus only on customers with a summed order total of more than
            $10,000.00:
        </p>
        <div class="example"><a id="having_illustration"/><p class="title"><strong>Example 11.39. Having illustration</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">select c.id, sum( o.total )
from Order o
    inner join o.customer c
group by c.id
having sum( o.total ) &gt; 10000.00</pre>
        </div></div><br class="example-break"/>
        <p>
            The HAVING clause follows the same rules as the WHERE clause and is also made up of predicates.  HAVING is
            applied after the groupings and aggregations have been done; WHERE is applied before.
        </p>
    </div>

    <div class="section" title="11.9. Ordering"><div class="titlepage"><div><div><h2 class="title"><a id="ql-ordering"/>11.9. Ordering</h2></div></div></div>
        
        <p>
            The results of the query can also be ordered.  The <code class="literal">ORDER BY</code> clause is used to specify
            the selected values to be used to order the result.  The types of expressions considered valid as part
             of the order-by clause include:
        </p>
        <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                    state fields
                </p>
            </li><li class="listitem">
                <p>
                    component/embeddable attributes
                </p>
            </li><li class="listitem">
                <p>
                    scalar expressions such as arithmetic operations, functions, etc.
                </p>
            </li><li class="listitem">
                <p>
                    identification variable declared in the select clause for any of the previous expression types
                </p>
            </li></ul></div>
        <p>
            Additionally, JPQL says that all values referenced in the order-by clause must be named in the select
            clause.  HQL does not mandate that restriction, but applications desiring database portability should be
            aware that not all databases support referencing values in the order-by clause that are not referenced
            in the select clause.
        </p>
        <p>
            Individual expressions in the order-by can be qualified with either <code class="literal">ASC</code> (ascending) or
            <code class="literal">DESC</code> (descending) to indicated the desired ordering direction. Null values can be placed
            in front or at the end of sorted set using <code class="literal">NULLS FIRST</code> or <code class="literal">NULLS LAST</code>
            clause respectively.
        </p>
        <div class="example"><a id="d5e3359"/><p class="title"><strong>Example 11.40. Order-by examples</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">// legal because p.name is implicitly part of p
select p
from Person p
order by p.name

select c.id, sum( o.total ) as t
from Order o
    inner join o.customer c
group by c.id
order by t
</pre>
        </div></div><br class="example-break"/>
    </div>

    <div class="section" title="11.10. Query API"><div class="titlepage"><div><div><h2 class="title"><a id="ql-api"/>11.10. Query API</h2></div></div></div>
        
    </div>
</div>
    <div class="chapter" title="Chapter 12. Criteria"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3364"/>Chapter 12. Criteria</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#querycriteria-typedquery">12.1. Typed criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">12.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">12.1.2. Selecting an expression</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">12.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">12.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">12.2. Tuple criteria queries</a></span></dt><dt><span class="section"><a href="#querycriteria-from">12.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">12.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">12.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">12.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">12.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">12.5. Using parameters</a></span></dt></dl></div>

    

    <p>
        Criteria queries offer a type-safe alternative to HQL, JPQL and native-sql queries.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
        <p>
            Hibernate offers an older, legacy <code class="interfacename">org.hibernate.Criteria</code> API which should be
            considered deprecated.  No feature development will target those APIs.  Eventually, Hibernate-specific
            criteria features will be ported as extensions to the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>.  For details on the
            <code class="interfacename">org.hibernate.Criteria</code> API, see <a class="xref" href="#">???</a>.
        </p>
        <p>
            This chapter will focus on the JPA APIs for declaring type-safe criteria queries.
        </p>
    </div>


    <p>
        Criteria queries are a programmatic, type-safe way to express a query.  They are type-safe in terms of
        using interfaces and classes to represent various structural parts of a query such as the query itself,
        or the select clause, or an order-by, etc.  They can also be type-safe in terms of referencing attributes
        as we will see in a bit. Users of the older Hibernate <code class="interfacename">org.hibernate.Criteria</code>
        query API will recognize the general approach, though we believe the JPA API to be superior
        as it represents a clean look at the lessons learned from that API.
    </p>

    <p>
        Criteria queries are essentially an object graph, where each part of the graph represents an increasing
        (as we navigate down this graph) more atomic part of query. The first step in performing a criteria query
        is building this graph. The <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
        interface is the first thing with which you need to become acquainted to begin using criteria queries. Its
        role is that of a factory for all the individual pieces of the criteria. You obtain a
        <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> instance by calling the
        <code class="methodname">getCriteriaBuilder</code> method of either
        <code class="interfacename">javax.persistence.EntityManagerFactory</code> or
        <code class="interfacename">javax.persistence.EntityManager</code>.
    </p>

    <p>
        The next step is to obtain a <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>. This
        is accomplished using one of the 3 methods on
        <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> for this purpose:
    </p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;T&gt; CriteriaQuery&lt;T&gt; createQuery(Class&lt;T&gt; resultClass);
CriteriaQuery&lt;Tuple&gt; createTupleQuery();
CriteriaQuery&lt;Object&gt; createQuery();
</pre>

    <p>
        Each serves a different purpose depending on the expected type of the query results.
    </p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            <em class="citetitle">Chapter 6 Criteria API</em> of the JPA Specification
            already contains a decent amount of reference material pertaining to the various parts of a
            criteria query. So rather than duplicate all that content here, lets instead look at some of
            the more widely anticipated usages of the API.
        </p>
    </div>

    <div class="section" title="12.1. Typed criteria queries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-typedquery"/>12.1. Typed criteria queries</h2></div></div></div>
        

        <p>
            The type of the criteria query (aka the &lt;T&gt;) indicates the expected types in the query
            result.  This might be an entity, an Integer, or any other object.
        </p>

        <div class="section" title="12.1.1. Selecting an entity"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-entity"/>12.1.1. Selecting an entity</h3></div></div></div>
            

            <p>
                This is probably the most common form of query.  The application wants to select entity instances.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-entity"/><p class="title"><strong>Example 12.1. Selecting the root entity</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; criteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Person&gt; people = em.createQuery( criteria ).getResultList();
for ( Person person : people ) {
    ...
}</pre>
            </div></div><br class="example-break"/>

            <p>
                The example uses <code class="methodname">createQuery</code> passing in the <code class="classname">Person</code>
                class reference as the results of the query will be Person objects.
            </p>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    The call to the <code class="methodname">CriteriaQuery.select</code> method in this example is
                    unnecessary because <span class="emphasis"><em>personRoot</em></span> will be the implied selection since we
                    have only a single query root. It was done here only for completeness of an example.
                </p>
                <p>
                    The <span class="emphasis"><em>Person_.eyeColor</em></span> reference is an example of the static form of JPA
                    metamodel reference.  We will use that form exclusively in this chapter.  See
                    the documentation for the Hibernate JPA Metamodel Generator for additional details on
                    the JPA static metamodel.
                </p>
            </div>
        </div>

        <div class="section" title="12.1.2. Selecting an expression"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-expression"/>12.1.2. Selecting an expression</h3></div></div></div>
            

            <p>
                The simplest form of selecting an expression is selecting a particular attribute from an entity.
                But this expression might also represent an aggregation, a mathematical operation, etc.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-attribute"/><p class="title"><strong>Example 12.2. Selecting an attribute</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Integer&gt; criteria = builder.createQuery( Integer.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot.get( Person_.age ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Integer&gt; ages = em.createQuery( criteria ).getResultList();
for ( Integer age : ages ) {
	...
}</pre>
            </div></div><br class="example-break"/>

            <p>
                In this example, the query is typed as <code class="classname">java.lang.Integer</code> because that
                is the anticipated type of the results (the type of the <code class="methodname">Person#age</code> attribute
                is <code class="classname">java.lang.Integer</code>).  Because a query might contain multiple references to
                the Person entity, attribute references always need to be qualified.  This is accomplished by the
                <code class="methodname">Root#get</code> method call.
            </p>
        </div>


        <div class="section" title="12.1.3. Selecting multiple values"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-multiselect"/>12.1.3. Selecting multiple values</h3></div></div></div>
            

            <p>
                There are actually a few different ways to select multiple values using criteria queries. We
                will explore 2 options here, but an alternative recommended approach is to use tuples as described in
                <a class="xref" href="#querycriteria-tuple" title="12.2. Tuple criteria queries">Section 12.2, “Tuple criteria queries”</a>.  Or consider a wrapper query; see
                <a class="xref" href="#querycriteria-typedquery-construct" title="12.1.4. Selecting a wrapper">Section 12.1.4, “Selecting a wrapper”</a> for details.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-array"/><p class="title"><strong>Example 12.3. Selecting an array</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.select( builder.array( idPath, agePath ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Object[]&gt; valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
	final Long id = (Long) values[0];
	final Integer age = (Integer) values[1];
	...
}</pre>
            </div></div><br class="example-break"/>

            <p>
                Technically this is classified as a typed query, but you can see from handling the results that
                this is sort of misleading.  Anyway, the expected result type here is an array.
            </p>

            <p>
                The example then uses the <code class="methodname">array</code> method of
                <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> which explicitly
                combines individual selections into a
                <code class="interfacename">javax.persistence.criteria.CompoundSelection</code>.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-array2"/><p class="title"><strong>Example 12.4. Selecting an array (2)</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multiselect( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Object[]&gt; valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
    final Long id = (Long) values[0];
    final Integer age = (Integer) values[1];
    ...
}</pre>
            </div></div><br class="example-break"/>

            <p>
                Just as we saw in <a class="xref" href="#ex-criteria-typedquery-array" title="Example 12.3. Selecting an array">Example 12.3, “Selecting an array”</a> we have a typed criteria
                query returning an Object array.  Both queries are functionally equivalent.  This second example
                uses the <code class="methodname">multiselect</code> method which behaves slightly differently based on
                the type given when the criteria query was first built, but in this case it says to select and
                return an <span class="emphasis"><em>Object[]</em></span>.
            </p>
        </div>

        <div class="section" title="12.1.4. Selecting a wrapper"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-construct"/>12.1.4. Selecting a wrapper</h3></div></div></div>
            

            <p>Another alternative to <a class="xref" href="#querycriteria-typedquery-multiselect" title="12.1.3. Selecting multiple values">Section 12.1.3, “Selecting multiple values”</a> is to instead
                select an object that will <span class="quote">“<span class="quote">wrap</span>”</span> the multiple values. Going back to the example
                query there, rather than returning an array of <span class="emphasis"><em>[Person#id, Person#age]</em></span>
                instead declare a class that holds these values and instead return that.
            </p>

            <div class="example"><a id="ex-criteria-typedquery-construct"/><p class="title"><strong>Example 12.5. Selecting an wrapper</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">public class PersonWrapper {
	private final Long id;
	private final Integer age;
	public PersonWrapper(Long id, Integer age) {
		this.id = id;
		this.age = age;
	}
	...
}

...

CriteriaQuery&lt;PersonWrapper&gt; criteria = builder.createQuery( PersonWrapper.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select(
		builder.construct(
			PersonWrapper.class,
			personRoot.get( Person_.id ),
			personRoot.get( Person_.age )
		)
);
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;PersonWrapper&gt; people = em.createQuery( criteria ).getResultList();
for ( PersonWrapper person : people ) {
    ...
}</pre>
            </div></div><br class="example-break"/>

            <p>
                First we see the simple definition of the wrapper object we will be using to wrap our result
                values. Specifically notice the constructor and its argument types.  Since we will be returning
                <code class="classname">PersonWrapper</code> objects, we use <code class="classname">PersonWrapper</code> as the
                type of our criteria query.
            </p>

            <p>
                This example illustrates the use of the
                <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> method
                <code class="methodname">construct</code> which is used to build a wrapper expression.  For every row in the
                result we are saying we would like a <span class="emphasis"><em>PersonWrapper</em></span> instantiated with
                the remaining arguments by the matching constructor. This wrapper expression is then passed as
                the select.
            </p>
        </div>
    </div>

    <div class="section" title="12.2. Tuple criteria queries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-tuple"/>12.2. Tuple criteria queries</h2></div></div></div>
        

        <p>
            A better approach to <a class="xref" href="#querycriteria-typedquery-multiselect" title="12.1.3. Selecting multiple values">Section 12.1.3, “Selecting multiple values”</a> is to use either a
            wrapper (which we just saw in <a class="xref" href="#querycriteria-typedquery-construct" title="12.1.4. Selecting a wrapper">Section 12.1.4, “Selecting a wrapper”</a>) or using the
            <code class="interfacename">javax.persistence.Tuple</code> contract.
        </p>

        <div class="example"><a id="ex-criteria-typedquery-tuple"/><p class="title"><strong>Example 12.6. Selecting a tuple</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Tuple&gt; criteria = builder.createTupleQuery();
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multiselect( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );

List&lt;Tuple&gt; tuples = em.createQuery( criteria ).getResultList();
for ( Tuple tuple : valueArray ) {
    assert tuple.get( 0 ) == tuple.get( idPath );
	assert tuple.get( 1 ) == tuple.get( agePath );
	...
}</pre>
        </div></div><br class="example-break"/>

        <p>
            This example illustrates accessing the query results through the
            <code class="interfacename">javax.persistence.Tuple</code> interface.  The example uses the explicit
            <code class="methodname">createTupleQuery</code> of
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>.  An alternate approach
            is to use <code class="methodname">createQuery</code> passing <code class="literal">Tuple.class</code>.
        </p>

        <p>
            Again we see the use of the <code class="methodname">multiselect</code> method, just like in
            <a class="xref" href="#ex-criteria-typedquery-array2" title="Example 12.4. Selecting an array (2)">Example 12.4, “Selecting an array (2)”</a>. The difference here is that the type of the
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code> was defined as
            <code class="interfacename">javax.persistence.Tuple</code> so the compound selections in this case are
            interpreted to be the tuple elements.
        </p>

        <p>
            The <code class="interfacename">javax.persistence.Tuple</code> contract provides 3 forms of access to
            the underlying elements:
        </p>

        <div class="variablelist"><dl><dt><span class="term">typed</span></dt><dd>
                    <p>
                        The <a class="xref" href="#ex-criteria-typedquery-tuple" title="Example 12.6. Selecting a tuple">Example 12.6, “Selecting a tuple”</a> example illustrates this form of access
                        in the <code class="literal">tuple.get( idPath )</code> and <code class="literal">tuple.get( agePath )</code> calls.
                        This allows typed access to the underlying tuple values based on the
                        <code class="interfacename">javax.persistence.TupleElement</code> expressions used to build
                        the criteria.
                    </p>
                </dd><dt><span class="term">positional</span></dt><dd>
                    <p>
                        Allows access to the underlying tuple values based on the position.  The simple
                        <span class="emphasis"><em>Object get(int position)</em></span> form is very similar to the access
                        illustrated in <a class="xref" href="#ex-criteria-typedquery-array" title="Example 12.3. Selecting an array">Example 12.3, “Selecting an array”</a> and
                        <a class="xref" href="#ex-criteria-typedquery-array2" title="Example 12.4. Selecting an array (2)">Example 12.4, “Selecting an array (2)”</a>.  The
                        <span class="emphasis"><em>&lt;X&gt; X get(int position, Class&lt;X&gt; type</em></span> form
                        allows typed positional access, but based on the explicitly supplied type which the tuple
                        value must be type-assignable to.
                    </p>
                </dd><dt><span class="term">aliased</span></dt><dd>
                    <p>
                        Allows access to the underlying tuple values based an (optionally) assigned alias.  The
                        example query did not apply an alias.  An alias would be applied via the
                        <code class="methodname">alias</code> method on
                        <code class="interfacename">javax.persistence.criteria.Selection</code>.  Just like
                        <code class="literal">positional</code> access, there is both a typed
                        (<span class="emphasis"><em>Object get(String alias)</em></span>) and an untyped
                        (<span class="emphasis"><em>&lt;X&gt; X get(String alias, Class&lt;X&gt; type</em></span> form.
                    </p>
                </dd></dl></div>
    </div>

    <div class="section" title="12.3. FROM clause"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-from"/>12.3. FROM clause</h2></div></div></div>
        

        <div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
                A CriteriaQuery object defines a query over one or more entity, embeddable, or basic abstract
                schema types. The root objects of the query are entities, from which the other types are reached
                by navigation.
            </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution"><em class="citetitle">JPA Specification</em>, section 6.5.2 Query Roots, pg 262</span></td></tr></table></div>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                All the individual parts of the FROM clause (roots, joins, paths) implement the
                <code class="interfacename">javax.persistence.criteria.From</code> interface.
            </p>
        </div>

        <div class="section" title="12.3.1. Roots"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-root"/>12.3.1. Roots</h3></div></div></div>
            

            <p>
                Roots define the basis from which all joins, paths and attributes are available in the query.
                A root is always an entity type.  Roots are defined and added to the criteria by the overloaded
                <code class="methodname">from</code> methods on
                <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;X&gt; Root&lt;X&gt; from(Class&lt;X&gt;);

&lt;X&gt; Root&lt;X&gt; from(EntityType&lt;X&gt;)</pre>

            <div class="example"><a id="d5e3518"/><p class="title"><strong>Example 12.7. Adding a root</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
// create and add the root
person.from( Person.class );</pre>
            </div></div><br class="example-break"/>

            <p>
                Criteria queries may define multiple roots, the effect of which is to create a cartesian
                product between the newly added root and the others. Here is an example matching all single
                men and all single women:
            </p>

            <div class="example"><a id="d5e3522"/><p class="title"><strong>Example 12.8. Adding multiple roots</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery query = builder.createQuery();
Root&lt;Person&gt; men = query.from( Person.class );
Root&lt;Person&gt; women = query.from( Person.class );
Predicate menRestriction = builder.and(
		builder.equal( men.get( Person_.gender ), Gender.MALE ),
		builder.equal( men.get( Person_.relationshipStatus ), RelationshipStatus.SINGLE )
);
Predicate womenRestriction = builder.and(
		builder.equal( women.get( Person_.gender ), Gender.FEMALE ),
		builder.equal( women.get( Person_.relationshipStatus ), RelationshipStatus.SINGLE )
);
query.where( builder.and( menRestriction, womenRestriction ) );</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="12.3.2. Joins"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-join"/>12.3.2. Joins</h3></div></div></div>
            

            <p>
                Joins allow navigation from other <code class="interfacename">javax.persistence.criteria.From</code>
                to either association or embedded attributes.  Joins are created by the numerous overloaded
                <code class="methodname">join</code> methods of the
                <code class="interfacename">javax.persistence.criteria.From</code> interface
            </p>

            <div class="example"><a id="criteria-join-singular"/><p class="title"><strong>Example 12.9. Example with Embedded and ManyToOne</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
// Person.address is an embedded attribute
Join&lt;Person,Address&gt; personAddress = personRoot.join( Person_.address );
// Address.country is a ManyToOne
Join&lt;Address,Country&gt; addressCountry = personAddress.join( Address_.country );</pre>
            </div></div><br class="example-break"/>

            <div class="example"><a id="criteria-join-plural"/><p class="title"><strong>Example 12.10. Example with Collections</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
Join&lt;Person,Order&gt; orders = personRoot.join( Person_.orders );
Join&lt;Order,LineItem&gt; orderLines = orders.join( Order_.lineItems );</pre>
            </div></div><br class="example-break"/>
        </div>

        <div class="section" title="12.3.3. Fetches"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-fetch"/>12.3.3. Fetches</h3></div></div></div>
            

            <p>
                Just like in HQL and JPQL, criteria queries can specify that associated data be fetched along
                with the owner.  Fetches are created by the numerous overloaded <code class="methodname">fetch</code>
                methods of the <code class="interfacename">javax.persistence.criteria.From</code> interface.
            </p>

            <div class="example"><a id="criteria-fetch-singular"/><p class="title"><strong>Example 12.11. Example with Embedded and ManyToOne</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
// Person.address is an embedded attribute
Fetch&lt;Person,Address&gt; personAddress = personRoot.fetch( Person_.address );
// Address.country is a ManyToOne
Fetch&lt;Address,Country&gt; addressCountry = personAddress.fetch( Address_.country );</pre>
            </div></div><br class="example-break"/>

            <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                <p>
                    Technically speaking, embedded attributes are always fetched with their owner.  However in
                    order to define the fetching of <span class="emphasis"><em>Address#country</em></span> we needed a
                    <code class="interfacename">javax.persistence.criteria.Fetch</code> for its parent path.
                </p>
            </div>

            <div class="example"><a id="criteria-fetch-plural"/><p class="title"><strong>Example 12.12. Example with Collections</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&amp;lt;Person&amp;gt; personCriteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = person.from( Person.class );
Fetch&lt;Person,Order&gt; orders = personRoot.fetch( Person_.orders );
Fetch&lt;Order,LineItem&gt; orderLines = orders.fetch( Order_.lineItems );</pre>
            </div></div><br class="example-break"/>
        </div>
    </div>

    <div class="section" title="12.4. Path expressions"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-path"/>12.4. Path expressions</h2></div></div></div>
        
        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                Roots, joins and fetches are themselves paths as well.
            </p>
        </div>
    </div>

    <div class="section" title="12.5. Using parameters"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-param"/>12.5. Using parameters</h2></div></div></div>
        

        <div class="example"><a id="ex-querycriteria-param"/><p class="title"><strong>Example 12.13. Using parameters</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CriteriaQuery&lt;Person&gt; criteria = build.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot );
ParameterExpression&lt;String&gt; eyeColorParam = builder.parameter( String.class );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), eyeColorParam ) );

TypedQuery&lt;Person&gt; query = em.createQuery( criteria );
query.setParameter( eyeColorParam, "brown" );
List&lt;Person&gt; people = query.getResultList();</pre>
        </div></div><br class="example-break"/>

        <p>
            Use the <code class="methodname">parameter</code> method of
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code> to obtain a parameter
            reference.  Then use the parameter reference to bind the parameter value to the
            <code class="interfacename">javax.persistence.Query</code>
        </p>
    </div>

</div>
    <div class="chapter" title="Chapter 13. Native SQL Queries"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3565"/>Chapter 13. Native SQL Queries</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#querysql-creating">13.1. Using a <code class="literal">SQLQuery</code></a></span></dt><dd><dl><dt><span class="section"><a href="#d5e3574">13.1.1. Scalar queries</a></span></dt><dt><span class="section"><a href="#d5e3598">13.1.2. Entity queries</a></span></dt><dt><span class="section"><a href="#d5e3616">13.1.3. Handling associations and collections</a></span></dt><dt><span class="section"><a href="#d5e3629">13.1.4. Returning multiple entities</a></span></dt><dt><span class="section"><a href="#d5e3721">13.1.5. Returning non-managed entities</a></span></dt><dt><span class="section"><a href="#d5e3733">13.1.6. Handling inheritance</a></span></dt><dt><span class="section"><a href="#d5e3736">13.1.7. Parameters</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-namedqueries">13.2. Named SQL queries</a></span></dt><dd><dl><dt><span class="section"><a href="#propertyresults">13.2.1. Using return-property to explicitly specify column/alias
      names</a></span></dt><dt><span class="section"><a href="#sp_query">13.2.2. Using stored procedures for querying</a></span></dt></dl></dd><dt><span class="section"><a href="#querysql-cud">13.3. Custom SQL for create, update and delete</a></span></dt><dt><span class="section"><a href="#querysql-load">13.4. Custom SQL for loading</a></span></dt></dl></div>

    

    <p>
        You may also express queries in the native SQL dialect of your database. This is useful if you
        want to utilize database specific features such as query hints or the CONNECT BY option in Oracle.
        It also provides a clean migration path from a direct SQL/JDBC based application to Hibernate/JPA.
        Hibernate also allows you to specify handwritten SQL (including stored procedures) for all
        create, update, delete, and load operations.
    </p>

  <div class="section" title="13.1. Using a SQLQuery"><div class="titlepage"><div><div><h2 class="title"><a id="querysql-creating"/>13.1. Using a <code class="literal">SQLQuery</code></h2></div></div></div>
    

    <p>Execution of native SQL queries is controlled via the
    <code class="literal">SQLQuery</code> interface, which is obtained by calling
    <code class="literal">Session.createSQLQuery()</code>. The following sections
    describe how to use this API for querying.</p>

    <div class="section" title="13.1.1. Scalar queries"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3574"/>13.1.1. Scalar queries</h3></div></div></div>
      

      <p>The most basic SQL query is to get a list of scalars
      (values).</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS").list();
sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE FROM CATS").list();
</pre>

      <p>These will return a List of Object arrays (Object[]) with scalar
      values for each column in the CATS table. Hibernate will use
      ResultSetMetadata to deduce the actual order and types of the returned
      scalar values.</p>

      <p>To avoid the overhead of using
      <code class="literal">ResultSetMetadata</code>, or simply to be more explicit in
      what is returned, one can use <code class="literal">addScalar()</code>:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS")
 .addScalar("ID", Hibernate.LONG)
 .addScalar("NAME", Hibernate.STRING)
 .addScalar("BIRTHDATE", Hibernate.DATE)
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>the columns and types to return</p>
        </li></ul></div>

      <p>This will return Object arrays, but now it will not use
      <code class="literal">ResultSetMetadata</code> but will instead explicitly get the
      ID, NAME and BIRTHDATE column as respectively a Long, String and a Short
      from the underlying resultset. This also means that only these three
      columns will be returned, even though the query is using
      <code class="literal">*</code> and could return more than the three listed
      columns.</p>

      <p>It is possible to leave out the type information for all or some
      of the scalars.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS")
 .addScalar("ID", Hibernate.LONG)
 .addScalar("NAME")
 .addScalar("BIRTHDATE")
</pre>

      <p>This is essentially the same query as before, but now
      <code class="literal">ResultSetMetaData</code> is used to determine the type of
      NAME and BIRTHDATE, where as the type of ID is explicitly
      specified.</p>

      <p>How the java.sql.Types returned from ResultSetMetaData is mapped
      to Hibernate types is controlled by the Dialect. If a specific type is
      not mapped, or does not result in the expected type, it is possible to
      customize it via calls to <code class="literal">registerHibernateType</code> in
      the Dialect.</p>
    </div>

    <div class="section" title="13.1.2. Entity queries"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3598"/>13.1.2. Entity queries</h3></div></div></div>
      

      <p>The above queries were all about returning scalar values,
      basically returning the "raw" values from the resultset. The following
      shows how to get entity objects from a native sql query via
      <code class="literal">addEntity()</code>.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT * FROM CATS").addEntity(Cat.class);
sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE FROM CATS").addEntity(Cat.class);
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>the entity returned by the query</p>
        </li></ul></div>

      <p>Assuming that Cat is mapped as a class with the columns ID, NAME
      and BIRTHDATE the above queries will both return a List where each
      element is a Cat entity.</p>

      <p>If the entity is mapped with a <code class="literal">many-to-one</code> to
      another entity it is required to also return this when performing the
      native query, otherwise a database specific "column not found" error
      will occur. The additional columns will automatically be returned when
      using the * notation, but we prefer to be explicit as in the following
      example for a <code class="literal">many-to-one</code> to a
      <code class="literal">Dog</code>:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE, DOG_ID FROM CATS").addEntity(Cat.class);
</pre>

      <p>This will allow cat.getDog() to function properly.</p>
    </div>

    <div class="section" title="13.1.3. Handling associations and collections"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3616"/>13.1.3. Handling associations and collections</h3></div></div></div>
      

      <p>It is possible to eagerly join in the <code class="literal">Dog</code> to
      avoid the possible extra roundtrip for initializing the proxy. This is
      done via the <code class="literal">addJoin()</code> method, which allows you to
      join in an association or collection.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT c.ID, NAME, BIRTHDATE, DOG_ID, D_ID, D_NAME FROM CATS c, DOGS d WHERE c.DOG_ID = d.D_ID")
 .addEntity("cat", Cat.class)
 .addJoin("cat.dog");
</pre>

      <p>In this example, the returned <code class="literal">Cat</code>'s will have
      their <code class="literal">dog</code> property fully initialized without any
      extra roundtrip to the database. Notice that you added an alias name
      ("cat") to be able to specify the target property path of the join. It
      is possible to do the same eager joining for collections, e.g. if the
      <code class="literal">Cat</code> had a one-to-many to <code class="literal">Dog</code>
      instead.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT ID, NAME, BIRTHDATE, D_ID, D_NAME, CAT_ID FROM CATS c, DOGS d WHERE c.ID = d.CAT_ID")
 .addEntity("cat", Cat.class)
 .addJoin("cat.dogs");
</pre>

      <p>At this stage you are reaching the limits of what is possible with
      native queries, without starting to enhance the sql queries to make them
      usable in Hibernate. Problems can arise when returning multiple entities
      of the same type or when the default alias/column names are not
      enough.</p>
    </div>

    <div class="section" title="13.1.4. Returning multiple entities"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3629"/>13.1.4. Returning multiple entities</h3></div></div></div>
      

      <p>Until now, the result set column names are assumed to be the same
      as the column names specified in the mapping document. This can be
      problematic for SQL queries that join multiple tables, since the same
      column names can appear in more than one table.</p>

      <p>Column alias injection is needed in the following query (which
      most likely will fail):</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT c.*, m.*  FROM CATS c, CATS m WHERE c.MOTHER_ID = c.ID")
 .addEntity("cat", Cat.class)
 .addEntity("mother", Cat.class)
</pre>

      <p>The query was intended to return two Cat instances per row: a cat
      and its mother. The query will, however, fail because there is a
      conflict of names; the instances are mapped to the same column names.
      Also, on some databases the returned column aliases will most likely be
      on the form "c.ID", "c.NAME", etc. which are not equal to the columns
      specified in the mappings ("ID" and "NAME").</p>

      <p>The following form is not vulnerable to column name
      duplication:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT {cat.*}, {m.*}  FROM CATS c, CATS m WHERE c.MOTHER_ID = m.ID")
 .addEntity("cat", Cat.class)
 .addEntity("mother", Cat.class)
</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string, with placeholders for Hibernate to
          inject column aliases</p>
        </li><li class="listitem">
          <p>the entities returned by the query</p>
        </li></ul></div>

      <p>The {cat.*} and {mother.*} notation used above is a shorthand for
      "all properties". Alternatively, you can list the columns explicitly,
      but even in this case Hibernate injects the SQL column aliases for each
      property. The placeholder for a column alias is just the property name
      qualified by the table alias. In the following example, you retrieve
      Cats and their mothers from a different table (cat_log) to the one
      declared in the mapping metadata. You can even use the property aliases
      in the where clause.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">String sql = "SELECT ID as {c.id}, NAME as {c.name}, " +
         "BIRTHDATE as {c.birthDate}, MOTHER_ID as {c.mother}, {mother.*} " +
         "FROM CAT_LOG c, CAT_LOG m WHERE {c.mother} = c.ID";

List loggedCats = sess.createSQLQuery(sql)
        .addEntity("cat", Cat.class)
        .addEntity("mother", Cat.class).list()
</pre>

      <div class="section" title="13.1.4.1. Alias and property references"><div class="titlepage"><div><div><h4 class="title"><a id="querysql-aliasreferences"/>13.1.4.1. Alias and property references</h4></div></div></div>
        

        <p>In most cases the above alias injection is needed. For queries
        relating to more complex mappings, like composite properties,
        inheritance discriminators, collections etc., you can use specific
        aliases that allow Hibernate to inject the proper aliases.</p>

        <p>The following table shows the different ways you can use the
        alias injection. Please note that the alias names in the result are
        simply examples; each alias will have a unique and probably different
        name when used.</p>

        <div class="table"><a id="aliasinjection-summary"/><p class="title"><strong>Table 13.1. Alias injection names</strong></p><div class="table-contents">
          

          <table summary="Alias injection names" border="1"><colgroup><col width="1*"/><col width="1*"/><col width="2.5*"/></colgroup><thead><tr><th>Description</th><th>Syntax</th><th>Example</th></tr></thead><tbody><tr><td>A simple property</td><td><code class="literal">{[aliasname].[propertyname]</code></td><td><code class="literal">A_NAME as {item.name}</code></td></tr><tr><td>A composite property</td><td><code class="literal">{[aliasname].[componentname].[propertyname]}</code></td><td><code class="literal">CURRENCY as {item.amount.currency}, VALUE as
                {item.amount.value}</code></td></tr><tr><td>Discriminator of an entity</td><td><code class="literal">{[aliasname].class}</code></td><td><code class="literal">DISC as {item.class}</code></td></tr><tr><td>All properties of an entity</td><td><code class="literal">{[aliasname].*}</code></td><td><code class="literal">{item.*}</code></td></tr><tr><td>A collection key</td><td><code class="literal">{[aliasname].key}</code></td><td><code class="literal">ORGID as {coll.key}</code></td></tr><tr><td>The id of an collection</td><td><code class="literal">{[aliasname].id}</code></td><td><code class="literal">EMPID as {coll.id}</code></td></tr><tr><td>The element of an collection</td><td><code class="literal">{[aliasname].element}</code></td><td><code class="literal">XID as {coll.element}</code></td></tr><tr><td>property of the element in the collection</td><td><code class="literal">{[aliasname].element.[propertyname]}</code></td><td><code class="literal">NAME as {coll.element.name}</code></td></tr><tr><td>All properties of the element in the collection</td><td><code class="literal">{[aliasname].element.*}</code></td><td><code class="literal">{coll.element.*}</code></td></tr><tr><td>All properties of the collection</td><td><code class="literal">{[aliasname].*}</code></td><td><code class="literal">{coll.*}</code></td></tr></tbody></table>
        </div></div><br class="table-break"/>
      </div>
    </div>

    <div class="section" title="13.1.5. Returning non-managed entities"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3721"/>13.1.5. Returning non-managed entities</h3></div></div></div>
      

      <p>It is possible to apply a ResultTransformer to native SQL queries,
      allowing it to return non-managed entities.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">sess.createSQLQuery("SELECT NAME, BIRTHDATE FROM CATS")
        .setResultTransformer(Transformers.aliasToBean(CatDTO.class))</pre>

      <p>This query specified:</p>

      <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
          <p>the SQL query string</p>
        </li><li class="listitem">
          <p>a result transformer</p>
        </li></ul></div>

      <p>The above query will return a list of <code class="literal">CatDTO</code>
      which has been instantiated and injected the values of NAME and
      BIRTHNAME into its corresponding properties or fields.</p>
    </div>

    <div class="section" title="13.1.6. Handling inheritance"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3733"/>13.1.6. Handling inheritance</h3></div></div></div>
      

      <p>Native SQL queries which query for entities that are mapped as
      part of an inheritance must include all properties for the baseclass and
      all its subclasses.</p>
    </div>

    <div class="section" title="13.1.7. Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="d5e3736"/>13.1.7. Parameters</h3></div></div></div>
      

      <p>Native SQL queries support positional as well as named
      parameters:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Query query = sess.createSQLQuery("SELECT * FROM CATS WHERE NAME like ?").addEntity(Cat.class);
List pusList = query.setString(0, "Pus%").list();

query = sess.createSQLQuery("SELECT * FROM CATS WHERE NAME like :name").addEntity(Cat.class);
List pusList = query.setString("name", "Pus%").list();          </pre>
    </div>
  </div>

  <div class="section" title="13.2. Named SQL queries"><div class="titlepage"><div><div><h2 class="title"><a id="querysql-namedqueries"/>13.2. Named SQL queries</h2></div></div></div>
    

    <p>Named SQL queries can also be defined in the mapping document and
    called in exactly the same way as a named HQL query (see <a class="xref" href="#">???</a>). In this case, you do
    <span class="emphasis"><em>not</em></span> need to call
    <code class="literal">addEntity()</code>.</p>

    <div class="example"><a id="d5e3746"/><p class="title"><strong>Example 13.1. Named sql query using the &lt;sql-query&gt; maping
      element</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="persons"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex}
    FROM PERSON person
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></div><br class="example-break"/>

    <div class="example"><a id="d5e3749"/><p class="title"><strong>Example 13.2. Execution of a named query</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List people = sess.getNamedQuery("persons")
    .setString("namePattern", namePattern)
    .setMaxResults(50)
    .list();</pre>
    </div></div><br class="example-break"/>

    <p>The <code class="literal">&lt;return-join&gt;</code> element is use to join
    associations and the <code class="literal">&lt;load-collection&gt;</code> element is
    used to define queries which initialize collections,</p>

    <div class="example"><a id="d5e3755"/><p class="title"><strong>Example 13.3. Named sql query with association</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="personsWith"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    &lt;return-join alias="address" property="person.mailingAddress"/&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex},
           address.STREET AS {address.street},
           address.CITY AS {address.city},
           address.STATE AS {address.state},
           address.ZIP AS {address.zip}
    FROM PERSON person
    JOIN ADDRESS address
        ON person.ID = address.PERSON_ID AND address.TYPE='MAILING'
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></div><br class="example-break"/>

    <p>A named SQL query may return a scalar value. You must declare the
    column alias and Hibernate type using the
    <code class="literal">&lt;return-scalar&gt;</code> element:</p>

    <div class="example"><a id="d5e3760"/><p class="title"><strong>Example 13.4. Named query returning a scalar</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="mySqlQuery"&gt;
    &lt;return-scalar column="name" type="string"/&gt;
    &lt;return-scalar column="age" type="long"/&gt;
    SELECT p.NAME AS name,
           p.AGE AS age,
    FROM PERSON p WHERE p.NAME LIKE 'Hiber%'
&lt;/sql-query&gt;</pre>
    </div></div><br class="example-break"/>

    <p>You can externalize the resultset mapping information in a
    <code class="literal">&lt;resultset&gt;</code> element which will allow you to
    either reuse them across several named queries or through the
    <code class="literal">setResultSetMapping()</code> API.</p>

    <div class="example"><a id="d5e3766"/><p class="title"><strong>Example 13.5. &lt;resultset&gt; mapping used to externalize mapping
      information</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;resultset name="personAddress"&gt;
    &lt;return alias="person" class="eg.Person"/&gt;
    &lt;return-join alias="address" property="person.mailingAddress"/&gt;
&lt;/resultset&gt;

&lt;sql-query name="personsWith" resultset-ref="personAddress"&gt;
    SELECT person.NAME AS {person.name},
           person.AGE AS {person.age},
           person.SEX AS {person.sex},
           address.STREET AS {address.street},
           address.CITY AS {address.city},
           address.STATE AS {address.state},
           address.ZIP AS {address.zip}
    FROM PERSON person
    JOIN ADDRESS address
        ON person.ID = address.PERSON_ID AND address.TYPE='MAILING'
    WHERE person.NAME LIKE :namePattern
&lt;/sql-query&gt;</pre>
    </div></div><br class="example-break"/>

    <p>You can, alternatively, use the resultset mapping information in
    your hbm files directly in java code.</p>

    <div class="example"><a id="d5e3770"/><p class="title"><strong>Example 13.6. Programmatically specifying the result mapping information
      </strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createSQLQuery(
        "select {cat.*}, {kitten.*} from cats cat, cats kitten where kitten.mother = cat.id"
    )
    .setResultSetMapping("catAndKitten")
    .list();</pre>
    </div></div><br class="example-break"/>

    <p>So far we have only looked at externalizing SQL queries using
    Hibernate mapping files. The same concept is also available with
    anntations and is called named native queries. You can use
    <code class="classname">@NamedNativeQuery</code>
    (<code class="classname">@NamedNativeQueries</code>) in conjunction with
    <code class="literal">@SqlResultSetMapping</code>
    (<code class="literal">@SqlResultSetMappings</code>). Like
    <code class="literal">@NamedQuery</code>, <code class="classname">@NamedNativeQuery</code>
    and <code class="literal">@SqlResultSetMapping</code> can be defined at class level,
    but their scope is global to the application. Lets look at a view
    examples.</p>

    <p><a class="xref" href="#example-named-native-query-annotation-with-result-set-mapping" title="Example 13.7. Named SQL query using @NamedNativeQuery together with @SqlResultSetMapping">Example 13.7, “Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code>”</a>
    shows how a <code class="literal">resultSetMapping</code> parameter is defined in
    <code class="literal">@NamedNativeQuery</code>. It represents the name of a defined
    <code class="literal">@SqlResultSetMapping</code>. The resultset mapping declares
    the entities retrieved by this native query. Each field of the entity is
    bound to an SQL alias (or column name). All fields of the entity including
    the ones of subclasses and the foreign key columns of related entities
    have to be present in the SQL query. Field definitions are optional
    provided that they map to the same column name as the one declared on the
    class property. In the example 2 entities, <code class="literal">Night</code> and
    <code class="literal">Area</code>, are returned and each property is declared and
    associated to a column name, actually the column name retrieved by the
    query. </p>

    <p>In <a class="xref" href="#example-implicit-result-set-mapping" title="Example 13.8. Implicit result set mapping">Example 13.8, “Implicit result set mapping”</a> the result
    set mapping is implicit. We only describe the entity class of the result
    set mapping. The property / column mappings is done using the entity
    mapping values. In this case the model property is bound to the model_txt
    column. </p>

    <p>Finally, if the association to a related entity involve a composite
    primary key, a <code class="literal">@FieldResult</code> element should be used for
    each foreign key column. The <code class="literal">@FieldResult</code> name is
    composed of the property name for the relationship, followed by a dot
    ("."), followed by the name or the field or property of the primary key.
    This can be seen in <a class="xref" href="#example-field-result-annotation-with-associations" title="Example 13.9. Using dot notation in @FieldResult for specifying associations">Example 13.9, “Using dot notation in @FieldResult for specifying associations
      ”</a>.</p>

    <div class="example"><a id="example-named-native-query-annotation-with-result-set-mapping"/><p class="title"><strong>Example 13.7. Named SQL query using <code class="classname">@NamedNativeQuery</code>
      together with <code class="classname">@SqlResultSetMapping</code></strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">NamedNativeQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;night&amp;area&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;query</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;select&nbsp;night.id&nbsp;nid,&nbsp;night.night_duration,&nbsp;&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;&nbsp;night.night_date,&nbsp;area.id&nbsp;aid,&nbsp;night.area_id,&nbsp;area.name&nbsp;&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;from&nbsp;Night&nbsp;night,&nbsp;Area&nbsp;area&nbsp;where&nbsp;night.area_id&nbsp;=&nbsp;area.id&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">&quot;joinMapping&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;joinMapping&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entities</span><span class="java_operator">=</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">Night</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;nid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;duration&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_duration&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;date&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_date&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;area&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;area_id&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;discriminatorColumn</span><span class="java_operator">=</span><span class="java_literal">&quot;disc&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">test</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_type">Area</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;aid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">)</span></pre>
    </div></div><br class="example-break"/>

    <div class="example"><a id="example-implicit-result-set-mapping"/><p class="title"><strong>Example 13.8. Implicit result set mapping</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;implicit&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entities</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">SpaceShip</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">))</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;implicitSample&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">&quot;select&nbsp;*&nbsp;from&nbsp;SpaceShip&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">&quot;implicit&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setName</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Column</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;model_txt&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getModel</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setModel</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">model&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getSpeed</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setSpeed</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">speed&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre>
    </div></div><br class="example-break"/>

    <div class="example"><a id="example-field-result-annotation-with-associations"/><p class="title"><strong>Example 13.9. Using dot notation in @FieldResult for specifying associations
      </strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;compositekey&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entities</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_type">SpaceShip</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;model&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;model&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;speed&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;speed&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;captain.firstname&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;firstn&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;captain.lastname&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;lastn&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;dimensions.length&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;length&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;dimensions.width&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;width&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;columns&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;@</span><span class="java_type">ColumnResult</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;surface&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ColumnResult</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;volume&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;compositekey&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">&quot;select&nbsp;name,&nbsp;model,&nbsp;speed,&nbsp;lname&nbsp;as&nbsp;lastn,&nbsp;fname&nbsp;as&nbsp;firstn,&nbsp;length,&nbsp;width,&nbsp;length&nbsp;*&nbsp;width&nbsp;as&nbsp;surface&nbsp;from&nbsp;SpaceShip&quot;</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">&quot;compositekey&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setName</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ManyToOne</span><span class="java_separator">(</span><span class="java_plain">fetch</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchType</span><span class="java_separator">.</span><span class="java_plain">LAZY</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumns</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;fname&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;referencedColumnName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;firstname&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;lname&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;referencedColumnName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;lastname&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;getCaptain</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setCaptain</span><span class="java_separator">(</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">captain&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;captain</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getModel</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setModel</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;model</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">model&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;model</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">double</span><span class="java_plain">&nbsp;getSpeed</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setSpeed</span><span class="java_separator">(</span><span class="java_type">double</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">speed&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;speed</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;getDimensions</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setDimensions</span><span class="java_separator">(</span><span class="java_type">Dimensions</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">dimensions&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;dimensions</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">IdClass</span><span class="java_separator">(</span><span class="java_type">Identity</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Captain</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getFirstname</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setFirstname</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">firstname&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstname</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getLastname</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setLastname</span><span class="java_separator">(</span><span class="java_type">String</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">lastname&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;lastname</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</pre>
    </div></div><br class="example-break"/>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>If you retrieve a single entity using the default mapping, you can
      specify the <code class="literal">resultClass</code> attribute instead of
      <code class="literal">resultSetMapping</code>:</p>

      <pre xmlns="" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">NamedNativeQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;implicitSample&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;query</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;select&nbsp;*&nbsp;from&nbsp;SpaceShip&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;resultClass</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_type">SpaceShip</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span></pre>
    </div>

    <p>In some of your native queries, you'll have to return scalar values,
    for example when building report queries. You can map them in the
    <code class="literal">@SqlResultsetMapping</code> through
    <code class="literal">@ColumnResult</code>. You actually can even mix, entities and
    scalar returns in the same native query (this is probably not that common
    though).</p>

    <div class="example"><a id="d5e3813"/><p class="title"><strong>Example 13.10. Scalar values via <code class="classname">@ColumnResult</code></strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">SqlResultSetMapping</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;scalar&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;columns</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">ColumnResult</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;dimension&quot;</span><!-- <br/> --><span class="java_separator">))</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;scalar&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">&quot;select&nbsp;length*width&nbsp;as&nbsp;dimension&nbsp;from&nbsp;SpaceShip&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;resultSetMapping</span><span class="java_operator">=</span><span class="java_literal">&quot;scalar&quot;</span><span class="java_separator">)</span></pre>
    </div></div><br class="example-break"/>

    <p>An other query hint specific to native queries has been introduced:
    <code class="literal">org.hibernate.callable</code> which can be true or false
    depending on whether the query is a stored procedure or not.</p>

    <div class="section" title="13.2.1. Using return-property to explicitly specify column/alias names"><div class="titlepage"><div><div><h3 class="title"><a id="propertyresults"/>13.2.1. Using return-property to explicitly specify column/alias
      names</h3></div></div></div>
      

      <p>You can explicitly tell Hibernate what column aliases to use with
      <code class="literal">&lt;return-property&gt;</code>, instead of using the
      <code class="literal">{}</code>-syntax to let Hibernate inject its own aliases.For
      example:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="mySqlQuery"&gt;
    &lt;return alias="person" class="eg.Person"&gt;
        &lt;return-property name="name" column="myName"/&gt;
        &lt;return-property name="age" column="myAge"/&gt;
        &lt;return-property name="sex" column="mySex"/&gt;
    &lt;/return&gt;
    SELECT person.NAME AS myName,
           person.AGE AS myAge,
           person.SEX AS mySex,
    FROM PERSON person WHERE person.NAME LIKE :name
&lt;/sql-query&gt;
</pre>

      <p><code class="literal">&lt;return-property&gt;</code> also works with
      multiple columns. This solves a limitation with the
      <code class="literal">{}</code>-syntax which cannot allow fine grained control of
      multi-column properties.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="organizationCurrentEmployments"&gt;
    &lt;return alias="emp" class="Employment"&gt;
        &lt;return-property name="salary"&gt;
            &lt;return-column name="VALUE"/&gt;
            &lt;return-column name="CURRENCY"/&gt;
        &lt;/return-property&gt;
        &lt;return-property name="endDate" column="myEndDate"/&gt;
    &lt;/return&gt;
        SELECT EMPLOYEE AS {emp.employee}, EMPLOYER AS {emp.employer},
        STARTDATE AS {emp.startDate}, ENDDATE AS {emp.endDate},
        REGIONCODE as {emp.regionCode}, EID AS {emp.id}, VALUE, CURRENCY
        FROM EMPLOYMENT
        WHERE EMPLOYER = :id AND ENDDATE IS NULL
        ORDER BY STARTDATE ASC
&lt;/sql-query&gt;</pre>

      <p>In this example <code class="literal">&lt;return-property&gt;</code> was
      used in combination with the <code class="literal">{}</code>-syntax for injection.
      This allows users to choose how they want to refer column and
      properties.</p>

      <p>If your mapping has a discriminator you must use
      <code class="literal">&lt;return-discriminator&gt;</code> to specify the
      discriminator column.</p>
    </div>

    <div class="section" title="13.2.2. Using stored procedures for querying"><div class="titlepage"><div><div><h3 class="title"><a id="sp_query"/>13.2.2. Using stored procedures for querying</h3></div></div></div>
      

      <p>Hibernate provides support for queries via stored procedures and
      functions. Most of the following documentation is equivalent for both.
      The stored procedure/function must return a resultset as the first
      out-parameter to be able to work with Hibernate. An example of such a
      stored function in Oracle 9 and higher is as follows:</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CREATE OR REPLACE FUNCTION selectAllEmployments
    RETURN SYS_REFCURSOR
AS
    st_cursor SYS_REFCURSOR;
BEGIN
    OPEN st_cursor FOR
 SELECT EMPLOYEE, EMPLOYER,
 STARTDATE, ENDDATE,
 REGIONCODE, EID, VALUE, CURRENCY
 FROM EMPLOYMENT;
      RETURN  st_cursor;
 END;</pre>

      <p>To use this query in Hibernate you need to map it via a named
      query.</p>

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="selectAllEmployees_SP" callable="true"&gt;
    &lt;return alias="emp" class="Employment"&gt;
        &lt;return-property name="employee" column="EMPLOYEE"/&gt;
        &lt;return-property name="employer" column="EMPLOYER"/&gt;
        &lt;return-property name="startDate" column="STARTDATE"/&gt;
        &lt;return-property name="endDate" column="ENDDATE"/&gt;
        &lt;return-property name="regionCode" column="REGIONCODE"/&gt;
        &lt;return-property name="id" column="EID"/&gt;
        &lt;return-property name="salary"&gt;
            &lt;return-column name="VALUE"/&gt;
            &lt;return-column name="CURRENCY"/&gt;
        &lt;/return-property&gt;
    &lt;/return&gt;
    { ? = call selectAllEmployments() }
&lt;/sql-query&gt;</pre>

      <p>Stored procedures currently only return scalars and entities.
      <code class="literal">&lt;return-join&gt;</code> and
      <code class="literal">&lt;load-collection&gt;</code> are not supported.</p>

      <div class="section" title="13.2.2.1. Rules/limitations for using stored procedures"><div class="titlepage"><div><div><h4 class="title"><a id="querysql-limits-storedprocedures"/>13.2.2.1. Rules/limitations for using stored procedures</h4></div></div></div>
        

        <p>You cannot use stored procedures with Hibernate unless you
        follow some procedure/function rules. If they do not follow those
        rules they are not usable with Hibernate. If you still want to use
        these procedures you have to execute them via
        <code class="literal">session.connection()</code>. The rules are different for
        each database, since database vendors have different stored procedure
        semantics/syntax.</p>

        <p>Stored procedure queries cannot be paged with
        <code class="literal">setFirstResult()/setMaxResults()</code>.</p>

        <p>The recommended call form is standard SQL92: <code class="literal">{ ? = call
        functionName(&lt;parameters&gt;) }</code> or <code class="literal">{ ? = call
        procedureName(&lt;parameters&gt;}</code>. Native call syntax is not
        supported.</p>

        <p>For Oracle the following rules apply:</p>

        <div class="itemizedlist"><ul class="itemizedlist" compact="compact"><li class="listitem">
            <p>A function must return a result set. The first parameter of
            a procedure must be an <code class="literal">OUT</code> that returns a
            result set. This is done by using a
            <code class="literal">SYS_REFCURSOR</code> type in Oracle 9 or 10. In Oracle
            you need to define a <code class="literal">REF CURSOR</code> type. See
            Oracle literature for further information.</p>
          </li></ul></div>

        <p>For Sybase or MS SQL server the following rules apply:</p>

        <div class="itemizedlist"><ul class="itemizedlist" compact="compact"><li class="listitem">
            <p>The procedure must return a result set. Note that since
            these servers can return multiple result sets and update counts,
            Hibernate will iterate the results and take the first result that
            is a result set as its return value. Everything else will be
            discarded.</p>
          </li><li class="listitem">
            <p>If you can enable <code class="literal">SET NOCOUNT ON</code> in your
            procedure it will probably be more efficient, but this is not a
            requirement.</p>
          </li></ul></div>
      </div>
    </div>
  </div>

  <div class="section" title="13.3. Custom SQL for create, update and delete"><div class="titlepage"><div><div><h2 class="title"><a id="querysql-cud"/>13.3. Custom SQL for create, update and delete</h2></div></div></div>
    

    <p>Hibernate can use custom SQL for create, update, and delete
    operations. The SQL can be overridden at the statement level or
    inidividual column level. This section describes statement overrides. For
    columns, see <a class="xref" href="#">???</a>. <a class="xref" href="#example-custom-crdu-via-annotations" title="Example 13.11. Custom CRUD via annotations">Example 13.11, “Custom CRUD via annotations”</a> shows how to define
    custom SQL operatons using annotations.</p>

    <div class="example"><a id="example-custom-crdu-via-annotations"/><p class="title"><strong>Example 13.11. Custom CRUD via annotations</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;CHAOS&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;INSERT&nbsp;INTO&nbsp;CHAOS(size,&nbsp;name,&nbsp;nickname,&nbsp;id)&nbsp;VALUES(?,upper(?),?,?)&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLUpdate</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;UPDATE&nbsp;CHAOS&nbsp;SET&nbsp;size&nbsp;=&nbsp;?,&nbsp;name&nbsp;=&nbsp;upper(?),&nbsp;nickname&nbsp;=&nbsp;?&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;?&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLDelete</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;DELETE&nbsp;CHAOS&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;?&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLDeleteAll</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;DELETE&nbsp;CHAOS&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Loader</span><span class="java_separator">(</span><span class="java_plain">namedQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;chaos&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">NamedNativeQuery</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;chaos&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">&quot;select&nbsp;id,&nbsp;size,&nbsp;name,&nbsp;lower(&nbsp;nickname&nbsp;)&nbsp;as&nbsp;nickname&nbsp;from&nbsp;CHAOS&nbsp;where&nbsp;id=&nbsp;?&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;resultClass&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Chaos</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Chaos</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_plain">&nbsp;size</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;nickname</span><span class="java_separator">;</span></pre>
    </div></div><br class="example-break"/>

    <p><code class="literal">@SQLInsert</code>, <code class="literal">@SQLUpdate</code>,
    <code class="literal">@SQLDelete</code>, <code class="literal">@SQLDeleteAll</code>
    respectively override the INSERT, UPDATE, DELETE, and DELETE all
    statement. The same can be achieved using Hibernate mapping files and the
    <code class="literal">&lt;sql-insert&gt;</code>,
    <code class="literal">&lt;sql-update&gt;</code> and
    <code class="literal">&lt;sql-delete&gt;</code> nodes. This can be seen in <a class="xref" href="#example-custom-crdu-via-xml" title="Example 13.12. Custom CRUD XML">Example 13.12, “Custom CRUD XML”</a>.</p>

    <div class="example"><a id="example-custom-crdu-via-xml"/><p class="title"><strong>Example 13.12. Custom CRUD XML</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="Person"&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;property name="name" not-null="true"/&gt;
    &lt;sql-insert&gt;INSERT INTO PERSON (NAME, ID) VALUES ( UPPER(?), ? )&lt;/sql-insert&gt;
    &lt;sql-update&gt;UPDATE PERSON SET NAME=UPPER(?) WHERE ID=?&lt;/sql-update&gt;
    &lt;sql-delete&gt;DELETE FROM PERSON WHERE ID=?&lt;/sql-delete&gt;
&lt;/class&gt;</pre>
    </div></div><br class="example-break"/>

    <p>If you expect to call a store procedure, be sure to set the
    <code class="literal">callable</code> attribute to <code class="constant">true</code>. In
    annotations as well as in xml. </p>

    <p>To check that the execution happens correctly, Hibernate allows you
    to define one of those three strategies:</p>

    <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
        <p>none: no check is performed: the store procedure is expected to
        fail upon issues</p>
      </li><li class="listitem">
        <p>count: use of rowcount to check that the update is
        successful</p>
      </li><li class="listitem">
        <p>param: like COUNT but using an output parameter rather that the
        standard mechanism</p>
      </li></ul></div>

    <p>To define the result check style, use the <code class="literal">check</code>
    parameter which is again available in annoations as well as in xml.</p>

    <p>You can use the exact same set of annotations respectively xml nodes
    to override the collection related statements -see <a class="xref" href="#example-overriding-sql-collections-annotations" title="Example 13.13. Overriding SQL statements for collections using annotations">Example 13.13, “Overriding SQL statements for collections using
      annotations”</a>.</p>

    <div class="example"><a id="example-overriding-sql-collections-annotations"/><p class="title"><strong>Example 13.13. Overriding SQL statements for collections using
      annotations</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">OneToMany</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">JoinColumn</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;chaos_fk&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;UPDATE&nbsp;CASIMIR_PARTICULE&nbsp;SET&nbsp;chaos_fk&nbsp;=&nbsp;?&nbsp;where&nbsp;id&nbsp;=&nbsp;?&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SQLDelete</span><span class="java_separator">(</span><span class="java_plain">&nbsp;sql</span><span class="java_operator">=</span><span class="java_literal">&quot;UPDATE&nbsp;CASIMIR_PARTICULE&nbsp;SET&nbsp;chaos_fk&nbsp;=&nbsp;null&nbsp;where&nbsp;id&nbsp;=&nbsp;?&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Set</span><span class="java_operator">&lt;</span><span class="java_type">CasimirParticle</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;particles&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashSet</span><span class="java_operator">&lt;</span><span class="java_type">CasimirParticle</span><span class="java_operator">&gt;</span><span class="java_separator">();</span></pre>
    </div></div><br class="example-break"/>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>The parameter order is important and is defined by the order
      Hibernate handles properties. You can see the expected order by enabling
      debug logging for the <code class="literal">org.hibernate.persister.entity</code>
      level. With this level enabled Hibernate will print out the static SQL
      that is used to create, update, delete etc. entities. (To see the
      expected sequence, remember to not include your custom SQL through
      annotations or mapping files as that will override the Hibernate
      generated static sql)</p>
    </div>

    <p>Overriding SQL statements for secondary tables is also possible
    using <code class="literal">@org.hibernate.annotations.Table</code> and either (or
    all) attributes <code class="literal">sqlInsert</code>,
    <code class="literal">sqlUpdate</code>, <code class="literal">sqlDelete</code>:</p>

    <div class="example"><a id="d5e3912"/><p class="title"><strong>Example 13.14. Overriding SQL statements for secondary tables</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SecondaryTables</span><span class="java_separator">({</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">SecondaryTable</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;`Cat&nbsp;nbr1`&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">SecondaryTable</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Cat2&quot;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_plain">@org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_type">Tables</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">appliesTo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Cat&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;comment&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;My&nbsp;cat&nbsp;table&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Table</span><span class="java_separator">(</span><span class="java_plain">appliesTo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Cat2&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;foreignKey&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;@</span><span class="java_type">ForeignKey</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;FK_CAT2_CAT&quot;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;fetch&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchMode</span><span class="java_separator">.</span><span class="java_plain">SELECT</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sqlInsert</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">SQLInsert</span><span class="java_separator">(</span><span class="java_plain">sql</span><span class="java_operator">=</span><span class="java_literal">&quot;insert&nbsp;into&nbsp;Cat2(storyPart2,&nbsp;id)&nbsp;values(upper(?),&nbsp;?)&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;</span><span class="java_keyword">implements</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span></pre>
    </div></div><br class="example-break"/>

    <p>The previous example also shows that you can give a comment to a
    given table (primary or secondary): This comment will be used for DDL
    generation.</p>

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Tip</h2>
      <p>The SQL is directly executed in your database, so you can use any
      dialect you like. This will, however, reduce the portability of your
      mapping if you use database specific SQL.</p>
    </div>

    <p>Last but not least, stored procedures are in most cases required to
    return the number of rows inserted, updated and deleted. Hibernate always
    registers the first statement parameter as a numeric output parameter for
    the CUD operations:</p>

    <div class="example"><a id="d5e3919"/><p class="title"><strong>Example 13.15. Stored procedures and their return value</strong></p><div class="example-contents">
      

      <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CREATE OR REPLACE FUNCTION updatePerson (uid IN NUMBER, uname IN VARCHAR2)
    RETURN NUMBER IS
BEGIN

    update PERSON
    set
        NAME = uname,
    where
        ID = uid;

    return SQL%ROWCOUNT;

END updatePerson;</pre>
    </div></div><br class="example-break"/>
  </div>

  <div class="section" title="13.4. Custom SQL for loading"><div class="titlepage"><div><div><h2 class="title"><a id="querysql-load"/>13.4. Custom SQL for loading</h2></div></div></div>
    

    <p>You can also declare your own SQL (or HQL) queries for entity
    loading. As with inserts, updates, and deletes, this can be done at the
    individual column level as described in <a class="xref" href="#">???</a> or at the statement level. Here
    is an example of a statement level override:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="person"&gt;
    &lt;return alias="pers" class="Person" lock-mode="upgrade"/&gt;
    SELECT NAME AS {pers.name}, ID AS {pers.id}
    FROM PERSON
    WHERE ID=?
    FOR UPDATE
&lt;/sql-query&gt;</pre>

    <p>This is just a named query declaration, as discussed earlier. You
    can reference this named query in a class mapping:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="Person"&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;property name="name" not-null="true"/&gt;
    &lt;loader query-ref="person"/&gt;
&lt;/class&gt;</pre>

    <p>This even works with stored procedures.</p>

    <p>You can even define a query for collection loading:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;set name="employments" inverse="true"&gt;
    &lt;key/&gt;
    &lt;one-to-many class="Employment"/&gt;
    &lt;loader query-ref="employments"/&gt;
&lt;/set&gt;</pre>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="employments"&gt;
    &lt;load-collection alias="emp" role="Person.employments"/&gt;
    SELECT {emp.*}
    FROM EMPLOYMENT emp
    WHERE EMPLOYER = :id
    ORDER BY STARTDATE ASC, EMPLOYEE ASC
&lt;/sql-query&gt;</pre>

    <p>You can also define an entity loader that loads a collection by join
    fetching:</p>

    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;sql-query name="person"&gt;
    &lt;return alias="pers" class="Person"/&gt;
    &lt;return-join alias="emp" property="pers.employments"/&gt;
    SELECT NAME AS {pers.*}, {emp.*}
    FROM PERSON pers
    LEFT OUTER JOIN EMPLOYMENT emp
        ON pers.ID = emp.PERSON_ID
    WHERE ID=?
&lt;/sql-query&gt;</pre>

    <p>The annotation equivalent <code class="literal">&lt;loader&gt;</code> is the
    @Loader annotation as seen in <a class="xref" href="#example-custom-crdu-via-annotations" title="Example 13.11. Custom CRUD via annotations">Example 13.11, “Custom CRUD via annotations”</a>.</p>
  </div>

</div>
    <div class="chapter" title="Chapter 14. JMX"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3938"/>Chapter 14. JMX</h2></div></div></div>
    
    <p> </p>
</div>
    <div class="chapter" title="Chapter 15. Envers"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3941"/>Chapter 15. Envers</h2></div><div><div class="abstract" title="Abstract"><p class="title"><strong>Abstract</strong></p>
            <p>
                The aim of Hibernate Envers is to provide historical versioning of your application's entity data.  Much
                like source control management tools such as Subversion or Git, Hibernate Envers manages a notion of revisions
                if your application data through the use of audit tables.  Each transaction relates to one global revision number
                which can be used to identify groups of changes (much like a change set in source control).  As the revisions
                are global, having a revision number, you can query for various entities at that revision, retrieving a
                (partial) view of the database at that revision. You can find a revision number having a date, and the other
                way round, you can get the date at which a revision was committed.
            </p>
        </div></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e3947">15.1. Basics</a></span></dt><dt><span class="section"><a href="#d5e3968">15.2. Configuration</a></span></dt><dt><span class="section"><a href="#d5e4099">15.3. Additional mapping annotations</a></span></dt><dt><span class="section"><a href="#d5e4121">15.4. Choosing an audit strategy</a></span></dt><dt><span class="section"><a href="#envers-revisionlog">15.5. Revision Log</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-tracking-modified-entities-revchanges">15.5.1. Tracking entity names modified during revisions</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-tracking-properties-changes">15.6. Tracking entity changes at property level</a></span></dt><dt><span class="section"><a href="#envers-queries">15.7. Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#entities-at-revision">15.7.1. Querying for entities of a class at a given revision</a></span></dt><dt><span class="section"><a href="#revisions-of-entity">15.7.2. Querying for revisions, at which entities of a given class changed</a></span></dt><dt><span class="section"><a href="#envers-envers-tracking-properties-changes-queries">15.7.3. Querying for revisions of entity that modified given property</a></span></dt><dt><span class="section"><a href="#envers-tracking-modified-entities-queries">15.7.4. Querying for entities modified in a given revision</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4338">15.8. Conditional auditing</a></span></dt><dt><span class="section"><a href="#d5e4358">15.9. Understanding the Envers Schema</a></span></dt><dt><span class="section"><a href="#envers-generateschema">15.10. Generating schema with Ant</a></span></dt><dt><span class="section"><a href="#envers-mappingexceptions">15.11. Mapping exceptions</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4393">15.11.1. What isn't and will not be supported</a></span></dt><dt><span class="section"><a href="#d5e4404">15.11.2. What isn't and <span class="emphasis"><em>will</em></span> be supported</a></span></dt><dt><span class="section"><a href="#d5e4411">15.11.3. <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></a></span></dt></dl></dd><dt><span class="section"><a href="#envers-partitioning">15.12. Advanced: Audit table partitioning</a></span></dt><dd><dl><dt><span class="section"><a href="#envers-partitioning-benefits">15.12.1. Benefits of audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-columns">15.12.2. Suitable columns for audit table partitioning</a></span></dt><dt><span class="section"><a href="#envers-partitioning-example">15.12.3. Audit table partitioning example</a></span></dt></dl></dd><dt><span class="section"><a href="#envers-links">15.13. Envers links</a></span></dt></dl></div>
    

    <div class="section" title="15.1. Basics"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3947"/>15.1. Basics</h2></div></div></div>
        

        <p>
            To audit changes that are performed on an entity, you only need two things: the
            <code class="literal">hibernate-envers</code> jar on the classpath and an <code class="literal">@Audited</code> annotation
            on the entity.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                Unlike in previous versions, you no longer need to specify listeners in the Hibernate configuration
                file. Just putting the Envers jar on the classpath is enough - listeners will be registered
                automatically.
            </p>
        </div>

        <p>
            And that's all - you can create, modify and delete the entities as always. If you look at the generated
            schema for your entities, or at the data persisted by Hibernate, you will notice that there are no changes.
            However, for each audited entity, a new table is introduced - <code class="literal">entity_table_AUD</code>,
            which stores the historical data, whenever you commit a transaction. Envers automatically creates audit
            tables if <code class="literal">hibernate.hbm2ddl.auto</code> option is set to <code class="literal">create</code>,
            <code class="literal">create-drop</code> or <code class="literal">update</code>. Otherwise, to export complete database schema
            programatically, use <code class="literal">org.hibernate.tool.EnversSchemaGenerator</code>. Appropriate DDL
            statements can be also generated with Ant task described later in this manual.
        </p>

        <p>
            Instead of annotating the whole class and auditing all properties, you can annotate
            only some persistent properties with <code class="literal">@Audited</code>. This will cause only
            these properties to be audited.
        </p>

        <p>
            The audit (history) of an entity can be accessed using the <code class="literal">AuditReader</code> interface, which
            can be obtained having an open <code class="literal">EntityManager</code> or <code class="literal">Session</code> via
            the <code class="literal">AuditReaderFactory</code>. See the javadocs for these classes for details on the
            functionality offered.
        </p>
    </div>

    <div class="section" title="15.2. Configuration"><div class="titlepage"><div><div><h2 class="title"><a id="d5e3968"/>15.2. Configuration</h2></div></div></div>
        
        <p>
            It is possible to configure various aspects of Hibernate Envers behavior, such as table names, etc.
        </p>

        <div class="table"><a id="d5e3971"/><p class="title"><strong>Table 15.1. Envers Configuration Properties</strong></p><div class="table-contents">
            
            <table summary="Envers Configuration Properties" border="1"><colgroup><col width="1*" class="c1"/><col width="1*" class="c2"/><col width="1*" class="c2"/></colgroup><thead><tr><th>Property name</th><th>Default value</th><th>Description</th></tr></thead><tbody><tr><td>
                            <span class="property">org.hibernate.envers.audit_table_prefix</span>
                        </td><td>
                        </td><td>
                            String that will be prepended to the name of an audited entity to create the name of the
                            entity, that will hold audit information.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_table_suffix</span>
                        </td><td>
                            _AUD
                        </td><td>
                            String that will be appended to the name of an audited entity to create the name of the
                            entity, that will hold audit information. If you audit an entity with a table name Person,
                            in the default setting Envers will generate a <code class="literal">Person_AUD</code> table to store
                            historical data.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_field_name</span>
                        </td><td>
                            REV
                        </td><td>
                            Name of a field in the audit entity that will hold the revision number.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_type_field_name</span>
                        </td><td>
                            REVTYPE
                        </td><td>
                            Name of a field in the audit entity that will hold the type of the revision (currently,
                            this can be: add, mod, del).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.revision_on_collection_change</span>
                        </td><td>
                            true
                        </td><td>
                            Should a revision be generated when a not-owned relation field changes (this can be either
                            a collection in a one-to-many relation, or the field using "mappedBy" attribute in a
                            one-to-one relation).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.do_not_audit_optimistic_locking_field</span>
                        </td><td>
                            true
                        </td><td>
                            When true, properties to be used for optimistic locking, annotated with
                            <code class="literal">@Version</code>, will be automatically not audited (their history won't be
                            stored; it normally doesn't make sense to store it).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.store_data_at_delete</span>
                        </td><td>
                            false
                        </td><td>
                            Should the entity data be stored in the revision when the entity is deleted (instead of only
                            storing the id and all other properties as null). This is not normally needed, as the data is
                            present in the last-but-one revision. Sometimes, however, it is easier and more efficient to
                            access it in the last revision (then the data that the entity contained before deletion is
                            stored twice).
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.default_schema</span>
                        </td><td>
                            null (same schema as table being audited)
                        </td><td>
                            The default schema name that should be used for audit tables. Can be overridden using the
                            <code class="literal">@AuditTable(schema="...")</code> annotation. If not present, the schema will
                            be the same as the schema of the table being audited.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.default_catalog</span>
                        </td><td>
                            null (same catalog as table being audited)
                        </td><td>
                            The default catalog name that should be used for audit tables. Can be overridden using the
                            <code class="literal">@AuditTable(catalog="...")</code> annotation. If not present, the catalog will
                            be the same as the catalog of the normal tables.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy</span>
                        </td><td>
                            org.hibernate.envers.strategy.DefaultAuditStrategy
                        </td><td>
                            The audit strategy that should be used when persisting audit data. The default stores only
                            the revision, at which an entity was modified. An alternative, the
                            <code class="literal">org.hibernate.envers.strategy.ValidityAuditStrategy</code> stores both the
                            start revision and the end revision. Together these define when an audit row was valid,
                            hence the name ValidityAuditStrategy.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_end_rev_field_name</span>
                        </td><td>
                            REVEND
                        </td><td>
                            The column name that will hold the end revision number in audit entities. This property is
                            only valid if the validity audit strategy is used.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</span>
                        </td><td>
                            false
                        </td><td>
                            Should the timestamp of the end revision be stored, until which the data was valid, in
                            addition to the end revision itself.  This is useful to be able to purge old Audit records
                            out of a relational database by using table partitioning.  Partitioning requires a column
                            that exists within the table.  This property is only evaluated if the ValidityAuditStrategy
                            is used.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.audit_strategy_validity_revend_timestamp_field_name</span>
                        </td><td>
                            REVEND_TSTMP
                        </td><td>
                            Column name of the timestamp of the end revision until which the data was valid.  Only used
                            if the ValidityAuditStrategy is used, and
                            <span class="property">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</span>
                            evaluates to true
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.use_revision_entity_with_native_id</span>
                        </td><td>
                            true
                        </td><td>
                            Boolean flag that determines the strategy of revision number generation. Default
                            implementation of revision entity uses native identifier generator. If current database
                            engine does not support identity columns, users are advised to set this property to false.
                            In this case revision numbers are created by preconfigured
                            <code class="classname">org.hibernate.id.enhanced.SequenceStyleGenerator</code>. See:
                            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><code class="classname">org.hibernate.envers.DefaultRevisionEntity</code></li><li class="listitem"><code class="classname">org.hibernate.envers.enhanced.SequenceIdRevisionEntity</code></li></ol></div>
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.track_entities_changed_in_revision</span>
                        </td><td>
                            false
                        </td><td>
                            Should entity types, that have been modified during each revision, be tracked. The default
                            implementation creates <code class="literal">REVCHANGES</code> table that stores entity names
                            of modified persistent objects. Single record encapsulates the revision identifier
                            (foreign key to <code class="literal">REVINFO</code> table) and a string value. For more
                            information refer to <a class="xref" href="#envers-tracking-modified-entities-revchanges" title="15.5.1. Tracking entity names modified during revisions">Section 15.5.1, “Tracking entity names modified during revisions”</a>
                            and <a class="xref" href="#envers-tracking-modified-entities-queries" title="15.7.4. Querying for entities modified in a given revision">Section 15.7.4, “Querying for entities modified in a given revision”</a>.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.global_with_modified_flag</span>
                        </td><td>
                            false, can be individually overriden with <code class="literal">@Audited(withModifiedFlag=true)</code>
                        </td><td>
                            Should property modification flags be stored for all audited entities and all properties.
                            When set to true, for all properties an additional boolean column in the audit tables will
                            be created, filled with information if the given property changed in the given revision.
                            When set to false, such column can be added to selected entities or properties using the
                            <code class="literal">@Audited</code> annotation.
                            For more information refer to <a class="xref" href="#envers-tracking-properties-changes" title="15.6. Tracking entity changes at property level">Section 15.6, “Tracking entity changes at property level”</a>
                            and <a class="xref" href="#envers-envers-tracking-properties-changes-queries" title="15.7.3. Querying for revisions of entity that modified given property">Section 15.7.3, “Querying for revisions of entity that modified given property”</a>.
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.modified_flag_suffix</span>
                        </td><td>
                            _MOD
                        </td><td>
                            The suffix for columns storing "Modified Flags".
                            For example: a property called "age", will by default get modified flag with column name "age_MOD".
                        </td></tr><tr><td>
                            <span class="property">org.hibernate.envers.embeddable_set_ordinal_field_name</span>
                        </td><td>
                            SETORDINAL
                        </td><td>
                            Name of column used for storing ordinal of the change in sets of embeddable elements.
                        </td></tr></tbody></table>
        </div></div><br class="table-break"/>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2>
            <p>
                The following configuration options have been added recently and should be regarded as experimental:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        org.hibernate.envers.track_entities_changed_in_revision
                    </li><li class="listitem">
                        org.hibernate.envers.using_modified_flag
                    </li><li class="listitem">
                        org.hibernate.envers.modified_flag_suffix
                    </li></ol></div><p>
            </p>
        </div>
    </div>

    <div class="section" title="15.3. Additional mapping annotations"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4099"/>15.3. Additional mapping annotations</h2></div></div></div>
        

        <p>
            The name of the audit table can be set on a per-entity basis, using the
            <code class="literal">@AuditTable</code> annotation. It may be tedious to add this
            annotation to every audited entity, so if possible, it's better to use a prefix/suffix.
        </p>

        <p>
            If you have a mapping with secondary tables, audit tables for them will be generated in
            the same way (by adding the prefix and suffix). If you wish to overwrite this behaviour,
            you can use the <code class="literal">@SecondaryAuditTable</code> and
            <code class="literal">@SecondaryAuditTables</code> annotations.
        </p>

        <p>
            If you'd like to override auditing behaviour of some fields/properties inherited from
            <code class="interfacename">@Mappedsuperclass</code> or in an embedded component, you can
            apply the <code class="literal">@AuditOverride(s)</code> annotation on the subtype or usage site
            of the component.
        </p>

        <p>
            If you want to audit a relation mapped with <code class="literal">@OneToMany+@JoinColumn</code>,
            please see <a class="xref" href="#envers-mappingexceptions" title="15.11. Mapping exceptions">Section 15.11, “Mapping exceptions”</a> for a description of the additional
            <code class="literal">@AuditJoinTable</code> annotation that you'll probably want to use.
        </p>

        <p>
            If you want to audit a relation, where the target entity is not audited (that is the case for example with
            dictionary-like entities, which don't change and don't have to be audited), just annotate it with
            <code class="literal">@Audited(targetAuditMode = RelationTargetAuditMode.NOT_AUDITED)</code>. Then, when reading historic
            versions of your entity, the relation will always point to the "current" related entity.
        </p>

        <p>
            If you'd like to audit properties of a superclass of an entity, which are not explicitly audited (which
            don't have the <code class="literal">@Audited</code> annotation on any properties or on the class), you can list the
            superclasses in the <code class="literal">auditParents</code> attribute of the <code class="interfacename">@Audited</code>
            annotation. Please note that <code class="literal">auditParents</code> feature has been deprecated. Use
            <code class="literal">@AuditOverride(forClass = SomeEntity.class, isAudited = true/false)</code> instead.
        </p>
    </div>

    <div class="section" title="15.4. Choosing an audit strategy"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4121"/>15.4. Choosing an audit strategy</h2></div></div></div>
        
        <p>
            After the basic configuration it is important to choose the audit strategy that will be used to persist
            and retrieve audit information. There is a trade-off between the performance of persisting and the
            performance of querying the audit information. Currently there two audit strategies.
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    The default audit strategy persists the audit data together with a start revision. For each row
                    inserted, updated or deleted in an audited table, one or more rows are inserted in the audit
                    tables, together with the start revision of its validity. Rows in the audit tables are never
                    updated after insertion.  Queries of audit information use subqueries to select the applicable
                    rows in the audit tables.  These subqueries are notoriously slow and difficult to index.
                </p>
            </li><li class="listitem">
                <p>
                    The alternative is a validity audit strategy. This strategy stores the start-revision and the
                    end-revision of audit information. For each row inserted, updated or deleted in an audited table,
                    one or more rows are inserted in the audit tables, together with the start revision of its
                    validity. But at the same time the end-revision field of the previous audit rows (if available)
                    are set to this revision.  Queries on the audit information can then use 'between start and end
                    revision' instead of subqueries as used by the default audit strategy.
                </p>
                <p>
                    The consequence of this strategy is that persisting audit information will be a bit slower,
                    because of the extra updates involved, but retrieving audit information will be a lot faster.
                    This can be improved by adding extra indexes.
                </p>
            </li></ol></div>
    </div>

    <div class="section" title="15.5. Revision Log"><div class="titlepage"><div><div><h2 class="title"><a id="envers-revisionlog"/>15.5. Revision Log</h2></div><div><h3 class="subtitle">Logging data for revisions</h3></div></div></div>
        
        

        <p>
            When Envers starts a new revision, it creates a new <em class="firstterm">revision entity</em> which stores
            information about the revision.  By default, that includes just
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    <em class="firstterm">revision number</em> - An integral value (<code class="literal">int/Integer</code> or
                    <code class="literal">long/Long</code>).  Essentially the primary key of the revision
                </p>
            </li><li class="listitem">
                <p>
                    <em class="firstterm">revision timestamp</em> - either a <code class="literal">long/Long</code> or
                    <code class="classname">java.util.Date</code> value representing the instant at which the revision was made.
                    When using a <code class="classname">java.util.Date</code>, instead of a <code class="literal">long/Long</code> for
                    the revision timestamp, take care not to store it to a column data type which will loose precision.
                </p>
            </li></ol></div>

        <p>
            Envers handles this information as an entity.  By default it uses its own internal class to act as the
            entity, mapped to the <code class="literal">REVINFO</code> table.
            You can, however, supply your own approach to collecting this information which might be useful to
            capture additional details such as who made a change or the ip address from which the request came.  There
            are 2 things you need to make this work.
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    First, you will need to tell Envers about the entity you wish to use.  Your entity must use the
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation.  It must
                    define the 2 attributes described above annotated with
                    <code class="interfacename">@org.hibernate.envers.RevisionNumber</code> and
                    <code class="interfacename">@org.hibernate.envers.RevisionTimestamp</code>, respectively.  You can extend
                    from <code class="classname">org.hibernate.envers.DefaultRevisionEntity</code>, if you wish, to inherit all
                    these required behaviors.
                </p>
                <p>
                    Simply add the custom revision entity as you do your normal entities.  Envers will "find it".  Note
                    that it is an error for there to be multiple entities marked as
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code>
                </p>
            </li><li class="listitem">
                <p>
                    Second, you need to tell Envers how to create instances of your revision entity which is handled
                    by the <code class="methodname">newRevision</code> method of the
                    <code class="interfacename">org.jboss.envers.RevisionListener</code> interface.
                </p>
                <p>
                    You tell Envers your custom <code class="interfacename">org.hibernate.envers.RevisionListener</code>
                    implementation to use by specifying it on the
                    <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation, using the
                    <code class="methodname">value</code> attribute. If your <code class="interfacename">RevisionListener</code>
                    class is inaccessible from <code class="interfacename">@RevisionEntity</code> (e.g. exists in a different
                    module), set <span class="property">org.hibernate.envers.revision_listener</span> property to it's fully
                    qualified name. Class name defined by the configuration parameter overrides revision entity's
                    <code class="methodname">value</code> attribute. 
                </p>
            </li></ol></div>
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">@Entity
@RevisionEntity( MyCustomRevisionListener.class )
public class MyCustomRevisionEntity {
    ...
}

public class MyCustomRevisionListener implements RevisionListener {
    public void newRevision(Object revisionEntity) {
        ( (MyCustomRevisionEntity) revisionEntity )...;
    }
}
</pre>

        <p>
            An alternative method to using the <code class="interfacename">org.hibernate.envers.RevisionListener</code>
            is to instead call the <code class="methodname">getCurrentRevision</code> method of the
            <code class="interfacename">org.hibernate.envers.AuditReader</code> interface to obtain the current revision,
            and fill it with desired information.  The method accepts a <code class="literal">persist</code> parameter indicating
            whether the revision entity should be persisted prior to returning from this method. <code class="literal">true</code>
            ensures that the returned entity has access to its identifier value (revision number), but the revision
            entity will be persisted regardless of whether there are any audited entities changed. <code class="literal">false</code>
            means that the revision number will be <code class="literal">null</code>, but the revision entity will be persisted
            only if some audited entities have changed.
        </p>


        <div class="example"><a id="d5e4180"/><p class="title"><strong>Example 15.1. Example of storing username with revision</strong></p><div class="example-contents">
            

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ExampleRevEntity.java</code>

package org.hibernate.envers.example;

import org.hibernate.envers.RevisionEntity;
import org.hibernate.envers.DefaultRevisionEntity;

import javax.persistence.Entity;

@Entity
@RevisionEntity(ExampleListener.class)
public class ExampleRevEntity extends DefaultRevisionEntity {
    private String username;

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }
}</pre>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ExampleListener.java</code>

package org.hibernate.envers.example;

import org.hibernate.envers.RevisionListener;
import org.jboss.seam.security.Identity;
import org.jboss.seam.Component;

public class ExampleListener implements RevisionListener {
    public void newRevision(Object revisionEntity) {
        ExampleRevEntity exampleRevEntity = (ExampleRevEntity) revisionEntity;
        Identity identity =
            (Identity) Component.getInstance("org.jboss.seam.security.identity");

        exampleRevEntity.setUsername(identity.getUsername());
    }
}</pre>

        </div></div><br class="example-break"/>

        <div class="section" title="15.5.1. Tracking entity names modified during revisions"><div class="titlepage"><div><div><h3 class="title"><a id="envers-tracking-modified-entities-revchanges"/>15.5.1. Tracking entity names modified during revisions</h3></div></div></div>
            
            <p>
                By default entity types that have been changed in each revision are not being tracked. This implies the
                necessity to query all tables storing audited data in order to retrieve changes made during
                specified revision. Envers provides a simple mechanism that creates <code class="literal">REVCHANGES</code>
                table which stores entity names of modified persistent objects. Single record encapsulates the revision
                identifier (foreign key to <code class="literal">REVINFO</code> table) and a string value.
            </p>
            <p>
                Tracking of modified entity names can be enabled in three different ways:
            </p>
            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Set <span class="property">org.hibernate.envers.track_entities_changed_in_revision</span> parameter to
                        <code class="literal">true</code>. In this case
                        <code class="classname">org.hibernate.envers.DefaultTrackingModifiedEntitiesRevisionEntity</code> will
                        be implicitly used as the revision log entity.
                    </p>
                </li><li class="listitem">
                    <p>
                        Create a custom revision entity that extends
                        <code class="classname">org.hibernate.envers.DefaultTrackingModifiedEntitiesRevisionEntity</code> class.
                    </p>
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
@Entity
@RevisionEntity
public class ExtendedRevisionEntity
             extends DefaultTrackingModifiedEntitiesRevisionEntity {
    ...
}</pre>
                </li><li class="listitem">
                    <p>
                        Mark an appropriate field of a custom revision entity with
                        <code class="interfacename">@org.hibernate.envers.ModifiedEntityNames</code> annotation. The property is
                        required to be of <code class="literal">Set&lt;String&gt;</code> type.
                    </p>
                    <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
@Entity
@RevisionEntity
public class AnnotatedTrackingRevisionEntity {
    ...

    @ElementCollection
    @JoinTable(name = "REVCHANGES", joinColumns = @JoinColumn(name = "REV"))
    @Column(name = "ENTITYNAME")
    @ModifiedEntityNames
    private Set&lt;String&gt; modifiedEntityNames;
    
    ...
}</pre>
                </li></ol></div>
            <p>
                Users, that have chosen one of the approaches listed above, can retrieve all entities modified in a
                specified revision by utilizing API described in <a class="xref" href="#envers-tracking-modified-entities-queries" title="15.7.4. Querying for entities modified in a given revision">Section 15.7.4, “Querying for entities modified in a given revision”</a>.
            </p>
            <p>
                Users are also allowed to implement custom mechanism of tracking modified entity types. In this case, they
                shall pass their own implementation of
                <code class="interfacename">org.hibernate.envers.EntityTrackingRevisionListener</code> interface as the value
                of <code class="interfacename">@org.hibernate.envers.RevisionEntity</code> annotation.
                <code class="interfacename">EntityTrackingRevisionListener</code> interface exposes one method that notifies
                whenever audited entity instance has been added, modified or removed within current revision boundaries.
            </p>
            
            <div class="example"><a id="d5e4213"/><p class="title"><strong>Example 15.2. Custom implementation of tracking entity classes modified during revisions</strong></p><div class="example-contents">
                
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">CustomEntityTrackingRevisionListener.java</code>

public class CustomEntityTrackingRevisionListener
             implements EntityTrackingRevisionListener {
    @Override
    public void entityChanged(Class entityClass, String entityName,
                              Serializable entityId, RevisionType revisionType,
                              Object revisionEntity) {
        String type = entityClass.getName();
        ((CustomTrackingRevisionEntity)revisionEntity).addModifiedEntityType(type);
    }

    @Override
    public void newRevision(Object revisionEntity) {
    }
}</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">CustomTrackingRevisionEntity.java</code>

@Entity
@RevisionEntity(CustomEntityTrackingRevisionListener.class)
public class CustomTrackingRevisionEntity {
    @Id
    @GeneratedValue
    @RevisionNumber
    private int customId;

    @RevisionTimestamp
    private long customTimestamp;

    @OneToMany(mappedBy="revision", cascade={CascadeType.PERSIST, CascadeType.REMOVE})
    private Set&lt;ModifiedEntityTypeEntity&gt; modifiedEntityTypes =
                                              new HashSet&lt;ModifiedEntityTypeEntity&gt;();
    
    public void addModifiedEntityType(String entityClassName) {
        modifiedEntityTypes.add(new ModifiedEntityTypeEntity(this, entityClassName));
    }
    
    ...
}
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
                    <code xmlns="http://www.w3.org/1999/xhtml" class="filename">ModifiedEntityTypeEntity.java</code>

@Entity
public class ModifiedEntityTypeEntity {
    @Id
    @GeneratedValue
    private Integer id;

    @ManyToOne
    private CustomTrackingRevisionEntity revision;
    
    private String entityClassName;
    
    ...
}
</pre>
                <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">CustomTrackingRevisionEntity revEntity =
    getAuditReader().findRevision(CustomTrackingRevisionEntity.class, revisionNumber);
Set&lt;ModifiedEntityTypeEntity&gt; modifiedEntityTypes = revEntity.getModifiedEntityTypes()</pre>
            </div></div><br class="example-break"/>
        </div>

    </div>

    <div class="section" title="15.6. Tracking entity changes at property level"><div class="titlepage"><div><div><h2 class="title"><a id="envers-tracking-properties-changes"/>15.6. Tracking entity changes at property level</h2></div></div></div>
        
        <p>
            By default the only information stored by Envers are revisions of modified entities.
            This approach lets user create audit queries based on historical values of entity's properties.

            Sometimes it is useful to store additional metadata for each revision, when you are interested also in
            the type of changes, not only about the resulting values. The feature described in
            <a class="xref" href="#envers-tracking-modified-entities-revchanges" title="15.5.1. Tracking entity names modified during revisions">Section 15.5.1, “Tracking entity names modified during revisions”</a>
            makes it possible to tell which entities were modified in given revision.

            Feature described here takes it one step further. "Modification Flags" enable Envers to track which
            properties of audited entities were modified in a given revision.
        </p>
        <p>
            Tracking entity changes at property level can be enabled by:
        </p>
        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    setting <span class="property">org.hibernate.envers.global_with_modified_flag</span> configuration
                    property to <code class="literal">true</code>.  This global switch will cause adding modification flags
                    for all audited properties in all audited entities.
                </p>
            </li><li class="listitem">
                <p>
                    using <code class="literal">@Audited(withModifiedFlag=true)</code> on a property or on an entity.
                </p>
            </li></ol></div>
        <p>
            The trade-off coming with this functionality is an increased size of
            audit tables and a very little, almost negligible, performance drop
            during audit writes. This is due to the fact that every tracked
            property has to have an accompanying boolean column in the
            schema that stores information about the property's modifications. Of
            course it is Envers' job to fill these columns accordingly - no additional work by the
            developer is required. Because of costs mentioned, it is recommended
            to enable the feature selectively, when needed with use of the
            granular configuration means described above.
        </p>
        <p>
            To see how "Modified Flags" can be utilized, check out the very
            simple query API that uses them: <a class="xref" href="#envers-envers-tracking-properties-changes-queries" title="15.7.3. Querying for revisions of entity that modified given property">Section 15.7.3, “Querying for revisions of entity that modified given property”</a>.
        </p>
    </div>

    <div class="section" title="15.7. Queries"><div class="titlepage"><div><div><h2 class="title"><a id="envers-queries"/>15.7. Queries</h2></div></div></div>

        

        <p>
            You can think of historic data as having two dimension. The first - horizontal -
            is the state of the database at a given revision. Thus, you can
            query for entities as they were at revision N. The second - vertical - are the
            revisions, at which entities changed. Hence, you can query for revisions,
            in which a given entity changed.
        </p>

        <p>
            The queries in Envers are similar to Hibernate Criteria queries, so if you are common with them,
            using Envers queries will be much easier.
        </p>

        <p>
            The main limitation of the current queries implementation is that you cannot
            traverse relations. You can only specify constraints on the ids of the
            related entities, and only on the "owning" side of the relation. This however
            will be changed in future releases.
        </p>

        <p>
            Please note, that queries on the audited data will be in many cases much slower
            than corresponding queries on "live" data, as they involve correlated subselects.
        </p>

        <p>
            In the future, queries will be improved both in terms of speed and possibilities, when using the valid-time
            audit strategy, that is when storing both start and end revisions for entities. See
            <a class="xref" href="#">???</a>.
        </p>

        <div class="section" title="15.7.1. Querying for entities of a class at a given revision"><div class="titlepage"><div><div><h3 class="title"><a id="entities-at-revision"/>15.7.1. Querying for entities of a class at a given revision</h3></div></div></div>

            

            <p>
                The entry point for this type of queries is:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader()
    .createQuery()
    .forEntitiesAtRevision(MyEntity.class, revisionNumber);</pre>

            <p>
                You can then specify constraints, which should be met by the entities returned, by
                adding restrictions, which can be obtained using the <code class="literal">AuditEntity</code>
                factory class. For example, to select only entities, where the "name" property
                is equal to "John":
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query.add(AuditEntity.property("name").eq("John"));</pre>

            <p>
                And to select only entites that are related to a given entity:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">query.add(AuditEntity.property("address").eq(relatedEntityInstance));
// or
query.add(AuditEntity.relatedId("address").eq(relatedEntityId));</pre>

            <p>
                You can limit the number of results, order them, and set aggregations and projections
                (except grouping) in the usual way.
                When your query is complete, you can obtain the results by calling the
                <code class="literal">getSingleResult()</code> or <code class="literal">getResultList()</code> methods.
            </p>

            <p>
                A full query, can look for example like this:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List personsAtAddress = getAuditReader().createQuery()
    .forEntitiesAtRevision(Person.class, 12)
    .addOrder(AuditEntity.property("surname").desc())
    .add(AuditEntity.relatedId("address").eq(addressId))
    .setFirstResult(4)
    .setMaxResults(2)
    .getResultList();</pre>

        </div>

        <div class="section" title="15.7.2. Querying for revisions, at which entities of a given class changed"><div class="titlepage"><div><div><h3 class="title"><a id="revisions-of-entity"/>15.7.2. Querying for revisions, at which entities of a given class changed</h3></div></div></div>

            

            <p>
                The entry point for this type of queries is:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">AuditQuery query = getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true);</pre>

            <p>
                You can add constraints to this query in the same way as to the previous one.
                There are some additional possibilities:
            </p>

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        using <code class="literal">AuditEntity.revisionNumber()</code> you can specify constraints, projections
                        and order on the revision number, in which the audited entity was modified
                    </p>
                </li><li class="listitem">
                    <p>
                        similarly, using <code class="literal">AuditEntity.revisionProperty(propertyName)</code> you can specify constraints,
                        projections and order on a property of the revision entity, corresponding to the revision
                        in which the audited entity was modified
                    </p>
                </li><li class="listitem">
                    <p>
                        <code class="literal">AuditEntity.revisionType()</code> gives you access as above to the type of
                        the revision (ADD, MOD, DEL).
                    </p>
                </li></ol></div>

            <p>
                Using these methods,
                you can order the query results by revision number, set projection or constraint
                the revision number to be greater or less than a specified value, etc. For example, the
                following query will select the smallest revision number, at which entity of class
                <code class="literal">MyEntity</code> with id <code class="literal">entityId</code> has changed, after revision
                number 42:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Number revision = (Number) getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true)
    .setProjection(AuditEntity.revisionNumber().min())
    .add(AuditEntity.id().eq(entityId))
    .add(AuditEntity.revisionNumber().gt(42))
    .getSingleResult();</pre>

            <p>
                The second additional feature you can use in queries for revisions is the ability
                to maximalize/minimize a property. For example, if you want to select the
                revision, at which the value of the <code class="literal">actualDate</code> for a given entity
                was larger then a given value, but as small as possible:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Number revision = (Number) getAuditReader().createQuery()
    .forRevisionsOfEntity(MyEntity.class, false, true)
    // We are only interested in the first revision
    .setProjection(AuditEntity.revisionNumber().min())
    .add(AuditEntity.property("actualDate").minimize()
        .add(AuditEntity.property("actualDate").ge(givenDate))
        .add(AuditEntity.id().eq(givenEntityId)))
    .getSingleResult();
</pre>

            <p>
                The <code class="literal">minimize()</code> and <code class="literal">maximize()</code> methods return a criteria,
                to which you can add constraints, which must be met by the entities with the
                maximized/minimized properties.
            </p>

            <p>
                You probably also noticed that there are two boolean parameters, passed when
                creating the query. The first one, <code class="literal">selectEntitiesOnly</code>, is only valid when
                you don't set an explicit projection. If true, the result of the query will be
                a list of entities (which changed at revisions satisfying the specified
                constraints).
            </p>

            <p>
                If false, the result will be a list of three element arrays. The
                first element will be the changed entity instance. The second will be an entity
                containing revision data (if no custom entity is used, this will be an instance
                of <code class="literal">DefaultRevisionEntity</code>). The third will be the type of the
                revision (one of the values of the <code class="literal">RevisionType</code> enumeration:
                ADD, MOD, DEL).
            </p>

            <p>
                The second parameter, <code class="literal">selectDeletedEntities</code>, specifies if revisions,
                in which the entity was deleted should be included in the results. If yes, such entities
                will have the revision type DEL and all fields, except the id,
                <code class="literal">null</code>.
            </p>

        </div>

        <div class="section" title="15.7.3. Querying for revisions of entity that modified given property"><div class="titlepage"><div><div><h3 class="title"><a id="envers-envers-tracking-properties-changes-queries"/>15.7.3. Querying for revisions of entity that modified given property</h3></div></div></div>

            

            <p>
                For the two types of queries described above it's possible to use
                special Audit criteria called
                <code class="literal">hasChanged()</code>
                and
                <code class="literal">hasNotChanged()</code>
                that makes use of the functionality
                described in <a class="xref" href="#envers-tracking-properties-changes" title="15.6. Tracking entity changes at property level">Section 15.6, “Tracking entity changes at property level”</a>.
                They're best suited for vertical queries,
                however existing API doesn't restrict their usage for horizontal
                ones.

                Let's have a look at following examples:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
            AuditQuery query = getAuditReader().createQuery()
            .forRevisionsOfEntity(MyEntity.class, false, true)
            .add(AuditEntity.id().eq(id));
            .add(AuditEntity.property("actualDate").hasChanged())
            </pre>

            <p>
                This query will return all revisions of MyEntity with given id,
                where the
                <span class="property">actualDate</span>
                property has been changed.
                Using this query we won't get all other revisions in which
                <span class="property">actualDate</span>
                wasn't touched. Of course nothing prevents user from combining
                hasChanged condition with some additional criteria - add method
                can be used here in a normal way.
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
            AuditQuery query = getAuditReader().createQuery()
            .forEntitiesAtRevision(MyEntity.class, revisionNumber)
            .add(AuditEntity.property("prop1").hasChanged())
            .add(AuditEntity.property("prop2").hasNotChanged());
            </pre>

            <p>
                This query will return horizontal slice for MyEntity at the time
                revisionNumber was generated. It will be limited to revisions
                that modified
                <span class="property">prop1</span>
                but not <span class="property">prop2</span>.
                Note that the result set will usually also contain revisions
                with numbers lower than the revisionNumber, so we cannot read
                this query as "Give me all MyEntities changed in revisionNumber
                with
                <span class="property">prop1</span>
                modified and
                <span class="property">prop2</span>
                untouched". To get such result we have to use the
                <code class="literal">forEntitiesModifiedAtRevision</code> query:
            </p>

            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
            AuditQuery query = getAuditReader().createQuery()
            .forEntitiesModifiedAtRevision(MyEntity.class, revisionNumber)
            .add(AuditEntity.property("prop1").hasChanged())
            .add(AuditEntity.property("prop2").hasNotChanged());
            </pre>

        </div>


        <div class="section" title="15.7.4. Querying for entities modified in a given revision"><div class="titlepage"><div><div><h3 class="title"><a id="envers-tracking-modified-entities-queries"/>15.7.4. Querying for entities modified in a given revision</h3></div></div></div>
            
            <p>
                The basic query allows retrieving entity names and corresponding Java classes changed in a specified revision:
            </p>
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Set&lt;Pair&lt;String, Class&gt;&gt; modifiedEntityTypes = getAuditReader()
    .getCrossTypeRevisionChangesReader().findEntityTypes(revisionNumber);</pre>
            <p>
                Other queries (also accessible from <code class="interfacename">org.hibernate.envers.CrossTypeRevisionChangesReader</code>):
            </p>
            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">List&lt;Object&gt; findEntities(Number)</code></em>
                        - Returns snapshots of all audited entities changed (added, updated and removed) in a given revision.
                        Executes <code class="literal">n+1</code> SQL queries, where <code class="literal">n</code> is a number of different entity
                        classes modified within specified revision.
                    </p>
                </li><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">List&lt;Object&gt; findEntities(Number, RevisionType)</code></em>
                        - Returns snapshots of all audited entities changed (added, updated or removed) in a given revision
                        filtered by modification type. Executes <code class="literal">n+1</code> SQL queries, where <code class="literal">n</code>
                        is a number of different entity classes modified within specified revision.
                    </p>
                </li><li class="listitem">
                    <p>
                        <em class="firstterm"><code class="methodname">Map&lt;RevisionType, List&lt;Object&gt;&gt; findEntitiesGroupByRevisionType(Number)</code></em>
                        - Returns a map containing lists of entity snapshots grouped by modification operation (e.g.
                        addition, update and removal). Executes <code class="literal">3n+1</code> SQL queries, where <code class="literal">n</code>
                        is a number of different entity classes modified within specified revision.
                    </p>
                </li></ol></div>
            <p>
                Note that methods described above can be legally used only when default mechanism of
                tracking changed entity names is enabled (see <a class="xref" href="#envers-tracking-modified-entities-revchanges" title="15.5.1. Tracking entity names modified during revisions">Section 15.5.1, “Tracking entity names modified during revisions”</a>).
            </p>
        </div>

    </div>

    <div class="section" title="15.8. Conditional auditing"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4338"/>15.8. Conditional auditing</h2></div></div></div>
        
        <p>
            Envers persists audit data in reaction to various Hibernate events (e.g. post update, post insert, and
            so on), using a series of even listeners from the <code class="literal">org.hibernate.envers.event</code>
            package. By default, if the Envers jar is in the classpath, the event listeners are auto-registered with
            Hibernate.
        </p>
        <p>
            Conditional auditing can be implemented by overriding some of the Envers event listeners.
            To use customized Envers event listeners, the following steps are needed:
            </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Turn off automatic Envers event listeners registration by setting the
                        <code class="literal">hibernate.listeners.envers.autoRegister</code> Hibernate property to
                        <code class="literal">false</code>.
                     </p>
                </li><li class="listitem">
                    <p>
                        Create subclasses for appropriate event listeners. For example, if you want to
                        conditionally audit entity insertions, extend the
                        <code class="literal">org.hibernate.envers.eventEnversPostInsertEventListenerImpl</code>
                        class. Place the conditional-auditing logic in the subclasses, call the super method if
                        auditing should be performed.
                    </p>
                </li><li class="listitem">
                    <p>
                        Create your own implementation of <code class="literal">org.hibernate.integrator.spi.Integrator</code>,
                        similar to <code class="literal">org.hibernate.envers.event.EnversIntegrator</code>. Use your event
                        listener classes instead of the default ones.
                    </p>
                </li><li class="listitem">
                    <p>
                        For the integrator to be automatically used when Hibernate starts up, you will need to add a
                        <code class="literal">META-INF/services/org.hibernate.integrator.spi.Integrator</code> file to your jar.
                        The file should contain the fully qualified name of the class implementing the interface.
                    </p>
                </li></ol></div><p>
        </p>
    </div>

    <div class="section" title="15.9. Understanding the Envers Schema"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4358"/>15.9. Understanding the Envers Schema</h2></div></div></div>
        

        <p>
            For each audited entity (that is, for each entity containing at least one audited field), an audit table is
            created.  By default, the audit table's name is created by adding a "_AUD" suffix to the original table name,
            but this can be overridden by specifying a different suffix/prefix in the configuration or per-entity using
            the <code class="interfacename">@org.hibernate.envers.AuditTable</code> annotation.
        </p>

        <div class="orderedlist" title="Audit table columns"><p class="title"><strong>Audit table columns</strong></p><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    id of the original entity (this can be more then one column in the case of composite primary keys)
                </p>
            </li><li class="listitem">
                <p>
                    revision number - an integer.  Matches to the revision number in the revision entity table.
                </p>
            </li><li class="listitem">
                <p>
                    revision type - a small integer
                </p>
            </li><li class="listitem">
                <p>
                    audited fields from the original entity
                </p>
            </li></ol></div>

        <p>
            The primary key of the audit table is the combination of the original id of the entity and the revision
            number - there can be at most one historic entry for a given entity instance at a given revision.
        </p>

        <p>
            The current entity data is stored in the original table and in the audit table.  This is a duplication of
            data, however as this solution makes the query system much more powerful, and as memory is cheap, hopefully
            this won't be a major drawback for the users.  A row in the audit table with entity id ID, revision N and
            data D means: entity with id ID has data D from revision N upwards.  Hence, if we want to find an entity at
            revision M, we have to search for a row in the audit table, which has the revision number smaller or equal
            to M, but as large as possible. If no such row is found, or a row with a "deleted" marker is found, it means
            that the entity didn't exist at that revision.
        </p>

        <p>
            The "revision type" field can currently have three values: 0, 1, 2, which means ADD, MOD and DEL,
            respectively. A row with a revision of type DEL will only contain the id of the entity and no data (all
            fields NULL), as it only serves as a marker saying "this entity was deleted at that revision".
        </p>

        <p>
            Additionally, there is a revision entity table which contains the information about the
            global revision.  By default the generated table is named <span class="database">REVINFO</span> and
            contains just 2 columns: <span class="database">ID</span> and <span class="database">TIMESTAMP</span>.
            A row is inserted into this table on each new revision, that is, on each commit of a transaction, which
            changes audited data.  The name of this table can be configured, the name of its columns as well as adding
            additional columns can be achieved as discussed in <a class="xref" href="#envers-revisionlog" title="15.5. Revision Log">Section 15.5, “Revision Log”</a>.
        </p>

        <p>
            While global revisions are a good way to provide correct auditing of relations, some people have pointed out
            that this may be a bottleneck in systems, where data is very often modified.  One viable solution is to
            introduce an option to have an entity "locally revisioned", that is revisions would be created for it
            independently.  This wouldn't enable correct versioning of relations, but wouldn't also require the
            <span class="database">REVINFO</span> table.  Another possibility is to introduce a notion of
            "revisioning groups": groups of entities which share revision numbering.  Each such group would have to
            consist of one or more strongly connected component of the graph induced by relations between entities.
            Your opinions on the subject are very welcome on the forum! :)
        </p>

    </div>

    <div class="section" title="15.10. Generating schema with Ant"><div class="titlepage"><div><div><h2 class="title"><a id="envers-generateschema"/>15.10. Generating schema with Ant</h2></div></div></div>
        

        <p>
            If you'd like to generate the database schema file with the Hibernate Tools Ant task,
            you'll probably notice that the generated file doesn't contain definitions of audit
            tables. To generate also the audit tables, you simply need to use
            <code class="literal">org.hibernate.tool.ant.EnversHibernateToolTask</code> instead of the usual
            <code class="literal">org.hibernate.tool.ant.HibernateToolTask</code>. The former class extends
            the latter, and only adds generation of the version entities. So you can use the task
            just as you used to.
        </p>

        <p>
            For example:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;target name="schemaexport" depends="build-demo"
  description="Exports a generated schema to DB and file"&gt;
  &lt;taskdef name="hibernatetool"
    classname="org.hibernate.tool.ant.EnversHibernateToolTask"
    classpathref="build.demo.classpath"/&gt;

  &lt;hibernatetool destdir="."&gt;
    &lt;classpath&gt;
      &lt;fileset refid="lib.hibernate" /&gt;
      &lt;path location="${build.demo.dir}" /&gt;
      &lt;path location="${build.main.dir}" /&gt;
    &lt;/classpath&gt;
    &lt;jpaconfiguration persistenceunit="ConsolePU" /&gt;
    &lt;hbm2ddl
      drop="false"
      create="true"
      export="false"
      outputfilename="versioning-ddl.sql"
      delimiter=";"
      format="true"/&gt;
  &lt;/hibernatetool&gt;
&lt;/target&gt;</pre>

        <p>
            Will generate the following schema:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
    create table Address (
        id integer generated by default as identity (start with 1),
        flatNumber integer,
        houseNumber integer,
        streetName varchar(255),
        primary key (id)
    );

    create table Address_AUD (
        id integer not null,
        REV integer not null,
        flatNumber integer,
        houseNumber integer,
        streetName varchar(255),
        REVTYPE tinyint,
        primary key (id, REV)
    );

    create table Person (
        id integer generated by default as identity (start with 1),
        name varchar(255),
        surname varchar(255),
        address_id integer,
        primary key (id)
    );

    create table Person_AUD (
        id integer not null,
        REV integer not null,
        name varchar(255),
        surname varchar(255),
        REVTYPE tinyint,
        address_id integer,
        primary key (id, REV)
    );

    create table REVINFO (
        REV integer generated by default as identity (start with 1),
        REVTSTMP bigint,
        primary key (REV)
    );

    alter table Person
        add constraint FK8E488775E4C3EA63
        foreign key (address_id)
        references Address;
    </pre>
    </div>


    <div class="section" title="15.11. Mapping exceptions"><div class="titlepage"><div><div><h2 class="title"><a id="envers-mappingexceptions"/>15.11. Mapping exceptions</h2></div></div></div>
        

        <div class="section" title="15.11.1. What isn't and will not be supported"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4393"/>15.11.1. What isn't and will not be supported</h3></div></div></div>

            

            <p>
                Bags, as they can contain non-unique elements.
                The reason is that persisting, for example a bag of String-s, violates a principle
                of relational databases: that each table is a set of tuples. In case of bags,
                however (which require a join table), if there is a duplicate element, the two
                tuples corresponding to the elements will be the same. Hibernate allows this,
                however Envers (or more precisely: the database connector) will throw an exception
                when trying to persist two identical elements, because of a unique constraint violation.
            </p>

            <p>
                There are at least two ways out if you need bag semantics:
            </p>

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        use an indexed collection, with the <code class="literal">@IndexColumn</code> annotation, or
                    </p>
                </li><li class="listitem">
                    <p>
                        provide a unique id for your elements with the <code class="literal">@CollectionId</code> annotation.
                    </p>
                </li></ol></div>

        </div>

        <div class="section" title="15.11.2. What isn't and will be supported"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4404"/>15.11.2. What isn't and <span class="emphasis"><em>will</em></span> be supported</h3></div></div></div>

            

            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                    <p>
                        Bag style collection which identifier column has been defined using
                        <code class="interfacename">@CollectionId</code> annotation (JIRA ticket HHH-3950).
                    </p>
                </li></ol></div>

        </div>

        <div class="section" title="15.11.3. @OneToMany+@JoinColumn"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4411"/>15.11.3. <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code></h3></div></div></div>

            

            <p>
                When a collection is mapped using these two annotations, Hibernate doesn't
                generate a join table. Envers, however, has to do this, so that when you read the
                revisions in which the related entity has changed, you don't get false results.
            </p>
            <p>
                To be able to name the additional join table, there is a special annotation:
                <code class="literal">@AuditJoinTable</code>, which has similar semantics to JPA's
                <code class="literal">@JoinTable</code>.
            </p>

            <p>
                One special case are relations mapped with <code class="literal">@OneToMany</code>+<code class="literal">@JoinColumn</code> on
                the one side, and <code class="literal">@ManyToOne</code>+<code class="literal">@JoinColumn(insertable=false, updatable=false</code>)
                on the many side.  Such relations are in fact bidirectional, but the owning side is the collection.
            </p>
            <p>
                To properly audit such relations with Envers, you can use the <code class="literal">@AuditMappedBy</code> annotation.
                It enables you to specify the reverse property (using the <code class="literal">mappedBy</code> element). In case
                of indexed collections, the index column must also be mapped in the referenced entity (using
                <code class="literal">@Column(insertable=false, updatable=false)</code>, and specified using
                <code class="literal">positionMappedBy</code>. This annotation will affect only the way
                Envers works. Please note that the annotation is experimental and may change in the future.
            </p>

        </div>
    </div>

    <div class="section" title="15.12. Advanced: Audit table partitioning"><div class="titlepage"><div><div><h2 class="title"><a id="envers-partitioning"/>15.12. Advanced: Audit table partitioning</h2></div></div></div>
        

        <div class="section" title="15.12.1. Benefits of audit table partitioning"><div class="titlepage"><div><div><h3 class="title"><a id="envers-partitioning-benefits"/>15.12.1. Benefits of audit table partitioning</h3></div></div></div>

            

            <p>
                Because audit tables tend to grow indefinitely they can quickly become really large. When the audit tables have grown
                to a certain limit (varying per RDBMS and/or operating system) it makes sense to start using table partitioning.
                SQL table partitioning offers a lot of advantages including, but certainly not limited to:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        <p>
                            Improved query performance by selectively moving rows to various partitions (or even purging old rows)
                        </p>
                    </li><li class="listitem">
                        <p>
                            Faster data loads, index creation, etc.
                        </p>
                    </li></ol></div><p>
            </p>

        </div>

        <div class="section" title="15.12.2. Suitable columns for audit table partitioning"><div class="titlepage"><div><div><h3 class="title"><a id="envers-partitioning-columns"/>15.12.2. Suitable columns for audit table partitioning</h3></div></div></div>

            
            <p>
                Generally SQL tables must be partitioned on a column that exists within the table. As a rule it makes sense to use
                either the <span class="emphasis"><em>end revision</em></span> or the <span class="emphasis"><em>end revision timestamp</em></span> column for
                partioning of audit tables.
                </p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
                    <p>
                        End revision information is not available for the default AuditStrategy.
                    </p>

                    <p>
                        Therefore the following Envers configuration options are required:
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy</code> =
                        <code class="literal">org.hibernate.envers.strategy.ValidityAuditStrategy</code>
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_store_revend_timestamp</code> =
                        <code class="literal">true</code>
                    </p>

                    <p>
                        Optionally, you can also override the default values following properties:
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_end_rev_field_name</code>
                    </p>
                    <p>
                        <code class="literal">org.hibernate.envers.audit_strategy_validity_revend_timestamp_field_name</code>
                    </p>

                    <p>
                        For more information, see <a class="xref" href="#">???</a>.
                    </p>
                </div><p>
            </p>

            <p>
                The reason why the end revision information should be used for audit table partioning is based on the assumption that
                audit tables should be partionioned on an 'increasing level of interestingness', like so:
            </p>

            <p>
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                        <p>
                            A couple of partitions with audit data that is not very (or no longer) interesting.
                            This can be stored on slow media, and perhaps even be purged eventually.
                        </p>
                    </li><li class="listitem">
                        <p>
                            Some partitions for audit data that is potentially interesting.
                        </p>
                    </li><li class="listitem">
                        <p>
                            One partition for audit data that is most likely to be interesting.
                            This should be stored on the fastest media, both for reading and writing.
                        </p>
                    </li></ol></div><p>
            </p>


        </div>

        <div class="section" title="15.12.3. Audit table partitioning example"><div class="titlepage"><div><div><h3 class="title"><a id="envers-partitioning-example"/>15.12.3. Audit table partitioning example</h3></div></div></div>

            
            <p>
                In order to determine a suitable column for the 'increasing level of interestingness',
                consider a simplified example of a salary registration for an unnamed agency.
            </p>

            <p>
                Currently, the salary table contains the following rows for a certain person X:

                </p><div class="table"><a id="d5e4473"/><p class="title"><strong>Table 15.2. Salaries table</strong></p><div class="table-contents">
                    
                    <table summary="Salaries table" border="1"><colgroup><col width="1*" class="c1"/><col width="1*" class="c2"/></colgroup><thead><tr><th>Year</th><th>Salary (USD)</th></tr></thead><tbody><tr><td>2006</td><td>3300</td></tr><tr><td>2007</td><td>3500</td></tr><tr><td>2008</td><td>4000</td></tr><tr><td>2009</td><td>4500</td></tr></tbody></table>
                </div></div><p><br class="table-break"/>
            </p>

            <p>
                The salary for the current fiscal year (2010) is unknown. The agency requires that all changes in registered
                salaries for a fiscal year are recorded (i.e. an audit trail). The rationale behind this is that decisions
                made at a certain date are based on the registered salary at that time. And at any time it must be possible
                reproduce the reason why a certain decision was made at a certain date.
            </p>

            <p>
                The following audit information is available, sorted on in order of occurrence:

                </p><div class="table"><a id="d5e4497"/><p class="title"><strong>Table 15.3. Salaries - audit table</strong></p><div class="table-contents">
                    
                    <table summary="Salaries - audit table" border="1"><colgroup><col width="1*" class="c1"/><col width="1*" class="c2"/><col width="1*" class="c3"/><col width="1*" class="c4"/><col width="1*" class="c5"/></colgroup><thead><tr><th>Year</th><th>Revision type</th><th>Revision timestamp</th><th>Salary (USD)</th><th>End revision timestamp</th></tr></thead><tbody><tr><td>2006</td><td>ADD</td><td>2007-04-01</td><td>3300</td><td>null</td></tr><tr><td>2007</td><td>ADD</td><td>2008-04-01</td><td>35</td><td>2008-04-02</td></tr><tr><td>2007</td><td>MOD</td><td>2008-04-02</td><td>3500</td><td>null</td></tr><tr><td>2008</td><td>ADD</td><td>2009-04-01</td><td>3700</td><td>2009-07-01</td></tr><tr><td>2008</td><td>MOD</td><td>2009-07-01</td><td>4100</td><td>2010-02-01</td></tr><tr><td>2008</td><td>MOD</td><td>2010-02-01</td><td>4000</td><td>null</td></tr><tr><td>2009</td><td>ADD</td><td>2010-04-01</td><td>4500</td><td>null</td></tr></tbody></table>
                </div></div><p><br class="table-break"/>
            </p>

            <div class="section" title="15.12.3.1. Determining a suitable partitioning column"><div class="titlepage"><div><div><h4 class="title"><a id="envers-partitioning-example-column"/>15.12.3.1. Determining a suitable partitioning column</h4></div></div></div>

                
                <p>
                    To partition this data, the 'level of interestingness' must be defined.
                    Consider the following:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                For fiscal year 2006 there is only one revision. It has the oldest <span class="emphasis"><em>revision timestamp</em></span>
                                of all audit rows, but should still be regarded as interesting because it is the latest modification
                                for this fiscal year in the salary table; its <span class="emphasis"><em>end revision timestamp</em></span> is null.
                            </p>
                            <p>
                                Also note that it would be very unfortunate if in 2011 there would be an update of the salary for fiscal
                                year 2006 (which is possible in until at least 10 years after the fiscal year) and the audit
                                information would have been moved to a slow disk (based on the age of the
                                <span class="emphasis"><em>revision timestamp</em></span>). Remember that in this case Envers will have to update
                                the <span class="emphasis"><em>end revision timestamp</em></span> of the most recent audit row.
                            </p>
                        </li><li class="listitem">
                            <p>
                                There are two revisions in the salary of fiscal year 2007 which both have nearly the same
                                <span class="emphasis"><em>revision timestamp</em></span> and a different <span class="emphasis"><em>end revision timestamp</em></span>.
                                On first sight it is evident that the first revision was a mistake and probably uninteresting.
                                The only interesting revision for 2007 is the one with <span class="emphasis"><em>end revision timestamp</em></span> null.
                            </p>
                        </li></ol></div><p>

                    Based on the above, it is evident that only the <span class="emphasis"><em>end revision timestamp</em></span> is suitable for
                    audit table partitioning. The <span class="emphasis"><em>revision timestamp</em></span> is not suitable.
                </p>

            </div>

            <div class="section" title="15.12.3.2. Determining a suitable partitioning scheme"><div class="titlepage"><div><div><h4 class="title"><a id="envers-partitioning-example-scheme"/>15.12.3.2. Determining a suitable partitioning scheme</h4></div></div></div>

                
                <p>
                    A possible partitioning scheme for the salary table would be as follows:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2008
                            </p>
                            <p>
                                This partition contains audit data that is not very (or no longer) interesting.
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2009
                            </p>
                            <p>
                                This partition contains audit data that is potentially interesting.
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year &gt;= 2010 or null
                            </p>
                            <p>
                                This partition contains the most interesting audit data.
                            </p>
                        </li></ol></div><p>
                </p>

                <p>
                    This partitioning scheme also covers the potential problem of the update of the
                    <span class="emphasis"><em>end revision timestamp</em></span>, which occurs if a row in the audited table is modified.
                    Even though Envers will update the <span class="emphasis"><em>end revision timestamp</em></span> of the audit row to
                    the system date at the instant of modification, the audit row will remain in the same partition
                    (the 'extension bucket').
                </p>

                <p>
                    And sometime in 2011, the last partition (or 'extension bucket') is split into two new partitions:
                    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year = 2010
                            </p>
                            <p>
                                This partition contains audit data that is potentially interesting (in 2011).
                            </p>
                        </li><li class="listitem">
                            <p>
                                <span class="emphasis"><em>end revision timestamp</em></span> year &gt;= 2011 or null
                            </p>
                            <p>
                                This partition contains the most interesting audit data and is the new 'extension bucket'.
                            </p>
                        </li></ol></div><p>
                </p>

            </div>

        </div>
    </div>

    <div class="section" title="15.13. Envers links"><div class="titlepage"><div><div><h2 class="title"><a id="envers-links"/>15.13. Envers links</h2></div></div></div>
        

        <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>
                    <a class="ulink" href="http://hibernate.org">Hibernate main page</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://community.jboss.org/en/envers?view=discussions">Forum</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://opensource.atlassian.com/projects/hibernate/browse/HHH">JIRA issue tracker</a>
                    (when adding issues concerning Envers, be sure to select the "envers" component!)
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="irc://irc.freenode.net:6667/envers">IRC channel</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="http://www.jboss.org/feeds/view/envers">Envers Blog</a>
                </p>
            </li><li class="listitem">
                <p>
                    <a class="ulink" href="https://community.jboss.org/wiki/EnversFAQ">FAQ</a>
                </p>
            </li></ol></div>

    </div>

</div>
    <div class="chapter" title="Chapter 16. Multi-tenancy"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4623"/>Chapter 16. Multi-tenancy</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e4625">16.1. What is multi-tenancy?</a></span></dt><dt><span class="section"><a href="#d5e4628">16.2. Multi-tenant data approaches</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4634">16.2.1. Separate database</a></span></dt><dt><span class="section"><a href="#d5e4643">16.2.2. Separate schema</a></span></dt><dt><span class="section"><a href="#d5e4660">16.2.3. Partitioned (discriminator) data</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4669">16.3. Multi-tenancy in Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4698">16.3.1. <code class="interfacename">MultiTenantConnectionProvider</code></a></span></dt><dt><span class="section"><a href="#d5e4723">16.3.2. <code class="interfacename">CurrentTenantIdentifierResolver</code></a></span></dt><dt><span class="section"><a href="#d5e4748">16.3.3. Caching</a></span></dt><dt><span class="section"><a href="#d5e4751">16.3.4. Odds and ends</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4755">16.4. Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</a></span></dt></dl></div>

    

    <div class="section" title="16.1. What is multi-tenancy?"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4625"/>16.1. What is multi-tenancy?</h2></div></div></div>
        
        <p>
            The term multi-tenancy in general is applied to software development to indicate an architecture in which
            a single running instance of an application simultaneously serves multiple clients (tenants).  This is
            highly common in SaaS solutions.  Isolating information (data, customizations, etc) pertaining to the
            various tenants is a particular challenge in these systems.  This includes the data owned by each tenant
            stored in the database.  It is this last piece, sometimes called multi-tenant data, on which we will focus.
        </p>
    </div>

    <div class="section" title="16.2. Multi-tenant data approaches"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4628"/>16.2. Multi-tenant data approaches</h2></div></div></div>
        
        <p>
            There are 3 main approaches to isolating information in these multi-tenant systems which goes hand-in-hand
            with different database schema definitions and JDBC setups.
        </p>

        <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
            <p>
                Each approach has pros and cons as well as specific techniques and considerations.  Such
                topics are beyond the scope of this documentation.  Many resources exist which delve into these
                other topics.  One example is <a class="ulink" href="http://msdn.microsoft.com/en-us/library/aa479086.aspx">http://msdn.microsoft.com/en-us/library/aa479086.aspx</a>
                which does a great job of covering these topics.
            </p>
        </div>

        <div class="section" title="16.2.1. Separate database"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4634"/>16.2.1. Separate database</h3></div></div></div>
            

            <div class="mediaobject" align="center"><img src="/home/brmeyer/workspace_master/hibernate-orm/documentation/src/main/docbook/devguide/en-US/chapters/multitenancy/images/multitenacy_database.png" align="middle"/></div>

            <p>
                Each tenant's data is kept in a physically separate database instance.  JDBC Connections would point
                specifically to each database, so any pooling would be per-tenant.  A general application approach
                here would be to define a JDBC Connection pool per-tenant and to select the pool to use based on the
                <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the currently logged in user.
            </p>
        </div>

        <div class="section" title="16.2.2. Separate schema"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4643"/>16.2.2. Separate schema</h3></div></div></div>
            

            <div class="mediaobject" align="center"><img src="/home/brmeyer/workspace_master/hibernate-orm/documentation/src/main/docbook/devguide/en-US/chapters/multitenancy/images/multitenacy_schema.png" align="middle"/></div>

            <p>
                Each tenant's data is kept in a distinct database schema on a single database instance.  There are 2
                different ways to define JDBC Connections here:
                </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                        <p>
                            Connections could point specifically to each schema, as we saw with the
                            <code class="literal">Separate database</code> approach.  This is an option provided that
                            the driver supports naming the default schema in the connection URL or if the
                            pooling mechanism supports naming a schema to use for its Connections.  Using this
                            approach, we would have a distinct JDBC Connection pool per-tenant where the pool to use
                            would be selected based on the <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the
                            currently logged in user.
                        </p>
                    </li><li class="listitem">
                        <p>
                            Connections could point to the database itself (using some default schema) but
                            the Connections would be altered using the SQL <code class="literal">SET SCHEMA</code> (or similar)
                            command.  Using this approach, we would have a single JDBC Connection pool for use to
                            service all tenants, but before using the Connection it would be altered to reference
                            the schema named by the <span class="quote">“<span class="quote">tenant identifier</span>”</span> associated with the currently
                            logged in user.
                        </p>
                    </li></ul></div><p>
            </p>
        </div>

        <div class="section" title="16.2.3. Partitioned (discriminator) data"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4660"/>16.2.3. Partitioned (discriminator) data</h3></div></div></div>
            

            <div class="mediaobject" align="center"><img src="/home/brmeyer/workspace_master/hibernate-orm/documentation/src/main/docbook/devguide/en-US/chapters/multitenancy/images/multitenacy_discriminator.png" align="middle"/></div>

            <p>
                All data is kept in a single database schema.  The data for each tenant is partitioned by the use of
                partition value or discriminator.  The complexity of this discriminator might range from a simple
                column value to a complex SQL formula.  Again, this approach would use a single Connection pool
                to service all tenants.  However, in this approach the application needs to alter each and every
                SQL statement sent to the database to reference the <span class="quote">“<span class="quote">tenant identifier</span>”</span> discriminator.
            </p>
        </div>
    </div>

    <div class="section" title="16.3. Multi-tenancy in Hibernate"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4669"/>16.3. Multi-tenancy in Hibernate</h2></div></div></div>
        
        <p>
            Using Hibernate with multi-tenant data comes down to both an API and then integration piece(s).  As
            usual Hibernate strives to keep the API simple and isolated from any underlying integration complexities.
            The API is really just defined by passing the tenant identifier as part of opening any session.
        </p>
        <div class="example"><a id="specifying-tenant-ex"/><p class="title"><strong>Example 16.1. Specifying tenant identifier from <code class="interfacename">SessionFactory</code></strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Session session = sessionFactory.withOptions()
        .tenantIdentifier( yourTenantIdentifier )
        ...
        .openSession();</pre>
        </div></div><br class="example-break"/>
        <p>
            Additionally, when specifying configuration, a <code class="classname">org.hibernate.MultiTenancyStrategy</code>
            should be named using the <span class="property">hibernate.multiTenancy</span> setting.  Hibernate will perform
            validations based on the type of strategy you specify.  The strategy here correlates to the isolation
            approach discussed above.
        </p>
        <div class="variablelist"><dl><dt><span class="term">NONE</span></dt><dd>
                    <p>
                        (the default) No multi-tenancy is expected.  In fact, it is considered an error if a tenant
                        identifier is specified when opening a session using this strategy.
                    </p>
                </dd><dt><span class="term">SCHEMA</span></dt><dd>
                    <p>
                        Correlates to the separate schema approach.  It is an error to attempt to open a session without
                        a tenant identifier using this strategy.  Additionally, a
                        <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code>
                        must be specified.
                    </p>
                </dd><dt><span class="term">DATABASE</span></dt><dd>
                    <p>
                        Correlates to the separate database approach.  It is an error to attempt to open a session without
                        a tenant identifier using this strategy.  Additionally, a
                        <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code>
                        must be specified.
                    </p>
                </dd><dt><span class="term">DISCRIMINATOR</span></dt><dd>
                    <p>
                        Correlates to the partitioned (discriminator) approach.  It is an error to attempt to open a
                        session without a tenant identifier using this strategy.  This strategy is not yet implemented
                        in Hibernate as of 4.0 and 4.1.  Its support is planned for 5.0.
                    </p>
                </dd></dl></div>

        <div class="section" title="16.3.1. MultiTenantConnectionProvider"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4698"/>16.3.1. <code class="interfacename">MultiTenantConnectionProvider</code></h3></div></div></div>
            
            <p>
                When using either the DATABASE or SCHEMA approach, Hibernate needs to be able to obtain Connections
                in a tenant specific manner.  That is the role of the
                <code class="interfacename">org.hibernate.service.jdbc.connections.spi.MultiTenantConnectionProvider</code>
                contract.  Application developers will need to provide an implementation of this
                contract.  Most of its methods are extremely self-explanatory.  The only ones which might not be are
                <code class="methodname">getAnyConnection</code> and <code class="methodname">releaseAnyConnection</code>.  It is
                important to note also that these methods do not accept the tenant identifier.  Hibernate uses these
                methods during startup to perform various configuration, mainly via the
                <code class="classname">java.sql.DatabaseMetaData</code> object.
            </p>
            <p>
                The <code class="interfacename">MultiTenantConnectionProvider</code> to use can be specified in a number of
                ways:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        Use the <span class="property">hibernate.multi_tenant_connection_provider</span> setting.  It could
                        name a <code class="interfacename">MultiTenantConnectionProvider</code> instance, a
                        <code class="interfacename">MultiTenantConnectionProvider</code> implementation class reference or
                        a <code class="interfacename">MultiTenantConnectionProvider</code> implementation class name.
                    </p>
                </li><li class="listitem">
                    <p>
                        Passed directly to the <code class="classname">org.hibernate.service.ServiceRegistryBuilder</code>.
                    </p>
                </li><li class="listitem">
                    <p>
                        If none of the above options match, but the settings do specify a
                        <span class="property">hibernate.connection.datasource</span> value, Hibernate will assume it should
                        use the specific
                        <code class="classname">org.hibernate.service.jdbc.connections.spi.DataSourceBasedMultiTenantConnectionProviderImpl</code>
                        implementation which works on a number of pretty reasonable assumptions when running inside of
                        an app server and using one <code class="interfacename">javax.sql.DataSource</code> per tenant.
                        See its javadocs for more details.
                    </p>
                </li></ul></div>
        </div>

        <div class="section" title="16.3.2. CurrentTenantIdentifierResolver"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4723"/>16.3.2. <code class="interfacename">CurrentTenantIdentifierResolver</code></h3></div></div></div>
            
            <p>
                <code class="interfacename">org.hibernate.context.spi.CurrentTenantIdentifierResolver</code> is a contract
                for Hibernate to be able to resolve what the application considers the current tenant identifier.
                The implementation to use is either passed directly to <code class="classname">Configuration</code> via its
                <code class="methodname">setCurrentTenantIdentifierResolver</code> method.  It can also be specified via
                the <span class="property">hibernate.tenant_identifier_resolver</span> setting.
            </p>
            <p>
                There are 2 situations where <code class="interfacename">CurrentTenantIdentifierResolver</code> is used:
            </p>
            <div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                    <p>
                        The first situation is when the application is using the
                        <code class="interfacename">org.hibernate.context.spi.CurrentSessionContext</code> feature in
                        conjunction with multi-tenancy.  In the case of the current-session feature,  Hibernate will
                        need to open a session if it cannot find an existing one in scope.  However, when a session
                        is opened in a multi-tenant environment the tenant identifier has to be specified.  This is
                        where the <code class="interfacename">CurrentTenantIdentifierResolver</code> comes into play;
                        Hibernate will consult the implementation you provide to determine the tenant identifier to use
                        when opening the session.  In this case, it is required that a
                        <code class="interfacename">CurrentTenantIdentifierResolver</code> be supplied.
                    </p>
                </li><li class="listitem">
                    <p>
                        The other situation is when you do not want to have to explicitly specify the tenant
                        identifier all the time as we saw in <a class="xref" href="#specifying-tenant-ex" title="Example 16.1. Specifying tenant identifier from SessionFactory">Example 16.1, “Specifying tenant identifier from <code class="interfacename">SessionFactory</code>”</a>.  If a
                        <code class="interfacename">CurrentTenantIdentifierResolver</code> has been specified, Hibernate
                        will use it to determine the default tenant identifier to use when opening the session.
                    </p>
                </li></ul></div>
            <p>
                Additionally, if the <code class="interfacename">CurrentTenantIdentifierResolver</code> implementation
                returns <code class="literal">true</code> for its <code class="methodname">validateExistingCurrentSessions</code>
                method, Hibernate will make sure any existing sessions that are found in scope have a matching
                tenant identifier.  This capability is only pertinent when the
                <code class="interfacename">CurrentTenantIdentifierResolver</code> is used in current-session settings.
            </p>
        </div>

        <div class="section" title="16.3.3. Caching"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4748"/>16.3.3. Caching</h3></div></div></div>
            
            <p>
                Multi-tenancy support in Hibernate works seamlessly with the Hibernate second level cache.  The key
                used to cache data encodes the tenant identifier.
            </p>
        </div>

        <div class="section" title="16.3.4. Odds and ends"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4751"/>16.3.4. Odds and ends</h3></div></div></div>
            
            <p>
                Currently schema export will not really work with multi-tenancy.  That may not change.
            </p>
            <p>
                The JPA expert group is in the process of defining multi-tenancy support for the upcoming 2.1
                version of the specification.
            </p>
        </div>
    </div>

    <div class="section" title="16.4. Strategies for MultiTenantConnectionProvider implementors"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4755"/>16.4. Strategies for <code class="interfacename">MultiTenantConnectionProvider</code> implementors</h2></div></div></div>
        
        <div class="example"><a id="d5e4758"/><p class="title"><strong>Example 16.2. Implementing MultiTenantConnectionProvider using different connection pools</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">/**
 * Simplisitc implementation for illustration purposes supporting 2 hard coded providers (pools) and leveraging
 * the support class {@link org.hibernate.service.jdbc.connections.spi.AbstractMultiTenantConnectionProvider}
 */
public class MultiTenantConnectionProviderImpl extends AbstractMultiTenantConnectionProvider {
	private final ConnectionProvider acmeProvider = ConnectionProviderUtils.buildConnectionProvider( "acme" );
	private final ConnectionProvider jbossProvider = ConnectionProviderUtils.buildConnectionProvider( "jboss" );

	@Override
	protected ConnectionProvider getAnyConnectionProvider() {
		return acmeProvider;
	}

	@Override
	protected ConnectionProvider selectConnectionProvider(String tenantIdentifier) {
		if ( "acme".equals( tenantIdentifier ) ) {
			return acmeProvider;
		}
		else if ( "jboss".equals( tenantIdentifier ) ) {
			return jbossProvider;
		}
		throw new HibernateException( "Unknown tenant identifier" );
	}
}</pre>
        </div></div><br class="example-break"/>
        <p>
            The approach above is valid for the DATABASE approach.  It is also valid for the SCHEMA approach
            provided the underlying database allows naming the schema to which to connect in the connection URL.
        </p>
        <div class="example"><a id="d5e4762"/><p class="title"><strong>Example 16.3. Implementing MultiTenantConnectionProvider using single connection pool</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">/**
 * Simplisitc implementation for illustration purposes showing a single connection pool used to serve
 * multiple schemas using "connection altering".  Here we use the T-SQL specific USE command; Oracle
 * users might use the ALTER SESSION SET SCHEMA command; etc.
 */
public class MultiTenantConnectionProviderImpl
		implements MultiTenantConnectionProvider, Stoppable {
	private final ConnectionProvider connectionProvider = ConnectionProviderUtils.buildConnectionProvider( "master" );

	@Override
	public Connection getAnyConnection() throws SQLException {
		return connectionProvider.getConnection();
	}

	@Override
	public void releaseAnyConnection(Connection connection) throws SQLException {
		connectionProvider.closeConnection( connection );
	}

	@Override
	public Connection getConnection(String tenantIdentifier) throws SQLException {
		final Connection connection = getAnyConnection();
		try {
			connection.createStatement().execute( "USE " + tenanantIdentifier );
		}
		catch ( SQLException e ) {
			throw new HibernateException(
					"Could not alter JDBC connection to specified schema [" +
							tenantIdentifier + "]",
					e
			);
		}
		return connection;
	}

	@Override
	public void releaseConnection(String tenantIdentifier, Connection connection) throws SQLException {
		try {
			connection.createStatement().execute( "USE master" );
		}
		catch ( SQLException e ) {
			// on error, throw an exception to make sure the connection is not returned to the pool.
			// your requirements may differ
			throw new HibernateException(
					"Could not alter JDBC connection to specified schema [" +
							tenantIdentifier + "]",
					e
			);
		}
		connectionProvider.closeConnection( connection );
	}

	...
}</pre>
        </div></div><br class="example-break"/>
        <p>
            This approach is only relevant to the SCHEMA approach.
        </p>
    </div>
</div>
    <div class="chapter" title="Chapter 17. OSGi"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4766"/>Chapter 17. OSGi</h2></div><div><div class="abstract" title="Abstract"><p class="title"><strong>Abstract</strong></p>
            <p>
                The Open Services Gateway initiative (OSGi) specification describes a dynamic, modularized system.  "Bundles"
                (components) can be installed, activated, deactivated, and uninstalled during runtime, without requiring
                a system restart.  OSGi frameworks manage bundles' dependencies, packages, and classes.  The framework
                is also in charge of ClassLoading, managing visibility of packages between bundles.  Further, service
                registry and discovery is provided through a "whiteboard" pattern.
            </p>
            
            <p>
                OSGi environments present numerous, unique challenges.  Most notably, the dynamic nature of available
                bundles during runtime can require significant architectural considerations.  Also,
                architectures must allow the OSGi-specific ClassLoading and service registration/discovery.
            </p>
        </div></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e4773">17.1. OSGi Specification and Environment</a></span></dt><dt><span class="section"><a href="#d5e4788">17.2. hibernate-osgi</a></span></dt><dt><span class="section"><a href="#osgi-managed-jpa">17.3. Container-Managed JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4798">17.3.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4808">17.3.2. DataSource</a></span></dt><dt><span class="section"><a href="#d5e4815">17.3.3. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4819">17.3.4. Obtaining an EntityManger</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-jpa">17.4. Unmanaged JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4832">17.4.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4848">17.4.2. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4852">17.4.3. Obtaining an EntityMangerFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#osgi-unmanaged-native">17.5. Unmanaged Native</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e4865">17.5.1. Client bundle imports</a></span></dt><dt><span class="section"><a href="#d5e4884">17.5.2. Bundle Ordering</a></span></dt><dt><span class="section"><a href="#d5e4888">17.5.3. Obtaining an SessionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e4896">17.6. Optional Modules</a></span></dt><dt><span class="section"><a href="#d5e4901">17.7. Extension Points</a></span></dt><dt><span class="section"><a href="#d5e4919">17.8. Caveats</a></span></dt></dl></div>
    

    <div class="section" title="17.1. OSGi Specification and Environment"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4773"/>17.1. OSGi Specification and Environment</h2></div></div></div>
        

        <p>
            Hibernate targets the OSGi 4.3 spec or later.  It was necessary to start with 4.3, over 4.2, due to our
            dependency on OSGi's <code class="literal">BundleWiring</code> for entity/mapping scanning.
        </p>

        <p>
        	Hibernate supports three types of configurations within OSGi.
        	
        	 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
	                <em class="firstterm">Container-Managed JPA</em>: <a class="xref" href="#osgi-managed-jpa" title="17.3. Container-Managed JPA">Section 17.3, “Container-Managed JPA”</a>
	            </li><li class="listitem">
	                <em class="firstterm">Unmanaged JPA</em>: <a class="xref" href="#osgi-unmanaged-jpa" title="17.4. Unmanaged JPA">Section 17.4, “Unmanaged JPA”</a>
	            </li><li class="listitem">
	                <em class="firstterm">Unmanaged Native</em>: <a class="xref" href="#osgi-unmanaged-native" title="17.5. Unmanaged Native">Section 17.5, “Unmanaged Native”</a>
	            </li></ol></div><p>
        </p>
    </div>

    <div class="section" title="17.2. hibernate-osgi"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4788"/>17.2. hibernate-osgi</h2></div></div></div>
        

        <p>
            Rather than embed OSGi capabilities into hibernate-core, hibernate-entitymanager, and sub-modules,
            hibernate-osgi was created.  It's purposefully separated, isolating all OSGi dependencies.  It provides an
            OSGi-specific ClassLoader (aggregates the container's CL with core and entitymanager CLs), JPA persistence
            provider, SF/EMF bootstrapping, entities/mappings scanner, and service management.
        </p>
    </div>

    <div class="section" title="17.3. Container-Managed JPA"><div class="titlepage"><div><div><h2 class="title"><a id="osgi-managed-jpa"/>17.3. Container-Managed JPA</h2></div></div></div>
        
        
        <p>
            The Enterprise OSGi specification includes container-managed JPA.  The container is responsible for
            discovering persistence units and creating the <code class="literal">EntityManagerFactory</code> (one EMF per PU).
            It uses the JPA provider (hibernate-osgi) that has registered itself with the OSGi
            <code class="literal">PersistenceProvider</code> service.
        </p>
        
        <p>
        	Quickstart tutorial project, demonstrating a container-managed JPA client bundle:
        	<a class="ulink" href="https://github.com/hibernate/hibernate-orm/tree/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/managed-jpa">managed-jpa</a>
        </p>
        
        <div class="section" title="17.3.1. Client bundle imports"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4798"/>17.3.1. Client bundle imports</h3></div></div></div>
        	
        	<p>
        		Your client bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime).
		                </p>
		            </li></ul></div><p>
        	</p>
        </div>
        
        <div class="section" title="17.3.2. DataSource"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4808"/>17.3.2. DataSource</h3></div></div></div>
        	
        	<p>
        		Typical Enterprise OSGi JPA usage includes a DataSource installed in the container.  The client
        		bundle's <code class="literal">persistence.xml</code> uses the DataSource through JNDI.  For an example,
        		see the QuickStart's DataSource:
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/datasource-h2.xml">datasource-h2.xml</a>
        		The DataSource is then called out in
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/managed-jpa/src/main/resources/META-INF/persistence.xml">
        		persistence.xml's</a> <code class="literal">jta-data-source</code>.
        	</p>
        </div>
        
        <div class="section" title="17.3.3. Bundle Ordering"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4815"/>17.3.3. Bundle Ordering</h3></div></div></div>
        	
        	<p>
        		Hibernate currently requires fairly specific bundle activation ordering.  See the managed-jpa
        		QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/managed-jpa/features.xml">features.xml</a>
        		for the best supported sequence.
        	</p>
        </div>
        
        <div class="section" title="17.3.4. Obtaining an EntityManger"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4819"/>17.3.4. Obtaining an EntityManger</h3></div></div></div>
        	
        	<p>
        		The easiest, and most supported, method of obtaining an <code class="literal">EntityManager</code> utilizes OSGi's
        		<code class="literal">blueprint.xml</code>.  The container takes the name of your persistence unit, then injects
        		an <code class="literal">EntityManager</code> instance into your given bean attribute.  See the
        		<code class="literal">dpService</code> bean in the managed-jpa QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/managed-jpa/src/main/resources/OSGI-INF/blueprint/blueprint.xml">blueprint.xml</a>
        		for an example.
        	</p>
        </div>
    </div>

    <div class="section" title="17.4. Unmanaged JPA"><div class="titlepage"><div><div><h2 class="title"><a id="osgi-unmanaged-jpa"/>17.4. Unmanaged JPA</h2></div></div></div>
        
        
        <p>
            Hibernate also supports the use of JPA through hibernate-entitymanager, unmanaged by the OSGi
            container.  The client bundle is responsible for managing the EntityManagerFactory and EntityManagers.
        </p>
        
        <p>
        	Quickstart tutorial project, demonstrating an unmanaged JPA client bundle:
        	<a class="ulink" href="https://github.com/hibernate/hibernate-orm/tree/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-jpa">unmanaged-jpa</a>
        </p>
        
        <div class="section" title="17.4.1. Client bundle imports"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4832"/>17.4.1. Client bundle imports</h3></div></div></div>
        	
        	<p>
        		Your client bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    JDBC driver package (example: <code class="literal">org.h2</code>)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.osgi.framework</code>, necessary to discover the EMF (described below)
		                </p>
		            </li></ul></div><p>
        	</p>
        </div>
        
        <div class="section" title="17.4.2. Bundle Ordering"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4848"/>17.4.2. Bundle Ordering</h3></div></div></div>
        	
        	<p>
        		Hibernate currently requires fairly specific bundle activation ordering.  See the unmanaged-jpa
        		QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-jpa/features.xml">features.xml</a>
        		for the best supported sequence.
        	</p>
        </div>
        
        <div class="section" title="17.4.3. Obtaining an EntityMangerFactory"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4852"/>17.4.3. Obtaining an EntityMangerFactory</h3></div></div></div>
        	
        	<p>
        		hibernate-osgi registers an OSGi service, using the JPA <code class="literal">PersistenceProvider</code> interface
        		name, that bootstraps and creates an <code class="literal">EntityManagerFactory</code> specific for OSGi
        		environments.  It is VITAL that your EMF be obtained through the service, rather than creating it
        		manually.  The service handles the OSGi ClassLoader, discovered extension points, scanning, etc.  Manually
        		creating an <code class="literal">EntityManagerFactory</code> is guaranteed to NOT work during runtime!
        	</p>
        	<p>
        		For an example on how to discover and use the service, see the unmanaged-jpa
        		QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-jpa/src/main/java/org/hibernate/osgitest/HibernateUtil.java">HibernateUtil.java</a>.
        	</p>
        </div>
    </div>

    <div class="section" title="17.5. Unmanaged Native"><div class="titlepage"><div><div><h2 class="title"><a id="osgi-unmanaged-native"/>17.5. Unmanaged Native</h2></div></div></div>
        
        
        <p>
            Native Hibernate use is also supported.  The client bundle is responsible for managing the
            SessionFactory and Sessions.
        </p>
        
        <p>
        	Quickstart tutorial project, demonstrating an unmanaged native client bundle:
        	<a class="ulink" href="https://github.com/hibernate/hibernate-orm/tree/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-native">unmanaged-native</a>
        </p>
        
        <div class="section" title="17.5.1. Client bundle imports"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4865"/>17.5.1. Client bundle imports</h3></div></div></div>
        	
        	<p>
        		Your client bundle's manifest will need to import, at a minimum,
        		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
		                <code class="literal">javax.persistence</code>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.proxy</code> and <code class="literal">javassist.util.proxy</code>, due to
		                    Hibernate's ability to return proxies for lazy initialization (Javassist enhancement
		                    occurs on the entity's ClassLoader during runtime)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    JDBC driver package (example: <code class="literal">org.h2</code>)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.osgi.framework</code>, necessary to discover the SF (described below)
		                </p>
		            </li><li class="listitem">
		                <p>
		                    <code class="literal">org.hibernate.*</code> packages, as necessary (ex: cfg, criterion, service, etc.)
		                </p>
		            </li></ul></div><p>
        	</p>
        </div>
        
        <div class="section" title="17.5.2. Bundle Ordering"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4884"/>17.5.2. Bundle Ordering</h3></div></div></div>
        	
        	<p>
        		Hibernate currently requires fairly specific bundle activation ordering.  See the unmanaged-native
        		QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-native/features.xml">features.xml</a>
        		for the best supported sequence.
        	</p>
        </div>
        
        <div class="section" title="17.5.3. Obtaining an SessionFactory"><div class="titlepage"><div><div><h3 class="title"><a id="d5e4888"/>17.5.3. Obtaining an SessionFactory</h3></div></div></div>
        	
        	<p>
        		hibernate-osgi registers an OSGi service, using the <code class="literal">SessionFactory</code> interface
        		name, that bootstraps and creates an <code class="literal">SessionFactory</code> specific for OSGi
        		environments.  It is VITAL that your SF be obtained through the service, rather than creating it
        		manually.  The service handles the OSGi ClassLoader, discovered extension points, scanning, etc.  Manually
        		creating an <code class="literal">SessionFactory</code> is guaranteed to NOT work during runtime!
        	</p>
        	<p>
        		For an example on how to discover and use the service, see the unmanaged-native
        		QuickStart's
        		<a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-native/src/main/java/org/hibernate/osgitest/HibernateUtil.java">HibernateUtil.java</a>.
        	</p>
        </div>
    </div>
    
    <div class="section" title="17.6. Optional Modules"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4896"/>17.6. Optional Modules</h2></div></div></div>
    	
    	
    	<p>
    		The <a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-native">unmanaged-native</a>
    		QuickStart project demonstrates the use of optional Hibernate modules.  Each module adds additional
    		dependency bundles that must first be activated
    		(see <a class="ulink" href="https://github.com/hibernate/hibernate-orm/blob/4.2/documentation/src/main/docbook/quickstart/tutorials/osgi/unmanaged-native/features.xml">features.xml</a>).
    		As of ORM 4.2, only Envers is fully supported.  Support for C3P0, Proxool, EhCache, and Infinispan will be added in
    		4.3, however none of their 3rd party libraries currently work in OSGi (lots of ClassLoader problems, etc.).
    		We're tracking the issues in JIRA.
    	</p>
    </div>
    
    <div class="section" title="17.7. Extension Points"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4901"/>17.7. Extension Points</h2></div></div></div>
    	
    	
    	<p>
    		Multiple contracts exist to allow applications to integrate with and extend Hibernate capabilities.  Most
    		apps utilize JDK services to provide their implementations.  hibernate-osgi supports the same
    		extensions through OSGi services.  Implement and register them in any of the three configurations.
    		hibernate-osgi will discover and integrate them during EMF/SF bootstrapping.  Supported extension points
    		are as follows.  The specified interface should be used during service registration.
    		
    		</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
	                <code class="literal">org.hibernate.integrator.spi.Integrator</code>
	            </li><li class="listitem">
	                JTA's <code class="literal">javax.transaction.TransactionManager</code> and
	                <code class="literal">javax.transaction.UserTransaction</code>, however these are typically
	                provided by the OSGi container.
	            </li></ul></div><p>
    	</p>
    	
    	<p>
    		The easiest way to register extension point implementations is through a <code class="literal">blueprint.xml</code>
    		file.  Add <code class="literal">OSGI-INF/blueprint/blueprint.xml</code> to your classpath.  Envers' blueprint
    		is a great example:
    	</p>
    	
    	<div class="example"><a id="d5e4913"/><p class="title"><strong>Example 17.1. Example extension point registrations in blueprint.xml</strong></p><div class="example-contents">
            
            <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;blueprint default-activation="eager"
	xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;

	&lt;bean id="integrator" class="org.hibernate.envers.event.spi.EnversIntegrator" /&gt;
	&lt;service ref="integrator" interface="org.hibernate.integrator.spi.Integrator" /&gt;

&lt;/blueprint&gt;</pre>
        </div></div><br class="example-break"/>
        
        <p>
        	Extension points can also be registered programmatically with
        	<code class="literal">BundleContext#registerService</code>, typically within your
        	<code class="literal">BundleActivator#start</code>.
        </p>
    </div>
    
    <div class="section" title="17.8. Caveats"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4919"/>17.8. Caveats</h2></div></div></div>
    	
    	
    	<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
                <p>
                	Technically, multiple persistence units are supported by Enterprise OSGi JPA and unmanaged
                	Hibernate JPA use.  However, we cannot currently support this in OSGi.  In Hibernate 4, only one
                	instance of the OSGi-specific ClassLoader is used per Hibernate bundle, mainly due to heavy use of
                	static TCCL utilities.  We hope to support one OSGi ClassLoader per persistence unit in
                	Hibernate 5.
                </p>
            </li><li class="listitem">
                <p>
                	Scanning is supported to find non-explicitly listed entities and mappings.  However, they MUST be
                	in the same bundle as your persistence unit (fairly typical anyway).  Our OSGi ClassLoader only
                	considers the "requesting bundle" (hence the requirement on using services to create EMF/SF),
                	rather than attempting to scan all available bundles.  This is primarily for versioning
                	considerations, collision protections, etc.
                </p>
            </li><li class="listitem">
                <p>
                	Some containers (ex: Aries) always return true for
                	<code class="literal">PersistenceUnitInfo#excludeUnlistedClasses</code>,
                	even if your persistence.xml explicitly has <code class="literal">exclude-unlisted-classes</code> set
                	to <code class="literal">false</code>.  They claim it's to protect JPA providers from having to implement
                	scanning ("we handle it for you"), even though we still want to support it in many cases.  The work
                	around is to set <code class="literal">hibernate.archive.autodetection</code> to, for example,
                	<code class="literal">hbm,class</code>.  This tells hibernate to ignore the excludeUnlistedClasses value and
                	scan for <code class="literal">*.hbm.xml</code> and entities regardless.
                </p>
            </li><li class="listitem">
                <p>
                	Scanning does not currently support annotated packages on <code class="literal">package-info.java</code>.
                </p>
            </li><li class="listitem">
                <p>
                	Currently, Hibernate OSGi is primarily tested using Apache Karaf and Apache Aries JPA.  Additional
                	testing is needed with Equinox, Gemini, and other container providers.
                </p>
            </li><li class="listitem">
                <p>
                	Hibernate ORM has many dependencies that do not currently provide OSGi manifests.
                	The QuickStart tutorials make heavy use of 3rd party bundles (SpringSource, ServiceMix) or the
                	<code class="literal">wrap:...</code> operator.
                </p>
            </li><li class="listitem">
                <p>
                	As previously mentioned, bundle activation is currently order specific.  See the QuickStart
                	tutorials' <code class="literal">features.xml</code> for example sequences.
                </p>
            </li></ul></div>
    </div>

</div>
    <div class="appendix" title="Appendix A. Configuration properties"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4945"/>Appendix A. Configuration properties</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#d5e4947">A.1. General Configuration</a></span></dt><dt><span class="section"><a href="#d5e5053">A.2. Database configuration</a></span></dt><dt><span class="section"><a href="#d5e5276">A.3. Connection pool properties</a></span></dt></dl></div>

  
  <div class="section" title="A.1. General Configuration"><div class="titlepage"><div><div><h2 class="title"><a id="d5e4947"/>A.1. General Configuration</h2></div></div></div>
    
    <div class="informaltable">
      <table border="1"><colgroup><col width="100px"/><col width="120px"/><col width="250px"/></colgroup><tbody><tr><td>hibernate.dialect</td><td>A fully-qualified classname</td><td>
              <p>
                The classname of a Hibernate <code class="classname">org.hibernate.dialect.Dialect</code> from which Hibernate
                can generate SQL optimized for a particular relational database.
              </p>
              <p>
                In most cases Hibernate can choose the correct <code class="classname">org.hibernate.dialect.Dialect</code>
                implementation based on the JDBC metadata returned by the JDBC driver.
              </p>
            </td></tr><tr><td>hibernate.show_sql</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Write all SQL statements to the console. This is an alternative to setting the log category
            <span class="property">org.hibernate.SQL</span> to debug.</td></tr><tr><td>hibernate.format_sql</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Pretty-print the SQL in the log and console.</td></tr><tr><td>hibernate.default_schema</td><td>A schema name</td><td>Qualify unqualified table names with the given schema or tablespace in generated SQL.</td></tr><tr><td>hibernate.default_catalog</td><td>A catalog name</td><td>Qualifies unqualified table names with the given catalog in generated SQL.</td></tr><tr><td>hibernate.session_factory_name</td><td>A JNDI name</td><td>The <code class="classname">org.hibernate.SessionFactory</code> is automatically bound to this name in JNDI
            after it is created.</td></tr><tr><td>hibernate.max_fetch_depth</td><td>A value between <code class="literal">0</code> and <code class="literal">3</code></td><td>Sets a maximum depth for the outer join fetch tree for single-ended associations. A single-ended
            assocation is a one-to-one or many-to-one assocation. A value of <code class="literal">0</code> disables default outer
            join fetching.</td></tr><tr><td>hibernate.default_batch_fetch_size</td><td><p><code class="literal">4</code>,<code class="literal">8</code>, or <code class="literal">16</code></p></td><td>Default size for Hibernate batch fetching of associations.</td></tr><tr><td>hibernate.default_entity_mode</td><td><p><code class="literal">dynamic-map</code> or <code class="literal">pojo</code></p></td><td>Default mode for entity representation for all sessions opened from this
            <code class="classname">SessionFactory</code>, defaults to <code class="literal">pojo</code>.</td></tr><tr><td>hibernate.order_updates</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Forces Hibernate to order SQL updates by the primary key value of the items being updated. This
            reduces the likelihood of transaction deadlocks in highly-concurrent systems.</td></tr><tr><td>hibernate.order_by.default_null_ordering</td><td><p><code class="literal">none</code>, <code class="literal">first</code> or <code class="literal">last</code></p></td><td>Defines precedence of null values in <code class="literal">ORDER BY</code> clause. Defaults to
            <code class="literal">none</code> which varies between RDBMS implementation.</td></tr><tr><td>hibernate.generate_statistics</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Causes Hibernate to collect statistics for performance tuning.</td></tr><tr><td>hibernate.use_identifier_rollback</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>If true, generated identifier properties are reset to default values when objects are
            deleted.</td></tr><tr><td>hibernate.use_sql_comments</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>If true, Hibernate generates comments inside the SQL, for easier debugging.</td></tr></tbody></table>
    </div>
  </div>
  <div class="section" title="A.2. Database configuration"><div class="titlepage"><div><div><h2 class="title"><a id="d5e5053"/>A.2. Database configuration</h2></div></div></div>
    
    <div class="table"><a id="d5e5055"/><p class="title"><strong>Table A.1. JDBC properties</strong></p><div class="table-contents">
      
      <table summary="JDBC properties" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Property</th><th>Example</th><th>Purpose</th></tr></thead><tbody><tr><td>hibernate.jdbc.fetch_size</td><td><code class="literal">0</code> or an integer</td><td>A non-zero value determines the JDBC fetch size, by calling
            <code class="methodname">Statement.setFetchSize()</code>.</td></tr><tr><td>hibernate.jdbc.batch_size</td><td><p>A value between <code class="literal">5</code> and <code class="literal">30</code></p></td><td>A non-zero value causes Hibernate to use JDBC2 batch updates.</td></tr><tr><td>hibernate.jdbc.batch_versioned_data</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td><p>Set this property to <code class="literal">true</code> if your JDBC driver returns correct row counts
            from <code class="methodname">executeBatch()</code>. This option is usually safe, but is disabled by default. If
            enabled, Hibernate uses batched DML for automatically versioned data.</p></td></tr><tr><td>hibernate.jdbc.factory_class</td><td>The fully-qualified class name of the factory</td><td><p>Select a custom <code class="classname">org.hibernate.jdbc.Batcher</code>. Irrelevant for most
            applications.</p></td></tr><tr><td>hibernate.jdbc.use_scrollable_resultset</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Enables Hibernate to use JDBC2 scrollable resultsets. This property is only relevant for
            user-supplied JDBC connections. Otherwise, Hibernate uses connection metadata.</td></tr><tr><td>hibernate.jdbc.use_streams_for_binary</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td><p>Use streams when writing or reading <span class="type">binary</span> or <span class="type">serializable</span> types to
            or from JDBC. This is a system-level property.</p></td></tr><tr><td>hibernate.jdbc.use_get_generated_keys</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td><p>Allows Hibernate to use JDBC3 <code class="classname">PreparedStatement.getGeneratedKeys()</code> to
            retrieve natively-generated keys after insert. You need the JDBC3+ driver and JRE1.4+. Disable this property
            if your driver has problems with the Hibernate identifier generators. By default, it tries to detect the
            driver capabilities from connection metadata.</p></td></tr></tbody></table>
    </div></div><br class="table-break"/>
    <div class="table"><a id="d5e5119"/><p class="title"><strong>Table A.2. Cache Properties</strong></p><div class="table-contents">
      
      <table summary="Cache Properties" border="1"><colgroup><col width="100px"/><col width="100px"/><col width="240px"/></colgroup><thead><tr><th>Property</th><th>Example</th><th>Purpose</th></tr></thead><tbody><tr><td>hibernate.cache.provider_class</td><td>Fully-qualified classname</td><td>The classname of a custom CacheProvider.</td></tr><tr><td>hibernate.cache.use_minimal_puts</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Optimizes second-level cache operation to minimize writes, at the cost of more frequent reads. This
            is most useful for clustered caches and is enabled by default for clustered cache implementations.</td></tr><tr><td>hibernate.cache.use_query_cache</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Enables the query cache. You still need to set individual queries to be cachable.</td></tr><tr><td>hibernate.cache.use_second_level_cache</td><td><p><code class="literal">true</code> or
            <code class="literal">false</code></p></td><td>Completely disable the second level cache, which is enabled
            by default for classes which specify a &lt;cache&gt; mapping.</td></tr><tr><td>hibernate.cache.query_cache_factory</td><td>Fully-qualified classname</td><td>A custom <code class="interfacename">QueryCache</code> interface. The default is the built-in
            <code class="interfacename">StandardQueryCache</code>.</td></tr><tr><td>hibernate.cache.region_prefix</td><td>A string</td><td>A prefix for second-level cache region names.</td></tr><tr><td>hibernate.cache.use_structured_entries</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Forces Hibernate to store data in the second-level cache in a more human-readable format.</td></tr><tr><td>hibernate.cache.use_reference_entries</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Optimizes second-level cache operation to store immutable entities  (aka "reference")  which do
                    not have associations into cache directly, this case, lots of disasseble and deep copy operations
                can be avoid.
                    Default value of this property is <code class="literal">false</code>.
                </td></tr></tbody></table>
    </div></div><br class="table-break"/>
    <div class="table"><a id="d5e5181"/><p class="title"><strong>Table A.3. Transactions properties</strong></p><div class="table-contents">
      
      <table summary="Transactions properties" border="1"><colgroup><col width="100px"/><col width="100px"/><col width="240px"/></colgroup><thead><tr><th>Property</th><th>Example</th><th>Purpose</th></tr></thead><tbody><tr><td>hibernate.transaction.factory_class</td><td>A fully-qualified classname</td><td>The classname of a <code class="classname">TransactionFactory</code> to use with Hibernate Transaction API. The
            default is <code class="classname">JDBCTransactionFactory</code>).</td></tr><tr><td>jta.UserTransaction</td><td>A JNDI name</td><td><p>The <code class="classname">JTATransactionFactory</code> needs a JNDI name to obtain the JTA
            UserTransaction from the application server.</p></td></tr><tr><td>hibernate.transaction.manager_lookup_class</td><td>A fully-qualified classname</td><td><p>The classname of a <code class="classname">TransactionManagerLookup</code>, which is used in
            conjunction with JVM-level or the hilo generator in a JTA environment.</p></td></tr><tr><td>hibernate.transaction.flush_before_completion</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Causes the session be flushed during the <span>before completion</span> phase of the
            transaction. If possible, use built-in and automatic session context management instead.</td></tr><tr><td>hibernate.transaction.auto_close_session</td><td><p><code class="literal">true</code> or <code class="literal">false</code></p></td><td>Causes the session to be closed during the <span>after completion</span> phase of the
            transaction. If possible, use built-in and automatic session context management instead.</td></tr></tbody></table>
    </div></div><br class="table-break"/>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        Each of the properties in the following table are prefixed by <code class="literal">hibernate.</code>. It has been removed
        in the table to conserve space.
      </p>
    </div>
    <div class="table"><a id="d5e5230"/><p class="title"><strong>Table A.4. Miscellaneous properties</strong></p><div class="table-contents">
      
      <table summary="Miscellaneous properties" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Property</th><th>Example</th><th>Purpose</th></tr></thead><tbody><tr><td>current_session_context_class</td><td><p>One of <code class="literal">jta</code>, <code class="literal">thread</code>, <code class="literal">managed</code>, or
            <code class="literal">custom.Class</code></p></td><td><p>Supply a custom strategy for the scoping of the <code class="classname">Current</code>
            Session.</p></td></tr><tr><td>factory_class</td><td><p><code class="literal">org.hibernate.hql.internal.ast.ASTQueryTranslatorFactory</code> or
            <code class="literal">org.hibernate.hql.internal.classic.ClassicQueryTranslatorFactory</code></p></td><td>Chooses the HQL parser implementation.</td></tr><tr><td>query.substitutions</td><td><p><code class="literal">hqlLiteral=SQL_LITERAL</code> or <code class="literal">hqlFunction=SQLFUNC</code>
            </p></td><td>Map from tokens in Hibernate queries to SQL tokens, such as function or literal names.</td></tr><tr><td>hbm2ddl.auto</td><td><p><code class="literal">validate</code>, <code class="literal">update</code>, <code class="literal">create</code>,
            <code class="literal">create-drop</code></p></td><td>Validates or exports schema DDL to the database when the <code class="classname">SessionFactory</code> is
            created. With <span class="command"><strong>create-drop</strong></span>, the database schema is dropped when the
            <code class="classname">SessionFactory</code> is closed explicitly.</td></tr></tbody></table>
    </div></div><br class="table-break"/>
  </div>
  <div class="section" title="A.3. Connection pool properties"><div class="titlepage"><div><div><h2 class="title"><a id="d5e5276"/>A.3. Connection pool properties</h2></div></div></div>
    
    <div class="itemizedlist" title="c3p0 connection pool properties"><p class="title"><strong>c3p0 connection pool properties</strong></p><ul class="itemizedlist"><li class="listitem"><p>hibernate.c3p0.min_size</p></li><li class="listitem"><p>hibernate.c3p0.max_size</p></li><li class="listitem"><p>hibernate.c3p0.timeout</p></li><li class="listitem"><p>hibernate.c3p0.max_statements</p></li></ul></div>
    <div class="table"><a id="d5e5288"/><p class="title"><strong>Table A.5. Proxool connection pool properties</strong></p><div class="table-contents">
      
      <table summary="Proxool connection pool properties" border="1"><colgroup><col width="100px"/><col width="340px"/></colgroup><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td>hibernate.proxool.xml</td><td>Configure Proxool provider using an XML file (.xml is appended automatically)</td></tr><tr><td>hibernate.proxool.properties</td><td>Configure the Proxool provider using a properties file (.properties is appended
            automatically)</td></tr><tr><td>hibernate.proxool.existing_pool</td><td>Whether to configure the Proxool provider from an existing pool</td></tr><tr><td>hibernate.proxool.pool_alias</td><td>Proxool pool alias to use. Required.</td></tr></tbody></table>
    </div></div><br class="table-break"/>
    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
      <p>
        For information on specific configuration of Proxool, refer to the Proxool documentation available from
          <a class="ulink" href="http://proxool.sourceforge.net/">http://proxool.sourceforge.net/</a>.
      </p>
    </div>
  </div>
</div>
    <div class="appendix" title="Appendix B. Legacy Hibernate Criteria Queries"><div class="titlepage"><div><div><h2 class="title"><a id="d5e5313"/>Appendix B. Legacy Hibernate Criteria Queries</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#querycriteria-creating">B.1. Creating a <code class="literal">Criteria</code> instance</a></span></dt><dt><span class="section"><a href="#querycriteria-narrowing">B.2. Narrowing the result set</a></span></dt><dt><span class="section"><a href="#querycriteria-ordering">B.3. Ordering the results</a></span></dt><dt><span class="section"><a href="#querycriteria-associations">B.4. Associations</a></span></dt><dt><span class="section"><a href="#querycriteria-dynamicfetching">B.5. Dynamic association fetching</a></span></dt><dt><span class="section"><a href="#querycriteria-components">B.6. Components</a></span></dt><dt><span class="section"><a href="#querycriteria-collections">B.7. Collections</a></span></dt><dt><span class="section"><a href="#querycriteria-examples">B.8. Example queries</a></span></dt><dt><span class="section"><a href="#querycriteria-projection">B.9. Projections, aggregation and grouping</a></span></dt><dt><span class="section"><a href="#querycriteria-detachedqueries">B.10. Detached queries and subqueries</a></span></dt><dt><span class="section"><a href="#query-criteria-naturalid">B.11. Queries by natural identifier</a></span></dt></dl></div>
    

    <div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2>
        <p>
            This appendix covers the legacy Hibernate <code class="interfacename">org.hibernate.Criteria</code> API, which
            should be considered deprecated.  New development should focus on the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code> API.  Eventually,
            Hibernate-specific criteria features will be ported as extensions to the JPA
            <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>.  For details on the JPA APIs, see
            <a class="xref" href="#">???</a>.
        </p>
        <p>
            This information is copied as-is from the older Hibernate documentation.
        </p>
    </div>

    <p>
        Hibernate features an intuitive, extensible criteria query API.
    </p>
    
    <div class="section" title="B.1. Creating a Criteria instance"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-creating"/>B.1. Creating a <code class="literal">Criteria</code> instance</h2></div></div></div>
        

        <p>
            The interface <code class="literal">org.hibernate.Criteria</code> represents a query against
            a particular persistent class. The <code class="literal">Session</code> is a factory for
            <code class="literal">Criteria</code> instances.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Criteria crit = sess.createCriteria(Cat.class);
crit.setMaxResults(50);
List cats = crit.list();</pre>

    </div>
     
    <div class="section" title="B.2. Narrowing the result set"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-narrowing"/>B.2. Narrowing the result set</h2></div></div></div>
        

        <p>
            An individual query criterion is an instance of the interface
            <code class="literal">org.hibernate.criterion.Criterion</code>. The class
            <code class="literal">org.hibernate.criterion.Restrictions</code> defines
            factory methods for obtaining certain built-in
            <code class="literal">Criterion</code> types.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .add( Restrictions.between("weight", minWeight, maxWeight) )
    .list();</pre>
    
        <p>
            Restrictions can be grouped logically.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .add( Restrictions.or(
        Restrictions.eq( "age", new Integer(0) ),
        Restrictions.isNull("age")
    ) )
    .list();</pre>
    
       <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.in( "name", new String[] { "Fritz", "Izi", "Pk" } ) )
    .add( Restrictions.disjunction()
        .add( Restrictions.isNull("age") )
        .add( Restrictions.eq("age", new Integer(0) ) )
        .add( Restrictions.eq("age", new Integer(1) ) )
        .add( Restrictions.eq("age", new Integer(2) ) )
    ) )
    .list();</pre>
    
        <p>
            There are a range of built-in criterion types (<code class="literal">Restrictions</code>
            subclasses). One of the most useful allows you to specify SQL directly.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.sqlRestriction("lower({alias}.name) like lower(?)", "Fritz%", Hibernate.STRING) )
    .list();</pre>
    
        <p>
            The <code class="literal">{alias}</code> placeholder will be replaced by the row alias
            of the queried entity.
        </p>
        
        <p>
            You can also obtain a criterion from a 
            <code class="literal">Property</code> instance. You can create a <code class="literal">Property</code>
            by calling <code class="literal">Property.forName()</code>:
        </p>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
Property age = Property.forName("age");
List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.disjunction()
        .add( age.isNull() )
        .add( age.eq( new Integer(0) ) )
        .add( age.eq( new Integer(1) ) )
        .add( age.eq( new Integer(2) ) )
    ) )
    .add( Property.forName("name").in( new String[] { "Fritz", "Izi", "Pk" } ) )
    .list();</pre>
    
   </div>
     
    <div class="section" title="B.3. Ordering the results"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-ordering"/>B.3. Ordering the results</h2></div></div></div>
        

        <p>
            You can order the results using <code class="literal">org.hibernate.criterion.Order</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "F%")
    .addOrder( Order.asc("name").nulls(NullPrecedence.LAST) )
    .addOrder( Order.desc("age") )
    .setMaxResults(50)
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Property.forName("name").like("F%") )
    .addOrder( Property.forName("name").asc() )
    .addOrder( Property.forName("age").desc() )
    .setMaxResults(50)
    .list();</pre>
    
    </div>
    
    <div class="section" title="B.4. Associations"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-associations"/>B.4. Associations</h2></div></div></div>
        

        <p>
            By navigating
            associations using <code class="literal">createCriteria()</code> you can specify constraints upon related entities:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "F%") )
    .createCriteria("kittens")
        .add( Restrictions.like("name", "F%") )
    .list();</pre>

        <p>
            The second <code class="literal">createCriteria()</code> returns a new
            instance of <code class="literal">Criteria</code> that refers to the elements of
            the <code class="literal">kittens</code> collection.
        </p>

        <p>
            There is also an alternate form that is useful in certain circumstances:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .createAlias("kittens", "kt")
    .createAlias("mate", "mt")
    .add( Restrictions.eqProperty("kt.name", "mt.name") )
    .list();</pre>

        <p>
            (<code class="literal">createAlias()</code> does not create a new instance of
            <code class="literal">Criteria</code>.)
        </p>

        <p>
            The kittens collections held by the <code class="literal">Cat</code> instances
            returned by the previous two queries are <span class="emphasis"><em>not</em></span> pre-filtered
            by the criteria. If you want to retrieve just the kittens that match the
            criteria, you must use a <code class="literal">ResultTransformer</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .createCriteria("kittens", "kt")
        .add( Restrictions.eq("name", "F%") )
    .setResultTransformer(Criteria.ALIAS_TO_ENTITY_MAP)
    .list();
Iterator iter = cats.iterator();
while ( iter.hasNext() ) {
    Map map = (Map) iter.next();
    Cat cat = (Cat) map.get(Criteria.ROOT_ALIAS);
    Cat kitten = (Cat) map.get("kt");
}</pre>

	<p>
		Additionally you may manipulate the result set using a left outer join:
	</p>
	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
		List cats = session.createCriteria( Cat.class )
                       .createAlias("mate", "mt", Criteria.LEFT_JOIN, Restrictions.like("mt.name", "good%") )
                       .addOrder(Order.asc("mt.age"))
                       .list();
	
	</pre>

	<p>
		This will return all of the <code class="literal">Cat</code>s with a mate whose name starts with "good"
		ordered by their mate's age, and all cats who do not have a mate.  
		 This is useful when there is a need to order or limit in the database
		 prior to returning complex/large result sets, and removes many instances where
		 multiple queries would have to be performed and the results unioned 
		 by java in memory.  
	</p>
	<p>
		Without this feature, first all of the cats without a mate would need to be loaded in one query. 
	</p>
	<p>
		A second query would need to retreive the cats with mates who's name started with "good" sorted by the mates age.
	</p>
	<p>
		Thirdly, in memory; the lists would need to be joined manually.
	</p>
    </div>
    
    <div class="section" title="B.5. Dynamic association fetching"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-dynamicfetching"/>B.5. Dynamic association fetching</h2></div></div></div>
        

        <p>
            You can specify association fetching semantics at runtime using
            <code class="literal">setFetchMode()</code>.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like("name", "Fritz%") )
    .setFetchMode("mate", FetchMode.EAGER)
    .setFetchMode("kittens", FetchMode.EAGER)
    .list();</pre>
    
        <p>
            This query will fetch both <code class="literal">mate</code> and <code class="literal">kittens</code>
            by outer join. See <a class="xref" href="#">???</a> for more information.
        </p>
    
    </div>

    <div class="section" title="B.6. Components"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-components"/>B.6. Components</h2></div></div></div>
        

        <p>
               To add a restriction against a property of an embedded component, the component property
               name should be prepended to the property name when creating the <code class="literal">Restriction</code>.
               The criteria object should be created on the owning entity, and cannot be created on the component 
               itself.  For example, suppose the <code class="literal">Cat</code> has a component property <code class="literal">fullName</code>
               with sub-properties <code class="literal">firstName</code> and <code class="literal">lastName</code>:
	</p>

	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
		List cats = session.createCriteria(Cat.class)
			.add(Restrictions.eq("fullName.lastName", "Cattington"))
			.list();
	</pre>
	
	<p>
		Note: this does not apply when querying collections of components, for that see below 
		<a class="xref" href="#querycriteria-collections" title="B.7. Collections">Section B.7, “Collections”</a>
	</p>

    </div>

    <div class="section" title="B.7. Collections"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-collections"/>B.7. Collections</h2></div></div></div>
	
	<p>
		When using criteria against collections, there are two distinct cases.  One is if
		the collection contains entities (eg. <code class="literal">&lt;one-to-many/&gt;</code> 
		or <code class="literal">&lt;many-to-many/&gt;</code>) or components 
		(<code class="literal">&lt;composite-element/&gt;</code> ),
		and the second is if the collection contains scalar values 
		(<code class="literal">&lt;element/&gt;</code>).
		In the first case, the syntax is as given above in the section 
		<a class="xref" href="#querycriteria-associations" title="B.4. Associations">Section B.4, “Associations”</a> where we restrict the <code class="literal">kittens</code>
		collection. Essentially we create a <code class="literal">Criteria</code> object against the collection
		property and restrict the entity or component properties using that instance.
	</p>
	<p>
		For queryng a collection of basic values, we still create the <code class="literal">Criteria</code>
		object against the collection, but to reference the value, we use the special property 
		"elements".  For an indexed collection, we can also reference the index property using
		the special property "indices".
	</p>
	<pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">
		List cats = session.createCriteria(Cat.class)
			.createCriteria("nickNames")
				.add(Restrictions.eq("elements", "BadBoy"))
			.list();
	</pre>
    </div>

    <div class="section" title="B.8. Example queries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-examples"/>B.8. Example queries</h2></div></div></div>
        

        <p>
            The class <code class="literal">org.hibernate.criterion.Example</code> allows
            you to construct a query criterion from a given instance.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Cat cat = new Cat();
cat.setSex('F');
cat.setColor(Color.BLACK);
List results = session.createCriteria(Cat.class)
    .add( Example.create(cat) )
    .list();</pre>
    
        <p>
           Version properties, identifiers and associations are ignored. By default,
           null valued properties are excluded.
        </p>

        <p>
           You can adjust how the <code class="literal">Example</code> is applied.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">Example example = Example.create(cat)
    .excludeZeroes()           //exclude zero valued properties
    .excludeProperty("color")  //exclude the property named "color"
    .ignoreCase()              //perform case insensitive string comparisons
    .enableLike();             //use like for string comparisons
List results = session.createCriteria(Cat.class)
    .add(example)
    .list();</pre>
    
        <p>
            You can even use examples to place criteria upon associated objects.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .add( Example.create(cat) )
    .createCriteria("mate")
        .add( Example.create( cat.getMate() ) )
    .list();</pre>
    
    </div>
    
    <div class="section" title="B.9. Projections, aggregation and grouping"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-projection"/>B.9. Projections, aggregation and grouping</h2></div></div></div>
        
        <p>
            The class <code class="literal">org.hibernate.criterion.Projections</code> is a
            factory for <code class="literal">Projection</code> instances. You can apply a
            projection to a query by calling <code class="literal">setProjection()</code>.
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.rowCount() )
    .add( Restrictions.eq("color", Color.BLACK) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount() )
        .add( Projections.avg("weight") )
        .add( Projections.max("weight") )
        .add( Projections.groupProperty("color") )
    )
    .list();</pre>
    
        <p>
            There is no explicit "group by" necessary in a criteria query. Certain
            projection types are defined to be <span class="emphasis"><em>grouping projections</em></span>,
            which also appear in the SQL <code class="literal">group by</code> clause.
        </p>
    
        <p>
            An alias can be assigned to a projection so that the projected value
            can be referred to in restrictions or orderings. Here are two different ways to
            do this:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.alias( Projections.groupProperty("color"), "colr" ) )
    .addOrder( Order.asc("colr") )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.groupProperty("color").as("colr") )
    .addOrder( Order.asc("colr") )
    .list();</pre>
    
        <p>
            The <code class="literal">alias()</code> and <code class="literal">as()</code> methods simply wrap a
            projection instance in another, aliased, instance of <code class="literal">Projection</code>.
            As a shortcut, you can assign an alias when you add the projection to a 
            projection list:
        </p>

       <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount(), "catCountByColor" )
        .add( Projections.avg("weight"), "avgWeight" )
        .add( Projections.max("weight"), "maxWeight" )
        .add( Projections.groupProperty("color"), "color" )
    )
    .addOrder( Order.desc("catCountByColor") )
    .addOrder( Order.desc("avgWeight") )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Domestic.class, "cat")
    .createAlias("kittens", "kit")
    .setProjection( Projections.projectionList()
        .add( Projections.property("cat.name"), "catName" )
        .add( Projections.property("kit.name"), "kitName" )
    )
    .addOrder( Order.asc("catName") )
    .addOrder( Order.asc("kitName") )
    .list();</pre>
    
        <p>
            You can also use <code class="literal">Property.forName()</code> to express projections:
        </p>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Property.forName("name") )
    .add( Property.forName("color").eq(Color.BLACK) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">List results = session.createCriteria(Cat.class)
    .setProjection( Projections.projectionList()
        .add( Projections.rowCount().as("catCountByColor") )
        .add( Property.forName("weight").avg().as("avgWeight") )
        .add( Property.forName("weight").max().as("maxWeight") )
        .add( Property.forName("color").group().as("color" )
    )
    .addOrder( Order.desc("catCountByColor") )
    .addOrder( Order.desc("avgWeight") )
    .list();</pre>
    
    </div>
    
    <div class="section" title="B.10. Detached queries and subqueries"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-detachedqueries"/>B.10. Detached queries and subqueries</h2></div></div></div>
        
        <p>
            The <code class="literal">DetachedCriteria</code> class allows you to create a query outside the scope 
            of a session and then execute it using an arbitrary <code class="literal">Session</code>.
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria query = DetachedCriteria.forClass(Cat.class)
    .add( Property.forName("sex").eq('F') );
    
Session session = ....;
Transaction txn = session.beginTransaction();
List results = query.getExecutableCriteria(session).setMaxResults(100).list();
txn.commit();
session.close();</pre>

        <p>
            A <code class="literal">DetachedCriteria</code> can also be used to express a subquery. Criterion
            instances involving subqueries can be obtained via <code class="literal">Subqueries</code> or
            <code class="literal">Property</code>.            
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria avgWeight = DetachedCriteria.forClass(Cat.class)
    .setProjection( Property.forName("weight").avg() );
session.createCriteria(Cat.class)
    .add( Property.forName("weight").gt(avgWeight) )
    .list();</pre>
    
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria weights = DetachedCriteria.forClass(Cat.class)
    .setProjection( Property.forName("weight") );
session.createCriteria(Cat.class)
    .add( Subqueries.geAll("weight", weights) )
    .list();</pre>
    
        <p>
            Correlated subqueries are also possible:
        </p>
        
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria avgWeightForSex = DetachedCriteria.forClass(Cat.class, "cat2")
    .setProjection( Property.forName("weight").avg() )
    .add( Property.forName("cat2.sex").eqProperty("cat.sex") );
session.createCriteria(Cat.class, "cat")
    .add( Property.forName("weight").gt(avgWeightForSex) )
    .list();</pre>

        <p>
            Example of multi-column restriction based on a subquery:
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">DetachedCriteria sizeQuery = DetachedCriteria.forClass( Man.class )
    .setProjection( Projections.projectionList().add( Projections.property( "weight" ) )
                                                .add( Projections.property( "height" ) ) )
    .add( Restrictions.eq( "name", "John" ) );
session.createCriteria( Woman.class )
    .add( Subqueries.propertiesEq( new String[] { "weight", "height" }, sizeQuery ) )
    .list();</pre>

    </div>

        
               
    <div class="section" title="B.11. Queries by natural identifier"><div class="titlepage"><div><div><h2 class="title"><a id="query-criteria-naturalid"/>B.11. Queries by natural identifier</h2></div></div></div>
        
        
        <p>
            For most queries, including criteria queries, the query cache is not efficient
            because query cache invalidation occurs too frequently. However, there is a special
            kind of query where you can optimize the cache invalidation algorithm: lookups by a 
            constant natural key. In some applications, this kind of query occurs frequently.
            The criteria API provides special provision for this use case.
        </p>
        
        <p>
            First, map the natural key of your entity using 
            <code class="literal">&lt;natural-id&gt;</code> and enable use of the second-level cache.
        </p>

        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">&lt;class name="User"&gt;
    &lt;cache usage="read-write"/&gt;
    &lt;id name="id"&gt;
        &lt;generator class="increment"/&gt;
    &lt;/id&gt;
    &lt;natural-id&gt;
        &lt;property name="name"/&gt;
        &lt;property name="org"/&gt;
    &lt;/natural-id&gt;
    &lt;property name="password"/&gt;
&lt;/class&gt;</pre>
    
        <p>
            This functionality is not intended for use with entities with 
            <span class="emphasis"><em>mutable</em></span> natural keys.
        </p>
        
        <p>
            Once you have enabled the Hibernate query cache, 
            the <code class="literal">Restrictions.naturalId()</code> allows you to make use of
            the more efficient cache algorithm.
        </p>
       
        <pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="">session.createCriteria(User.class)
    .add( Restrictions.naturalId()
        .set("name", "gavin")
        .set("org", "hb") 
    ).setCacheable(true)
    .uniqueResult();</pre>
            
    </div>
    
</div>
</div><hr xmlns="" xmlns:d="http://docbook.org/ns/docbook"/><a xmlns="" xmlns:d="http://docbook.org/ns/docbook" href="legalnotice.html"/></body></html>