<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 5. Querying</title><link rel="stylesheet" href="css/hibernate.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.72.0"/><link rel="start" href="index.html" title="Hibernate Search"/><link rel="up" href="index.html" title="Hibernate Search"/><link rel="prev" href="search-mapping.html" title="Chapter 4. Mapping entities to the index structure"/><link rel="next" href="manual-index-changes.html" title="Chapter 6. Manual index changes"/></head><body><p id="title"><a href="http://www.hibernate.org" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="search-mapping.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="manual-index-changes.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="search-query"/>Chapter 5. Querying</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="search-query.html#section-building-lucene-queries">5.1. Building queries</a></span></dt><dd><dl><dt><span class="section"><a href="search-query.html#search-query-lucene-api">5.1.1. Building a Lucene query using the Lucene API</a></span></dt><dt><span class="section"><a href="search-query.html#search-query-querydsl">5.1.2. Building a Lucene query with the Hibernate Search query
      DSL</a></span></dt><dt><span class="section"><a href="search-query.html#d0e5677">5.1.3. Building a Hibernate Search query</a></span></dt></dl></dd><dt><span class="section"><a href="search-query.html#d0e6119">5.2. Retrieving the results</a></span></dt><dd><dl><dt><span class="section"><a href="search-query.html#d0e6136">5.2.1. Performance considerations</a></span></dt><dt><span class="section"><a href="search-query.html#d0e6182">5.2.2. Result size</a></span></dt><dt><span class="section"><a href="search-query.html#d0e6213">5.2.3. ResultTransformer</a></span></dt><dt><span class="section"><a href="search-query.html#d0e6239">5.2.4. Understanding results</a></span></dt></dl></dd><dt><span class="section"><a href="search-query.html#query-filter">5.3. Filters</a></span></dt><dd><dl><dt><span class="section"><a href="search-query.html#query-filter-shard">5.3.1. Using filters in a sharded environment</a></span></dt></dl></dd><dt><span class="section"><a href="search-query.html#query-faceting">5.4. Faceting</a></span></dt><dd><dl><dt><span class="section"><a href="search-query.html#section-creating-faceting-request">5.4.1. Creating a faceting request</a></span></dt><dt><span class="section"><a href="search-query.html#section-sorting-faceting-request">5.4.2. Setting the facet sort order</a></span></dt><dt><span class="section"><a href="search-query.html#section-applying-faceting-request">5.4.3. Applying a faceting request</a></span></dt><dt><span class="section"><a href="search-query.html#section-interpreting-facet-result">5.4.4. Interpreting a <code class="classname">Facet</code> result</a></span></dt><dt><span class="section"><a href="search-query.html#d0e6894">5.4.5. Restricting query results</a></span></dt></dl></dd><dt><span class="section"><a href="search-query.html#d0e6932">5.5. Optimizing the query process</a></span></dt><dd><dl><dt><span class="section"><a href="search-query.html#query-fieldcaches">5.5.1. Caching index values: FieldCache</a></span></dt></dl></dd></dl></div><p>The second most important capability of Hibernate Search is the
  ability to execute Lucene queries and retrieve entities managed by a
  Hibernate session. The search provides the power of Lucene without leaving
  the Hibernate paradigm, giving another dimension to the Hibernate classic
  search mechanisms (HQL, Criteria query, native SQL query).</p><p>Preparing and executing a query consists of four simple steps:</p><div class="itemizedlist"><ul><li><p>Creating a <code class="classname">FullTextSession</code></p></li><li><p>Creating a Lucene query either via the Hibernate Search query DSL
      (recommended) or by utilizing the Lucene query API</p></li><li><p>Wrapping the Lucene query using an
      <code class="classname">org.hibernate.Query</code></p></li><li><p>Executing the search by calling for example
      <code class="methodname">list()</code> or
      <code class="methodname">scroll()</code></p></li></ul></div><p>To access the querying facilities, you have to use a
  <code class="classname">FullTextSession</code>. This Search specific session wraps a
  regular <code class="classname">org.hibernate.Session</code> in order to provide
  query and indexing capabilities.</p><div class="example"><a id="d0e5324"/><p class="title"><b>Example 5.1. Creating a FullTextSession</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sessionFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">openSession</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_type">FullTextSession</span><span class="java_plain">&nbsp;fullTextSession&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Search</span><span class="java_separator">.</span><span class="java_plain">getFullTextSession</span><span class="java_separator">(</span><span class="java_plain">session</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><p>Once you have a <code class="classname">FullTextSession</code> you have two
  options to build the full-text query: the Hibernate Search query DSL or the
  native Lucene query.</p><p>If you use the Hibernate Search query DSL, it will look like
  this:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;b&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextSession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getSearchFactory</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildQueryBuilder</span><span class="java_separator">().</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_type">Myth</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">).</span><span class="java_plain">get</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">apache</span><span class="java_separator">.</span><span class="java_plain">lucene</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;b</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">).</span><span class="java_plain">boostedTo</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;storm&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;a&nbsp;list&nbsp;of&nbsp;managed&nbsp;objects</span>
</pre><p>You can alternatively write your Lucene query either using the Lucene
  query parser or Lucene programmatic API.</p><div class="example"><a id="d0e5340"/><p class="title"><b>Example 5.2. Creating a Lucene query via the
    <code class="classname">QueryParser</code></b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_type">SearchFactory</span><span class="java_plain">&nbsp;searchFactory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">getSearchFactory</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">apache</span><span class="java_separator">.</span><span class="java_plain">lucene</span><span class="java_separator">.</span><span class="java_plain">queryParser</span><span class="java_separator">.</span><span class="java_type">QueryParser</span><span class="java_plain">&nbsp;parser&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">QueryParser</span><span class="java_separator">(</span><span class="java_literal">&quot;title&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;searchFactory</span><span class="java_separator">.</span><span class="java_plain">getAnalyzer</span><span class="java_separator">(</span><span class="java_type">Myth</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">));</span>
<!--  --><br/><span class="java_keyword">try</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">apache</span><span class="java_separator">.</span><span class="java_plain">lucene</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;parser</span><span class="java_separator">.</span><span class="java_plain">parse</span><span class="java_separator">(</span><span class="java_literal">&quot;history:storm^3&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">ParseException</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">handle&nbsp;parsing&nbsp;failure</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;a&nbsp;list&nbsp;of&nbsp;managed&nbsp;objects&nbsp;&nbsp;&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The Hibernate query built on top of the Lucene query is a regular
    <code class="literal">org.hibernate.Query</code>, which means you are in the same
    paradigm as the other Hibernate query facilities (HQL, Native or
    Criteria). The regular <code class="literal">list()</code> ,
    <code class="literal">uniqueResult()</code>, <code class="literal">iterate()</code> and
    <code class="literal">scroll()</code> methods can be used.</p></div><p>In case you are using the Java Persistence APIs of Hibernate, the same
  extensions exist:</p><div class="example"><a id="d0e5367"/><p class="title"><b>Example 5.3. Creating a Search query using the JPA API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">EntityManager</span><!-- <br/> --><span class="java_plain">&nbsp;em&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManagerFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEntityManager</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">FullTextEntityManager</span><span class="java_plain">&nbsp;fullTextEntityManager&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_plain">jpa</span><span class="java_separator">.</span><span class="java_type">Search</span><span class="java_separator">.</span><span class="java_plain">getFullTextEntityManager</span><span class="java_separator">(</span><span class="java_plain">em</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_type">QueryBuilder</span><span class="java_plain">&nbsp;b&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextEntityManager</span><span class="java_separator">.</span><span class="java_plain">getSearchFactory</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildQueryBuilder</span><span class="java_separator">().</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Myth</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">).</span><span class="java_plain">get</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">apache</span><span class="java_separator">.</span><span class="java_plain">lucene</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;b</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">).</span><span class="java_plain">boostedTo</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;storm&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
javax.persistence.Query fullTextQuery = 
    fullTextEntityManager.createFullTextQuery( luceneQuery );</span>
</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;a&nbsp;list&nbsp;of&nbsp;managed&nbsp;objects&nbsp;&nbsp;</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The following examples we will use the Hibernate APIs but the same
    example can be easily rewritten with the Java Persistence API by just
    adjusting the way the <code class="classname">FullTextQuery</code> is
    retrieved.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="section-building-lucene-queries"/>5.1. Building queries</h2></div></div></div><p>Hibernate Search queries are built on top of Lucene queries which
    gives you total freedom on the type of Lucene query you want to execute.
    However, once built, Hibernate Search wraps further query processing using
    <code class="classname">org.hibernate.Query</code> as your primary query
    manipulation API.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="search-query-lucene-api"/>5.1.1. Building a Lucene query using the Lucene API</h3></div></div></div><p>Using the Lucene API, you have several options. You can use the
      query parser (fine for simple queries) or the Lucene programmatic API
      (for more complex use cases). It is out of the scope of this
      documentation on how to exactly build a Lucene query. Please refer to
      the online Lucene documentation or get hold of a copy of Lucene In
      Action or Hibernate Search in Action.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="search-query-querydsl"/>5.1.2. Building a Lucene query with the Hibernate Search query
      DSL</h3></div></div></div><p>Writing full-text queries with the Lucene programmatic API is
      quite complex. It's even more complex to understand the code once
      written. Besides the inherent API complexity, you have to remember to
      convert your parameters to their string equivalent as well as make sure
      to apply the correct analyzer to the right field (a ngram analyzer will
      for example use several ngrams as the tokens for a given word and should
      be searched as such).</p><p>The Hibernate Search query DSL makes use of a style of API called
      a fluent API. This API has a few key characteristics:</p><div class="itemizedlist"><ul><li><p>it has meaningful method names making a succession of
          operations reads almost like English</p></li><li><p>it limits the options offered to what makes sense in a given
          context (thanks to strong typing and IDE autocompletion).</p></li><li><p>It often uses the chaining method pattern</p></li><li><p>it's easy to use and even easier to read</p></li></ul></div><p>Let's see how to use the API. You first need to create a query
      builder that is attached to a given indexed entity type. This
      <code class="classname">QueryBuilder</code> will know what analyzer to use and
      what field bridge to apply. You can create several
      <code class="classname">QueryBuilder</code>s (one for each entity type involved
      in the root of your query). You get the
      <code class="classname">QueryBuilder</code> from the
      <code class="classname">SearchFactory</code>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;searchFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">buildQueryBuilder</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">forEntity</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Myth</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">get</span><!-- <br/> --><span class="java_separator">();</span></pre><p>You can also override the analyzer used for a given field or
      fields. This is rarely needed and should be avoided unless you know what
      you are doing.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;searchFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">buildQueryBuilder</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Myth</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">overridesForField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">,</span><span class="java_literal">&quot;stem_analyzer_definition&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">();</span></pre><p>Using the query builder, you can then build queries. It is
      important to realize that the end result of a
      <code class="classname">QueryBuilder</code> is a Lucene query. For this reason
      you can easily mix and match queries generated via Lucene's query parser
      or <code class="classname">Query</code> objects you have assembled with the
      Lucene programmatic API and use them with the Hibernate Search DSL. Just
      in case the DSL is missing some features.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5442"/>5.1.2.1. Keyword queries</h4></div></div></div><p>Let's start with the most basic use case - searching for a
        specific word:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">keyword</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">onField</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;history&quot;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">matching</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;storm&quot;</span><!-- <br/> --><span class="java_separator">).</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">();</span></pre><p><code class="methodname">keyword()</code> means that you are trying to
        find a specific word. <code class="methodname">onField()</code> specifies in
        which Lucene field to look. <code class="methodname">matching()</code> tells
        what to look for. And finally <code class="methodname">createQuery()</code>
        creates the Lucene query object. A lot is going on with this line of
        code.</p><div class="itemizedlist"><ul><li><p>The value storm is passed through the
            <code class="literal">history</code> <code class="classname">FieldBridge</code>: it
            does not matter here but you will see that it's quite handy when
            dealing with numbers or dates.</p></li><li><p>The field bridge value is then passed to the analyzer used
            to index the field <code class="literal">history</code>. This ensures that
            the query uses the same term transformation than the indexing
            (lower case, n-gram, stemming and so on). If the analyzing process
            generates several terms for a given word, a boolean query is used
            with the <code class="literal">SHOULD</code> logic (roughly an
            <code class="literal">OR</code> logic).</p></li></ul></div><p>Let's see how you can search a property that is not of type
        string.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Indexed</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Myth</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">DateBridge</span><span class="java_separator">(</span><span class="java_plain">resolution&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Resolution</span><span class="java_separator">.</span><span class="java_plain">YEAR</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;getCreationDate</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;creationDate</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;setCreationDate</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_plain">&nbsp;creationDate</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">creationDate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;creationDate</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;creationDate</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_type">Date</span><span class="java_plain">&nbsp;birthdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQb</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;creationDate&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_plain">birthdate</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>In plain Lucene, you would have had to convert the
          <code class="classname">Date</code> object to its string representation (in
          this case the year).</p></div><p>This conversion works for any object, not just
        <code class="classname">Date</code>, provided that the
        <code class="classname">FieldBridge</code> has an
        <code class="methodname">objectToString</code> method (and all built-in
        <code class="classname">FieldBridge</code> implementations do).</p><p>We make the example a little more advanced now and have a look
        at how to search a field that uses ngram analyzers. ngram analyzers
        index succession of ngrams of your words which helps to recover from
        user typos. For example the 3-grams of the word hibernate are hib,
        ibe, ber, rna, nat, ate.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">AnalyzerDef</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;ngram&quot;</span><!-- <br/> --><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;tokenizer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;@</span><span class="java_type">TokenizerDef</span><span class="java_separator">(</span><span class="java_plain">factory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">StandardTokenizerFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;filters&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">TokenFilterDef</span><span class="java_separator">(</span><span class="java_plain">factory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">StandardFilterFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">TokenFilterDef</span><span class="java_separator">(</span><span class="java_plain">factory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">LowerCaseFilterFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">TokenFilterDef</span><span class="java_separator">(</span><span class="java_plain">factory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">StopFilterFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">TokenFilterDef</span><span class="java_separator">(</span><span class="java_plain">factory&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">NGramFilterFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Parameter</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;minGramSize&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;value&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;3&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Parameter</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;maxGramSize&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;value&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;3&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Entity</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Indexed</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Myth</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyzer</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">Analyzer</span><span class="java_separator">(</span><span class="java_plain">definition</span><span class="java_operator">=</span><span class="java_literal">&quot;ngram&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;@</span><span class="java_type">DateBridge</span><span class="java_separator">(</span><span class="java_plain">resolution&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Resolution</span><span class="java_separator">.</span><span class="java_plain">YEAR</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getName</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;setName</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_type">Date</span><span class="java_plain">&nbsp;birthdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQb</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;Sisiphus&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</pre><p>The matching word "Sisiphus" will be lower-cased and then split
        into 3-grams: sis, isi, sip, phu, hus. Each of these n-gram will be
        part of the query. We will then be able to find the Sysiphus myth
        (with a <code class="literal">y</code>). All that is transparently done for
        you.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>If for some reason you do not want a specific field to use the
          field bridge or the analyzer you can call the
          <code class="methodname">ignoreAnalyzer()</code> or
          <code class="methodname">ignoreFieldBridge()</code> functions</p></div><p>To search for multiple possible words in the same field, simply
        add them all in the matching clause.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">search&nbsp;document&nbsp;with&nbsp;storm&nbsp;or&nbsp;lightning&nbsp;in&nbsp;their&nbsp;history</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;storm&nbsp;lightning&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><p>To search the same word on multiple fields, use the
        <code class="methodname">onFields</code> method.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onFields</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">,</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">,</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;storm&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><p>Sometimes, one field should be treated differently from another
        field even if searching the same term, you can use the
        <code class="methodname">andField()</code> method for that.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">keyword</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">andField</span><span class="java_separator">(</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">boostedTo</span><span class="java_separator">(</span><span class="java_literal">5</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">andField</span><span class="java_separator">(</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;storm&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><p>In the previous example, only field name is boosted to 5.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5546"/>5.1.2.2. Fuzzy queries</h4></div></div></div><p>To execute a fuzzy query (based on the Levenshtein distance
        algorithm), start like a <code class="literal">keyword</code> query and add the
        fuzzy flag.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">fuzzy</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">withThreshold</span><span class="java_separator">(</span><span class="java_literal">.8f</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">withPrefixLength</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;starm&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><p><code class="literal">threshold</code> is the limit above which two terms
        are considering matching. It's a decimal between 0 and 1 and defaults
        to 0.5. <code class="literal">prefixLength</code> is the length of the prefix
        ignored by the "fuzzyness": while it defaults to 0, a non zero value
        is recommended for indexes containing a huge amount of distinct
        terms.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5563"/>5.1.2.3. Wildcard queries</h4></div></div></div><p>You can also execute wildcard queries (queries where some of
        parts of the word are unknown). <code class="literal">?</code> represents a
        single character and <code class="literal">*</code> represents any character
        sequence. Note that for performance purposes, it is recommended that
        the query does not start with either <code class="literal">?</code> or
        <code class="literal">*</code>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">wildcard</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;sto*&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Wildcard queries do not apply the analyzer on the matching
          terms. Otherwise the risk of <code class="literal">*</code> or
          <code class="literal">?</code> being mangled is too high.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5591"/>5.1.2.4. Phrase queries</h4></div></div></div><p>So far we have been looking for words or sets of words, you can
        also search exact or approximate sentences. Use
        <code class="methodname">phrase()</code> to do so.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">phrase</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">sentence</span><span class="java_separator">(</span><span class="java_literal">&quot;Thou&nbsp;shalt&nbsp;not&nbsp;kill&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre><p>You can search approximate sentences by adding a slop factor.
        The slop factor represents the number of other words permitted in the
        sentence: this works like a within or near operator</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">phrase</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">withSlop</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;history&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">sentence</span><span class="java_separator">(</span><span class="java_literal">&quot;Thou&nbsp;kill&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5605"/>5.1.2.5. Range queries</h4></div></div></div><p>After looking at all these query examples for searching for to a
        given word, it is time to introduce range queries (on numbers, dates,
        strings etc). A range query searches for a value in between given
        boundaries (included or not) or for a value below or above a given
        boundary (included or not).</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">look&nbsp;</span><!-- <br/> --><span class="java_keyword">for</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">0</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;=</span><!-- <br/> --><span class="java_plain">&nbsp;starred&nbsp;</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">3</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;starred&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">).</span><span class="java_plain">to</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">).</span><span class="java_plain">excludeLimit</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">look&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;myths&nbsp;strictly&nbsp;BC</span>
<!--  --><br/><span class="java_type">Date</span><span class="java_plain">&nbsp;beforeChrist&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;creationDate&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">below</span><span class="java_separator">(</span><span class="java_plain">beforeChrist</span><span class="java_separator">).</span><span class="java_plain">excludeLimit</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5612"/>5.1.2.6. Combining queries</h4></div></div></div><p>Finally, you can aggregate (combine) queries to create more
        complex queries. The following aggregation operators are
        available:</p><div class="itemizedlist"><ul><li><p><code class="literal">SHOULD</code>: the query query should contain
            the matching elements of the subquery</p></li><li><p><code class="literal">MUST</code>: the query must contain the matching
            elements of the subquery</p></li><li><p><code class="literal">MUST NOT</code>: the query must not contain the
            matching elements of the subquery</p></li></ul></div><p>The subqueries can be any Lucene query including a boolean query
        itself. Let's look at a few examples:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">look&nbsp;</span><!-- <br/> --><span class="java_keyword">for</span><!-- <br/> --><span class="java_plain">&nbsp;popular&nbsp;modern&nbsp;myths&nbsp;that&nbsp;are&nbsp;not&nbsp;urban</span>
<!--  --><br/><span class="java_type">Date</span><span class="java_plain">&nbsp;twentiethCentury&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">bool</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">must</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;urban&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">not</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">must</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;starred&quot;</span><span class="java_separator">).</span><span class="java_plain">above</span><span class="java_separator">(</span><span class="java_literal">4</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">must</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;creationDate&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">above</span><span class="java_separator">(</span><span class="java_plain">twentiethCentury</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">look&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;popular&nbsp;myths&nbsp;that&nbsp;are&nbsp;preferably&nbsp;urban</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">bool</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">should</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;urban&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">must</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;starred&quot;</span><span class="java_separator">).</span><span class="java_plain">above</span><span class="java_separator">(</span><span class="java_literal">4</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">look&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;all&nbsp;myths&nbsp;except&nbsp;religious&nbsp;ones</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">all</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">except</span><span class="java_separator">(</span><span class="java_plain">&nbsp;monthQb</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;description_stem&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;religion&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span></pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5637"/>5.1.2.7. Query options</h4></div></div></div><p>We already have seen several query options in the previous
        example, but lets summarize again the options for query types and
        fields:</p><div class="itemizedlist"><ul><li><p><code class="methodname">boostedTo</code> (on query type and on
            field): boost the whole query or the specific field to a given
            factor</p></li><li><p><code class="methodname">withConstantScore</code> (on query): all
            results matching the query have a constant score equals to the
            boost</p></li><li><p><code class="methodname">filteredBy(Filter)</code> (on query):
            filter query results using the <code class="classname">Filter</code>
            instance</p></li><li><p><code class="methodname">ignoreAnalyzer</code> (on field): ignore
            the analyzer when processing this field</p></li><li><p><code class="methodname">ignoreFieldBridge</code> (on field):
            ignore field bridge when processing this field</p></li></ul></div><p>Let's check out an example using some of these options</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">bool</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">should</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">().</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;description&quot;</span><span class="java_separator">).</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;urban&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">should</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">keyword</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">boostedTo</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">ignoreAnalyzer</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">matching</span><span class="java_separator">(</span><span class="java_literal">&quot;urban&quot;</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">must</span><span class="java_separator">(</span><span class="java_plain">&nbsp;mythQB</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">boostedTo</span><span class="java_separator">(</span><span class="java_literal">5</span><span class="java_separator">).</span><span class="java_plain">withConstantScore</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;starred&quot;</span><span class="java_separator">).</span><span class="java_plain">above</span><span class="java_separator">(</span><span class="java_literal">4</span><span class="java_separator">).</span><span class="java_plain">createQuery</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">();</span>
</pre><p>As you can see, the Hibernate Search query DSL is an easy to use
        and easy to read query API and by accepting and producing Lucene
        queries, you can easily incorporate query types not (yet) supported by
        the DSL. Please give us feedback!</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5677"/>5.1.3. Building a Hibernate Search query</h3></div></div></div><p>So far we only covered the process of how to create your Lucene
      query (see <a href="search-query.html#section-building-lucene-queries" title="5.1. Building queries">Section 5.1, “Building queries”</a>). However,
      this is only the first step in the chain of actions. Let's now see how
      to build the Hibernate Search query from the Lucene query.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5684"/>5.1.3.1. Generality</h4></div></div></div><p>Once the Lucene query is built, it needs to be wrapped into an
        Hibernate Query. If not specified otherwise, the query will be
        executed against all indexed entities, potentially returning all types
        of indexed classes.</p><div class="example"><a id="d0e5689"/><p class="title"><b>Example 5.4. Wrapping a Lucene query into a Hibernate Query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">FullTextSession</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextSession&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Search</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getFullTextSession</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_type">Query</span><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>It is advised, from a performance point of view, to restrict the
        returned types:</p><div class="example"><a id="example-filtering-by-entity-type"/><p class="title"><b>Example 5.5. Filtering the search result by entity type</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">fullTextQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextSession</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;or</span>
</span>
<!--  --><br/><span class="java_plain">fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Actor</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>In <a href="search-query.html#example-filtering-by-entity-type" title="Example 5.5. Filtering the search result by entity type">Example 5.5, “Filtering the search result by entity type”</a> the first
        example returns only matching <code class="classname">Customer</code>s, the
        second returns matching <code class="classname">Actor</code>s and
        <code class="classname">Item</code>s. The type restriction is fully
        polymorphic which means that if there are two indexed subclasses
        <code class="classname">Salesman</code> and <code class="classname">Customer</code> of
        the baseclass <code class="classname">Person</code>, it is possible to just
        specify <code class="classname">Person.class</code> in order to filter on
        result types.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5726"/>5.1.3.2. Pagination</h4></div></div></div><p>Out of performance reasons it is recommended to restrict the
        number of returned objects per query. In fact is a very common use
        case anyway that the user navigates from one page to an other. The way
        to define pagination is exactly the way you would define pagination in
        a plain HQL or Criteria query.</p><div class="example"><a id="d0e5731"/><p class="title"><b>Example 5.6. Defining pagination for a search query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hibernate</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">setFirstResult</span><span class="java_separator">(</span><span class="java_literal">15</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">start&nbsp;from&nbsp;the&nbsp;</span><span class="java_literal">15</span><span class="java_plain">th&nbsp;element</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">setMaxResults</span><span class="java_separator">(</span><span class="java_literal">10</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_plain">&nbsp;elements</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>It is still possible to get the total number of matching
          elements regardless of the pagination via
          <code class="methodname">fulltextQuery.</code><code class="methodname">getResultSize()</code></p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5743"/>5.1.3.3. Sorting</h4></div></div></div><p>Apache Lucene provides a very flexible and powerful way to sort
        results. While the default sorting (by relevance) is appropriate most
        of the time, it can be interesting to sort by one or several other
        properties. In order to do so set the Lucene Sort object to apply a
        Lucene sorting strategy.</p><div class="example"><a id="d0e5748"/><p class="title"><b>Example 5.7. Specifying a Lucene <code class="classname">Sort</code> in order to
          sort the results</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">apache</span><span class="java_separator">.</span><span class="java_plain">lucene</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">Sort</span><span class="java_plain">&nbsp;sort&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Sort</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">SortField</span><span class="java_separator">(</span><span class="java_literal">&quot;title&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">SortField</span><span class="java_separator">.</span><span class="java_plain">STRING</span><span class="java_separator">));</span>
query.setSort(sort);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
</pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="tip"><h2>Tip</h2><p>Be aware that fields used for sorting must not be tokenized
          (see <a href="search-mapping.html#field-annotation" title="4.1.1.2. @Field">Section 4.1.1.2, “@Field”</a>).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5764"/>5.1.3.4. Fetching strategy</h4></div></div></div><p>When you restrict the return types to one class, Hibernate
        Search loads the objects using a single query. It also respects the
        static fetching strategy defined in your domain model.</p><p>It is often useful, however, to refine the fetching strategy for
        a specific use case.</p><div class="example"><a id="d0e5771"/><p class="title"><b>Example 5.8. Specifying <code class="classname">FetchMode</code> on a
          query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Criteria</span><!-- <br/> --><span class="java_plain">&nbsp;criteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createCriteria</span><span class="java_separator">(</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">).</span><span class="java_plain">setFetchMode</span><span class="java_separator">(</span><span class="java_literal">&quot;authors&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">FetchMode</span><span class="java_separator">.</span><span class="java_plain">JOIN</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">).</span><span class="java_plain">setCriteriaQuery</span><span class="java_separator">(</span><span class="java_plain">criteria</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p>In this example, the query will return all Books matching the
        luceneQuery. The authors collection will be loaded from the same query
        using an SQL outer join.</p><p>When defining a criteria query, it is not necessary to restrict
        the returned entity types when creating the Hibernate Search query
        from the full text session: the type is guessed from the criteria
        query itself.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Only fetch mode can be adjusted, refrain from applying any
          other restriction. While it is known to work as of Hibernate Search
          4, using restriction (ie a where clause) on your
          <code class="classname">Criteria</code> query should be avoided when
          possible. <code class="methodname">getResultSize()</code> will throw a
          <code class="classname">SearchException</code> if used in conjunction with a
          <code class="classname">Criteria</code> with restriction.</p></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>You cannot use <code class="methodname">setCriteriaQuery</code> if
          more than one entity type is expected to be returned.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="projections"/>5.1.3.5. Projection</h4></div></div></div><p>For some use cases, returning the domain object (including its
        associations) is overkill. Only a small subset of the properties is
        necessary. Hibernate Search allows you to return a subset of
        properties:</p><div class="example"><a id="d0e5809"/><p class="title"><b>Example 5.9. Using projection instead of returning the full domain
          object</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hibernate</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">search</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span>setProjection("id", "summary", "body", "mainAuthor.name")<span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;firstResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Object</span><span class="java_separator">[])</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Integer</span><span class="java_plain">&nbsp;id&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;summary&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">1</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;body&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">2</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;authorName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">3</span><span class="java_separator">];</span></pre></div></div><br class="example-break"/><p>Hibernate Search extracts the properties from the Lucene index
        and convert them back to their object representation, returning a list
        of <code class="classname">Object[]</code>. Projections avoid a potential
        database round trip (useful if the query response time is critical).
        However, it also has several constraints:</p><div class="itemizedlist"><ul><li><p>the properties projected must be stored in the index
            (<code class="literal">@Field(store=Store.YES)</code>), which increases the
            index size</p></li><li><p>the properties projected must use a
            <code class="literal">FieldBridge</code> implementing
            <code class="classname">org.hibernate.search.bridge.TwoWayFieldBridge</code>
            or
            <code class="literal">org.hibernate.search.bridge.TwoWayStringBridge</code>,
            the latter being the simpler version.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>All Hibernate Search built-in types are two-way.</p></div></li><li><p>you can only project simple properties of the indexed entity
            or its embedded associations. This means you cannot project a
            whole embedded entity.</p></li><li><p>projection does not work on collections or maps which are
            indexed via <code class="classname">@IndexedEmbedded</code></p></li></ul></div><p>Projection is also useful for another kind of use case. Lucene
        can provide metadata information about the results. By using some
        special projection constants, the projection mechanism can retrieve
        this metadata:</p><div class="example"><a id="d0e5854"/><p class="title"><b>Example 5.10. Using projection in order to retrieve meta data</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hibernate</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">search</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span>setProjection( 
    FullTextQuery.SCORE, 
    FullTextQuery.THIS, 
    "mainAuthor.name" )<span class="java_separator">;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;firstResult&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Object</span><span class="java_separator">[])</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">float</span><span class="java_plain">&nbsp;score&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_type">Book</span><span class="java_plain">&nbsp;book&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">1</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;authorName&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstResult</span><span class="java_separator">[</span><span class="java_literal">2</span><span class="java_separator">];</span></pre></div></div><br class="example-break"/><p>You can mix and match regular fields and projection constants.
        Here is the list of the available constants:</p><div class="itemizedlist"><ul><li><p><code class="classname">FullTextQuery.THIS</code>: returns the
            initialized and managed entity (as a non projected query would
            have done).</p></li><li><p><code class="classname">FullTextQuery.DOCUMENT</code>: returns the
            Lucene Document related to the object projected.</p></li><li><p><code class="classname">FullTextQuery.OBJECT_CLASS</code>: returns
            the class of the indexed entity.</p></li><li><p><code class="classname">FullTextQuery.SCORE</code>: returns the
            document score in the query. Scores are handy to compare one
            result against an other for a given query but are useless when
            comparing the result of different queries.</p></li><li><p><code class="classname">FullTextQuery.ID</code>: the id property
            value of the projected object.</p></li><li><p><code class="classname">FullTextQuery.DOCUMENT_ID</code>: the Lucene
            document id. Careful, Lucene document id can change overtime
            between two different IndexReader opening.</p></li><li><p><code class="classname">FullTextQuery.EXPLANATION</code>: returns
            the Lucene Explanation object for the matching object/document in
            the given query. Do not use if you retrieve a lot of data. Running
            explanation typically is as costly as running the whole Lucene
            query per matching element. Make sure you use projection!</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e5900"/>5.1.3.6. Customizing object initialization strategies</h4></div></div></div><p>By default, Hibernate Search uses the most appropriate strategy
        to initialize entities matching your full text query. It executes one
        (or several) queries to retrieve the required entities. This is the
        best approach to minimize database round trips in a scenario where
        none / few of the retrieved entities are present in the persistence
        context (ie the session) or the second level cache.</p><p>If most of your entities are present in the second level cache,
        you can force Hibernate Search to look into the cache before
        retrieving an object from the database.</p><div class="example"><a id="d0e5907"/><p class="title"><b>Example 5.11. Check the second-level cache before using a query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;session</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createFullTextQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">luceneQuery</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">User</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">initializeObjectWith</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">ObjectLookupMethod</span><span class="java_separator">.</span><span class="java_plain">SECOND_LEVEL_CACHE</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">DatabaseRetrievalMethod</span><span class="java_separator">.</span><span class="java_plain">QUERY</span>
<!--  --><br/><span class="java_separator">);</span></pre></div></div><br class="example-break"/><p><code class="classname">ObjectLookupMethod</code> defines the strategy
        used to check if an object is easily accessible (without database
        round trip). Other options are:</p><div class="itemizedlist"><ul><li><p><code class="literal">ObjectLookupMethod.PERSISTENCE_CONTEXT</code>:
            useful if most of the matching entities are already in the
            persistence context (ie loaded in the
            <code class="classname">Session</code> or
            <code class="classname">EntityManager</code>)</p></li><li><p><code class="literal">ObjectLookupMethod.SECOND_LEVEL_CACHE</code>:
            check first the persistence context and then the second-level
            cache.</p></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Note that to search in the second-level cache, several
          settings must be in place:</p><div class="itemizedlist"><ul><li><p>the second level cache must be properly configured and
              active</p></li><li><p>the entity must have enabled second-level cache (eg via
              <code class="classname">@Cacheable</code>)</p></li><li><p>the <code class="classname">Session</code>,
              <code class="classname">EntityManager</code> or
              <code class="classname">Query</code> must allow access to the
              second-level cache for read access (ie
              <code class="literal">CacheMode.NORMAL</code> in Hibernate native APIs or
              <code class="literal">CacheRetrieveMode.USE</code> in JPA 2 APIs).</p></li></ul></div></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Avoid using
          <code class="literal">ObjectLookupMethod.SECOND_LEVEL_CACHE</code> unless your
          second level cache implementation is either EHCache or Infinispan;
          other second level cache providers don't currently implement this
          operation efficiently.</p></div><p>You can also customize how objects are loaded from the database
        (if not found before). Use
        <code class="classname">DatabaseRetrievalMethod</code> for that:</p><div class="itemizedlist"><ul><li><p><code class="classname">QUERY</code> (default): use a (set of)
            queries to load several objects in batch. This is usually the best
            approach.</p></li><li><p><code class="classname">FIND_BY_ID</code>: load objects one by one
            using the
            <code class="classname">Session</code>.<code class="methodname">get</code> or
            <code class="classname">EntityManager</code>.<code class="methodname">find</code>
            semantic. This might be useful if batch-size is set on the entity
            (in which case, entities will be loaded in batch by Hibernate
            Core). <code class="classname">QUERY</code> should be preferred almost all
            the time.</p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6001"/>5.1.3.7. Limiting the time of a query</h4></div></div></div><p>You can limit the time a query takes in Hibernate Search in two
        ways:</p><div class="itemizedlist"><ul><li><p>raise an exception when the limit is reached</p></li><li><p>limit to the number of results retrieved when the time limit
            is raised</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e6013"/>5.1.3.7.1. Raise an exception on time limit</h5></div></div></div><p>You can decide to stop a query if when it takes more than a
          predefined amount of time. Note that this is a best effort basis but
          if Hibernate Search still has significant work to do and if we are
          beyond the time limit, a
          <code class="classname">QueryTimeoutException</code> will be raised
          (<code class="classname">org.hibernate.QueryTimeoutException</code> or
          <code class="classname">javax.persistence.QueryTimeoutException</code>
          depending on your programmatic API).</p><p>To define the limit when using the native Hibernate APIs, use
          one of the following approaches</p><div class="example"><a id="d0e6029"/><p class="title"><b>Example 5.12. Defining a timeout in query execution</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">define&nbsp;the&nbsp;timeout&nbsp;in&nbsp;seconds</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">setTimeout</span><span class="java_separator">(</span><span class="java_literal">5</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">alternatively</span><span class="java_separator">,</span><span class="java_plain">&nbsp;define&nbsp;the&nbsp;timeout&nbsp;in&nbsp;any&nbsp;given&nbsp;time&nbsp;unit</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">setTimeout</span><span class="java_separator">(</span><span class="java_literal">450</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">TimeUnit</span><span class="java_separator">.</span><span class="java_plain">MILLISECONDS</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">try</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_type">QueryTimeoutException</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;something</span><span class="java_separator">,</span><span class="java_plain">&nbsp;too&nbsp;slow</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Likewise <code class="literal">getResultSize()</code>,
          <code class="methodname">iterate()</code> and
          <code class="methodname">scroll()</code> honor the timeout but only until
          the end of the method call. That simply means that the methods of
          <code class="classname">Iterable</code> or the
          <code class="classname">ScrollableResults</code> ignore the timeout.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p><code class="methodname">explain()</code> does not honor the
            timeout: this method is used for debug purposes and in particular
            to find out why a query is slow</p></div><p>When using JPA, simply use the standard way of limiting query
          execution time.</p><div class="example"><a id="d0e6058"/><p class="title"><b>Example 5.13. Defining a timeout in query execution</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextEM</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">define&nbsp;the&nbsp;timeout&nbsp;in&nbsp;milliseconds</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">setHint</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;javax.persistence.query.timeout&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">450</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">try</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">javax</span><span class="java_separator">.</span><span class="java_plain">persistence</span><span class="java_separator">.</span><span class="java_type">QueryTimeoutException</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;something</span><span class="java_separator">,</span><span class="java_plain">&nbsp;too&nbsp;slow</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Remember, this is a best effort approach and does not
            guarantee to stop exactly on the specified timeout.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e6066"/>5.1.3.7.2. Limit the number of results when the time limit is
          reached</h5></div></div></div><p>Alternatively, you can return the number of results which have
          already been fetched by the time the limit is reached. Note that
          only the Lucene part of the query is influenced by this limit. It is
          possible that, if you retrieve managed object, it takes longer to
          fetch these objects.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>This approach is not compatible with the
            <code class="classname">setTimeout</code> approach.</p></div><p>To define this soft limit, use the following approach</p><div class="example"><a id="d0e6079"/><p class="title"><b>Example 5.14. Defining a time limit in query execution</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">define&nbsp;the&nbsp;timeout&nbsp;in&nbsp;seconds</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">limitExecutionTimeTo</span><span class="java_separator">(</span><span class="java_literal">500</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">TimeUnit</span><span class="java_separator">.</span><span class="java_plain">MILLISECONDS</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>Likewise <code class="literal">getResultSize()</code>,
          <code class="methodname">iterate()</code> and
          <code class="methodname">scroll()</code> honor the time limit but only
          until the end of the method call. That simply means that the methods
          of <code class="classname">Iterable</code> or the
          <code class="classname">ScrollableResults</code> ignore the timeout.</p><p>You can determine if the results have been partially loaded by
          invoking the <code class="methodname">hasPartialResults</code>
          method.</p><div class="example"><a id="d0e6106"/><p class="title"><b>Example 5.15. Determines when a query returns partial results</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">...;</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">define&nbsp;the&nbsp;timeout&nbsp;in&nbsp;seconds</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">limitExecutionTimeTo</span><span class="java_separator">(</span><span class="java_literal">500</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">TimeUnit</span><span class="java_separator">.</span><span class="java_plain">MILLISECONDS</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">hasPartialResults</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;displayWarningToUser</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>If you use the JPA API,
          <code class="methodname">limitExecutionTimeTo</code> and
          <code class="methodname">hasPartialResults</code> are also available to
          you.</p></div></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6119"/>5.2. Retrieving the results</h2></div></div></div><p>Once the Hibernate Search query is built, executing it is in no way
    different than executing a HQL or Criteria query. The same paradigm and
    object semantic applies. All the common operations are available:
    <code class="methodname">list()</code>, <code class="methodname">uniqueResult()</code>,
    <code class="methodname">iterate()</code>,
    <code class="methodname">scroll()</code>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6136"/>5.2.1. Performance considerations</h3></div></div></div><p>If you expect a reasonable number of results (for example using
      pagination) and expect to work on all of them,
      <code class="methodname">list()</code> or
      <code class="methodname">uniqueResult()</code> are recommended.
      <code class="methodname">list()</code> work best if the entity
      <code class="literal">batch-size</code> is set up properly. Note that Hibernate
      Search has to process all Lucene Hits elements (within the pagination)
      when using <code class="methodname">list()</code> ,
      <code class="methodname">uniqueResult()</code> and
      <code class="methodname">iterate()</code>.</p><p>If you wish to minimize Lucene document loading,
      <code class="methodname">scroll()</code> is more appropriate. Don't forget to
      close the <code class="classname">ScrollableResults</code> object when you're
      done, since it keeps Lucene resources. If you expect to use
      <code class="methodname">scroll,</code> but wish to load objects in batch, you
      can use <code class="methodname">query.setFetchSize()</code>. When an object is
      accessed, and if not already loaded, Hibernate Search will load the next
      <code class="literal">fetchSize</code> objects in one pass.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>Pagination is preferred over scrolling.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6182"/>5.2.2. Result size</h3></div></div></div><p>It is sometimes useful to know the total number of matching
      documents:</p><div class="itemizedlist"><ul><li><p>for the Google-like feature "1-10 of about 888,000,000"</p></li><li><p>to implement a fast pagination navigation</p></li><li><p>to implement a multi step search engine (adding approximation
          if the restricted query return no or not enough results)</p></li></ul></div><p>Of course it would be too costly to retrieve all the matching
      documents. Hibernate Search allows you to retrieve the total number of
      matching documents regardless of the pagination parameters. Even more
      interesting, you can retrieve the number of matching elements without
      triggering a single object load.</p><div class="example"><a id="d0e6199"/><p class="title"><b>Example 5.16. Determining the result size of a query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hibernate</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">search</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;the&nbsp;number&nbsp;of&nbsp;matching&nbsp;books&nbsp;without&nbsp;loading&nbsp;a&nbsp;single&nbsp;one</span>
<!--  --><br/><span class="java_keyword">assert</span><span class="java_plain">&nbsp;</span><span class="java_literal">3245</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span>query.getResultSize()<span class="java_separator">;</span><span class="java_plain">&nbsp;</span>
</span>
<!--  --><br/><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">setMaxResult</span><span class="java_separator">(</span><span class="java_literal">10</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;matching&nbsp;books&nbsp;regardless&nbsp;of&nbsp;pagination</span>
<!--  --><br/><span class="java_keyword">assert</span><span class="java_plain">&nbsp;</span><span class="java_literal">3245</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span>query.getResultSize()<span class="java_separator">;</span><span class="java_plain">&nbsp;</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Like Google, the number of results is an approximation if the
        index is not fully up-to-date with the database (asynchronous cluster
        for example).</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6213"/>5.2.3. ResultTransformer</h3></div></div></div><p>As seen in <a href="search-query.html#projections" title="5.1.3.5. Projection">Section 5.1.3.5, “Projection”</a> projection results are
      returns as <code class="classname">Object</code> arrays. This data structure is
      not always matching the application needs. In this cases It is possible
      to apply a <code class="classname">ResultTransformer</code> which post query
      execution can build the needed data structure:</p><div class="example"><a id="d0e6226"/><p class="title"><b>Example 5.17. Using ResultTransformer in conjunction with projections</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">org</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">hibernate</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">search</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;s</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Book</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">setProjection</span><span class="java_separator">(</span><span class="java_literal">&quot;title&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;mainAuthor.name&quot;</span><span class="java_separator">);</span>
query.setResultTransformer( 
    new StaticAliasToBeanResultTransformer( 
        BookView.class, 
        "title", 
        "author" ) 
);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">BookView</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">BookView</span><span class="java_operator">&gt;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">BookView</span><span class="java_plain">&nbsp;view&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;results</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;log</span><span class="java_separator">.</span><span class="java_plain">info</span><span class="java_separator">(</span><span class="java_literal">&quot;Book:&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;view</span><span class="java_separator">.</span><span class="java_plain">getTitle</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;,&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;view</span><span class="java_separator">.</span><span class="java_plain">getAuthor</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Examples of <code class="classname">ResultTransformer</code>
      implementations can be found in the Hibernate Core codebase.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6239"/>5.2.4. Understanding results</h3></div></div></div><p>You will find yourself sometimes puzzled by a result showing up in
      a query or a result not showing up in a query. Luke is a great tool to
      understand those mysteries. However, Hibernate Search also gives you
      access to the Lucene <code class="classname">Explanation</code> object for a
      given result (in a given query). This class is considered fairly
      advanced to Lucene users but can provide a good understanding of the
      scoring of an object. You have two ways to access the Explanation object
      for a given result:</p><div class="itemizedlist"><ul><li><p>Use the <code class="methodname">fullTextQuery.explain(int)</code>
          method</p></li><li><p>Use projection</p></li></ul></div><p>The first approach takes a document id as a parameter and return
      the Explanation object. The document id can be retrieved using
      projection and the <code class="literal">FullTextQuery.DOCUMENT_ID</code>
      constant.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The Document id has nothing to do with the entity id. Do not
        mess up these two notions.</p></div><p>In the second approach you project the
      <code class="classname">Explanation</code> object using the
      <code class="literal">FullTextQuery.EXPLANATION</code> constant.</p><div class="example"><a id="d0e6273"/><p class="title"><b>Example 5.18. Retrieving the Lucene Explanation object using
        projection</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">FullTextQuery</span><!-- <br/> --><span class="java_plain">&nbsp;ftQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;s</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createFullTextQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;luceneQuery</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Dvd</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setProjection</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">FullTextQuery</span><span class="java_separator">.</span><span class="java_plain">DOCUMENT_ID</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>FullTextQuery.EXPLANATION<span class="java_separator">,</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">FullTextQuery</span><span class="java_separator">.</span><span class="java_plain">THIS&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SuppressWarnings</span><span class="java_separator">(</span><span class="java_literal">&quot;unchecked&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ftQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;result&nbsp;</span><span class="java_operator">:</span><span class="java_plain">&nbsp;results</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Explanation</span><span class="java_plain">&nbsp;e&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Explanation</span><span class="java_separator">)</span><span class="java_plain">&nbsp;result</span><span class="java_separator">[</span><span class="java_literal">1</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;display</span><span class="java_separator">(</span><span class="java_plain">&nbsp;e</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Be careful, building the explanation object is quite expensive, it
      is roughly as expensive as running the Lucene query again. Don't do it
      if you don't need the object</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="query-filter"/>5.3. Filters</h2></div></div></div><p>Apache Lucene has a powerful feature that allows to filter query
    results according to a custom filtering process. This is a very powerful
    way to apply additional data restrictions, especially since filters can be
    cached and reused. Some interesting use cases are:</p><div class="itemizedlist"><ul><li><p>security</p></li><li><p>temporal data (eg. view only last month's data)</p></li><li><p>population filter (eg. search limited to a given
        category)</p></li><li><p>and many more</p></li></ul></div><p>Hibernate Search pushes the concept further by introducing the
    notion of parameterizable named filters which are transparently cached.
    For people familiar with the notion of Hibernate Core filters, the API is
    very similar:</p><div class="example"><a id="d0e6303"/><p class="title"><b>Example 5.19. Enabling fulltext filters for a given query</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">fullTextQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;s</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createFullTextQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">query</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Driver</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">enableFullTextFilter</span><span class="java_separator">(</span><span class="java_literal">&quot;bestDriver&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">enableFullTextFilter</span><span class="java_separator">(</span><span class="java_literal">&quot;security&quot;</span><span class="java_separator">).</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">&quot;login&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;andre&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">returns&nbsp;only&nbsp;best&nbsp;drivers&nbsp;where&nbsp;andre&nbsp;has&nbsp;credentials</span></pre></div></div><br class="example-break"/><p>In this example we enabled two filters on top of the query. You can
    enable (or disable) as many filters as you like.</p><p>Declaring filters is done through the
    <code class="classname">@FullTextFilterDef</code> annotation. This annotation can
    be on any <code class="literal">@Indexed</code> entity regardless of the query the
    filter is later applied to. This implies that filter definitions are
    global and their names must be unique. A
    <code class="classname">SearchException</code> is thrown in case two different
    <code class="classname">@FullTextFilterDef</code> annotations with the same name
    are defined. Each named filter has to specify its actual filter
    implementation.</p><div class="example"><a id="d0e6324"/><p class="title"><b>Example 5.20. Defining and implementing a Filter</b></p><div class="example-contents"><pre class="programlisting">@Entity
@Indexed
@FullTextFilterDefs( {
    <span class="bold"><strong>@FullTextFilterDef(name = "bestDriver", impl = BestDriversFilter.class)</strong></span>, 
    <span class="bold"><strong>@FullTextFilterDef(name = "security", impl = SecurityFilterFactory.class)</strong></span> 
})
public class Driver { ... }</pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">BestDriversFilter</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">extends</span><!-- <br/> --><span class="java_plain">&nbsp;</span>org.apache.lucene.search.Filter<span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">DocIdSet</span><span class="java_plain">&nbsp;getDocIdSet</span><span class="java_separator">(</span><span class="java_type">IndexReader</span><span class="java_plain">&nbsp;reader</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throws</span><span class="java_plain">&nbsp;</span><span class="java_type">IOException</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">OpenBitSet</span><span class="java_plain">&nbsp;bitSet&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">OpenBitSet</span><span class="java_separator">(</span><span class="java_plain">&nbsp;reader</span><span class="java_separator">.</span><span class="java_plain">maxDoc</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">TermDocs</span><span class="java_plain">&nbsp;termDocs&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;reader</span><span class="java_separator">.</span><span class="java_plain">termDocs</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Term</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;score&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;5&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;termDocs</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bitSet</span><span class="java_separator">.</span><span class="java_plain">set</span><span class="java_separator">(</span><span class="java_plain">&nbsp;termDocs</span><span class="java_separator">.</span><span class="java_plain">doc</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;bitSet</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p><code class="classname">BestDriversFilter</code> is an example of a simple
    Lucene filter which reduces the result set to drivers whose score is 5. In
    this example the specified filter implements the
    <code class="literal">org.apache.lucene.search.Filter</code> directly and contains a
    no-arg constructor.</p><p>If your Filter creation requires additional steps or if the filter
    you want to use does not have a no-arg constructor, you can use the
    factory pattern:</p><div class="example"><a id="d0e6349"/><p class="title"><b>Example 5.21. Creating a filter using the factory pattern</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Indexed</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">FullTextFilterDef</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;bestDriver&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;impl&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">BestDriversFilterFactory</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Driver</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;</span><span class="java_separator">...</span><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">BestDriversFilterFactory</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>@Factory</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Filter</span><span class="java_plain">&nbsp;getFilter</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">some&nbsp;additional&nbsp;steps&nbsp;to&nbsp;cache&nbsp;the&nbsp;filter&nbsp;results&nbsp;per&nbsp;</span><span class="java_type">IndexReader</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Filter</span><span class="java_plain">&nbsp;bestDriversFilter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">BestDriversFilter</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">CachingWrapperFilter</span><span class="java_separator">(</span><span class="java_plain">bestDriversFilter</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Hibernate Search will look for a <code class="literal">@Factory</code>
    annotated method and use it to build the filter instance. The factory must
    have a no-arg constructor.</p><p>Named filters come in handy where parameters have to be passed to
    the filter. For example a security filter might want to know which
    security level you want to apply:</p><div class="example"><a id="d0e6364"/><p class="title"><b>Example 5.22. Passing parameters to a defined filter</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">fullTextQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;s</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createFullTextQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">query</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Driver</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">enableFullTextFilter</span><span class="java_separator">(</span><span class="java_literal">&quot;security&quot;</span><span class="java_separator">)</span>.setParameter("level", 5)<span class="java_separator">;</span></pre></div></div><br class="example-break"/><p>Each parameter name should have an associated setter on either the
    filter or filter factory of the targeted named filter definition.</p><div class="example"><a id="d0e6374"/><p class="title"><b>Example 5.23. Using parameters in the actual filter implementation</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">SecurityFilterFactory</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;level</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;injected&nbsp;parameter</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>public void setLevel(Integer level)<span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">level&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;level</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>@Key
    public FilterKey getKey()<span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">StandardFilterKey</span><span class="java_plain">&nbsp;key&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StandardFilterKey</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key</span><span class="java_separator">.</span><span class="java_plain">addParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;level&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;key</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Factory</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">Filter</span><span class="java_plain">&nbsp;getFilter</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Query</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">TermQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Term</span><span class="java_separator">(</span><span class="java_literal">&quot;level&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;level</span><span class="java_separator">.</span><span class="java_plain">toString</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">CachingWrapperFilter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">QueryWrapperFilter</span><span class="java_separator">(</span><span class="java_plain">query</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre></div></div><br class="example-break"/><p>Note the method annotated <code class="classname">@Key</code> returning a
    <code class="classname">FilterKey</code> object. The returned object has a special
    contract: the key object must implement <code class="methodname">equals()</code>
    / <code class="methodname">hashCode()</code> so that 2 keys are equal if and only
    if the given <code class="classname">Filter</code> types are the same and the set
    of parameters are the same. In other words, 2 filter keys are equal if and
    only if the filters from which the keys are generated can be interchanged.
    The key object is used as a key in the cache mechanism.</p><p><code class="classname">@Key</code> methods are needed only if:</p><div class="itemizedlist"><ul><li><p>you enabled the filter caching system (enabled by
        default)</p></li><li><p>your filter has parameters</p></li></ul></div><p>In most cases, using the <code class="literal">StandardFilterKey</code>
    implementation will be good enough. It delegates the
    <code class="methodname">equals()</code> / <code class="methodname">hashCode()</code>
    implementation to each of the parameters equals and hashcode
    methods.</p><p>As mentioned before the defined filters are per default cached and
    the cache uses a combination of hard and soft references to allow disposal
    of memory when needed. The hard reference cache keeps track of the most
    recently used filters and transforms the ones least used to
    <code class="classname">SoftReferences</code> when needed. Once the limit of the
    hard reference cache is reached additional filters are cached as
    <code class="classname">SoftReferences</code>. To adjust the size of the hard
    reference cache, use
    <code class="literal">hibernate.search.filter.cache_strategy.size</code> (defaults
    to 128). For advanced use of filter caching, you can implement your own
    <code class="classname">FilterCachingStrategy</code>. The classname is defined by
    <code class="literal">hibernate.search.filter.cache_strategy</code>.</p><p>This filter caching mechanism should not be confused with caching
    the actual filter results. In Lucene it is common practice to wrap filters
    using the <code class="classname">IndexReader</code> around a
    <code class="classname">CachingWrapperFilter.</code> The wrapper will cache the
    <code class="classname">DocIdSet</code> returned from the
    <code class="methodname">getDocIdSet(IndexReader reader)</code> method to avoid
    expensive recomputation. It is important to mention that the computed
    <code class="classname">DocIdSet</code> is only cachable for the same
    <code class="classname">IndexReader</code> instance, because the reader
    effectively represents the state of the index at the moment it was opened.
    The document list cannot change within an opened
    <code class="classname">IndexReader</code>. A different/new<code class="classname">
    IndexReader</code> instance, however, works potentially on a
    different set of <code class="classname">Document</code>s (either from a different
    index or simply because the index has changed), hence the cached
    <code class="classname">DocIdSet</code> has to be recomputed.</p><p>Hibernate Search also helps with this aspect of caching. Per default
    the <code class="literal">cache</code> flag of <code class="classname">@FullTextFilterDef
    </code>is set to
    <code class="literal">FilterCacheModeType.INSTANCE_AND_DOCIDSETRESULTS</code> which
    will automatically cache the filter instance as well as wrap the specified
    filter around a Hibernate specific implementation of
    <code class="classname">CachingWrapperFilter</code>. In contrast to Lucene's
    version of this class <code class="classname">SoftReference</code>s are used
    together with a hard reference count (see discussion about filter cache).
    The hard reference count can be adjusted using
    <code class="literal">hibernate.search.filter.cache_docidresults.size</code>
    (defaults to 5). The wrapping behaviour can be controlled using the
    <code class="literal">@FullTextFilterDef.cache</code> parameter. There are three
    different values for this parameter:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="center">Value</th><th align="center">Definition</th></tr></thead><tbody><tr><td align="left">FilterCacheModeType.NONE</td><td align="left">No filter instance and no result is cached by Hibernate
              Search. For every filter call, a new filter instance is created.
              This setting might be useful for rapidly changing data sets or
              heavily memory constrained environments.</td></tr><tr><td align="left">FilterCacheModeType.INSTANCE_ONLY</td><td align="left">The filter instance is cached and reused across
              concurrent <code class="methodname">Filter.getDocIdSet()</code> calls.
              <code class="classname">DocIdSet</code> results are not cached. This
              setting is useful when a filter uses its own specific caching
              mechanism or the filter results change dynamically due to
              application specific events making
              <code class="classname">DocIdSet</code> caching in both cases
              unnecessary.</td></tr><tr><td align="left">FilterCacheModeType.INSTANCE_AND_DOCIDSETRESULTS</td><td align="left">Both the filter instance and the
              <code class="classname">DocIdSet</code> results are cached. This is the
              default value.</td></tr></tbody></table></div><p>Last but not least - why should filters be cached? There
    are two areas where filter caching shines:</p><div class="itemizedlist"><ul><li><p>the system does not update the targeted entity index often (in
        other words, the IndexReader is reused a lot)</p></li><li><p>the Filter's DocIdSet is expensive to compute (compared to the
        time spent to execute the query)</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="query-filter-shard"/>5.3.1. Using filters in a sharded environment</h3></div></div></div><p>It is possible, in a sharded environment to execute queries on a
      subset of the available shards. This can be done in two steps:</p><div class="itemizedlist"><ul><li><p>create a sharding strategy that does select a subset of
          <code class="classname">IndexManager</code>s depending on some filter
          configuration</p></li><li><p>activate the proper filter at query time</p></li></ul></div><p>Let's first look at an example of sharding strategy that query on
      a specific customer shard if the customer filter is activated.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CustomerShardingStrategy</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">IndexShardingStrategy</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;stored&nbsp;</span><span class="java_type">IndexManagers</span><span class="java_plain">&nbsp;in&nbsp;a&nbsp;array&nbsp;indexed&nbsp;by&nbsp;customerID</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;initialize</span><span class="java_separator">(</span><span class="java_type">Properties</span><span class="java_plain">&nbsp;properties</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">this</span><span class="java_separator">.</span><span class="java_plain">indexManagers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;getIndexManagersForAllShards</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_plain">&nbsp;getIndexManagerForAddition</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Class</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;id</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;idInString</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Document</span><span class="java_plain">&nbsp;document</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;customerID&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_separator">.</span><span class="java_plain">parseInt</span><span class="java_separator">(</span><span class="java_plain">document</span><span class="java_separator">.</span><span class="java_plain">getFieldable</span><span class="java_separator">(</span><span class="java_literal">&quot;customerID&quot;</span><span class="java_separator">).</span><span class="java_plain">stringValue</span><span class="java_separator">());</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">[</span><span class="java_plain">customerID</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;getIndexManagersForDeletion</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Class</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Serializable</span><span class="java_plain">&nbsp;id</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;idInString</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;getIndexManagersForAllShards</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;*&nbsp;Optimization;&nbsp;don't&nbsp;search&nbsp;ALL&nbsp;shards&nbsp;and&nbsp;union&nbsp;the&nbsp;results;&nbsp;in&nbsp;this&nbsp;case,&nbsp;we&nbsp;</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;*&nbsp;can&nbsp;be&nbsp;certain&nbsp;that&nbsp;all&nbsp;the&nbsp;data&nbsp;for&nbsp;a&nbsp;particular&nbsp;customer&nbsp;Filter&nbsp;is&nbsp;in&nbsp;a&nbsp;single</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;*&nbsp;shard;&nbsp;simply&nbsp;return&nbsp;that&nbsp;shard&nbsp;by&nbsp;customerID.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;getIndexManagersForQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">FullTextFilterImplementor</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;filters</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_type">FullTextFilter</span><span class="java_plain">&nbsp;filter&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;getCustomerFilter</span><span class="java_separator">(</span><span class="java_plain">filters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;customer&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">filter&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;getIndexManagersForAllShards</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">else</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">IndexManager</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;indexManagers</span><span class="java_separator">[</span><span class="java_type">Integer</span><span class="java_separator">.</span><span class="java_plain">parseInt</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter</span><span class="java_separator">.</span><span class="java_plain">getParameter</span><span class="java_separator">(</span><span class="java_literal">&quot;customerID&quot;</span><span class="java_separator">).</span><span class="java_plain">toString</span><span class="java_separator">())]</span><span class="java_plain">&nbsp;</span><span class="java_separator">};</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">FullTextFilter</span><span class="java_plain">&nbsp;getCustomerFilter</span><span class="java_separator">(</span><span class="java_type">FullTextFilterImplementor</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;filters</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">for</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">FullTextFilterImplementor</span><span class="java_plain">&nbsp;filter</span><span class="java_operator">:</span><span class="java_plain">&nbsp;filters</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">filter</span><span class="java_separator">.</span><span class="java_plain">getName</span><span class="java_separator">().</span><span class="java_plain">equals</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_separator">))</span><span class="java_plain">&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;filter</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>In this example, if the filter named <code class="literal">customer</code>
      is present, we make sure to only use the shard dedicated to this
      customer. Otherwise, we return all shards. A given Sharding strategy can
      react to one or more filters and depends on their parameters.</p><p>The second step is simply to activate the filter at query time.
      While the filter can be a regular filter (as defined in <a href="search-query.html#query-filter" title="5.3. Filters">Section 5.3, “Filters”</a>) which also filters Lucene results after the
      query, you can make use of a special filter that will only be passed to
      the sharding strategy and otherwise ignored for the rest of the query.
      Simply use the <code class="classname">ShardSensitiveOnlyFilter</code> class
      when declaring your filter.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span><!-- <br/> --><span class="java_plain">&nbsp;@</span><!-- <br/> --><span class="java_type">Indexed</span>
@FullTextFilterDef(name="customer", impl=ShardSensitiveOnlyFilter.class)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;query&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;ftEm</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
query.enableFulltextFilter("customer").setParameter("CustomerID", 5);</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SuppressWarnings</span><span class="java_separator">(</span><span class="java_literal">&quot;unchecked&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Customer</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;results&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><p>Note that by using the
      <code class="classname">ShardSensitiveOnlyFilter</code>, you do not have to
      implement any Lucene filter. Using filters and sharding strategy
      reacting to these filters is recommended to speed up queries in a
      sharded environment.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="query-faceting"/>5.4. Faceting</h2></div></div></div><p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Faceted_search">Faceted
    search</a> is a technique which allows to divide the results of a
    query into multiple categories. This categorization includes the
    calculation of hit counts for each category and the ability to further
    restrict search results based on these facets (categories). <a href="search-query.html#example-amazon-facets" title="Example 5.24. Search for 'Hibernate Search' on Amazon">Example 5.24, “Search for <span class="emphasis"><em>'Hibernate Search'</em></span> on
      Amazon”</a> shows a faceting example. The search for
    'Hibernate Search' results in fifteen hits which are displayed on the main
    part of the page. The navigation bar on the left, however, shows the
    category<span class="emphasis"><em> Computers &amp; Internet</em></span> with its
    subcategories <span class="emphasis"><em>Programming</em></span>, <span class="emphasis"><em>Computer
    Science</em></span>, <span class="emphasis"><em>Databases</em></span>,
    <span class="emphasis"><em>Software</em></span>, <span class="emphasis"><em>Web Development,</em></span>
    <span class="emphasis"><em>Networking</em></span> and <span class="emphasis"><em>Home Computing</em></span>.
    For each of these subcategories the number of books is shown matching the
    main search criteria and belonging to the respective subcategory. This
    division of the category <span class="emphasis"><em>Computers &amp; Internet</em></span> is
    one facet of this search. Another one is for example the average customer
    review rating.</p><div class="example"><a id="example-amazon-facets"/><p class="title"><b>Example 5.24. Search for <span class="emphasis"><em>'Hibernate Search'</em></span> on
      Amazon</b></p><div class="example-contents"><div class="mediaobject" align="center"><img src="faceting.png" align="middle"/></div></div></div><br class="example-break"/><p>In Hibernate Search the classes <code class="classname">QueryBuilder</code>
    and <code class="classname">FullTextQuery</code> are the entry point to the
    faceting API. The former allows to create faceting requests whereas the
    latter gives access to the so called <code class="classname">FacetManager</code>.
    With the help of the <code class="classname">FacetManager</code> faceting requests
    can be applied on a query and selected facets can be added to an existing
    query in order to refine search results. The following sections will
    describe the faceting process in more detail. The examples will use the
    entity <code class="classname">Cd</code> as shown in <a href="search-query.html#example-faceting-entity" title="Example 5.25. Example entity for faceting">Example 5.25, “Example entity for faceting”</a>:</p><div class="example"><a id="example-faceting-entity"/><p class="title"><b>Example 5.25. Example entity for faceting</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Indexed</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Cd</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">GeneratedValue</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Fields</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">name&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;name_un_analyzed&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;analyze&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;price</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">DateBridge</span><span class="java_separator">(</span><span class="java_plain">resolution&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Resolution</span><span class="java_separator">.</span><span class="java_plain">YEAR</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;releaseYear</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Field</span><span class="java_separator">(</span><span class="java_plain">analyze&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Analyze</span><span class="java_separator">.</span><span class="java_plain">NO</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;label</span><span class="java_separator">;</span>
</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;setter</span><span class="java_operator">/</span><span class="java_plain">getter</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="section-creating-faceting-request"/>5.4.1. Creating a faceting request</h3></div></div></div><p>The first step towards a faceted search is to create the
      <code class="classname">FacetingRequest</code>. Currently two types of faceting
      requests are supported. The first type is called <span class="emphasis"><em>discrete
      faceting</em></span> and the second type <span class="emphasis"><em>range
      faceting</em></span> request.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="discrete-faceting-request"/>5.4.1.1. Discrete faceting request</h4></div></div></div><p>In the case of a discrete faceting request you start with giving
        the request a unique name. This name will later be used to retrieve
        the facet values (see <a href="search-query.html#section-interpreting-facet-result" title="5.4.4. Interpreting a Facet result">Section 5.4.4, “Interpreting a <code class="classname">Facet</code> result”</a>). Then you need to
        specify on which index field you want to categorize on and which
        faceting options to apply. An example for a discrete faceting request
        can be seen in <a href="search-query.html#example-discrete-faceting" title="Example 5.26. Creating a discrete faceting request">Example 5.26, “Creating a discrete faceting request”</a>:</p><div class="example"><a id="example-discrete-faceting"/><p class="title"><b>Example 5.26. Creating a discrete faceting request</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;builder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextSession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getSearchFactory</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildQueryBuilder</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_type">Cd</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">FacetingRequest</span><span class="java_plain">&nbsp;labelFacetingRequest&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">facet</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">name</span><span class="java_separator">(</span><span class="java_literal">&quot;labelFacetRequest&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;label&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">discrete</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">orderedBy</span><span class="java_separator">(</span><span class="java_type">FacetSortOrder</span><span class="java_separator">.</span><span class="java_plain">COUNT_DESC</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">includeZeroCounts</span><span class="java_separator">(</span><span class="java_literal">false</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">maxFacetCount</span><span class="java_separator">(</span><span class="java_literal">3</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createFacetingRequest</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/><p>When executing this faceting request a
        <code class="classname">Facet</code> instance will be created for each
        discrete value for the indexed field <code class="constant">label</code>. The
        <code class="classname">Facet</code> instance will record the actual field
        value including how often this particular field value occurs within
        the original query results. Parameters <code class="methodname">orderedBy</code>,
        <code class="methodname">includeZeroCounts</code> and
        <code class="methodname">maxFacetCount</code> are optional and can be applied
        on any faceting request.
        Parameter <code class="methodname">orderedBy</code> allows to specify in which
        order the created facets will be returned. The default is
        <code class="constant">FacetSortOrder.COUNT_DESC</code>, but you can also sort
        on the field value. Parameter <code class="methodname">includeZeroCount</code>
        determines whether facets with a count of 0 will be included in the
        result (by default they are) and <code class="methodname">maxFacetCount</code>
        allows to limit the maximum amount of facets returned.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>There are several preconditions an indexed field has to meet
          in order to categorize (facet) on it. The indexed
          property must be of type <code class="classname">String</code>,
          <code class="classname">Date</code> or a subtype of
          <code class="classname">Number</code>; also <code class="constant">null</code> values
          should be avoided. Finally the property has to be indexed with
          <code class="constant">Analyze.NO</code> and you can not use it in combination
          with <code class="classname">@NumericField</code>. When you need these other
          options we suggest to index the property twice and use the appropriate
          field depending on the use case: </p><pre class="programlisting">...
@Fields({
  @Field( name="price" ),
  @Field( name="price_facet", analyze=Analyze.NO )
})
@NumericFields({
  @NumericField( forField="price" )
})
private int price;
...</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="range-faceting-request"/>5.4.1.2. Creating a range faceting request</h4></div></div></div><p>The creation of a range faceting request is similar. We also
        start with a name for the request and the field to facet on. Then
        we have to specify ranges for the field values. A range faceting
        request can be seen in <a href="search-query.html#example-range-faceting" title="Example 5.27. Creating a range faceting request">Example 5.27, “Creating a range faceting request”</a>.
        There, three different price ranges are specified.
        <code class="methodname">below</code> and <code class="methodname">above</code> can
        only be specified once, but you can specify as many
        <code class="methodname">from</code> - <code class="methodname">to</code> ranges as
        you want. For each range boundary you can also specify via
        <code class="methodname">excludeLimit</code> whether it is included into the
        range or not.</p><div class="example"><a id="example-range-faceting"/><p class="title"><b>Example 5.27. Creating a range faceting request</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">QueryBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;builder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;fullTextSession</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getSearchFactory</span><!-- <br/> --><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildQueryBuilder</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">forEntity</span><span class="java_separator">(</span><span class="java_type">Cd</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">FacetingRequest</span><span class="java_plain">&nbsp;priceFacetingRequest&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">facet</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">name</span><span class="java_separator">(</span><span class="java_literal">&quot;priceFaceting&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">onField</span><span class="java_separator">(</span><span class="java_literal">&quot;price_facet&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">range</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">below</span><span class="java_separator">(</span><span class="java_literal">1000</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_literal">1001</span><span class="java_separator">).</span><span class="java_plain">to</span><span class="java_separator">(</span><span class="java_literal">1500</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">above</span><span class="java_separator">(</span><span class="java_literal">1500</span><span class="java_separator">).</span><span class="java_plain">excludeLimit</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">createFacetingRequest</span><span class="java_separator">();</span></pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="section-sorting-faceting-request"/>5.4.2. Setting the facet sort order</h3></div></div></div><p>The result of applying a faceting request is a list of
      <code class="classname">Facet</code> instances as seen in <a href="search-query.html#example-applying-faceting" title="Example 5.28. Applying a faceting request">Example 5.28, “Applying a faceting request”</a>. The order within the list is
      given by the <code class="classname">FacetSortOrder</code> parameter specified
      via <code class="methodname">orderedBy</code> when creating the faceting
      request. The default value is
      <code class="constant">FacetSortOrder.COUNT_DESC</code>, meaning facets are
      ordered by their count in descending order (highest count first).
      Other values are <code class="constant">COUNT_ASC</code>,
      <code class="constant">FIELD_VALUE</code> and
      <code class="constant">RANGE_DEFINITION_ORDER</code>.
      <code class="constant">COUNT_ASC</code> returns the facets in ascending count
      order whereas <code class="constant">FIELD_VALUE</code> will return them in
      alphabetical order of the facet/category value (see <a href="search-query.html#section-interpreting-facet-result" title="5.4.4. Interpreting a Facet result">Section 5.4.4, “Interpreting a <code class="classname">Facet</code> result”</a>).
      <code class="constant">RANGE_DEFINITION_ORDER</code> only applies for range
      faceting request and returns the facets in the same order in which the
      ranges are defined. For <a href="search-query.html#example-range-faceting" title="Example 5.27. Creating a range faceting request">Example 5.27, “Creating a range faceting request”</a> this
      would mean the facet for the range of below 1000 would be returned
      first, followed by the facet for the range 1001 to 1500 and finally
      the facet for above 1500.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="section-applying-faceting-request"/>5.4.3. Applying a faceting request</h3></div></div></div><p>In <a href="search-query.html#section-creating-faceting-request" title="5.4.1. Creating a faceting request">Section 5.4.1, “Creating a faceting request”</a> we have
      seen how to create a faceting request. Now it is time to apply it on a
      query. The key is the <code class="classname">FacetManager</code> which can be
      retrieved via the <code class="classname">FullTextQuery</code> (see <a href="search-query.html#example-applying-faceting" title="Example 5.28. Applying a faceting request">Example 5.28, “Applying a faceting request”</a>).</p><div class="example"><a id="example-applying-faceting"/><p class="title"><b>Example 5.28. Applying a faceting request</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;create&nbsp;a&nbsp;fulltext&nbsp;query</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">all</span><span class="java_separator">().</span><span class="java_plain">createQuery</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;match&nbsp;all&nbsp;query</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Cd</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;retrieve&nbsp;facet&nbsp;manager&nbsp;and&nbsp;apply&nbsp;faceting&nbsp;request</span>
<!--  --><br/><span class="java_type">FacetManager</span><span class="java_plain">&nbsp;facetManager&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">getFacetManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">facetManager</span><span class="java_separator">.</span><span class="java_plain">enableFaceting</span><span class="java_separator">(</span><span class="java_plain">priceFacetingRequest</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;get&nbsp;the&nbsp;list&nbsp;of&nbsp;</span><span class="java_type">Cds</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Cd</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cds&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;retrieve&nbsp;the&nbsp;faceting&nbsp;results</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Facet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;facets&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;facetManager</span><span class="java_separator">.</span><span class="java_plain">getFacets</span><span class="java_separator">(</span><span class="java_literal">&quot;priceFaceting&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/><p>You need to enable the faceting request before you execute the
      query. You do that via
      <code class="methodname">facetManager.enableFaceting(&lt;facetName&gt;)</code>.
      You can enable as many faceting requests as you like, then you execute
      the query and retrieve the facet results for a given request via
      <code class="methodname">facetManager.getFacets(&lt;facetname&gt;)</code>. For
      each request you will get a list of <code class="classname">Facet</code>
      instances. Facet requests stay active and get applied to the fulltext
      query until they are either explicitly disabled via
      <code class="methodname">disableFaceting(&lt;facetName&gt;)</code> or the
      query is discarded.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="section-interpreting-facet-result"/>5.4.4. Interpreting a <code class="classname">Facet</code> result</h3></div></div></div><p>Each facet request results in a list of
      <code class="classname">Facet</code> instances. Each instance represents one
      facet/category value. In the CD example (<a href="search-query.html#example-discrete-faceting" title="Example 5.26. Creating a discrete faceting request">Example 5.26, “Creating a discrete faceting request”</a>) where we want to categorize on
      the Cd labels, there would for example be a <code class="classname">Facet</code>
      for each of the record labels Universal, Sony and Warner. <a href="search-query.html#example-facet-api" title="Example 5.29. Facet API">Example 5.29, “Facet API”</a> shows the API of
      <code class="classname">Facet</code>.</p><div class="example"><a id="example-facet-api"/><p class="title"><b>Example 5.29. Facet API</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">interface</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Facet</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@return</span><span class="java_javadoc_comment">&nbsp;the&nbsp;faceting&nbsp;name&nbsp;this&nbsp;{</span><span class="java_javadoc_tag">@code</span><span class="java_javadoc_comment">&nbsp;Facet}&nbsp;belongs&nbsp;to.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@see</span><span class="java_javadoc_comment">&nbsp;org.hibernate.search.query.facet.FacetingRequest#getFacetingName()</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getFacetingName</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;the&nbsp;{</span><span class="java_javadoc_tag">@code</span><span class="java_javadoc_comment">&nbsp;Document}&nbsp;field&nbsp;name&nbsp;this&nbsp;facet&nbsp;is&nbsp;targeting.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;field&nbsp;needs&nbsp;to&nbsp;be&nbsp;indexed&nbsp;with&nbsp;{</span><span class="java_javadoc_tag">@code</span><span class="java_javadoc_comment">&nbsp;Analyze.NO}.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@return</span><span class="java_javadoc_comment">&nbsp;the&nbsp;{</span><span class="java_javadoc_tag">@code</span><span class="java_javadoc_comment">&nbsp;Document}&nbsp;field&nbsp;name&nbsp;this&nbsp;facet&nbsp;is&nbsp;targeting.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getFieldName</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@return</span><span class="java_javadoc_comment">&nbsp;the&nbsp;value&nbsp;of&nbsp;this&nbsp;facet.&nbsp;In&nbsp;case&nbsp;of&nbsp;a&nbsp;discrete&nbsp;facet&nbsp;it&nbsp;is&nbsp;the&nbsp;actual</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="java_javadoc_tag">@code</span><span class="java_javadoc_comment">&nbsp;Document}&nbsp;field&nbsp;value.&nbsp;In&nbsp;case&nbsp;of&nbsp;a&nbsp;range&nbsp;query&nbsp;the&nbsp;value&nbsp;is&nbsp;a</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;representation&nbsp;of&nbsp;the&nbsp;range.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;getValue</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@return</span><span class="java_javadoc_comment">&nbsp;the&nbsp;facet&nbsp;count.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;getCount</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span><span class="java_javadoc_tag">@return</span><span class="java_javadoc_comment">&nbsp;a&nbsp;Lucene&nbsp;{</span><span class="java_javadoc_tag">@link</span><span class="java_javadoc_comment">&nbsp;Query}&nbsp;which&nbsp;can&nbsp;be&nbsp;executed&nbsp;to&nbsp;retrieve&nbsp;all</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;documents&nbsp;matching&nbsp;the&nbsp;value&nbsp;of&nbsp;this&nbsp;facet.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Query</span><span class="java_plain">&nbsp;getFacetQuery</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
</pre></div></div><br class="example-break"/><p><code class="methodname">getFacetingName()</code> and
      <code class="methodname">getFieldName()</code> are returning the facet request
      name and the targeted document field name as specified by the underlying
      <code class="classname">FacetRequest</code>. For <a href="search-query.html#example-discrete-faceting" title="Example 5.26. Creating a discrete faceting request">Example 5.26, “Creating a discrete faceting request”</a> that would be
      <code class="constant">labelFacetRequest</code> and <code class="constant">label</code>
      respectively. The interesting information is provided by
      <code class="methodname">getValue()</code> and
      <code class="methodname">getCount()</code>. The former is the actual
      facet/category value, for example a concrete record label like
      Universal. The latter returns the count for this value. To stick with
      the example again, the count value tells you how many Cds are released
      under the Universal label. Last but not least,
      <code class="classname">getFacetQuery()</code> returns a Lucene query which can
      be used to retrieve the entities counted in this facet.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6894"/>5.4.5. Restricting query results</h3></div></div></div><p>A common use case for faceting is a "drill-down" functionality
      which allows you to narrow your original search by applying a given
      facet on it. To do this, you can apply any of the returned
      <code class="classname">Facet</code>s as additional criteria on your original
      query via <code class="classname">FacetSelection</code>.
      <code class="classname">FacetSelection</code>s are available via the
      <code class="classname">FacetManager</code> and allow you to select a facet as
      query criteria (<code class="methodname">selectFacets</code>), remove a facet
      restriction (<code class="methodname">deselectFacets</code>), remove all facet
      restrictions (<code class="methodname">clearSelectedFacets</code>) and retrieve
      all currently selected facets
      (<code class="methodname">getSelectedFacets</code>). <a href="search-query.html#example-restricting-query-results" title="Example 5.30. Restricting query results via the application of a FacetSelection">Example 5.30, “Restricting query results via the application of a
        <code class="classname">FacetSelection</code>”</a> shows an example.</p><div class="example"><a id="example-restricting-query-results"/><p class="title"><b>Example 5.30. Restricting query results via the application of a
        <code class="classname">FacetSelection</code></b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;create&nbsp;a&nbsp;fulltext&nbsp;query</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;luceneQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">all</span><span class="java_separator">().</span><span class="java_plain">createQuery</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;match&nbsp;all&nbsp;query</span>
<!--  --><br/><span class="java_type">FullTextQuery</span><span class="java_plain">&nbsp;fullTextQuery&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextSession</span><span class="java_separator">.</span><span class="java_plain">createFullTextQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;luceneQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;clazz&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;retrieve&nbsp;facet&nbsp;manager&nbsp;and&nbsp;apply&nbsp;faceting&nbsp;request</span>
<!--  --><br/><span class="java_type">FacetManager</span><span class="java_plain">&nbsp;facetManager&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">getFacetManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">facetManager</span><span class="java_separator">.</span><span class="java_plain">enableFaceting</span><span class="java_separator">(</span><span class="java_plain">&nbsp;priceFacetingRequest&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;get&nbsp;the&nbsp;list&nbsp;of&nbsp;</span><span class="java_type">Cd</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Cd</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cds&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">cds</span><span class="java_separator">.</span><span class="java_plain">size</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">10</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;retrieve&nbsp;the&nbsp;faceting&nbsp;results</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Facet</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;facets&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;facetManager</span><span class="java_separator">.</span><span class="java_plain">getFacets</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;priceFaceting&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">facets</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_literal">0</span><span class="java_separator">).</span><span class="java_plain">getCount</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">2</span><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;apply&nbsp;first&nbsp;facet&nbsp;as&nbsp;additional&nbsp;search&nbsp;criteria</span>
<!--  --><br/><span class="java_type">FacetSelection</span><span class="java_plain">&nbsp;facetSelection&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;facetManager</span><span class="java_separator">.</span><span class="java_plain">getFacetGroup</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;priceFaceting&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">facetSelection</span><span class="java_separator">.</span><span class="java_plain">selectFacets</span><span class="java_separator">(</span><span class="java_plain">&nbsp;facets</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;re</span><span class="java_operator">-</span><span class="java_plain">execute&nbsp;the&nbsp;query</span>
<!--  --><br/><span class="java_plain">cds&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;fullTextQuery</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">assertTrue</span><span class="java_separator">(</span><span class="java_plain">cds</span><span class="java_separator">.</span><span class="java_plain">size</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_operator">==</span><span class="java_plain">&nbsp;</span><span class="java_literal">2</span><span class="java_separator">);</span></pre></div></div><br class="example-break"/></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e6932"/>5.5. Optimizing the query process</h2></div></div></div><p>Query performance depends on several criteria:</p><div class="itemizedlist"><ul><li><p>the Lucene query itself: read the literature on this
        subject.</p></li><li><p>the number of loaded objects: use pagination and / or index
        projection (if needed).</p></li><li><p>the way Hibernate Search interacts with the Lucene readers:
        defines the appropriate <a href="search-architecture.html#search-architecture-readerstrategy" title="2.3. Reader strategy">Reader strategy</a>.</p></li><li><p>caching frequently extracted values from the index: see <a href="search-query.html#query-fieldcaches" title="5.5.1. Caching index values: FieldCache">Section 5.5.1, “Caching index values: FieldCache”</a>.</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="query-fieldcaches"/>5.5.1. Caching index values: FieldCache</h3></div></div></div><p>The primary function of a Lucene index is to identify matches to
      your queries, still after the query is performed the results must be
      analyzed to extract useful information: typically Hibernate Search might
      need to extract the Class type and the primary key.</p><p>Extracting the needed values from the index has a performance
      cost, which in some cases might be very low and not noticeable, but in
      some other cases might be a good candidate for caching.</p><p>What is exactly needed depends on the kind of Projections being
      used (see <a href="search-query.html#projections" title="5.1.3.5. Projection">Section 5.1.3.5, “Projection”</a>), and in some cases the Class
      type is not needed as it can be inferred from the query context or other
      means.</p><p>Using the @<code class="classname">CacheFromIndex</code> annotation you
      can experiment different kinds of caching of the main metadata fields
      required by Hibernate Search:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"></span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_type">FieldCacheType</span><span class="java_separator">.</span><span class="java_plain">CLASS</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_keyword">import</span><span class="java_plain">&nbsp;</span><span class="java_keyword">static</span><span class="java_plain">&nbsp;org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">search</span><span class="java_separator">.</span><span class="java_plain">annotations</span><span class="java_separator">.</span><span class="java_type">FieldCacheType</span><span class="java_separator">.</span><span class="java_plain">ID</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Indexed</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">CacheFromIndex</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span><span class="java_plain">&nbsp;CLASS</span><span class="java_separator">,</span><span class="java_plain">&nbsp;ID&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Essay</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>It is currently possible to cache Class types and IDs using this
      annotation:</p><div class="itemizedlist"><ul><li><p><code class="constant">CLASS</code>: Hibernate Search will use a Lucene
          FieldCache to improve peformance of the Class type extraction from
          the index.</p><p>This value is enabled by default, and is what Hibernate Search
          will apply if you don't specify the
          @<code class="classname">CacheFromIndex</code> annotation.</p></li><li><p><code class="constant">ID</code>: Extracting the primary identifier
          will use a cache. This is likely providing the best performing
          queries, but will consume much more memory which in turn might
          reduce performance.</p></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Measure the performance and memory consumption impact after
        warmup (executing some queries): enabling Field Caches is likely to
        improve performance but this is not always the case.</p></div><p>Using a FieldCache has two downsides to consider:</p><div class="itemizedlist"><ul><li><p>Memory usage: these caches can be quite memory hungry.
          Typically the CLASS cache has lower requirements than the ID
          cache.</p></li><li><p>Index warmup: when using field caches, the first query on a
          new index or segment will be slower than when you don't have caching
          enabled.</p></li></ul></div><p>With some queries the classtype won't be needed at all, in that
      case even if you enabled the <code class="constant">CLASS</code> field cache,
      this might not be used; for example if you are targeting a single class,
      obviously all returned values will be of that type (this is evaluated at
      each Query execution).</p><p>For the ID FieldCache to be used, the ids of targeted entities
      must be using a <code class="classname">TwoWayFieldBridge</code> (as all
      builting bridges), and all types being loaded in a specific query must
      use the fieldname for the id, and have ids of the same type (this is
      evaluated at each Query execution).</p></div></div></div><HR xmlns=""/><a xmlns="" href=""/><ul class="docnav"><li class="previous"><a accesskey="p" href="search-mapping.html"><strong>Prev</strong>Chapter 4. Mapping entities to the index structure</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="manual-index-changes.html"><strong>Next</strong>Chapter 6. Manual index changes</a></li></ul></body></html>